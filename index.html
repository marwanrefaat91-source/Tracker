<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Investments Tracker ‚Äî Marwan</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-primary: #09090b;
    --bg-card: rgba(255,255,255,0.03);
    --bg-input: rgba(0,0,0,0.4);
    --border-subtle: rgba(255,255,255,0.06);
    --border-medium: rgba(255,255,255,0.1);
    --border-strong: rgba(255,255,255,0.15);
    --text-primary: #fafafa;
    --text-secondary: #a1a1aa;
    --text-tertiary: #71717a;
    --text-muted: #52525b;
    --text-dim: #3f3f46;
    --accent-blue: #3b82f6;
    --accent-blue-soft: rgba(59,130,246,0.15);
    --accent-gold: #eab308;
    --positive: #4ade80;
    --negative: #f87171;
    --font-mono: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    --font-main: 'DM Sans', 'Segoe UI', system-ui, sans-serif;
    --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 20px;
  }

  body { min-height:100vh; background:var(--bg-primary); color:#e4e4e7; font-family:var(--font-main); overflow-x:hidden; }
  body::before, body::after { content:''; position:fixed; border-radius:50%; pointer-events:none; z-index:0; filter:blur(80px); }
  body::before { top:-20%; right:-10%; width:700px; height:700px; background:radial-gradient(circle,rgba(234,179,8,0.05) 0%,transparent 70%); }
  body::after { bottom:-15%; left:-10%; width:600px; height:600px; background:radial-gradient(circle,rgba(59,130,246,0.04) 0%,transparent 70%); }

  .container { max-width:960px; margin:0 auto; padding:40px 20px 60px; position:relative; z-index:1; }

  .header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:28px; flex-wrap:wrap; gap:16px; }
  .header h1 { font-size:26px; font-weight:800; color:var(--text-primary); letter-spacing:-0.5px; }
  .header p { font-size:13px; color:var(--text-tertiary); margin-top:4px; }
  .header-btns { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  .btn { background:rgba(255,255,255,0.05); border:1px solid var(--border-medium); color:var(--text-secondary); padding:8px 16px; border-radius:var(--radius-sm); cursor:pointer; font-size:13px; font-family:inherit; font-weight:500; transition:all 0.2s ease; white-space:nowrap; display:inline-flex; align-items:center; gap:6px; }
  .btn:hover { background:rgba(255,255,255,0.1); color:var(--text-primary); border-color:var(--border-strong); }
  .btn:active { transform:scale(0.97); }
  .btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; }
  .btn-primary { background:var(--accent-blue-soft); border-color:rgba(59,130,246,0.3); color:#60a5fa; }
  .btn-primary:hover { background:rgba(59,130,246,0.25); color:#93bbfd; border-color:rgba(59,130,246,0.5); }
  .btn-sm { padding:5px 10px; font-size:12px; }
  .btn-danger { background:rgba(248,113,113,0.1); border-color:rgba(248,113,113,0.25); color:#f87171; }
  .btn-danger:hover { background:rgba(248,113,113,0.2); }

  /* ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ */
  .tabs { display:flex; gap:4px; margin-bottom:24px; background:rgba(255,255,255,0.03); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:4px; }
  .tab-btn { flex:1; padding:8px 12px; border-radius:var(--radius-sm); border:none; background:transparent; color:var(--text-tertiary); cursor:pointer; font-size:13px; font-family:inherit; font-weight:500; transition:all 0.2s; text-align:center; }
  .tab-btn:hover { color:var(--text-primary); background:rgba(255,255,255,0.04); }
  .tab-btn.active { background:rgba(255,255,255,0.08); color:var(--text-primary); border:1px solid var(--border-medium); }
  .tab-panel { display:none; }
  .tab-panel.active { display:block; }

  /* ‚îÄ‚îÄ Total Card ‚îÄ‚îÄ */
  .total-card { background:linear-gradient(135deg,rgba(255,255,255,0.04) 0%,rgba(255,255,255,0.01) 100%); border:1px solid rgba(255,255,255,0.08); border-radius:var(--radius-xl); padding:32px 28px 24px; margin-bottom:20px; backdrop-filter:blur(20px); text-align:center; position:relative; overflow:hidden; }
  .total-card::before { content:''; position:absolute; top:0; left:50%; transform:translateX(-50%); width:200px; height:1px; background:linear-gradient(90deg,transparent,rgba(234,179,8,0.4),transparent); }
  .total-label { font-size:11px; font-weight:600; letter-spacing:2px; color:var(--text-tertiary); text-transform:uppercase; }
  .total-amount { font-size:48px; font-weight:800; color:var(--text-primary); margin:8px 0 4px; letter-spacing:-1.5px; font-variant-numeric:tabular-nums; font-family:var(--font-mono); }
  .total-egp { font-size:18px; color:var(--text-secondary); font-weight:500; font-variant-numeric:tabular-nums; font-family:var(--font-mono); }
  .timestamp { font-size:11px; color:var(--text-muted); margin-top:8px; display:block; }

  .alloc-bar { display:flex; height:6px; border-radius:3px; overflow:hidden; gap:2px; margin:20px 0 12px; }
  .alloc-segment { height:100%; border-radius:3px; transition:width 0.6s cubic-bezier(0.4,0,0.2,1); min-width:4px; }
  .legend { display:flex; justify-content:center; gap:16px; flex-wrap:wrap; }
  .legend-item { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text-secondary); }
  .legend-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }

  .total-unrealized { font-size:14px; margin-top:6px; color:var(--text-secondary); font-weight:600; font-variant-numeric:tabular-nums; font-family:var(--font-mono); }
  .total-unrealized.positive { color:var(--positive); }
  .total-unrealized.negative { color:var(--negative); }
  .mode-toggles { margin-top:10px; display:flex; justify-content:center; gap:4px; }
  .mode-toggles .btn { padding:4px 12px; font-size:12px; min-width:36px; justify-content:center; }

  /* ‚îÄ‚îÄ Rates Banner ‚îÄ‚îÄ */
  .rates-banner { display:flex; gap:10px; margin-bottom:24px; flex-wrap:wrap; }
  .rate-chip { flex:1; min-width:110px; background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:12px 14px; display:flex; flex-direction:column; gap:4px; transition:border-color 0.2s; }
  .rate-chip:hover { border-color:var(--border-medium); }
  .rate-top { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .rate-label { font-size:11px; color:var(--text-tertiary); font-weight:600; letter-spacing:0.5px; text-transform:uppercase; }
  .rate-value { font-size:14px; color:#d4d4d8; font-weight:700; font-variant-numeric:tabular-nums; font-family:var(--font-mono); }
  .rate-meta { font-size:10px; color:var(--text-muted); }
  .rate-change { font-size:11px; font-weight:600; font-family:var(--font-mono); }
  .rate-change.positive { color:var(--positive); }
  .rate-change.negative { color:var(--negative); }

  /* ‚îÄ‚îÄ Search & Sort Bar ‚îÄ‚îÄ */
  .search-sort-bar { display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap; align-items:center; }
  .search-input { flex:1; min-width:180px; padding:8px 12px 8px 36px; border-radius:var(--radius-sm); border:1px solid var(--border-medium); background:var(--bg-input); color:var(--text-primary); font-size:13px; font-family:inherit; outline:none; transition:border-color 0.2s; }
  .search-input:focus { border-color:var(--accent-blue); }
  .search-wrap { position:relative; flex:1; min-width:180px; }
  .search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--text-muted); font-size:14px; pointer-events:none; }
  .sort-select { padding:8px 12px; border-radius:var(--radius-sm); border:1px solid var(--border-medium); background:var(--bg-input); color:var(--text-secondary); font-size:13px; font-family:inherit; outline:none; cursor:pointer; }
  .sort-select:focus { border-color:var(--accent-blue); }

  /* ‚îÄ‚îÄ Asset Cards ‚îÄ‚îÄ */
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(340px,1fr)); gap:14px; margin-bottom:24px; }
  .card { border:1px solid; border-radius:var(--radius-lg); padding:20px 22px; transition:transform 0.15s ease,box-shadow 0.2s ease; position:relative; }
  .card:hover { transform:translateY(-2px); box-shadow:0 8px 32px rgba(0,0,0,0.3); }
  .card-header { display:flex; align-items:center; gap:10px; margin-bottom:16px; }
  .card-icon { font-size:22px; }
  .card-label { font-size:16px; font-weight:700; flex:1; }
  .card-pct { font-size:13px; font-weight:700; opacity:0.8; font-family:var(--font-mono); }

  .holding-row { margin-bottom:12px; }
  .holding-label { font-size:11px; color:var(--text-tertiary); font-weight:600; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; display:block; }
  .holding-input-wrap { display:flex; align-items:center; gap:8px; }
  .holding-input { flex:1; padding:8px 12px; border-radius:var(--radius-sm); border:1px solid var(--border-medium); background:var(--bg-input); color:var(--text-primary); font-size:20px; font-weight:700; font-family:var(--font-mono); outline:none; font-variant-numeric:tabular-nums; transition:border-color 0.2s; width:100%; }
  .holding-input:focus { border-width:2px; }
  .unit { font-size:13px; color:var(--text-tertiary); font-weight:500; min-width:50px; }

  .price-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-top:1px solid rgba(255,255,255,0.04); margin-bottom:4px; }
  .price-label { font-size:12px; color:var(--text-muted); }
  .price-value { font-size:13px; color:var(--text-secondary); font-weight:500; font-variant-numeric:tabular-nums; font-family:var(--font-mono); }
  .price-unit { font-size:11px; color:var(--text-muted); }

  .value-row { display:flex; justify-content:space-between; align-items:center; padding-top:10px; border-top:1px solid rgba(255,255,255,0.06); }
  .value-label { font-size:12px; color:var(--text-tertiary); font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
  .value-amount { font-size:22px; font-weight:800; font-variant-numeric:tabular-nums; font-family:var(--font-mono); }

  .card-remove { position:absolute; top:10px; right:12px; background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:16px; padding:4px 6px; border-radius:4px; transition:all 0.2s; line-height:1; opacity:0; }
  .card:hover .card-remove { opacity:1; }
  .card-remove:hover { color:var(--negative); background:rgba(239,68,68,0.1); }

  .manual-price-row { display:flex; align-items:center; gap:6px; padding:6px 0 0; margin-top:4px; }
  .manual-price-input { width:110px; padding:4px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background:rgba(0,0,0,0.3); color:var(--text-primary); font-size:12px; font-family:var(--font-mono); outline:none; }
  .manual-price-input:focus { border-color:var(--accent-gold); }
  .manual-price-label { font-size:11px; color:var(--text-dim); }

  .avgcost-row { display:flex; align-items:center; gap:8px; padding:6px 0 0; margin-top:4px; }
  .avgcost-label { font-size:11px; color:var(--text-dim); }
  .avgcost-input { width:140px; padding:4px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background:rgba(0,0,0,0.3); color:var(--text-primary); font-size:12px; font-family:var(--font-mono); outline:none; }
  .avgcost-input:focus { border-color:var(--accent-blue); }
  .avgcost-ccy { font-size:11px; color:var(--text-muted); font-weight:700; min-width:38px; }

  .gain-row { display:flex; justify-content:space-between; align-items:center; padding-top:8px; border-top:1px solid rgba(255,255,255,0.06); margin-top:8px; }
  .gain-value { font-size:14px; font-weight:800; font-variant-numeric:tabular-nums; font-family:var(--font-mono); }
  .gain-value.positive { color:var(--positive); }
  .gain-value.negative { color:var(--negative); }
  .gain-value.neutral { color:var(--text-secondary); }

  .today-row { display:flex; justify-content:space-between; align-items:center; padding-top:4px; }
  .today-value { font-size:12px; font-weight:600; font-variant-numeric:tabular-nums; font-family:var(--font-mono); }
  .today-value.positive { color:var(--positive); }
  .today-value.negative { color:var(--negative); }
  .today-value.neutral { color:var(--text-muted); }

  /* ‚îÄ‚îÄ Transactions ‚îÄ‚îÄ */
  .tx-btn { font-size:11px; padding:3px 8px; border-radius:4px; margin-top:6px; }
  .tx-log { margin-top:8px; border-top:1px solid rgba(255,255,255,0.05); padding-top:8px; }
  .tx-log-title { font-size:10px; color:var(--text-muted); font-weight:600; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
  .tx-item { display:flex; justify-content:space-between; align-items:center; padding:4px 0; font-size:11px; border-bottom:1px solid rgba(255,255,255,0.03); }
  .tx-item:last-child { border-bottom:none; }
  .tx-type { font-weight:700; padding:1px 5px; border-radius:3px; font-size:10px; }
  .tx-type.buy { color:#4ade80; background:rgba(74,222,128,0.1); }
  .tx-type.sell { color:#f87171; background:rgba(248,113,113,0.1); }
  .tx-type.dividend { color:#60a5fa; background:rgba(96,165,250,0.1); }
  .tx-date { color:var(--text-muted); font-size:10px; }
  .tx-detail { color:var(--text-secondary); font-family:var(--font-mono); }
  .tx-remove-btn { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:12px; padding:0 2px; transition:color 0.2s; }
  .tx-remove-btn:hover { color:var(--negative); }

  /* ‚îÄ‚îÄ Performance Tab ‚îÄ‚îÄ */
  .perf-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; margin-bottom:24px; }
  .perf-metric { background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:18px 20px; }
  .perf-metric-label { font-size:11px; color:var(--text-tertiary); font-weight:600; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
  .perf-metric-value { font-size:26px; font-weight:800; font-family:var(--font-mono); font-variant-numeric:tabular-nums; }
  .perf-metric-value.positive { color:var(--positive); }
  .perf-metric-value.negative { color:var(--negative); }
  .perf-metric-sub { font-size:11px; color:var(--text-muted); margin-top:4px; }

  .chart-section { background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:var(--radius-lg); padding:20px 22px; margin-bottom:20px; }
  .chart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:10px; }
  .chart-title { font-size:14px; font-weight:700; color:var(--text-primary); }
  .chart-range-btns { display:flex; gap:4px; }
  .chart-range-btn { padding:4px 10px; font-size:11px; border-radius:4px; border:1px solid var(--border-subtle); background:transparent; color:var(--text-muted); cursor:pointer; font-family:inherit; transition:all 0.15s; }
  .chart-range-btn:hover { color:var(--text-primary); border-color:var(--border-medium); }
  .chart-range-btn.active { background:var(--accent-blue-soft); border-color:rgba(59,130,246,0.3); color:#60a5fa; }
  canvas { width:100% !important; }

  /* ‚îÄ‚îÄ Empty ‚îÄ‚îÄ */
  .empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); grid-column:1/-1; }
  .empty-state .eicon { font-size:48px; margin-bottom:16px; display:block; }
  .empty-state p { font-size:14px; line-height:1.6; }

  /* ‚îÄ‚îÄ Lock Screen ‚îÄ‚îÄ */
  .lock-overlay { position:fixed; inset:0; background:rgba(9,9,11,0.95); backdrop-filter:blur(20px); z-index:9999; display:flex; align-items:center; justify-content:center; padding:24px; }
  .lock-card { width:100%; max-width:440px; background:rgba(24,24,27,0.95); border:1px solid var(--border-medium); border-radius:var(--radius-xl); padding:32px 28px 24px; text-align:left; position:relative; overflow:hidden; }
  .lock-card::before { content:''; position:absolute; top:0; left:50%; transform:translateX(-50%); width:120px; height:1px; background:linear-gradient(90deg,transparent,rgba(59,130,246,0.5),transparent); }
  .lock-title { font-size:20px; font-weight:800; color:var(--text-primary); margin-bottom:6px; text-align:center; }
  .lock-sub { font-size:13px; color:var(--text-tertiary); margin-bottom:14px; line-height:1.5; text-align:center; }
  .lock-grid { display:grid; grid-template-columns:1fr; gap:10px; margin-top:12px; }
  .lock-row { display:flex; gap:10px; align-items:center; margin-top:14px; }
  .lock-input { width:100%; padding:12px 14px; border-radius:var(--radius-md); border:1px solid var(--border-medium); background:var(--bg-input); color:var(--text-primary); font-size:14px; font-family:var(--font-main); outline:none; transition:border-color 0.2s; }
  .lock-input:focus { border-color:rgba(59,130,246,0.55); }
  .lock-hint { font-size:11px; color:var(--text-muted); line-height:1.5; }
  .lock-secret { font-family:var(--font-mono); font-size:13px; color:#e4e4e7; background:rgba(0,0,0,0.35); border:1px solid var(--border-medium); border-radius:var(--radius-md); padding:10px 12px; user-select:all; overflow-wrap:anywhere; }
  .lock-error { font-size:12px; color:var(--negative); margin-top:10px; min-height:16px; text-align:center; }
  .lock-links { margin-top:12px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
  .link-btn { background:none; border:none; color:var(--text-secondary); font-size:12px; cursor:pointer; padding:6px 8px; border-radius:var(--radius-sm); font-family:var(--font-main); transition:all 0.2s; }
  .link-btn:hover { color:var(--text-primary); background:rgba(255,255,255,0.06); }


  .app-hidden { display:none !important; }

  /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
  .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:200; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(8px); animation:fadeIn 0.15s ease; }
  .modal-overlay.above-lock { z-index:10001; } /* for modals opened from lock screen */
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  .modal-overlay.hidden { display:none; }
  .modal { background:#18181b; border:1px solid var(--border-medium); border-radius:var(--radius-xl); padding:28px 28px 24px; width:90%; max-width:480px; max-height:90vh; overflow-y:auto; animation:slideUp 0.2s ease; }
  @keyframes slideUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  .modal h2 { font-size:20px; font-weight:700; color:var(--text-primary); margin-bottom:4px; }
  .modal > p { font-size:13px; color:var(--text-tertiary); margin-bottom:20px; }

  .asset-type-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; }
  .asset-type-btn { padding:14px 12px; border-radius:var(--radius-md); border:1px solid rgba(255,255,255,0.08); background:var(--bg-card); color:var(--text-secondary); cursor:pointer; text-align:center; font-family:inherit; font-size:13px; font-weight:500; transition:all 0.2s; }
  .asset-type-btn:hover { background:rgba(255,255,255,0.06); color:var(--text-primary); border-color:var(--border-strong); }
  .asset-type-btn.selected { background:var(--accent-blue-soft); border-color:rgba(59,130,246,0.4); color:#60a5fa; }
  .asset-type-btn .icon { font-size:22px; display:block; margin-bottom:4px; }

  .form-group { margin-bottom:14px; }
  .form-label { display:block; font-size:12px; color:var(--text-tertiary); font-weight:500; margin-bottom:6px; }
  .form-input { width:100%; padding:10px 14px; border-radius:var(--radius-sm); border:1px solid var(--border-medium); background:var(--bg-input); color:var(--text-primary); font-size:14px; font-family:inherit; outline:none; transition:border-color 0.2s; }
  .form-input:focus { border-color:var(--accent-blue); }
  .form-input::placeholder { color:var(--text-dim); }
  .form-hint { font-size:11px; color:var(--text-muted); margin-top:4px; }
  .form-row { display:flex; gap:10px; }
  .form-row .form-group { flex:1; }
  .modal-actions { display:flex; gap:10px; margin-top:20px; }
  .modal-actions .btn { flex:1; padding:10px 16px; font-size:14px; font-weight:600; text-align:center; justify-content:center; }

  .loading-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(9,9,11,0.85); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; gap:16px; backdrop-filter:blur(4px); }
  .loading-overlay.hidden { display:none; }
  .spinner { width:40px; height:40px; border:3px solid rgba(255,255,255,0.08); border-top-color:var(--accent-gold); border-radius:50%; animation:spin 0.8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { color:var(--text-tertiary); font-size:14px; }

  .export-content { background:rgba(0,0,0,0.3); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:16px; font-family:var(--font-mono); font-size:12px; color:var(--text-secondary); max-height:300px; overflow-y:auto; white-space:pre-wrap; word-break:break-all; }

  .footer { text-align:center; font-size:12px; color:var(--text-dim); line-height:1.6; padding-top:8px; border-top:1px solid var(--border-subtle); }

  .toast-container { position:fixed; bottom:24px; right:24px; z-index:300; display:flex; flex-direction:column; gap:8px; }
  .toast { background:#27272a; border:1px solid var(--border-medium); border-radius:var(--radius-md); padding:12px 18px; font-size:13px; color:var(--text-primary); box-shadow:0 8px 32px rgba(0,0,0,0.4); animation:toastIn 0.3s ease,toastOut 0.3s ease 2.7s forwards; max-width:340px; }
  .toast.success { border-left:3px solid var(--positive); }
  .toast.error { border-left:3px solid var(--negative); }
  .toast.info { border-left:3px solid var(--accent-blue); }
  .toast.warn { border-left:3px solid #f97316; background: rgba(249,115,22,0.12); color:#fdba74; }
  @keyframes toastIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  @keyframes toastOut { from{opacity:1} to{opacity:0} }

  /* ‚îÄ‚îÄ Restore Modal ‚îÄ‚îÄ */
  .restore-drop { border:2px dashed var(--border-medium); border-radius:var(--radius-md); padding:32px; text-align:center; color:var(--text-muted); cursor:pointer; transition:all 0.2s; margin-bottom:14px; }
  .restore-drop:hover, .restore-drop.drag-over { border-color:var(--accent-blue); color:var(--text-secondary); background:var(--accent-blue-soft); }
  .restore-drop input[type="file"] { display:none; }

  /* ‚îÄ‚îÄ Snapshot history table ‚îÄ‚îÄ */
  .snap-table { width:100%; border-collapse:collapse; font-size:12px; margin-top:12px; }
  .snap-table th { text-align:left; padding:6px 10px; color:var(--text-muted); font-weight:600; font-size:10px; text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid var(--border-subtle); }
  .snap-table td { padding:7px 10px; border-bottom:1px solid rgba(255,255,255,0.03); color:var(--text-secondary); font-family:var(--font-mono); }
  .snap-table tr:last-child td { border-bottom:none; }
  .snap-table tr:hover td { background:rgba(255,255,255,0.02); }

  @media (max-width:500px) {
    .total-amount { font-size:32px; }
    .total-egp { font-size:15px; }
    .grid { grid-template-columns:1fr; }
    .header { flex-direction:column; }
    .header-btns { width:100%; }
    .card-remove { opacity:1; }
    .tabs { flex-wrap:wrap; }
    .tab-btn { min-width:80px; }
  }
</style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<!-- Lock Screen -->
<div class="lock-overlay" id="lockOverlay">
  <div class="lock-card">
    <div class="lock-title" id="lockTitle">üîí Locked</div>
    <div class="lock-sub" id="lockSub">Enter password + authenticator code to view your tracker.</div>
    <div id="lockLogin" class="lock-grid">
      <input class="lock-input" id="lockPass" type="password" placeholder="Password" autocomplete="current-password">
      <input class="lock-input" id="lockTotp" inputmode="numeric" placeholder="Authenticator code (6 digits)" maxlength="6">
      <div class="lock-hint">Use Google Authenticator / Microsoft Authenticator / Authy.</div>
    </div>
    <div id="lockCreatePass" class="lock-grid app-hidden">
      <input class="lock-input" id="newPass1" type="password" placeholder="Create a password (min 4 chars)">
      <input class="lock-input" id="newPass2" type="password" placeholder="Confirm password">
      <div class="lock-hint">Next step: you will set up Google Authenticator codes.</div>
    </div>
    <div id="lockSetup2fa" class="lock-grid app-hidden">
      <div class="lock-hint">Step 1: Open Google Authenticator ‚Üí "+" ‚Üí "Enter a setup key"<br>Step 2: Account name: <b>Investments Tracker</b><br>Step 3: Key: copy the secret below (Type: <b>Time-based</b>)</div>
      <div class="lock-secret" id="totpSecretBox">‚Äî</div>
      <div class="lock-hint">Step 4: Enter the 6-digit code from your authenticator to confirm.</div>
      <input class="lock-input" id="setupTotpCode" inputmode="numeric" placeholder="Authenticator code (6 digits)" maxlength="6">
    </div>
    <div class="lock-row">
      <button class="btn btn-primary" id="unlockBtn" type="button" style="width:100%;justify-content:center;">Unlock</button>
    </div>
    <div class="lock-error" id="lockError"></div>
    <div id="storageDiagBanner" style="display:none;font-size:11px;padding:8px 12px;border-radius:6px;margin-top:6px;background:rgba(255,255,255,0.04);text-align:center;"></div>
    <div class="lock-links">
      <button class="link-btn" type="button" onclick="lockHelp()">Help</button>
    </div>
    <div style="margin-top:10px;">
      <button type="button" onclick="openRestoreModal()" style="width:100%;background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.25);color:#d4a017;border-radius:var(--radius-md);padding:10px;font-size:13px;font-family:inherit;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px;" onmouseover="this.style.background='rgba(234,179,8,0.15)'" onmouseout="this.style.background='rgba(234,179,8,0.08)'">
        üìÇ Restore from Encrypted Backup
      </button>
    </div>
    <div style="margin-top:10px;font-size:11px;color:var(--text-muted);text-align:center;">Press Enter to continue</div>
  </div>
</div>

<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Fetching live prices‚Ä¶</div>
</div>

<!-- Change Password Modal -->
<div class="modal-overlay hidden" id="passModal">
  <div class="modal">
    <h2>Change Password</h2>
    <p>Requires your current password + authenticator code</p>
    <div class="form-group"><label class="form-label">Current Password</label><input type="password" class="form-input" id="curPass" placeholder="Current password"></div>
    <div class="form-group"><label class="form-label">Authenticator Code</label><input type="text" class="form-input" id="curTotp" placeholder="6-digit code" inputmode="numeric" maxlength="6"></div>
    <div class="form-group"><label class="form-label">New Password</label><input type="password" class="form-input" id="newPass" placeholder="New password (min 4 chars)"><div class="form-hint" id="passMsg" style="color:var(--negative);"></div></div>
    <div class="modal-actions"><button class="btn" onclick="closeChangePass()">Cancel</button><button class="btn btn-primary" onclick="submitChangePass()">Save</button></div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay hidden" id="exportModal">
  <div class="modal">
    <h2>Export Portfolio</h2>
    <p>Copy your portfolio summary, download as CSV, or save an encrypted backup</p>
    <div class="export-content" id="exportContent"></div>
    <div class="modal-actions" style="margin-top:16px;flex-wrap:wrap;">
      <button class="btn" onclick="closeExport()">Close</button>
      <button class="btn" onclick="copyExport()">üìã Copy</button>
      <button class="btn btn-primary" onclick="downloadCSV()">üì• CSV</button>
      <button class="btn" onclick="downloadEncryptedBackup()" style="background:rgba(234,179,8,0.1);border-color:rgba(234,179,8,0.3);color:#fbbf24;">üîê Encrypted Backup</button>
    </div>
  </div>
</div>


<!-- Cloud Sync Modal -->
<div class="modal-overlay hidden" id="cloudModal">
  <div class="modal">
    <h2>‚òÅÔ∏è Cloud Sync</h2>
    <p>Sync your encrypted vault across devices using Supabase (your data stays encrypted; Supabase stores only the encrypted blob).</p>

    <div class="form-group">
      <label class="form-label">Supabase Project URL</label>
      <input class="form-input" id="sbUrl" placeholder="https://xxxx.supabase.co">
      <div class="form-hint">Find this in Supabase ‚Üí Project Settings ‚Üí API</div>
    </div>

    <div class="form-group">
      <label class="form-label">Supabase Anon Key</label>
      <input class="form-input" id="sbAnon" placeholder="eyJhbGciOi..." autocomplete="off">
      <div class="form-hint">Safe to use in the browser when Row Level Security (RLS) is enabled.</div>
    </div>

    <div class="form-group">
      <label class="form-label">Cloud Vault Key</label>
      <input class="form-input" id="sbVaultKey" placeholder="primary">
      <div class="form-hint">Use the same key on all devices (default: <code>primary</code>).</div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Supabase Account Email</label>
        <input class="form-input" id="sbEmail" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">Supabase Account Password</label>
        <input class="form-input" id="sbPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
    </div>

    <div id="cloudMsg" style="font-size:12px;min-height:18px;margin-top:4px;margin-bottom:8px;color:var(--text-tertiary);"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
      <button class="btn" onclick="cloudConnect()">üîå Connect</button>
      <button class="btn" onclick="cloudSignUp()">üÜï Sign up</button>
      <button class="btn btn-primary" onclick="cloudPull()">‚¨áÔ∏è Pull to this device</button>
      <button class="btn" onclick="cloudPush()">‚¨ÜÔ∏è Push from this device</button>
    </div>

    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border-subtle);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
      <label style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-secondary);">
        <input type="checkbox" id="cloudAutoToggle" onchange="setCloudAuto(this.checked)">
        Auto-sync on every change
      </label>
      <label style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-secondary);">
        <input type="checkbox" id="cloudAutoPullToggle" onchange="setCloudAutoPull(this.checked)">
        Auto-pull updates (check cloud every 20s)
      </label>
      <label style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-secondary);">
        <input type="checkbox" id="cloudRememberToggle" onchange="setCloudRemember(this.checked)">
        Remember Supabase login in vault (encrypted)
      </label>
      <input class="form-input" id="cloudPollMs" style="width:140px;height:34px;font-size:12px;" placeholder="20000" inputmode="numeric" title="Polling interval in milliseconds" onchange="setCloudPollMs(this.value)">
      <button class="btn" onclick="cloudSignOut()">üö™ Sign out</button>
    </div>

    <div style="margin-top:12px;font-size:11px;color:var(--text-muted);line-height:1.7;">
      <b>Setup required (one-time):</b> create a Supabase table called <code>vaults</code> with RLS enabled. This modal includes a ‚ÄúSetup SQL‚Äù snippet once you click Connect.
    </div>

    <div class="modal-actions">
      <button class="btn" onclick="closeCloudModal()">Close</button>
    </div>
  </div>
</div>


<!-- Restore Backup Modal -->
<div class="modal-overlay hidden" id="restoreModal">
  <div class="modal">
    <h2>üìÇ Restore from Backup</h2>
    <p>Decrypt and restore a <code>.vault</code> backup file. Your original password and TOTP are required.</p>

    <!-- Step 1: file -->
    <div style="margin-bottom:14px;">
      <div class="form-label" style="margin-bottom:8px;">Step 1 ‚Äî Select your backup file</div>
      <div class="restore-drop" id="restoreDrop" onclick="document.getElementById('restoreFile').click()">
        <input type="file" id="restoreFile" accept=".json,.vault" onchange="handleRestoreFile(this)">
        <div id="restoreDropIcon" style="font-size:28px;margin-bottom:6px;">üìÅ</div>
        <div id="restoreDropText" style="font-size:13px;">Click to choose file, or drag &amp; drop</div>
        <div style="font-size:11px;margin-top:4px;color:var(--text-muted);">Accepts .vault or .json backup files</div>
      </div>
    </div>

    <!-- Step 2: credentials -->
    <div class="form-label" style="margin-bottom:8px;">Step 2 ‚Äî Enter your credentials</div>
    <div class="form-group">
      <label class="form-label">Password (from when backup was created)</label>
      <input type="password" class="form-input" id="restorePass" placeholder="Your vault password" autocomplete="current-password">
    </div>
    <div class="form-group">
      <label class="form-label">Authenticator Code</label>
      <input type="text" class="form-input" id="restoreTotp" placeholder="6-digit code from your authenticator app" inputmode="numeric" maxlength="6">
    </div>

    <!-- Status area -->
    <div id="restoreMsg" style="font-size:12px;min-height:18px;margin-bottom:10px;padding:6px 10px;border-radius:6px;display:none;"></div>

    <!-- Progress bar (hidden until working) -->
    <div id="restoreProgress" style="display:none;margin-bottom:12px;">
      <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:6px;" id="restoreProgressLabel">Decrypting‚Ä¶</div>
      <div style="height:4px;background:var(--border-subtle);border-radius:2px;overflow:hidden;">
        <div id="restoreProgressBar" style="height:100%;background:var(--accent-blue);border-radius:2px;width:0%;transition:width 0.3s;"></div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn" id="restoreCancelBtn" onclick="closeRestoreModal()">Cancel</button>
      <button class="btn btn-primary" id="restoreSubmitBtn" onclick="submitRestore()">üîì Restore</button>
    </div>

    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border-subtle);font-size:11px;color:var(--text-muted);line-height:1.8;">
      <b style="color:#f97316;">‚ö†Ô∏è Important ‚Äî read before restoring:</b><br>
      ‚Ä¢ Each browser stores its own separate copy of your data. Browsers <b>do not sync automatically</b>.<br>
      ‚Ä¢ Restoring will <b>overwrite</b> whatever is currently saved in <i>this</i> browser with the backup file.<br>
      ‚Ä¢ If this browser has newer data, a <b>safety backup will auto-download first</b> so you don't lose anything.<br>
      ‚Ä¢ Best practice: always download a fresh backup from your primary browser before switching.<br><br>
      <b style="color:var(--text-tertiary);">Security:</b> Your data is AES-256-GCM encrypted. The .vault file is unreadable without your password.
    </div>
  </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal-overlay hidden" id="txModal">
  <div class="modal">
    <h2>Add Transaction</h2>
    <p id="txModalSubtitle">Log a buy, sell, or dividend</p>
    <div class="form-group">
      <label class="form-label">Type</label>
      <select class="form-input" id="txType">
        <option value="buy">Buy</option>
        <option value="sell">Sell</option>
        <option value="dividend">Dividend</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Date</label>
      <input type="date" class="form-input" id="txDate">
    </div>
    <div class="form-row">
      <div class="form-group" id="txQtyGroup">
        <label class="form-label" id="txQtyLabel">Quantity</label>
        <input type="number" class="form-input" id="txQty" placeholder="0" step="0.0001">
      </div>
      <div class="form-group" id="txPriceGroup">
        <label class="form-label" id="txPriceLabel">Price per unit</label>
        <input type="number" class="form-input" id="txPrice" placeholder="0" step="0.01">
      </div>
    </div>
    <div class="form-group" id="txAmountGroup" style="display:none">
      <label class="form-label">Dividend Amount (USD)</label>
      <input type="number" class="form-input" id="txAmount" placeholder="0" step="0.01">
    </div>
    <div class="form-group"><label class="form-label">Notes (optional)</label><input type="text" class="form-input" id="txNotes" placeholder="Optional note"></div>
    <div class="modal-actions"><button class="btn" onclick="closeTxModal()">Cancel</button><button class="btn btn-primary" onclick="submitTx()">Add Transaction</button></div>
  </div>
</div>

<!-- Add Asset Modal -->
<div class="modal-overlay hidden" id="addModal">
  <div class="modal">
    <h2>Add New Asset</h2>
    <p>Choose asset type and fill in the details</p>
    <div class="asset-type-grid" id="assetTypeGrid">
      <button class="asset-type-btn selected" data-type="etf" onclick="selectAssetType('etf')"><span class="icon">üìà</span> Stock / ETF</button>
      <button class="asset-type-btn" data-type="cash" onclick="selectAssetType('cash')"><span class="icon">üíµ</span> Cash (any currency)</button>
      <button class="asset-type-btn" data-type="gold" onclick="selectAssetType('gold')"><span class="icon">ü•á</span> Gold (grams)</button>
      <button class="asset-type-btn" data-type="deposit" onclick="selectAssetType('deposit')"><span class="icon">üè¶</span> Deposit / Bond</button>
    </div>
    <div id="fieldsETF">
      <div class="form-group"><label class="form-label">Ticker Symbol</label><input type="text" class="form-input" id="addTicker" placeholder="e.g. IGLN.L, AAPL, VWRA.L" oninput="this.value=this.value.toUpperCase()"><div class="form-hint">Use the full ticker with exchange suffix: .L (London), .DE (Germany), etc.</div></div>
      <div class="form-group"><label class="form-label">Number of Shares</label><input type="number" class="form-input" id="addShares" placeholder="0" step="0.01"></div>
    </div>
    <div id="fieldsCash" style="display:none">
      <div class="form-group"><label class="form-label">Label</label><input type="text" class="form-input" id="addCashLabel" placeholder="e.g. EUR Savings, GBP Cash"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Amount</label><input type="number" class="form-input" id="addCashAmount" placeholder="0"></div><div class="form-group"><label class="form-label">Currency Code</label><input type="text" class="form-input" id="addCashCurrency" placeholder="e.g. EUR, GBP, SAR" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div></div>
    </div>
    <div id="fieldsGold" style="display:none">
      <div class="form-group"><label class="form-label">Label</label><input type="text" class="form-input" id="addGoldLabel" placeholder="e.g. 24K Ingots, 22K Jewelry" value="24K Gold"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Weight in Grams</label><input type="number" class="form-input" id="addGoldGrams" placeholder="0" step="0.01"></div><div class="form-group"><label class="form-label">Purity</label><select class="form-input" id="addGoldPurity"><option value="1">24K (99.9%)</option><option value="0.916">22K (91.6%)</option><option value="0.75">18K (75%)</option><option value="0.585">14K (58.5%)</option></select></div></div>
    </div>
    <div id="fieldsDeposit" style="display:none">
      <div class="form-group"><label class="form-label">Label</label><input type="text" class="form-input" id="addDepLabel" placeholder="e.g. CIB Certificate, Treasury Bill"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Amount</label><input type="number" class="form-input" id="addDepAmount" placeholder="0"></div><div class="form-group"><label class="form-label">Currency Code</label><input type="text" class="form-input" id="addDepCurrency" placeholder="e.g. EGP" maxlength="3" value="EGP" oninput="this.value=this.value.toUpperCase()"></div></div>
    </div>
    <div class="modal-actions"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="addAsset()">‚ûï Add Asset</button></div>
  </div>
</div>

<!-- APP ROOT -->
<div class="container app-hidden" id="appRoot">
  <div class="header">
    <div><h1>Investments Tracker</h1><p>Live multi-asset portfolio valuation</p></div>
    <div class="header-btns">
      <button class="btn btn-primary" onclick="openModal()">‚ûï Add Asset</button>
      <button class="btn" id="refreshBtn" onclick="fetchAllPrices()">üîÑ Refresh</button>
      <button class="btn" onclick="openExport()">üìä Export</button>
      <button class="btn" onclick="openCloudModal()">‚òÅÔ∏è Sync</button>
      <button class="btn btn-sm" id="forgetDeviceBtn" onclick="forgetDevice()" title="Forget this device (re-enable TOTP)" style="display:none">üîì Trusted</button>
      <button class="btn btn-sm" onclick="openChangePass()" title="Change password">üîê</button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
    <button class="tab-btn" onclick="switchTab('performance')">üìà Performance</button>
    <button class="tab-btn" onclick="switchTab('history')">üïê History</button>
  </div>

  <!-- DASHBOARD TAB -->
  <div class="tab-panel active" id="tab-dashboard">
    <div class="total-card">
      <div class="total-label">TOTAL NET WORTH</div>
      <div class="total-amount" id="totalUSD">$0.00</div>
      <div class="total-egp" id="totalEGP">EGP 0.00</div>
      <div class="total-unrealized" id="totalUnrealized">Unrealized: ‚Äî</div>
      <div class="mode-toggles">
        <button class="btn btn-sm" id="uModeUsdBtn" onclick="setUnrealizedMode('usd')">$</button>
        <button class="btn btn-sm" id="uModePctBtn" onclick="setUnrealizedMode('pct')">%</button>
        <button class="btn btn-sm" id="uModeBothBtn" onclick="setUnrealizedMode('both')">$ + %</button>
      </div>
      <div class="total-unrealized" id="totalTodayGain">Today: ‚Äî</div>
      <span class="timestamp" id="timestamp"></span>
      <div class="alloc-bar" id="allocBar"></div>
      <div class="legend" id="legend"></div>
    </div>

    <div class="rates-banner" id="ratesBanner"></div>

    <!-- Search & Sort -->
    <div class="search-sort-bar">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-input" id="searchInput" placeholder="Search assets‚Ä¶" oninput="onSearchInput()">
      </div>
      <select class="sort-select" id="sortSelect" onchange="render()">
        <option value="default">Order: Default</option>
        <option value="value-desc">Value: High ‚Üí Low</option>
        <option value="alloc-desc">Allocation: High ‚Üí Low</option>
        <option value="gain-desc">Unrealized: Best ‚Üí Worst</option>
        <option value="today-desc">Today: Best ‚Üí Worst</option>
        <option value="name-asc">Name: A ‚Üí Z</option>
      </select>
    </div>

    <div class="grid" id="cardsGrid"></div>
    <!-- Backup status bar -->
    <div id="backupWarningBanner" style="display:none;margin:12px 0 4px;padding:10px 14px;border-radius:8px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <span id="backupWarningText" style="font-size:13px;color:#f97316;"></span>
      <button class="btn btn-sm" onclick="downloadEncryptedBackup()" style="background:rgba(249,115,22,0.15);border-color:rgba(249,115,22,0.4);color:#f97316;white-space:nowrap;">üì• Backup Now</button>
    </div>
    <p class="footer" style="display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap;">
      <span>Auto-saves to encrypted vault</span>
      <span id="backupStatus" style="font-size:12px;">Checking backup‚Ä¶</span>
      <button class="link-btn" style="display:inline;font-size:12px;" onclick="openExport()">Export data</button>
    </p>
  </div>

  <!-- PERFORMANCE TAB -->
  <div class="tab-panel" id="tab-performance">
    <div class="perf-grid" id="perfMetrics"></div>

    <div class="chart-section">
      <div class="chart-header">
        <span class="chart-title">Total Portfolio Value (USD)</span>
        <div class="chart-range-btns">
          <button class="chart-range-btn active" onclick="setChartRange('1W',this)">1W</button>
          <button class="chart-range-btn" onclick="setChartRange('1M',this)">1M</button>
          <button class="chart-range-btn" onclick="setChartRange('3M',this)">3M</button>
          <button class="chart-range-btn" onclick="setChartRange('ALL',this)">All</button>
        </div>
      </div>
      <canvas id="valueChart" height="220"></canvas>
      <div id="chartEmpty" style="text-align:center;color:var(--text-muted);font-size:13px;padding:40px 0;display:none;">No snapshot history yet. Snapshots are captured daily on your first visit each day.</div>
    </div>

    <div class="chart-section">
      <div class="chart-header">
        <span class="chart-title">Asset Allocation Over Time</span>
      </div>
      <canvas id="allocChart" height="180"></canvas>
    </div>

    <p class="footer" style="margin-top:24px;">Time-weighted return (TWR) calculated from daily snapshots ¬∑ Snapshots stored per session</p>
  </div>

  <!-- HISTORY TAB -->
  <div class="tab-panel" id="tab-history">
    <div class="chart-section">
      <div class="chart-header">
        <span class="chart-title">Daily Snapshots</span>
        <button class="btn btn-sm btn-danger" onclick="clearHistory()">üóë Clear History</button>
      </div>
      <table class="snap-table" id="snapTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Total Value (USD)</th>
            <th>Change ($)</th>
            <th>Change (%)</th>
            <th>Assets</th>
          </tr>
        </thead>
        <tbody id="snapBody"></tbody>
      </table>
      <div id="snapEmpty" style="text-align:center;color:var(--text-muted);font-size:13px;padding:40px 0;">No history snapshots yet.</div>
    </div>
  </div>
</div>

<script>
const TROY_OZ_GRAM=31.1035;
const COLORS=['#22c55e','#eab308','#3b82f6','#a855f7','#f97316','#06b6d4','#ec4899','#14b8a6','#f43f5e','#84cc16','#8b5cf6','#0ea5e9','#d946ef','#facc15','#10b981'];
const DEFAULT_ASSETS=[
  {id:'usd-cash',type:'cash',label:'USD Cash',icon:'üíµ',currency:'USD',holding:0,color:'#22c55e'},
  {id:'gold-24k',type:'gold',label:'24K Gold',icon:'ü•á',purity:1,holding:0,color:'#eab308'},
  {id:'igda-l',type:'etf',label:'IGDA.L',icon:'üìà',ticker:'IGDA.L',holding:0,color:'#3b82f6'},
  {id:'igln-l',type:'etf',label:'IGLN.L',icon:'üìà',ticker:'IGLN.L',holding:0,color:'#a855f7'},
  {id:'cd-egp',type:'deposit',label:'Certificate of Deposit',icon:'üè¶',currency:'EGP',holding:0,color:'#f97316'},
];

let assets=[];
let fxRates={};
let fxMeta={updatedAt:null,source:null,attempted:false};
let goldMeta={updatedAt:null,source:null};
let etfMeta={};
let goldPerOz=0;
let goldPrevOz=0;
let etfPrices={};
let unrealizedMode='both';
let autoRefreshTimer=null;
let snapshots=[]; // [{date:'YYYY-MM-DD', totalUSD:number, assets:{id:value,...}}]
let transactions={}; // {assetId:[{type,date,qty,price,amount,notes},...]}
let currentTxAssetId=null;
let debounceTimers={};
let activeChartRange='1W';
let searchQuery='';
let chartInstances={};
let restoreBlob=null;

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
function showToast(msg,type='info'){
  const c=document.getElementById('toastContainer');
  const t=document.createElement('div');
  t.className='toast '+type; t.textContent=msg;
  c.appendChild(t); setTimeout(()=>t.remove(),3100);
}

/* ‚ïê‚ïê ENCRYPTED VAULT ‚ïê‚ïê */
const PBKDF2_ITERS=150000;
let vaultKey=null;
let vaultData=null;
let activeVaultId=null; // the identity slot this window is using

// Stable per-device identifier for cloud sync metadata
function getDeviceId(){
  let id = localStorage.getItem('nwt-device-id');
  if(!id){
    id = (crypto.randomUUID ? crypto.randomUUID() : ('dev-'+Math.random().toString(16).slice(2)));
    localStorage.setItem('nwt-device-id', id);
  }
  return id;
}
const DEVICE_ID = getDeviceId();

// Generate a new random vault identity string
function newVaultId(){
  const b=new Uint8Array(6);crypto.getRandomValues(b);
  return 'id-'+Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join('');
}

// Pointer key: stores which vaultId is the "active" one for this browser.
// Survives window close/reopen. Updated whenever user logs in or restores.
const ACTIVE_ID_PTR='nwt-active-id-ptr';

function resolveVaultId(){
  // 1. Session already resolved (same tab, page refresh)
  let sid=sessionStorage.getItem('nwt-active-id');
  if(sid){activeVaultId=sid;return sid;}

  // 2. Persistent pointer in localStorage (survives window close)
  const ptr=localStorage.getItem(ACTIVE_ID_PTR);
  if(ptr&&localStorage.getItem('nwt-passrec-'+ptr)){
    activeVaultId=ptr;
    sessionStorage.setItem('nwt-active-id',ptr);
    return ptr;
  }

  // 3. Legacy: old v1 passrec (will be migrated on first login)
  if(localStorage.getItem('nwt-passrec-v1')){
    activeVaultId='legacy';
    sessionStorage.setItem('nwt-active-id','legacy');
    return 'legacy';
  }

  // 4. Brand new ‚Äî no identity yet
  return null;
}

function setActiveVaultId(id){
  activeVaultId=id;
  sessionStorage.setItem('nwt-active-id',id);
  localStorage.setItem(ACTIVE_ID_PTR,id); // persist across window close
}

function getPassRecKey(id){return 'nwt-passrec-'+(id||activeVaultId||'legacy');}
function getVaultKey(id){return 'nwt-vault-'+(id||activeVaultId||'legacy');}

function b64encode(u8){let s='';for(let i=0;i<u8.length;i++)s+=String.fromCharCode(u8[i]);return btoa(s);}
function b64decode(b){const s=atob(b);const u=new Uint8Array(s.length);for(let i=0;i<s.length;i++)u[i]=s.charCodeAt(i);return u;}

async function derive64(pw,salt,iter=PBKDF2_ITERS){
  const km=await crypto.subtle.importKey('raw',new TextEncoder().encode(pw),'PBKDF2',false,['deriveBits']);
  return new Uint8Array(await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations:iter,hash:'SHA-256'},km,512));
}
function splitKV(d){return{aesKeyBytes:d.slice(0,32),verifier:d.slice(32,64)};}
async function importAes(b){return crypto.subtle.importKey('raw',b,{name:'AES-GCM'},false,['encrypt','decrypt']);}

async function encVault(key,obj){
  const iv=new Uint8Array(12);crypto.getRandomValues(iv);
  const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},key,new TextEncoder().encode(JSON.stringify(obj))));
  return{v:2,iv:b64encode(iv),ct:b64encode(ct)};
}
async function decVault(key,blob){
  if(!blob||!blob.iv||!blob.ct)throw new Error('Invalid vault blob (missing iv/ct)');
  // Accept any version ‚Äî future-proof
  return JSON.parse(new TextDecoder().decode(new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM',iv:b64decode(blob.iv)},key,b64decode(blob.ct)))));
}

function getPassRec(id){
  try{
    // Try dynamic key first
    const key=getPassRecKey(id);
    const v=localStorage.getItem(key);
    if(v)return JSON.parse(v);
    // Legacy fallback (one-time migration)
    if(!id){const leg=localStorage.getItem('nwt-passrec-v1');if(leg)return JSON.parse(leg);}
    return null;
  }catch{return null;}
}
function setPassRec(r,id){
  localStorage.setItem(getPassRecKey(id),JSON.stringify(r));
}
function getVaultBlob(id){
  try{
    // Try dynamic key
    const v=localStorage.getItem(getVaultKey(id));
    if(v)return JSON.parse(v);
    // Legacy fallbacks (one-time migration)
    if(!id){
      const leg2=localStorage.getItem('nwt-vault-v2');if(leg2)return JSON.parse(leg2);
      const leg1=localStorage.getItem('nwt-vault-v1');if(leg1)return JSON.parse(leg1);
    }
    return null;
  }catch{return null;}
}
function setVaultBlob(b,id){
  localStorage.setItem(getVaultKey(id),JSON.stringify(b));
}

function defaultVault(){return{totpSecret:'',assets:JSON.parse(JSON.stringify(DEFAULT_ASSETS)),fxRates:{},goldPerOz:0,goldPrevOz:0,etfPrices:{},unrealizedMode:'both',snapshots:[],transactions:{}};}

async function setPasswordAndCreateVault(pw,obj,id){
  // Generate a new identity if not provided
  if(!id){id=newVaultId();setActiveVaultId(id);}
  const salt=new Uint8Array(16);crypto.getRandomValues(salt);
  const d=await derive64(pw,salt);const { aesKeyBytes, verifier: verifierBytes } = splitKV(d);
  setPassRec({salt:b64encode(salt),iterations:PBKDF2_ITERS,verifier:b64encode(verifierBytes),vaultId:id},id);
  const k=await importAes(aesKeyBytes);setVaultBlob(await encVault(k,obj),id);
}

async function openVaultWithPassword(pw){
  // Resolve which identity slot to open
  const id=resolveVaultId();
  const rec=getPassRec(id);
  if(!rec?.salt||!rec?.verifier)throw new Error('No password set');
  const d=await derive64(pw,b64decode(rec.salt),rec.iterations||PBKDF2_ITERS);
  const { aesKeyBytes, verifier: verifierBytes } = splitKV(d);
  if(b64encode(verifierBytes)!==rec.verifier)throw new Error('Wrong password');
  const k=await importAes(aesKeyBytes);
  const blob=getVaultBlob(id);
  if(!blob)throw new Error('Vault data not found in this browser. Use Restore Backup to import your data.');
  let vObj;
  try{vObj=await decVault(k,blob);}
  catch(decErr){throw new Error('Decryption failed ‚Äî vault may be corrupted ('+decErr.message+')');}
  // Migrate legacy keys to identity-based key (one time, silent)
  if(!id||id==='legacy'){
    const newId=newVaultId();
    setActiveVaultId(newId);
    const freshBlob=await encVault(k,vObj);
    setPassRec({...rec,vaultId:newId},newId);
    setVaultBlob(freshBlob,newId);
    console.log('[Tracker] Migrated legacy vault to identity:',newId);
  }
  return { aesKey:k, aesKeyBytes, verifierBytes, vaultObj:vObj };
}

async function persistVault(){
  if(!vaultKey||!vaultData||!activeVaultId)return;
  const blob = await encVault(vaultKey,vaultData);
  setVaultBlob(blob,activeVaultId);
  // Track local changes for conflict detection
  lastLocalChangeMs = Date.now();
  localStorage.setItem('nwt-cloud-lastchange-ms', String(lastLocalChangeMs));
  // Optional cloud sync (encrypted blob only)
  scheduleCloudPush(blob);
}

function hydrateFromVault(){
  assets=vaultData.assets||JSON.parse(JSON.stringify(DEFAULT_ASSETS));
  fxRates=vaultData.fxRates||{};goldPerOz=vaultData.goldPerOz||0;goldPrevOz=vaultData.goldPrevOz||0;
  etfPrices=vaultData.etfPrices||{};unrealizedMode=vaultData.unrealizedMode||'both';
  snapshots=vaultData.snapshots||[];
  transactions=vaultData.transactions||{};
  // Restore etfMeta/goldMeta from vault if present
  if(vaultData.goldMeta)goldMeta=vaultData.goldMeta;
  if(vaultData.etfMeta)etfMeta=vaultData.etfMeta;
}
function dehydrateToVault(){
  vaultData.assets=assets;vaultData.fxRates=fxRates;vaultData.goldPerOz=goldPerOz;
  vaultData.goldPrevOz=goldPrevOz;vaultData.etfPrices=etfPrices;vaultData.unrealizedMode=unrealizedMode;
  vaultData.snapshots=snapshots;vaultData.transactions=transactions;
}
function saveData(){
  if(!vaultData) return;
  dehydrateToVault();
  vaultData._rev = (vaultData._rev || 0) + 1; // local revision (for cloud sync)
  persistVault();
}

/* ‚ïê‚ïê SNAPSHOTS ‚ïê‚ïê */
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`; // local timezone
}
function captureSnapshot(){
  const key=todayKey();
  const total=getTotalUSD();
  const perAsset={};assets.forEach(a=>{perAsset[a.id]=assetValueUSD(a);});
  // Only store one per day (overwrite same-day)
  const existing=snapshots.findIndex(s=>s.date===key);
  const snap={date:key,totalUSD:total,assets:perAsset};
  if(existing>=0)snapshots[existing]=snap;
  else snapshots.push(snap);
  snapshots.sort((a,b)=>a.date<b.date?-1:1);
  if(snapshots.length>365)snapshots=snapshots.slice(-365);
  saveData();
}

function getTotalUSD(){
  let t=0;assets.forEach(a=>t+=assetValueUSD(a));return t;
}

function getSnapshotsForRange(range){
  if(!snapshots.length)return[];
  const now=new Date();
  let cutoff=new Date(now);
  if(range==='1W')cutoff.setDate(cutoff.getDate()-7);
  else if(range==='1M')cutoff.setMonth(cutoff.getMonth()-1);
  else if(range==='3M')cutoff.setMonth(cutoff.getMonth()-3);
  else cutoff=new Date('2000-01-01');
  const y = cutoff.getFullYear();
  const m = String(cutoff.getMonth()+1).padStart(2,'0');
  const day = String(cutoff.getDate()).padStart(2,'0');
  const cutStr = `${y}-${m}-${day}`;
  return snapshots.filter(s=>s.date>=cutStr);
}

/* TWR: product of daily returns */
function calcTWR(snaps){
  if(snaps.length<2)return null;
  let twr=1;
  for(let i=1;i<snaps.length;i++){
    const prev=snaps[i-1].totalUSD,cur=snaps[i].totalUSD;
    if(prev>0)twr*=(cur/prev);
  }
  return(twr-1)*100;
}

/* ‚ïê‚ïê TRANSACTIONS ‚ïê‚ïê */
function openTxModal(assetId){
  currentTxAssetId=assetId;
  const a=assets.find(x=>x.id===assetId);
  document.getElementById('txModalSubtitle').textContent=(a?a.label:'Asset')+' ‚Äî log a transaction';
  document.getElementById('txDate').value=todayKey();
  document.getElementById('txQty').value='';document.getElementById('txPrice').value='';
  document.getElementById('txAmount').value='';document.getElementById('txNotes').value='';
  document.getElementById('txType').value='buy';onTxTypeChange();
  document.getElementById('txModal').classList.remove('hidden');
}
function closeTxModal(){document.getElementById('txModal').classList.add('hidden');currentTxAssetId=null;}
function onTxTypeChange(){
  const t=document.getElementById('txType').value;
  const isDividend=t==='dividend';
  document.getElementById('txQtyGroup').style.display=isDividend?'none':'';
  document.getElementById('txPriceGroup').style.display=isDividend?'none':'';
  document.getElementById('txAmountGroup').style.display=isDividend?'':'none';
}
document.getElementById('txType').addEventListener('change',onTxTypeChange);

function submitTx(){
  if(!currentTxAssetId)return;
  const type=document.getElementById('txType').value;
  const date=document.getElementById('txDate').value||todayKey();
  const qty=parseFloat(document.getElementById('txQty').value)||0;
  const price=parseFloat(document.getElementById('txPrice').value)||0;
  const amount=parseFloat(document.getElementById('txAmount').value)||0;
  const notes=document.getElementById('txNotes').value.trim();
  if(type!=='dividend'&&(qty<=0||price<=0)){alert('Enter valid quantity and price.');return;}
  if(type==='dividend'&&amount<=0){alert('Enter dividend amount.');return;}
  if(!transactions[currentTxAssetId])transactions[currentTxAssetId]=[];
  const tx={id:'tx-'+Date.now(),type,date,qty,price,amount,notes};
  transactions[currentTxAssetId].push(tx);
  transactions[currentTxAssetId].sort((a,b)=>a.date<b.date?-1:1);
  // Auto-calculate holding & avg cost from transactions
  recalcFromTransactions(currentTxAssetId);
  saveData();closeTxModal();render();showToast('Transaction added','success');
}

function recalcFromTransactions(assetId){
  const txs=transactions[assetId];if(!txs||!txs.length)return;
  const a=assets.find(x=>x.id===assetId);if(!a)return;
  if(a.type==='cash'||a.type==='deposit')return; // Not applicable
  let holding=0,totalCost=0;
  for(const tx of txs){
    if(tx.type==='buy'){holding+=tx.qty;totalCost+=tx.qty*tx.price;}
    else if(tx.type==='sell'){const frac=holding>0?tx.qty/holding:0;totalCost*=(1-frac);holding=Math.max(0,holding-tx.qty);}
  }
  a.holding=Math.round(holding*10000)/10000;
  a.avgCost=holding>0?Math.round((totalCost/holding)*10000)/10000:0;
}

function removeTx(assetId,txId){
  if(!transactions[assetId])return;
  transactions[assetId]=transactions[assetId].filter(t=>t.id!==txId);
  recalcFromTransactions(assetId);
  saveData();render();showToast('Transaction removed','info');
}

/* ‚ïê‚ïê REMEMBER THIS DEVICE ‚ïê‚ïê
   Stores an HMAC-signed token in localStorage so the device skips TOTP
   for 30 days. The signing key is derived from the vault AES key,
   so clearing the vault or changing password auto-invalidates all tokens.
   The TOTP code is still needed the first time on each device.          */
const DEVICE_TOKEN_KEY = 'nwt-device-v1';
const LAST_BACKUP_KEY  = 'nwt-last-backup';
const DEVICE_TTL_DAYS  = 30;

// Device token: HMAC-signed with the password verifier bytes.
// Verifier = PBKDF2(password, salt)[32:64] ‚Äî stable for the lifetime of a password.
// We pass verifierBytes explicitly so there's no dependency on activeVaultId timing.
async function deriveDeviceSignKey(verifierBytes){
  return crypto.subtle.importKey('raw', verifierBytes, {name:'HMAC', hash:'SHA-256'}, false, ['sign','verify']);
}

async function createDeviceToken(verifierBytes){
  // verifierBytes passed in from login flow where we just derived them
  const key     = await deriveDeviceSignKey(verifierBytes);
  const expires = Date.now() + DEVICE_TTL_DAYS * 86400_000;
  const payload = JSON.stringify({expires, rand: b64encode(crypto.getRandomValues(new Uint8Array(16)))});
  const sig     = b64encode(new Uint8Array(await crypto.subtle.sign('HMAC', key, new TextEncoder().encode(payload))));
  localStorage.setItem(DEVICE_TOKEN_KEY, JSON.stringify({payload, sig}));
  console.log('[Tracker] Device token created, expires:', new Date(expires).toLocaleDateString());
}

async function verifyDeviceToken(verifierBytes){
  try{
    const stored = JSON.parse(localStorage.getItem(DEVICE_TOKEN_KEY) || 'null');
    if(!stored?.payload || !stored?.sig){console.log('[Tracker] No device token found.');return false;}
    const key   = await deriveDeviceSignKey(verifierBytes);
    const valid = await crypto.subtle.verify('HMAC', key,
                    b64decode(stored.sig), new TextEncoder().encode(stored.payload));
    if(!valid){console.log('[Tracker] Device token: signature mismatch.');return false;}
    const {expires} = JSON.parse(stored.payload);
    const ok = Date.now() < expires;
    console.log('[Tracker] Device token valid:', ok, '‚Äî expires:', new Date(expires).toLocaleDateString());
    return ok;
  }catch(e){console.warn('[Tracker] verifyDeviceToken error:',e);return false;}
}

function clearDeviceToken(){ localStorage.removeItem(DEVICE_TOKEN_KEY); }

function deviceTokenDaysLeft(){
  try{
    const stored = JSON.parse(localStorage.getItem(DEVICE_TOKEN_KEY) || 'null');
    if(!stored?.payload) return 0;
    const {expires} = JSON.parse(stored.payload);
    return Math.max(0, Math.ceil((expires - Date.now()) / 86400_000));
  }catch{ return 0; }
}


/* ‚ïê‚ïê TOTP ‚ïê‚ïê */
const UNLOCK_KEY='nwt-unlocked';
function getTotpSecret(){return vaultData?.totpSecret||'';}
function lockHelp(){alert('This tracker uses Password + Authenticator (TOTP).\n\n‚Ä¢ First time: create password, then set up Google Authenticator.\n‚Ä¢ After that: unlock requires password + 6-digit code.\n‚Ä¢ Password can only be changed while logged in.\n\nTip: Make sure your phone time is set to automatic.');}

const B32='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
function b32enc(bytes){let bits=0,val=0,out='';for(const b of bytes){val=(val<<8)|b;bits+=8;while(bits>=5){out+=B32[(val>>>(bits-5))&31];bits-=5;}}if(bits>0)out+=B32[(val<<(5-bits))&31];return out;}
function b32dec(str){const c=(str||'').toUpperCase().replace(/[^A-Z2-7]/g,'');let bits=0,val=0;const out=[];for(const ch of c){const i=B32.indexOf(ch);if(i<0)continue;val=(val<<5)|i;bits+=5;if(bits>=8){out.push((val>>>(bits-8))&255);bits-=8;}}return new Uint8Array(out);}

async function totpCode(sec,t=Date.now(),step=30,dig=6){
  const kb=b32dec(sec);const ctr=Math.floor((t/1000)/step);
  const msg=new Uint8Array(8);let c=ctr;for(let i=7;i>=0;i--){msg[i]=c&0xff;c=Math.floor(c/256);}
  const ck=await crypto.subtle.importKey('raw',kb,{name:'HMAC',hash:'SHA-1'},false,['sign']);
  const sig=new Uint8Array(await crypto.subtle.sign('HMAC',ck,msg));
  const off=sig[sig.length-1]&0x0f;
  const bin=((sig[off]&0x7f)<<24)|((sig[off+1]&0xff)<<16)|((sig[off+2]&0xff)<<8)|(sig[off+3]&0xff);
  return(bin%(10**dig)).toString().padStart(dig,'0');
}

async function verifyTotp(code){
  const sec=getTotpSecret();if(!sec)return false;
  const c=String(code||'').replace(/\s+/g,'').trim();if(!/^\d{6}$/.test(c))return false;
  const now=Date.now();
  const cands=await Promise.all([totpCode(sec,now-30000),totpCode(sec,now),totpCode(sec,now+30000)]);
  return cands.includes(c);
}
function genTotpSecret(){const b=new Uint8Array(20);crypto.getRandomValues(b);return b32enc(b);}
function isUnlocked(){return sessionStorage.getItem(UNLOCK_KEY)==='1';}
function lockUI(){document.getElementById('appRoot')?.classList.add('app-hidden');document.getElementById('lockOverlay')?.classList.remove('app-hidden');}
function unlockUI(){document.getElementById('lockOverlay')?.classList.add('app-hidden');document.getElementById('appRoot')?.classList.remove('app-hidden');}

function setLockMode(mode){
  const els=[document.getElementById('lockLogin'),document.getElementById('lockCreatePass'),document.getElementById('lockSetup2fa')];
  els.forEach(el=>el&&el.classList.add('app-hidden'));
  if(mode==='createPass')els[1]?.classList.remove('app-hidden');
  if(mode==='setup2fa')els[2]?.classList.remove('app-hidden');
  if(mode==='login')els[0]?.classList.remove('app-hidden');
  if(!els.some(el=>el&&!el.classList.contains('app-hidden')))els[0]?.classList.remove('app-hidden');
}
function focusFirst(mode){setTimeout(()=>{if(mode==='createPass')document.getElementById('newPass1')?.focus();else if(mode==='setup2fa')document.getElementById('setupTotpCode')?.focus();else document.getElementById('lockPass')?.focus();},0);}

let lockEnterHandler=null;
window.addEventListener('error',ev=>{const b=document.getElementById('lockError');if(b&&!document.getElementById('lockOverlay')?.classList.contains('app-hidden'))b.textContent='Error: '+(ev.message||'Script error');});
window.addEventListener('unhandledrejection',ev=>{const b=document.getElementById('lockError');if(b&&!document.getElementById('lockOverlay')?.classList.contains('app-hidden'))b.textContent='Error: '+(ev.reason?.message||'Unhandled rejection');});

async function diagStorage(){
  // Scan all tracker keys in localStorage
  const found={};
  let hasPass=false,hasVault=false,vaultLen=0;
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k&&k.startsWith('nwt-')){
      const v=localStorage.getItem(k)||'';
      found[k]='present('+v.length+'chars)';
      if(k.startsWith('nwt-passrec-'))hasPass=true;
      if(k.startsWith('nwt-vault-')){hasVault=true;vaultLen=Math.max(vaultLen,v.length);}
    }
  }
  // Legacy keys
  const hasV1=!!localStorage.getItem('nwt-vault-v1');
  const hasV2=!!localStorage.getItem('nwt-vault-v2');
  found['active-id-session']=sessionStorage.getItem('nwt-active-id')||'none';
  found['active-id-ptr']=localStorage.getItem(ACTIVE_ID_PTR)||'none';
  console.log('[Tracker Storage Diagnostic]',found);
  const banner=document.getElementById('storageDiagBanner');
  if(banner){
    // Use the already-computed hasPass/hasVault/vaultLen from the identity-aware scan above
    // hasPass  = true if any nwt-passrec-* exists (includes new id-based keys)
    // hasVault = true if any nwt-vault-* exists (includes new id-based keys)
    // vaultLen = length of the largest vault blob found
    const activePtr=localStorage.getItem(ACTIVE_ID_PTR)||'';
    const activeVaultPresent=activePtr&&!!localStorage.getItem('nwt-vault-'+activePtr);
    const activePassPresent =activePtr&&!!localStorage.getItem('nwt-passrec-'+activePtr);

    if(!hasPass&&!hasVault){
      // Truly new browser ‚Äî no data at all
      banner.innerHTML='New browser ‚Äî no data found. Create a password or <button onclick="openRestoreModal()" style="background:none;border:none;color:#f97316;cursor:pointer;text-decoration:underline;font-size:inherit;padding:0;">restore a backup</button>.';
      banner.style.display='block';banner.style.color='var(--text-muted)';
    }else if(activePtr&&activePassPresent&&activeVaultPresent&&vaultLen>=800){
      // Active identity exists and vault looks healthy ‚Äî all good, hide banner
      banner.style.display='none';
    }else if(activePtr&&activePassPresent&&!activeVaultPresent){
      // Pointer exists but vault blob missing for that identity
      banner.innerHTML='‚ö†Ô∏è Vault data missing for active identity. <button onclick="openRestoreModal()" style="background:none;border:none;color:#f97316;cursor:pointer;text-decoration:underline;font-size:inherit;padding:0;">Restore a backup</button>.';
      banner.style.display='block';banner.style.color='var(--negative)';
    }else if(hasVault&&vaultLen<800){
      // All vaults are suspiciously small (empty default)
      banner.innerHTML='‚ö†Ô∏è Vault appears empty. If you had data, <button onclick="openRestoreModal()" style="background:none;border:none;color:#f97316;cursor:pointer;text-decoration:underline;font-size:inherit;padding:0;">restore from a backup file</button>.';
      banner.style.display='block';banner.style.color='#f97316';
    }else{
      // Data present but older format ‚Äî login will migrate automatically
      banner.style.display='none';
    }
  }
}

async function initLock(){
  const old=document.getElementById('unlockBtn');const btn=old.cloneNode(true);old.parentNode.replaceChild(btn,old);
  const err=document.getElementById('lockError');err.textContent='';
  resolveVaultId(); // establish which identity slot this window uses
  const hasPass=!!getPassRec();
  diagStorage(); // show storage state for debugging

  if(isUnlocked()&&!vaultKey)sessionStorage.removeItem(UNLOCK_KEY);
  if(isUnlocked()&&vaultKey){unlockUI();startApp();return;}

  lockUI();
  let mode=hasPass?'login':'createPass';
  const title=document.getElementById('lockTitle'),sub=document.getElementById('lockSub');
  if(mode==='createPass'){title.textContent='üîê Create Password';sub.textContent='Create a password, then set up Google Authenticator.';btn.textContent='Continue';}
  else{title.textContent='üîí Locked';sub.textContent='Enter password + authenticator code to unlock.';btn.textContent='Unlock';}
  setLockMode(mode);focusFirst(mode);

  async function createPass(){
    err.textContent='';const p1=document.getElementById('newPass1').value||'',p2=document.getElementById('newPass2').value||'';
    if(p1.length<4){err.textContent='Password must be at least 4 characters.';return;}
    if(p1!==p2){err.textContent='Passwords do not match.';return;}
    const v=defaultVault();v.totpSecret=genTotpSecret();await setPasswordAndCreateVault(p1,v);
    try{const o=await openVaultWithPassword(p1);vaultKey=o.aesKey;vaultData=o.vaultObj;}catch(e){err.textContent='Could not open vault: '+(e?.message||'');return;}
    setLockMode('setup2fa');title.textContent='üõ°Ô∏è Set Up Authenticator';sub.textContent='Add the secret to Google Authenticator and confirm the code.';
    document.getElementById('unlockBtn').textContent='Enable 2FA';document.getElementById('totpSecretBox').textContent=vaultData.totpSecret||'‚Äî';focusFirst('setup2fa');
  }
  async function setup2fa(){
    err.textContent='';if(!(await verifyTotp((document.getElementById('setupTotpCode').value||'').trim()))){err.textContent='Invalid code. Check the secret and try again.';return;}
    sessionStorage.setItem(UNLOCK_KEY,'1');
    unlockUI();startApp();
  }
  async function login(){
    err.textContent='';
    const pw  = (document.getElementById('lockPass').value||'').trim();
    const code= (document.getElementById('lockTotp').value||'').trim();
    // Step 1: verify password
    let o;
    try{o=await openVaultWithPassword(pw);vaultKey=o.aesKey;vaultData=o.vaultObj;}
    catch(e){err.textContent='Wrong password: '+(e?.message||'');return;}
    // Step 2: check if this device is trusted (skip TOTP)
    const trusted = await verifyDeviceToken(o.verifierBytes);
    if(!vaultData.totpSecret){
      vaultData.totpSecret=genTotpSecret();await persistVault();
      setLockMode('setup2fa');title.textContent='üõ°Ô∏è Set Up Authenticator';
      sub.textContent='Add the secret to Google Authenticator and confirm the code.';
      document.getElementById('unlockBtn').textContent='Enable 2FA';
      document.getElementById('totpSecretBox').textContent=vaultData.totpSecret;
      focusFirst('setup2fa');return;
    }
    if(!trusted){
      // Need TOTP on unrecognised device
      if(!(await verifyTotp(code))){
        if(!code)err.textContent='Enter your authenticator code.';
        else err.textContent='Invalid authenticator code.';
        return;
      }
    }
    sessionStorage.setItem(UNLOCK_KEY,'1');
    sessionStorage.setItem('nwt-rawkey',b64encode(o.aesKeyBytes));
    unlockUI();startApp();
  }
  async function dispatch(){
    const isC=!document.getElementById('lockCreatePass').classList.contains('app-hidden');
    const isS=!document.getElementById('lockSetup2fa').classList.contains('app-hidden');
    if(isC)return createPass();if(isS)return setup2fa();return login();
  }
  function safe(){Promise.resolve(dispatch()).catch(e=>{err.textContent='Error: '+(e?.message||'Unexpected');console.error(e);});}
  btn.addEventListener('click',safe);
  if(lockEnterHandler)document.removeEventListener('keydown',lockEnterHandler);
  lockEnterHandler=e=>{if(!document.getElementById('lockOverlay')?.classList.contains('app-hidden')&&e.key==='Enter')safe();};
  document.addEventListener('keydown',lockEnterHandler);
}




/* ‚îÄ‚îÄ Change Password ‚îÄ‚îÄ */
function openChangePass(){document.getElementById('passModal').classList.remove('hidden');['curPass','curTotp','newPass'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});document.getElementById('passMsg').textContent='';setTimeout(()=>document.getElementById('curPass')?.focus(),0);}
function closeChangePass(){document.getElementById('passModal').classList.add('hidden');}

async function submitChangePass(){
  const cur=(document.getElementById('curPass').value||'').trim(),code=(document.getElementById('curTotp').value||'').trim(),nw=(document.getElementById('newPass').value||'').trim();
  const msg=document.getElementById('passMsg');msg.style.color='var(--negative)';msg.textContent='';
  if(!isUnlocked()||!vaultData||!vaultKey){msg.textContent='You must be logged in.';return;}
  if(!(await verifyTotp(code))){msg.textContent='Invalid authenticator code.';return;}
  if(nw.length<4){msg.textContent='New password must be at least 4 characters.';return;}
  try{await openVaultWithPassword(cur);}catch{msg.textContent='Current password is incorrect.';return;}
  const salt=new Uint8Array(16);crypto.getRandomValues(salt);
  const d=await derive64(nw,salt);const { aesKeyBytes, verifier: verifierBytes } = splitKV(d);
  setPassRec({salt:b64encode(salt),iterations:PBKDF2_ITERS,verifier:b64encode(verifierBytes)});
  const nk=await importAes(aesKeyBytes);setVaultBlob(await encVault(nk,vaultData));vaultKey=nk;
  msg.style.color='var(--positive)';msg.textContent='Password updated.';showToast('Password changed','success');setTimeout(closeChangePass,800);
}

/* ‚îÄ‚îÄ Restore Backup ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ Restore helpers ‚îÄ‚îÄ */
function restoreShowMsg(text,type='error'){
  const el=document.getElementById('restoreMsg');
  if(!el)return;
  el.style.display='block';
  el.style.color=type==='error'?'var(--negative)':type==='ok'?'var(--positive)':'var(--text-secondary)';
  el.style.background=type==='error'?'rgba(248,113,113,0.08)':type==='ok'?'rgba(74,222,128,0.08)':'rgba(255,255,255,0.04)';
  el.textContent=text;
}
function restoreHideMsg(){const el=document.getElementById('restoreMsg');if(el)el.style.display='none';}
function restoreSetProgress(pct,label){
  const bar=document.getElementById('restoreProgressBar');
  const lbl=document.getElementById('restoreProgressLabel');
  const wrap=document.getElementById('restoreProgress');
  if(wrap)wrap.style.display=pct>=0?'block':'none';
  if(bar)bar.style.width=pct+'%';
  if(lbl&&label)lbl.textContent=label;
}
function restoreSetBusy(busy){
  const sb=document.getElementById('restoreSubmitBtn');
  const cb=document.getElementById('restoreCancelBtn');
  if(sb){sb.disabled=busy;sb.textContent=busy?'‚è≥ Working‚Ä¶':'üîì Restore';}
  if(cb)cb.disabled=busy;
}

function parseRestoreFile(text,filename){
  let parsed;
  try{parsed=JSON.parse(text);}
  catch{restoreShowMsg('Cannot parse file ‚Äî make sure you selected a .vault backup file.','error');return false;}
  // Validate structure
  if(!parsed.passRec||!parsed.vaultBlob){
    restoreShowMsg('File is not a valid vault backup (missing passRec or vaultBlob). Did you select the right file?','error');
    return false;
  }
  restoreBlob=parsed;
  const date=parsed.exportedAt?new Date(parsed.exportedAt).toLocaleDateString():'unknown date';
  document.getElementById('restoreDropIcon').textContent='‚úÖ';
  document.getElementById('restoreDropText').textContent='Loaded: '+filename+' (backup from '+date+')';
  document.getElementById('restoreDropText').style.color='var(--positive)';
  restoreShowMsg('File looks good! Enter your password and TOTP code, then click Restore.','ok');
  return true;
}

function openRestoreModal(){
  const modal=document.getElementById('restoreModal');
  modal.classList.remove('hidden');
  // Lift above lock overlay (z-index 9999) when opened from lock screen
  const locked=!document.getElementById('lockOverlay')?.classList.contains('app-hidden');
  modal.classList.toggle('above-lock',locked);
  restoreBlob=null;
  // Reset UI
  document.getElementById('restorePass').value='';
  document.getElementById('restoreTotp').value='';
  document.getElementById('restoreDropIcon').textContent='üìÅ';
  document.getElementById('restoreDropText').textContent='Click to choose file, or drag & drop';
  document.getElementById('restoreDropText').style.color='';
  document.getElementById('restoreFile').value='';
  restoreHideMsg();
  restoreSetProgress(-1,'');
  restoreSetBusy(false);
  // Attach drag-drop lazily (safe ‚Äî element exists now)
  const drop=document.getElementById('restoreDrop');
  if(drop&&!drop._listenersAdded){
    drop._listenersAdded=true;
    drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag-over');});
    drop.addEventListener('dragleave',()=>drop.classList.remove('drag-over'));
    drop.addEventListener('drop',e=>{
      e.preventDefault();drop.classList.remove('drag-over');
      const file=e.dataTransfer.files[0];
      if(!file)return;
      const fr=new FileReader();
      fr.onload=ev=>parseRestoreFile(ev.target.result,file.name);
      fr.readAsText(file);
    });
  }
  setTimeout(()=>document.getElementById('restorePass')?.focus(),100);
}
function closeRestoreModal(){
  const modal=document.getElementById('restoreModal');
  modal.classList.add('hidden');
  modal.classList.remove('above-lock');
  restoreSetBusy(false);
  restoreSetProgress(-1,'');
}

function handleRestoreFile(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>parseRestoreFile(e.target.result,file.name);
  reader.readAsText(file);
}

async function submitRestore(){
  if(!restoreBlob){restoreShowMsg('Please select a backup file first (Step 1).','error');return;}
  const pw=(document.getElementById('restorePass').value||'').trim();
  const code=(document.getElementById('restoreTotp').value||'').trim();
  if(!pw){restoreShowMsg('Enter your password (Step 2).','error');return;}
  if(!code){restoreShowMsg('Enter your authenticator code (Step 2).','error');return;}
  const passRec=restoreBlob.passRec;
  const vaultBlob=restoreBlob.vaultBlob;
  restoreSetBusy(true);
  restoreHideMsg();
  restoreSetProgress(10,'Verifying password‚Ä¶ (this takes a few seconds)');
  // Small delay so UI can paint before heavy PBKDF2
  await new Promise(r=>setTimeout(r,60));
  try{
    const d=await derive64(pw,b64decode(passRec.salt),passRec.iterations||PBKDF2_ITERS);
    const { aesKeyBytes, verifier: verifierBytes } = splitKV(d);
    restoreSetProgress(50,'Checking password‚Ä¶');
    if(b64encode(verifierBytes)!==passRec.verifier){
      restoreSetProgress(-1,'');
      restoreSetBusy(false);
      restoreShowMsg('Wrong password ‚Äî make sure you use the password from when this backup was created.','error');
      return;
    }
    restoreSetProgress(65,'Decrypting vault‚Ä¶');
    await new Promise(r=>setTimeout(r,30));
    const k=await importAes(aesKeyBytes);
    let vObj;
    try{vObj=await decVault(k,vaultBlob);}
    catch(decErr){
      restoreSetProgress(-1,'');
      restoreSetBusy(false);
      restoreShowMsg('Decryption failed ‚Äî the backup file may be corrupted or the password is wrong. ('+decErr.message+')','error');
      return;
    }
    restoreSetProgress(80,'Verifying authenticator code‚Ä¶');
    await new Promise(r=>setTimeout(r,30));
    const savedSecret=vObj.totpSecret;
    if(savedSecret){
      const now=Date.now();
      const cands=await Promise.all([
        totpCode(savedSecret,now-60000),totpCode(savedSecret,now-30000),
        totpCode(savedSecret,now),
        totpCode(savedSecret,now+30000),totpCode(savedSecret,now+60000),
      ]);
      if(!cands.includes(code)){
        restoreSetProgress(-1,'');
        restoreSetBusy(false);
        restoreShowMsg('Invalid authenticator code ‚Äî open your authenticator app and enter the current 6-digit code for "Investments Tracker".','error');
        return;
      }
    }
    restoreSetProgress(88,'Creating safety backup of current data‚Ä¶');
    await new Promise(r=>setTimeout(r,30));
    // Auto-download a safety backup of whatever is currently in this browser
    // BEFORE overwriting it ‚Äî so the user never loses data silently
    if(getPassRec()&&getVaultBlob()){
      try{
        const curKey=vaultKey; // may be null if called from lock screen before login
        if(curKey){
          const safeBlob=await encVault(curKey,vaultData||{});
          const safePR=getPassRec();
          const safeBackup={passRec:safePR,vaultBlob:safeBlob,exportedAt:new Date().toISOString(),version:2,note:'auto-safety-backup-before-restore'};
          const safeFile=new Blob([JSON.stringify(safeBackup,null,2)],{type:'application/json'});
          const safeUrl=URL.createObjectURL(safeFile);const sl=document.createElement('a');
          sl.href=safeUrl;sl.download='SAFETY_BACKUP_before_restore_'+new Date().toISOString().slice(0,10)+'.vault';
          sl.click();URL.revokeObjectURL(safeUrl);
        }
      }catch(safeErr){console.warn('Safety backup failed (non-fatal):',safeErr);}
    }
    restoreSetProgress(95,'Saving to this browser‚Ä¶');
    await new Promise(r=>setTimeout(r,30));
    // Write into a FRESH identity slot ‚Äî never overwrite any existing slot
    // This means restoring in window B can NEVER affect window A's data
    const restoredId=newVaultId();
    setActiveVaultId(restoredId);
    const newK=await importAes(aesKeyBytes);
    const freshPassRec={...passRec,vaultId:restoredId};
    setPassRec(freshPassRec,restoredId);
    setVaultBlob(await encVault(newK,vObj),restoredId);
    vaultKey=newK;vaultData=vObj;
    hydrateFromVault();appHydrated=true;
    sessionStorage.setItem(UNLOCK_KEY,'1');
    sessionStorage.setItem('nwt-rawkey',b64encode(aesKeyBytes));
    restoreSetProgress(100,'Done!');
    await new Promise(r=>setTimeout(r,400));
    closeRestoreModal();
    unlockUI();
    startApp();
    showToast('‚úÖ Backup restored ‚Äî welcome back!','success');
  }catch(e){
    restoreSetProgress(-1,'');
    restoreSetBusy(false);
    restoreShowMsg('Unexpected error: '+(e.message||String(e)),'error');
    console.error('submitRestore error:',e);
  }
}

/* ‚îÄ‚îÄ Export ‚îÄ‚îÄ */
function openExport(){
  const modal=document.getElementById('exportModal'),content=document.getElementById('exportContent');
  let total=getTotalUSD();const egp=getFxRate('EGP')||0;
  let t='NET WORTH SUMMARY ‚Äî '+new Date().toLocaleDateString()+'\n'+'‚îÄ'.repeat(50)+'\nTotal: '+fmt(total);
  if(egp)t+=' (EGP '+(total*egp).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})+')';t+='\n\n';
  assets.forEach(a=>{const v=assetValueUSD(a);const p=total>0?((v/total)*100).toFixed(1):'0.0';
    t+=a.icon+' '+a.label;if(a.ticker)t+=' ('+a.ticker+')';t+='\n   Holding: '+a.holding;
    if(a.type==='gold')t+=' grams';if(a.type==='etf')t+=' shares';if(a.currency)t+=' '+a.currency;
    t+='\n   Value: '+fmt(v)+' ('+p+'%)\n';
    const u=unrealizedUSD(a);if(u!==null){const b=costBasisUSD(a);t+='   Unrealized: '+fmtSigned(u)+' ('+fmtPct(b>0?u/b*100:0)+')\n';}t+='\n';});
  if(egp)t+='USD/EGP: '+egp.toFixed(2)+'\n';if(goldPerOz)t+='Gold/oz: '+fmt(goldPerOz)+'\n';
  content.textContent=t;modal.classList.remove('hidden');
}
function closeExport(){document.getElementById('exportModal').classList.add('hidden');}
function copyExport(){navigator.clipboard.writeText(document.getElementById('exportContent').textContent).then(()=>showToast('Copied to clipboard','success'));}
function downloadCSV(){
  let csv='Asset,Type,Ticker,Currency,Holding,Value USD,Allocation %,Avg Cost,Unrealized USD,Unrealized %\n';
  let total=getTotalUSD();
  assets.forEach(a=>{const v=assetValueUSD(a);const p=total>0?((v/total)*100).toFixed(2):'0.00';const u=unrealizedUSD(a);const b=costBasisUSD(a);
    csv+='"'+a.label+'",'+a.type+','+(a.ticker||'')+','+(a.currency||'')+','+a.holding+','+v.toFixed(2)+','+p+','+(a.avgCost||'')+','+(u!==null?u.toFixed(2):'')+','+(u!==null&&b>0?(u/b*100).toFixed(2):'')+'\n';});
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const l=document.createElement('a');l.href=url;l.download='portfolio_'+new Date().toISOString().slice(0,10)+'.csv';l.click();URL.revokeObjectURL(url);showToast('CSV downloaded','success');
}

async function downloadEncryptedBackup(){
  if(!vaultKey||!vaultData)return;
  const vaultBlob=await encVault(vaultKey,vaultData);
  const passRec=getPassRec();
  const now=new Date().toISOString();
  const backup={passRec,vaultBlob,exportedAt:now,version:2,vaultId:activeVaultId};
  const blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const l=document.createElement('a');
  l.href=url;l.download='investments_backup_'+now.slice(0,10)+'.vault';
  l.click();URL.revokeObjectURL(url);
  // Record backup time so we can warn if it gets stale
  localStorage.setItem(LAST_BACKUP_KEY,now);
  updateBackupStatus();
  showToast('Encrypted backup downloaded ‚Äî keep it safe!','success');
}

function getBackupAgeDays(){
  const ts=localStorage.getItem(LAST_BACKUP_KEY);
  if(!ts)return null;
  return(Date.now()-new Date(ts).getTime())/(1000*86400);
}

function checkBackupWarning(){
  const banner=document.getElementById('backupWarningBanner');
  const warnText=document.getElementById('backupWarningText');
  if(!banner||!warnText)return;
  const days=getBackupAgeDays();
  if(days===null){
    banner.style.display='flex';
    warnText.textContent='‚ö†Ô∏è You have no backup on record. If you open this file in a new browser, you will start fresh with empty data. Download a backup now.';
  }else if(days>=3){
    banner.style.display='flex';
    warnText.textContent='‚ö†Ô∏è Your last backup was '+Math.floor(days)+' days ago. Download a fresh one so your data is safe if you switch browsers.';
  }else{
    banner.style.display='none';
  }
}

function updateBackupStatus(){
  const el=document.getElementById('backupStatus');if(!el)return;
  const days=getBackupAgeDays();
  if(days===null){
    el.textContent='‚ö†Ô∏è No backup on record ‚Äî download one now';
    el.style.color='var(--negative)';
  }else if(days<1){
    el.textContent='‚úÖ Backup: today';
    el.style.color='var(--positive)';
  }else if(days<7){
    const h=Math.round(days*24);
    el.textContent='üïê Last backup: '+(h<24?h+'h ago':Math.floor(days)+'d ago');
    el.style.color='var(--text-secondary)';
  }else{
    el.textContent='‚ö†Ô∏è Backup is '+Math.floor(days)+' days old ‚Äî update it';
    el.style.color='#f97316';
  }
}

/* ‚îÄ‚îÄ Add Asset ‚îÄ‚îÄ */
let selectedType='etf';
function selectAssetType(type){selectedType=type;document.querySelectorAll('.asset-type-btn').forEach(b=>b.classList.remove('selected'));document.querySelector('[data-type="'+type+'"]').classList.add('selected');document.getElementById('fieldsETF').style.display=type==='etf'?'':'none';document.getElementById('fieldsCash').style.display=type==='cash'?'':'none';document.getElementById('fieldsGold').style.display=type==='gold'?'':'none';document.getElementById('fieldsDeposit').style.display=type==='deposit'?'':'none';}
function openModal(){document.getElementById('addModal').classList.remove('hidden');selectAssetType('etf');['addTicker','addShares','addCashLabel','addCashAmount','addCashCurrency','addGoldGrams','addDepLabel','addDepAmount'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});document.getElementById('addGoldLabel').value='24K Gold';document.getElementById('addDepCurrency').value='EGP';setTimeout(()=>document.getElementById('addTicker')?.focus(),0);}
function closeModal(){document.getElementById('addModal').classList.add('hidden');}
function closeAllModals(){closeModal();closeChangePass();closeExport();closeRestoreModal();closeTxModal();closeCloudModal();}
function generateId(){return'asset-'+Date.now()+'-'+Math.random().toString(36).slice(2,6);}

async function addAsset(){
  const uc=assets.map(a=>a.color);const color=COLORS.find(c=>!uc.includes(c))||COLORS[assets.length%COLORS.length];let na;
  switch(selectedType){
    case'etf':{const t=document.getElementById('addTicker').value.trim(),s=parseFloat(document.getElementById('addShares').value)||0;if(!t){alert('Enter a ticker');return;}if(assets.some(a=>a.ticker===t)){alert('Already tracked');return;}na={id:generateId(),type:'etf',label:t,icon:'üìà',ticker:t,holding:s,color};break;}
    case'cash':{const l=document.getElementById('addCashLabel').value.trim()||'Cash',a=parseFloat(document.getElementById('addCashAmount').value)||0,c=document.getElementById('addCashCurrency').value.trim()||'USD';na={id:generateId(),type:'cash',label:l,icon:'üíµ',currency:c,holding:a,color};break;}
    case'gold':{const l=document.getElementById('addGoldLabel').value.trim()||'Gold',g=parseFloat(document.getElementById('addGoldGrams').value)||0,p=parseFloat(document.getElementById('addGoldPurity').value);na={id:generateId(),type:'gold',label:l,icon:'ü•á',purity:p,holding:g,color};break;}
    case'deposit':{const l=document.getElementById('addDepLabel').value.trim()||'Deposit',a=parseFloat(document.getElementById('addDepAmount').value)||0,c=document.getElementById('addDepCurrency').value.trim()||'EGP';na={id:generateId(),type:'deposit',label:l,icon:'üè¶',currency:c,holding:a,color};break;}
  }
  assets.push(na);saveData();closeModal();showToast(na.label+' added','success');
  if(na.type==='etf'){const ov=document.getElementById('loadingOverlay'),lt=document.getElementById('loadingText');ov.classList.remove('hidden');lt.textContent='Fetching '+na.ticker+'‚Ä¶';const ok=await fetchETFPrice(na.ticker);if(!ok){lt.textContent='Could not fetch '+na.ticker+' ‚Äî enter manually';await new Promise(r=>setTimeout(r,1500));}ov.classList.add('hidden');saveData();}
  if(na.currency&&na.currency!=='USD'&&!fxRates[na.currency]){await fetchFX();saveData();}
  render();
}

/* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
function switchTab(name){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>{const tabs=['dashboard','performance','history'];b.classList.toggle('active',tabs[i]===name);});
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='performance')renderPerformanceTab();
  if(name==='history')renderHistoryTab();
}

/* ‚îÄ‚îÄ Search & Sort ‚îÄ‚îÄ */
let searchDebounce=null;
function onSearchInput(){
  clearTimeout(searchDebounce);
  searchDebounce=setTimeout(()=>{searchQuery=document.getElementById('searchInput').value.toLowerCase();renderCards();},200);
}

function getSortedFilteredAssets(){
  let list=[...assets];
  if(searchQuery)list=list.filter(a=>(a.label||'').toLowerCase().includes(searchQuery)||(a.ticker||'').toLowerCase().includes(searchQuery));
  const sort=document.getElementById('sortSelect').value;
  const total=getTotalUSD();
  if(sort==='value-desc')list.sort((a,b)=>assetValueUSD(b)-assetValueUSD(a));
  else if(sort==='alloc-desc')list.sort((a,b)=>assetValueUSD(b)-assetValueUSD(a));
  else if(sort==='gain-desc')list.sort((a,b)=>{const ua=unrealizedUSD(a)??-Infinity,ub=unrealizedUSD(b)??-Infinity;return ub-ua;});
  else if(sort==='today-desc')list.sort((a,b)=>{const ta=todaysGainUSD(a)??-Infinity,tb=todaysGainUSD(b)??-Infinity;return tb-ta;});
  else if(sort==='name-asc')list.sort((a,b)=>(a.label||'').localeCompare(b.label||''));
  return list;
}

/* ‚îÄ‚îÄ Formatting ‚îÄ‚îÄ */
function fmt(v){return'$'+Math.abs(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtSigned(v){return(v>0?'+':'')+(v<0?'‚àí':'')+fmt(Math.abs(v));}
function fmtPct(v){return(v>0?'+':'')+v.toFixed(2)+'%';}
function fmtDate(d){try{return new Date(d+'T00:00:00').toLocaleDateString();}catch{return d;}}

/* ‚îÄ‚îÄ FX ‚îÄ‚îÄ */
function getFxRate(c){if(!c||c==='USD')return 1;return fxRates?.[c.toUpperCase()]||0;}
function fxMetaText(){const w=fxMeta?.updatedAt?fxMeta.updatedAt.toLocaleString():'',s=fxMeta?.source||'';return(w||s)?(w+(s?' ¬∑ '+s:'')):''; }
function metaInline(u,s){const w=u?u.toLocaleString():'',src=s||'';return(w||src)?(w+(src?' ¬∑ '+src:'')):''; }

function toUSD(amt,ccy){
  if(!ccy||ccy==='USD')return amt;
  if(ccy==='GBp'||ccy==='GBX'){const r=getFxRate('GBP');return r?(amt/100)/r:0;}
  const rate=getFxRate(ccy.toUpperCase());return rate?amt/rate:0;
}

/* ‚îÄ‚îÄ Asset value ‚îÄ‚îÄ */
function assetValueUSD(a){
  switch(a.type){
    case'cash':return toUSD(a.holding,a.currency);
    case'gold':{const p=a.purity||1;const ppg=goldPerOz?(goldPerOz/TROY_OZ_GRAM)*p:0;return a.holding*ppg;}
    case'etf':{const ep=etfPrices[a.ticker];if(ep){let pu=ep.price;if(ep.currency&&ep.currency!=='USD')pu=toUSD(ep.price,ep.currency);return a.holding*pu;}return a.holding*(a.manualPrice||0);}
    case'deposit':return toUSD(a.holding,a.currency);
    default:return 0;
  }
}
function costBasisUSD(a){
  const avg=Number(a.avgCost)||0;if(avg<=0)return 0;
  if(a.type==='etf'){const ep=a.ticker?etfPrices[a.ticker]:null;return toUSD((Number(a.holding)||0)*avg,ep?.currency||'USD');}
  if(a.type==='gold')return(Number(a.holding)||0)*avg;return 0;
}
function unrealizedUSD(a){if(a.type!=='etf'&&a.type!=='gold')return null;const b=costBasisUSD(a);if(b<=0)return null;return assetValueUSD(a)-b;}
function todaysGainUSD(a){
  if(a.type==='etf'){const ep=etfPrices[a.ticker];if(!ep||ep.price==null||ep.prevClose==null)return null;const d=(ep.price-ep.prevClose)*(Number(a.holding)||0);return ep.currency&&ep.currency!=='USD'?toUSD(d,ep.currency):d;}
  if(a.type==='gold'){if(!goldPerOz||!goldPrevOz||goldPerOz===goldPrevOz)return null;const p=a.purity||1;const oz=((Number(a.holding)||0)/TROY_OZ_GRAM)*p;return(goldPerOz-goldPrevOz)*oz;}
  return null;
}

/* ‚ïê‚ïê API FETCHING ‚ïê‚ïê */
async function fetchWithTimeout(url,ms=5000){const c=new AbortController();const t=setTimeout(()=>c.abort(),ms);try{return await fetch(url,{signal:c.signal,cache:'no-store',headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}});}finally{clearTimeout(t);}}
const CORS_PROXIES=[url=>'https://api.allorigins.win/raw?url='+encodeURIComponent(url),url=>'https://corsproxy.io/?'+encodeURIComponent(url),url=>'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(url),url=>'https://thingproxy.freeboard.io/fetch/'+encodeURIComponent(url)];

// Race: try direct + all proxies simultaneously, return first success
async function fetchJsonRace(url,ms=6000){
  const tryUrl=async(u)=>{
    const r=await fetchWithTimeout(u,ms);
    if(!r.ok)throw new Error('HTTP '+r.status);
    return r.json();
  };
  const attempts=[tryUrl(url),...CORS_PROXIES.map(p=>tryUrl(p(url)))];
  // Use allSettled + check for first fulfilled
  return new Promise(resolve=>{
    let done=false,pending=attempts.length;
    attempts.forEach(p=>p.then(data=>{if(!done){done=true;resolve(data);}}).catch(()=>{if(--pending===0&&!done)resolve(null);}));
  });
}
// Kept for backward compat (sequential fallback for non-critical paths)
async function fetchJsonAny(url,ms=6000){return fetchJsonRace(url,ms);}

async function fetchFX(){
  const ts=Date.now(); fxMeta.attempted=true;
  const needed=new Set(['EGP']);
  for(const a of (assets||[])){if(a?.currency && a.currency!=='USD') needed.add(String(a.currency).toUpperCase());}
  const wanted=[...needed].filter(c=>/^[A-Z]{3}$/.test(c) && c!=='USD');
  if(!wanted.length){fxRates={};fxMeta={updatedAt:new Date(),source:'n/a',attempted:true};return true;}
  const haveEnough=()=>wanted.every(c=>Number.isFinite(fxRates?.[c])&&fxRates[c]>0);
  function mergeRates(ratesObj){if(!ratesObj)return;for(const c of wanted){const v=Number(ratesObj[c]);if(Number.isFinite(v)&&v>0)fxRates[c]=v;}}
  // Source 1: Yahoo Finance quote endpoint ‚Äî real-time, same source as ETF prices
  async function fromYahooQuote(){
    const syms=wanted.map(c=>'USD'+c+'=X').join(',');
    const d=await fetchJsonRace('https://query1.finance.yahoo.com/v7/finance/quote?symbols='+encodeURIComponent(syms)+'&_ts='+ts,6000);
    const results=d?.quoteResponse?.result;if(!Array.isArray(results)||!results.length)return false;
    const rates={};let lt=0;
    for(const q of results){
      const m=/^USD([A-Z]{3})=X$/.exec(q?.symbol||'');if(!m)continue;
      const px=Number(q?.regularMarketPrice);if(!Number.isFinite(px)||px<=0)continue;
      rates[m[1]]=px;
      const t=Number(q?.regularMarketTime);if(Number.isFinite(t)&&t>lt)lt=t;
    }
    mergeRates(rates);if(!(fxRates?.EGP>0))return false;
    fxMeta={updatedAt:lt?new Date(lt*1000):new Date(),source:'Yahoo Finance (live)'};return true;
  }
  // Source 2: Yahoo Finance chart endpoint for each currency pair ‚Äî very fresh
  async function fromYahooChart_FX(){
    const results=await Promise.allSettled(wanted.map(async c=>{
      const sym='USD'+c+'=X';
      const r=await fetchYahooChart(sym,'1d','1d');if(!r)return;
      const px=r.meta?.regularMarketPrice;if(!(px>0))return;
      fxRates[c]=px;
    }));
    if(!(fxRates?.EGP>0))return false;
    fxMeta={updatedAt:new Date(),source:'Yahoo Finance (live)'};return true;
  }
  // Source 3: Wise/TransferWise public rate (no key, real-time market rates)
  async function fromWise(){
    const results=await Promise.allSettled(wanted.map(async c=>{
      const d=await fetchJsonRace('https://wise.com/rates/live?source=USD&target='+c+'&_ts='+ts,6000);
      const px=Number(d?.value);if(!(px>0))return;
      fxRates[c]=px;
    }));
    if(!(fxRates?.EGP>0))return false;
    fxMeta={updatedAt:new Date(),source:'Wise (live)'};return true;
  }
  // Source 4: open.er-api.com ‚Äî free, refreshes every few hours
  async function fromErApi(){
    const d=await fetchJsonRace('https://open.er-api.com/v6/latest/USD?_ts='+ts,6000);
    const rates=d?.rates;if(!rates||typeof rates!=='object')return false;
    mergeRates(rates);if(!(fxRates?.EGP>0))return false;
    const t=Number(d?.time_last_update_unix);
    fxMeta={updatedAt:(Number.isFinite(t)&&t>0)?new Date(t*1000):new Date(),source:'open.er-api.com'};return true;
  }
  // Source 5: exchangerate.host ‚Äî fallback
  async function fromExchangeRateHost(){
    const d=await fetchJsonRace('https://api.exchangerate.host/latest?base=USD&symbols='+encodeURIComponent(wanted.join(','))+'&_ts='+ts,6000);
    const rates=d?.rates;if(!rates||typeof rates!=='object')return false;
    mergeRates(rates);if(!(fxRates?.EGP>0))return false;
    const dt=d?.date?new Date(d.date+'T00:00:00Z'):new Date();
    fxMeta={updatedAt:dt,source:'exchangerate.host'};return true;
  }

  const nextRates={};for(const c of wanted){if(fxRates?.[c])nextRates[c]=fxRates[c];}fxRates=nextRates;

  // Try sources in order of data freshness; stop as soon as EGP found
  const sources=[fromYahooQuote,fromYahooChart_FX,fromWise,fromErApi,fromExchangeRateHost];
  let ok=false;
  for(const fn of sources){try{const r=await fn();ok=ok||r;if(ok&&haveEnough())break;}catch{}}
  return(fxRates?.EGP>0);
}

async function fetchYahooChart(ticker,range='1d',interval='1d'){
  const u='https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(ticker)+'?interval='+encodeURIComponent(interval)+'&range='+encodeURIComponent(range)+'&_ts='+Date.now();
  const tryUrl=async(url)=>{
    const r=await fetchWithTimeout(url,6000);if(!r.ok)throw new Error('HTTP '+r.status);
    const d=await r.json();const res=d?.chart?.result?.[0];if(!res)throw new Error('No result');return res;
  };
  const attempts=[tryUrl(u),...CORS_PROXIES.map(p=>tryUrl(p(u)))];
  return new Promise(resolve=>{
    let done=false,pending=attempts.length;
    attempts.forEach(p=>p.then(data=>{if(!done){done=true;resolve(data);}}).catch(()=>{if(--pending===0&&!done)resolve(null);}));
  });
}

async function fetchGold(){
  for(const url of['https://api.metals.dev/v1/latest?api_key=demo&currency=USD&unit=toz','https://data-asg.goldprice.org/dbXRates/USD']){
    const d=await fetchJsonAny(url,8000);if(!d)continue;
    if(d.metals?.gold>0){goldPerOz=d.metals.gold;goldMeta={updatedAt:new Date(),source:'metals.dev'};return true;}
    if(d.items?.[0]?.xauPrice>0){goldPerOz=d.items[0].xauPrice;goldMeta={updatedAt:new Date(),source:'goldprice.org'};return true;}
  }return false;
}

async function fetchGoldPrevClose(){
  for(const sym of['XAUUSD=X','GC=F']){
    const r=await fetchYahooChart(sym,'2d','1d');if(!r)continue;
    const meta=r.meta||{};const cur=meta.regularMarketPrice;
    let prev=meta.previousClose??meta.chartPreviousClose??meta.regularMarketPreviousClose??null;
    if(prev==null){const cl=r?.indicators?.quote?.[0]?.close;if(Array.isArray(cl)){const nn=cl.filter(x=>x!=null);if(nn.length>=2)prev=nn[nn.length-2];}}
    if(typeof cur==='number'&&cur>0)goldPerOz=cur;if(typeof prev==='number'&&prev>0)goldPrevOz=prev;
    if(goldPerOz>0&&goldPrevOz>0){goldMeta={updatedAt:new Date(),source:'Yahoo ('+sym+')'};return true;}
  }return false;
}

function normCcy(ticker,meta){
  const raw=meta?.currency||'USD';
  if((ticker||'').toUpperCase().endsWith('.CA'))return'EGP';
  const ex=(meta?.fullExchangeName||meta?.exchangeName||'').toString().toLowerCase();
  if(ex.includes('cairo')||ex.includes('egypt'))return'EGP';return raw;
}

async function fetchETFPrice(ticker){
  const r=await fetchYahooChart(ticker,'1d','1d');if(!r)return false;
  const meta=r.meta||{};let ccy=normCcy(ticker,meta);let px=meta.regularMarketPrice;
  if(px==null){const cl=r?.indicators?.quote?.[0]?.close;if(Array.isArray(cl)){const nn=cl.filter(x=>x!=null);if(nn.length)px=nn[nn.length-1];}}
  let prev=meta.previousClose??meta.chartPreviousClose??meta.regularMarketPreviousClose??null;
  if(prev==null){const cl=r?.indicators?.quote?.[0]?.close;if(Array.isArray(cl)){const nn=cl.filter(x=>x!=null);if(nn.length>=2)prev=nn[nn.length-2];}}
  if(typeof px!=='number'||px<=0)return false;
  if(ccy==='GBp'||ccy==='GBX'){px=px/100;if(prev!=null)prev=prev/100;ccy='GBP';}
  etfPrices[ticker]={price:px,currency:ccy,prevClose:prev};etfMeta[ticker]={updatedAt:new Date(),source:'Yahoo'};return true;
}

async function fetchAllETFs(){
  const tickers=[...new Set(assets.filter(a=>a.type==='etf').map(a=>a.ticker))];
  const results=await Promise.allSettled(tickers.map(t=>fetchETFPrice(t)));
  return results.some(r=>r.status==='fulfilled'&&r.value===true);
}

async function fetchAllPrices(){
  const btn=document.getElementById('refreshBtn'),overlay=document.getElementById('loadingOverlay'),lt=document.getElementById('loadingText');
  btn.disabled=true;btn.textContent='‚è≥ Updating‚Ä¶';overlay.classList.remove('hidden');
  lt.textContent='Fetching live prices‚Ä¶';

  // Run all fetches in PARALLEL for maximum speed
  const hasGold=assets.some(a=>a.type==='gold');
  const hasETF=assets.some(a=>a.type==='etf');
  const [fxOk, goldOk, etfOk] = await Promise.all([
    fetchFX(),
    hasGold ? fetchGoldPrevClose().then(ok=>ok||fetchGold()) : Promise.resolve(false),
    hasETF  ? fetchAllETFs()                                  : Promise.resolve(false),
  ]);

  overlay.classList.add('hidden');btn.disabled=false;btn.textContent='üîÑ Refresh';
  const parts=[];parts.push(fxOk?'FX ‚úì':'FX ‚úó');
  if(hasGold)parts.push(goldOk?'Gold ‚úì':'Gold ‚úó');
  [...new Set(assets.filter(a=>a.type==='etf').map(a=>a.ticker))].forEach(t=>parts.push(etfPrices[t]?t+' ‚úì':t+' ‚úó'));
  document.getElementById('timestamp').textContent=parts.length>0?parts.join(' ¬∑ ')+' ‚Äî '+new Date().toLocaleTimeString():'‚ö†Ô∏è Price fetch failed';
  captureSnapshot();
  saveData();render();
  if(fxOk||goldOk||etfOk)showToast('Prices updated','success');else showToast('Some fetches failed ‚Äî check connection','error');
}

/* ‚ïê‚ïê RENDERING ‚ïê‚ïê */
function render(){renderRates();renderCards();renderTotals();highlightModeButtons();}

function renderRates(){
  const banner=document.getElementById('ratesBanner');const chips=[];
  if(goldPerOz){
    let chgH='';if(goldPrevOz&&goldPrevOz!==goldPerOz){const c=goldPerOz-goldPrevOz;const p=(c/goldPrevOz)*100;chgH='<span class="rate-change '+(c>0?'positive':'negative')+'">'+(c>0?'+':'')+p.toFixed(2)+'%</span>';}
    const m=metaInline(goldMeta?.updatedAt,goldMeta?.source);
    chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">GOLD/OZ</span><span class="rate-value">'+fmt(goldPerOz)+'</span></div>'+(chgH?'<div>'+chgH+'</div>':'')+(m?'<div class="rate-meta">'+m+'</div>':'')+'</div>');
  }
  [...new Set(assets.filter(a=>a.type==='etf').map(a=>a.ticker))].forEach(t=>{
    const ep=etfPrices[t];const m=etfMeta?.[t]||{};const meta=metaInline(m.updatedAt,m.source);
    if(ep){
      const disp=ep.currency==='USD'?fmt(ep.price):(ep.currency+' '+Number(ep.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}));
      let chgH='';if(ep.prevClose){const c=ep.price-ep.prevClose;const p=(c/ep.prevClose)*100;chgH='<span class="rate-change '+(c>0?'positive':'negative')+'">'+(c>0?'+':'')+p.toFixed(2)+'%</span>';}
      chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">'+t+'</span><span class="rate-value">'+disp+'</span></div>'+(chgH?'<div>'+chgH+'</div>':'')+(meta?'<div class="rate-meta">'+meta+'</div>':'')+'</div>');
    }else chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">'+t+'</span><span class="rate-value">‚Äî</span></div></div>');
  });
  [...new Set(['EGP',...assets.filter(a=>a.currency&&a.currency!=='USD').map(a=>(a.currency||'').toUpperCase())])].forEach(c=>{
    const rate=getFxRate(c);if(!rate)return;const meta=fxMetaText();
    chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">USD/'+c+'</span><span class="rate-value">'+rate.toFixed(2)+'</span></div>'+(meta?'<div class="rate-meta">'+meta+'</div>':'')+'</div>');
  });
  banner.innerHTML=chips.join('');
}

function renderGainRow(u,basis){
  let t='‚Äî',cls='neutral';
  if(u!==null){const p=basis>0?(u/basis*100):0;if(unrealizedMode==='usd')t=fmtSigned(u);else if(unrealizedMode==='pct')t=fmtPct(p);else t=fmtSigned(u)+' ('+fmtPct(p)+')';cls=u>0?'positive':(u<0?'negative':'neutral');}
  return'<div class="gain-row"><span class="value-label">Unrealized</span><span class="gain-value '+cls+'">'+t+'</span></div>';
}
function todayPctForAsset(a){
  // % based on the asset's own price movement vs previous close (not vs total portfolio)
  if(a.type==='etf'){const ep=etfPrices[a.ticker];if(!ep||ep.prevClose==null||ep.prevClose===0)return null;return(ep.price-ep.prevClose)/ep.prevClose*100;}
  if(a.type==='gold'){if(!goldPerOz||!goldPrevOz||goldPrevOz===0)return null;return(goldPerOz-goldPrevOz)/goldPrevOz*100;}
  return null;
}
function renderTodayRow(tg,a){
  if(tg===null)return'';const cls=tg>0?'positive':(tg<0?'negative':'neutral');
  const pct=todayPctForAsset(a);
  const pctStr=pct!==null?' <span style="opacity:0.7;font-size:10px;">('+fmtPct(pct)+')</span>':'';
  return'<div class="today-row"><span class="value-label" style="font-size:11px">Today</span><span class="today-value '+cls+'">'+fmtSigned(tg)+pctStr+'</span></div>';
}

function renderCards(){
  const grid=document.getElementById('cardsGrid');grid.innerHTML='';
  const list=getSortedFilteredAssets();
  if(!assets.length){grid.innerHTML='<div class="empty-state"><span class="eicon">üì≠</span><p>No assets yet.<br>Click <b>‚ûï Add Asset</b> to start tracking.</p></div>';return;}
  if(!list.length){grid.innerHTML='<div class="empty-state"><span class="eicon">üîç</span><p>No assets match your search.</p></div>';return;}
  const total=getTotalUSD();

  list.forEach((a,i)=>{
    const v=assetValueUSD(a);const c=a.color||COLORS[i%COLORS.length];const bg=c+'14';const bc=c+'33';
    let hl,hu,prH='',manH='',avgH='',gainH='',todH='';
    switch(a.type){
      case'cash':hl='Amount';hu=a.currency||'USD';
        if(a.currency&&a.currency!=='USD'&&fxRates[a.currency])prH='<div class="price-row"><span class="price-label">FX rate</span><span class="price-value">1 USD = '+getFxRate(a.currency).toFixed(2)+' '+a.currency+'</span></div>';
        break;
      case'gold':{hl='Weight';hu='grams';const pu=a.purity||1;const ppg=goldPerOz?(goldPerOz/TROY_OZ_GRAM)*pu:0;
        if(ppg>0)prH='<div class="price-row"><span class="price-label">Live price</span><span class="price-value">'+fmt(ppg)+' <span class="price-unit">per gram</span></span></div>';
        avgH='<div class="avgcost-row"><span class="avgcost-label">Avg cost / g</span><input type="number" class="avgcost-input" value="'+(a.avgCost||'')+'" placeholder="e.g. 58.20" step="0.01" oninput="debounceUpdateAvgCost(\''+a.id+'\',this.value)"><span class="avgcost-ccy">USD</span></div>';
        gainH=renderGainRow(unrealizedUSD(a),costBasisUSD(a));todH=renderTodayRow(todaysGainUSD(a),a);break;}
      case'etf':{hl='Shares';hu='shares';const ep=etfPrices[a.ticker];
        if(ep){const d=ep.currency==='USD'?fmt(ep.price):(ep.currency+' '+Number(ep.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}));prH='<div class="price-row"><span class="price-label">Live price ('+ep.currency+')</span><span class="price-value">'+d+' <span class="price-unit">per share</span></span></div>';}
        else manH='<div class="manual-price-row"><span class="manual-price-label">Manual price $ </span><input type="number" class="manual-price-input" value="'+(a.manualPrice||'')+'" placeholder="e.g. 4.85" step="0.01" oninput="setManualPrice(\''+a.id+'\',this.value)"></div>';
        const ac=ep?.currency||'USD';avgH='<div class="avgcost-row"><span class="avgcost-label">Avg cost / share</span><input type="number" class="avgcost-input" value="'+(a.avgCost||'')+'" placeholder="e.g. 102.55" step="0.01" oninput="debounceUpdateAvgCost(\''+a.id+'\',this.value)"><span class="avgcost-ccy">'+ac+'</span></div>';
        gainH=renderGainRow(unrealizedUSD(a),costBasisUSD(a));todH=renderTodayRow(todaysGainUSD(a),a);break;}
      case'deposit':hl='Amount';hu=a.currency||'EGP';
        if(a.currency&&a.currency!=='USD'&&fxRates[a.currency])prH='<div class="price-row"><span class="price-label">FX rate</span><span class="price-value">1 USD = '+getFxRate(a.currency).toFixed(2)+' '+a.currency+'</span></div>';
        break;
    }
    // Transactions
    const hasTxTypes=(a.type==='etf'||a.type==='gold');
    const txList=transactions[a.id]||[];
    let txH='';
    if(hasTxTypes){
      txH='<div style="margin-top:6px;"><button class="btn btn-sm tx-btn" onclick="openTxModal(\''+a.id+'\')">‚ûï Add Transaction</button></div>';
      if(txList.length){
        txH+='<div class="tx-log"><div class="tx-log-title">Transactions ('+txList.length+')</div>';
        const recent=txList.slice(-5).reverse();
        recent.forEach(tx=>{
          const detail=tx.type==='dividend'?'Div '+fmt(tx.amount):(tx.qty+' @ '+fmt(tx.price));
          txH+='<div class="tx-item"><span class="tx-type '+tx.type+'">'+tx.type.toUpperCase()+'</span><span class="tx-date">'+fmtDate(tx.date)+'</span><span class="tx-detail">'+detail+'</span><button class="tx-remove-btn" onclick="removeTx(\''+a.id+'\',\''+tx.id+'\')">‚úï</button></div>';
        });
        if(txList.length>5)txH+='<div style="font-size:10px;color:var(--text-muted);padding:4px 0;">+'+(txList.length-5)+' more‚Ä¶</div>';
        txH+='</div>';
      }
    }
    const tn=a.ticker?' <span style="font-weight:400;font-size:12px;color:var(--text-tertiary)">('+a.ticker+')</span>':'';
    const card=document.createElement('div');card.className='card';card.style.background=bg;card.style.borderColor=bc;
    card.innerHTML='<button class="card-remove" onclick="removeAsset(\''+a.id+'\')" title="Remove">‚úï</button><div class="card-header"><span class="card-icon">'+(a.icon||'üì¶')+'</span><span class="card-label" style="color:'+c+'">'+a.label+tn+'</span><span class="card-pct" style="color:'+c+'" id="pct-'+a.id+'">'+( total>0&&v>0?((v/total)*100).toFixed(1)+'%':'' )+'</span></div><div class="holding-row"><span class="holding-label">'+hl+'</span><div class="holding-input-wrap"><input type="number" class="holding-input" value="'+(a.holding||0)+'" step="0.01" style="border-color:'+bc+'" onfocus="this.style.borderColor=\''+c+'\'" onblur="this.style.borderColor=\''+bc+'\'" oninput="debounceUpdateHolding(\''+a.id+'\',this.value)"><span class="unit">'+hu+'</span></div></div>'+prH+manH+avgH+'<div class="value-row"><span class="value-label">Value (USD)</span><span class="value-amount" style="color:'+c+'" id="val-'+a.id+'">'+fmt(v)+'</span></div>'+gainH+todH+txH;
    grid.appendChild(card);
  });
}

function renderTotals(){
  const total=getTotalUSD();const vals=[];
  assets.forEach(a=>{const v=assetValueUSD(a);vals.push({id:a.id,val:v,color:a.color,label:a.label});});
  document.getElementById('totalUSD').textContent=fmt(total);
  const egp=getFxRate('EGP')||0;
  document.getElementById('totalEGP').textContent=egp?'EGP '+(total*egp).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):'';
  vals.forEach(v=>{const el=document.getElementById('pct-'+v.id);if(el)el.textContent=total>0&&v.val>0?((v.val/total)*100).toFixed(1)+'%':'';const ve=document.getElementById('val-'+v.id);if(ve)ve.textContent=fmt(v.val);});
  const bar=document.getElementById('allocBar'),leg=document.getElementById('legend');bar.innerHTML='';leg.innerHTML='';
  if(total>0)vals.forEach(v=>{if(v.val>0){const p=(v.val/total*100);bar.innerHTML+='<div class="alloc-segment" style="width:'+p+'%;background:'+v.color+'" title="'+v.label+': '+p.toFixed(1)+'%"></div>';leg.innerHTML+='<span class="legend-item"><span class="legend-dot" style="background:'+v.color+'"></span>'+v.label+' '+p.toFixed(1)+'%</span>';}});

  let tU=0,tB=0;assets.forEach(a=>{const u=unrealizedUSD(a),b=costBasisUSD(a);if(u!==null){tU+=u;tB+=b;}});
  const tu=document.getElementById('totalUnrealized');
  if(tu){tu.classList.remove('positive','negative');if(tB<=0)tu.textContent='Unrealized: ‚Äî';else{const p=tU/tB*100;let t;if(unrealizedMode==='usd')t=fmtSigned(tU);else if(unrealizedMode==='pct')t=fmtPct(p);else t=fmtSigned(tU)+' ('+fmtPct(p)+')';tu.textContent='Unrealized: '+t;if(tU>0)tu.classList.add('positive');else if(tU<0)tu.classList.add('negative');}}

  let tT=0,hT=false,prevTotal=0;
  assets.forEach(a=>{
    const g=todaysGainUSD(a);
    if(g!==null){
      tT+=g;hT=true;
      // prevClose value of this asset = current value - today's gain
      prevTotal+=assetValueUSD(a)-g;
    }
  });
  const tt=document.getElementById('totalTodayGain');
  if(tt){tt.classList.remove('positive','negative');if(!hT)tt.textContent='Today: ‚Äî';else{
    // % based on prev-close value of assets that have today data (not total portfolio)
    const todayPct=prevTotal>0?(tT/prevTotal*100):0;
    tt.textContent='Today: '+fmtSigned(tT)+' ('+fmtPct(todayPct)+')';
    if(tT>0)tt.classList.add('positive');else if(tT<0)tt.classList.add('negative');
  }}
}

/* ‚ïê‚ïê PERFORMANCE TAB ‚ïê‚ïê */
function renderPerformanceTab(){
  renderPerfMetrics();
  renderValueChart();
  renderAllocChart();
}

function renderPerfMetrics(){
  const snaps=getSnapshotsForRange('ALL');
  const total=getTotalUSD();
  const twr=calcTWR(snaps);

  let tU=0,tB=0;assets.forEach(a=>{const u=unrealizedUSD(a),b=costBasisUSD(a);if(u!==null){tU+=u;tB+=b;}});
  const unrealPct=tB>0?(tU/tB*100):null;

  let tT=0,hT=false,prevTotalPerf=0;
  assets.forEach(a=>{const g=todaysGainUSD(a);if(g!==null){tT+=g;hT=true;prevTotalPerf+=assetValueUSD(a)-g;}});
  const todayPct=prevTotalPerf>0?(tT/prevTotalPerf*100):0;

  // Best & worst day
  let bestDay=null,worstDay=null;
  for(let i=1;i<snaps.length;i++){
    const prev=snaps[i-1].totalUSD,cur=snaps[i].totalUSD;
    const chgPct=prev>0?((cur-prev)/prev*100):0;
    if(bestDay===null||chgPct>bestDay.pct)bestDay={date:snaps[i].date,pct:chgPct,usd:cur-prev};
    if(worstDay===null||chgPct<worstDay.pct)worstDay={date:snaps[i].date,pct:chgPct,usd:cur-prev};
  }

  const metrics=[
    {label:'Total Value',value:fmt(total),sub:'Current portfolio',cls:''},
    {label:'Total Unrealized',value:unrealPct!==null?fmtSigned(tU)+' ('+fmtPct(unrealPct)+')':'‚Äî',sub:'vs cost basis',cls:tU>0?'positive':tU<0?'negative':''},
    {label:"Today's Change",value:hT?fmtSigned(tT)+' ('+fmtPct(todayPct)+')':'‚Äî',sub:'vs yesterday',cls:tT>0?'positive':tT<0?'negative':''},
    {label:'TWR (All Time)',value:twr!==null?fmtPct(twr):'‚Äî',sub:snaps.length+' snapshots',cls:twr>0?'positive':twr<0?'negative':''},
    {label:'Best Day',value:bestDay?fmtPct(bestDay.pct):'‚Äî',sub:bestDay?fmtDate(bestDay.date):'No data',cls:'positive'},
    {label:'Worst Day',value:worstDay?fmtPct(worstDay.pct):'‚Äî',sub:worstDay?fmtDate(worstDay.date):'No data',cls:'negative'},
  ];
  document.getElementById('perfMetrics').innerHTML=metrics.map(m=>`<div class="perf-metric"><div class="perf-metric-label">${m.label}</div><div class="perf-metric-value ${m.cls}">${m.value}</div><div class="perf-metric-sub">${m.sub}</div></div>`).join('');
}

function setChartRange(range,btn){
  activeChartRange=range;
  document.querySelectorAll('.chart-range-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderValueChart();
}

function destroyChart(id){if(chartInstances[id]){chartInstances[id].destroy();delete chartInstances[id];}}

function renderValueChart(){
  const snaps=getSnapshotsForRange(activeChartRange);
  const canvas=document.getElementById('valueChart');
  const empty=document.getElementById('chartEmpty');
  destroyChart('value');
  if(snaps.length<2){canvas.style.display='none';empty.style.display='';return;}
  canvas.style.display='';empty.style.display='none';
  const ctx=canvas.getContext('2d');
  const labels=snaps.map(s=>fmtDate(s.date));
  const data=snaps.map(s=>s.totalUSD);
  const first=data[0]||1;const last=data[data.length-1];
  const isUp=last>=first;
  const color=isUp?'#4ade80':'#f87171';
  chartInstances['value']=drawLineChart(ctx,canvas,labels,data,color,'Portfolio Value (USD)');
}

function renderAllocChart(){
  const snaps=getSnapshotsForRange(activeChartRange);
  const canvas=document.getElementById('allocChart');
  destroyChart('alloc');
  if(snaps.length<2)return;
  const ctx=canvas.getContext('2d');
  // Stacked area: per asset
  const assetIds=[...new Set(snaps.flatMap(s=>Object.keys(s.assets||{})))];
  // Build datasets
  const datasets=assetIds.map(id=>{
    const a=assets.find(x=>x.id===id);
    const color=(a?.color)||COLORS[assetIds.indexOf(id)%COLORS.length];
    return{label:a?.label||id,data:snaps.map(s=>s.assets?.[id]||0),color};
  }).filter(d=>d.data.some(v=>v>0));
  const labels=snaps.map(s=>fmtDate(s.date));
  chartInstances['alloc']=drawStackedAreaChart(ctx,canvas,labels,datasets);
}

/* Minimal canvas chart helpers (no lib needed) */
function drawLineChart(ctx,canvas,labels,data,lineColor,label){
  const W=canvas.parentElement.clientWidth||600;const H=220;
  canvas.width=W;canvas.height=H;
  const pad={top:20,right:20,bottom:40,left:70};
  const cw=W-pad.left-pad.right,ch=H-pad.top-pad.bottom;
  const min=Math.min(...data)*0.995,max=Math.max(...data)*1.005;
  const range=max-min||1;
  function xp(i){return pad.left+i/(data.length-1)*cw;}
  function yp(v){return pad.top+ch*(1-(v-min)/range);}
  ctx.clearRect(0,0,W,H);
  // Grid lines
  ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){const y=pad.top+i/4*ch;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cw,y);ctx.stroke();}
  // Gradient fill
  const grad=ctx.createLinearGradient(0,pad.top,0,pad.top+ch);
  grad.addColorStop(0,lineColor+'33');grad.addColorStop(1,lineColor+'00');
  ctx.beginPath();ctx.moveTo(xp(0),yp(data[0]));
  for(let i=1;i<data.length;i++)ctx.lineTo(xp(i),yp(data[i]));
  ctx.lineTo(xp(data.length-1),pad.top+ch);ctx.lineTo(xp(0),pad.top+ch);ctx.closePath();
  ctx.fillStyle=grad;ctx.fill();
  // Line
  ctx.beginPath();ctx.strokeStyle=lineColor;ctx.lineWidth=2;ctx.lineJoin='round';
  ctx.moveTo(xp(0),yp(data[0]));
  for(let i=1;i<data.length;i++)ctx.lineTo(xp(i),yp(data[i]));
  ctx.stroke();
  // Y axis labels
  ctx.fillStyle='rgba(161,161,170,0.8)';ctx.font='10px JetBrains Mono, monospace';ctx.textAlign='right';
  for(let i=0;i<=4;i++){const v=min+i/4*range;ctx.fillText('$'+Math.round(v).toLocaleString(),pad.left-6,pad.top+ch*(1-i/4)+4);}
  // X axis labels (show max 6)
  ctx.textAlign='center';
  const step=Math.max(1,Math.floor(data.length/6));
  for(let i=0;i<labels.length;i+=step)ctx.fillText(labels[i],xp(i),H-10);
  return{destroy(){}};
}

function drawStackedAreaChart(ctx,canvas,labels,datasets){
  const W=canvas.parentElement.clientWidth||600;const H=180;
  canvas.width=W;canvas.height=H;
  const pad={top:10,right:20,bottom:30,left:70};
  const cw=W-pad.left-pad.right,ch=H-pad.top-pad.bottom;
  const n=labels.length;
  // Compute stacked totals per point
  const stacked=labels.map((_,i)=>0);
  datasets.forEach(ds=>ds.data.forEach((v,i)=>stacked[i]+=v));
  const max=Math.max(...stacked,1);
  function xp(i){return pad.left+i/(n-1)*cw;}
  function yp(v){return pad.top+ch*(1-v/max);}
  ctx.clearRect(0,0,W,H);
  // Draw each dataset as stacked area
  const cumulative=new Array(n).fill(0);
  datasets.forEach(ds=>{
    const base=cumulative.map(v=>v);
    ds.data.forEach((v,i)=>{cumulative[i]+=v;});
    ctx.beginPath();
    ctx.moveTo(xp(0),yp(base[0]));
    for(let i=1;i<n;i++)ctx.lineTo(xp(i),yp(base[i]));
    for(let i=n-1;i>=0;i--)ctx.lineTo(xp(i),yp(cumulative[i]));
    ctx.closePath();ctx.fillStyle=ds.color+'99';ctx.fill();
    ctx.beginPath();ctx.strokeStyle=ds.color;ctx.lineWidth=1.5;
    ctx.moveTo(xp(0),yp(cumulative[0]));
    for(let i=1;i<n;i++)ctx.lineTo(xp(i),yp(cumulative[i]));
    ctx.stroke();
  });
  // Y axis labels
  ctx.fillStyle='rgba(161,161,170,0.8)';ctx.font='10px JetBrains Mono, monospace';ctx.textAlign='right';
  for(let i=0;i<=3;i++){const v=i/3*max;ctx.fillText('$'+Math.round(v).toLocaleString(),pad.left-6,pad.top+ch*(1-i/3)+4);}
  // X axis labels
  ctx.textAlign='center';
  const step=Math.max(1,Math.floor(n/5));
  for(let i=0;i<labels.length;i+=step)ctx.fillText(labels[i],xp(i),H-5);
  return{destroy(){}};
}

/* ‚ïê‚ïê HISTORY TAB ‚ïê‚ïê */
function renderHistoryTab(){
  const body=document.getElementById('snapBody');
  const empty=document.getElementById('snapEmpty');
  body.innerHTML='';
  if(!snapshots.length){empty.style.display='';document.getElementById('snapTable').style.display='none';return;}
  empty.style.display='none';document.getElementById('snapTable').style.display='';
  const sorted=[...snapshots].reverse();
  sorted.forEach((s,i)=>{
    const prev=sorted[i+1];
    const chgUSD=prev?s.totalUSD-prev.totalUSD:null;
    const chgPct=(prev&&prev.totalUSD>0)?((s.totalUSD-prev.totalUSD)/prev.totalUSD*100):null;
    const chgCls=chgUSD>0?'positive':chgUSD<0?'negative':'';
    const assetCount=Object.keys(s.assets||{}).length;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmtDate(s.date)}</td><td style="font-weight:700">$${s.totalUSD.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</td><td style="color:var(--${chgCls==='positive'?'positive':'negative'})">${chgUSD!==null?(chgUSD>=0?'+':'')+chgUSD.toFixed(2):'‚Äî'}</td><td style="color:var(--${chgCls==='positive'?'positive':'negative'})">${chgPct!==null?(chgPct>=0?'+':'')+chgPct.toFixed(2)+'%':'‚Äî'}</td><td>${assetCount}</td>`;
    body.appendChild(tr);
  });
}

function clearHistory(){
  if(!confirm('Clear all snapshot history? This cannot be undone.'))return;
  snapshots=[];saveData();renderHistoryTab();showToast('History cleared','info');
}

/* ‚îÄ‚îÄ User actions ‚îÄ‚îÄ */
function updateHolding(id,val){const a=assets.find(x=>x.id===id);if(a){a.holding=parseFloat(val)||0;saveData();renderTotals();}}
function updateAvgCost(id,val){const a=assets.find(x=>x.id===id);if(!a)return;a.avgCost=parseFloat(val)||0;saveData();renderTotals();}
function setManualPrice(id,val){const a=assets.find(x=>x.id===id);if(a){a.manualPrice=parseFloat(val)||0;const ex=etfPrices[a.ticker];etfPrices[a.ticker]={price:a.manualPrice,currency:ex?.currency||'USD',prevClose:ex?.prevClose??null};saveData();renderTotals();}}

// Debounced update functions (150ms)
function debounceUpdateHolding(id,val){
  clearTimeout(debounceTimers['h_'+id]);
  debounceTimers['h_'+id]=setTimeout(()=>updateHolding(id,val),150);
}
function debounceUpdateAvgCost(id,val){
  clearTimeout(debounceTimers['ac_'+id]);
  debounceTimers['ac_'+id]=setTimeout(()=>updateAvgCost(id,val),150);
}

function removeAsset(id){if(!confirm('Remove this asset?'))return;const rm=assets.find(a=>a.id===id);assets=assets.filter(a=>a.id!==id);if(rm?.type==='etf'&&rm.ticker&&!assets.some(a=>a.type==='etf'&&a.ticker===rm.ticker))delete etfPrices[rm.ticker];delete transactions[id];saveData();render();showToast((rm?.label||'Asset')+' removed','info');}

function setUnrealizedMode(m){unrealizedMode=m;saveData();render();}
function highlightModeButtons(){const map={usd:'uModeUsdBtn',pct:'uModePctBtn',both:'uModeBothBtn'};Object.values(map).forEach(id=>document.getElementById(id)?.classList.remove('btn-primary'));const a=map[unrealizedMode];if(a)document.getElementById(a)?.classList.add('btn-primary');}


/* ‚ïê‚ïê CLOUD SYNC (Supabase) ‚ïê‚ïê */
let sb = null;
let sbCfg = { url:'', anon:'', email:'', pass:'', key:'primary', auto:false, autopull:false, pollMs:20000, remember:false };
let cloudPushTimer = null;
let lastPushedCt = null;
let cloudPollTimer = null;
let lastPulledCt = null;
let lastLocalChangeMs = 0;
let cloudChannel = null;

function getLocalCloudRev(){ return parseInt(localStorage.getItem('nwt-cloud-local-rev')||'0',10); }
function setLocalCloudRev(n){ localStorage.setItem('nwt-cloud-local-rev', String(n||0)); }

function loadCloudCfg(){
  try{
    const raw=localStorage.getItem('nwt-cloud-cfg');
    if(raw){const o=JSON.parse(raw);sbCfg={...sbCfg,...o}; if(sbCfg.pollMs==null) sbCfg.pollMs=20000;}
  }catch{}
}
function saveCloudCfg(){
  localStorage.setItem('nwt-cloud-cfg',JSON.stringify({
    url:sbCfg.url, anon:sbCfg.anon, email:sbCfg.email, key:sbCfg.key||'primary', auto:!!sbCfg.auto, autopull:!!sbCfg.autopull, pollMs: sbCfg.pollMs||20000, remember: !!sbCfg.remember
  }));
}
function setCloudMsg(msg,type='info'){
  const el=document.getElementById('cloudMsg');
  if(!el)return;
  el.textContent=msg||'';
  el.style.color = type==='error'?'var(--negative)':type==='ok'?'var(--positive)':'var(--text-tertiary)';
}
function openCloudModal(){
  loadCloudCfg();
  const m=document.getElementById('cloudModal');m.classList.remove('hidden');
  document.getElementById('sbUrl').value=sbCfg.url||'';
  document.getElementById('sbAnon').value=sbCfg.anon||'';
  document.getElementById('sbEmail').value=sbCfg.email||'';
  document.getElementById('sbVaultKey').value=sbCfg.key||'primary';
  document.getElementById('sbPass').value='';
  const t=document.getElementById('cloudAutoToggle');
  if(t)t.checked=!!sbCfg.auto;
  setCloudMsg(sb?('Connected.'):('Not connected.'),'info');
}
function closeCloudModal(){document.getElementById('cloudModal').classList.add('hidden');}

async function ensureSupabase(){
  if(sb) return sb;
  loadCloudCfg();
  sbCfg.url = document.getElementById('sbUrl')?.value?.trim() || sbCfg.url;
  sbCfg.anon = document.getElementById('sbAnon')?.value?.trim() || sbCfg.anon;
  if(!sbCfg.url || !sbCfg.anon) throw new Error('Enter Supabase URL + Anon key first.');
  // Dynamic import so the rest of the app stays non-module
  const mod = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
  sb = mod.createClient(sbCfg.url, sbCfg.anon, { auth: { persistSession:true, autoRefreshToken:true } });
  return sb;
}

function cloudSetupSQL(){
  return `-- 1) Table
create table if not exists public.vaults (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  vault_id text not null,
  passrec jsonb not null,
  vaultblob jsonb not null,
  rev bigint not null default 0,
  device_id text,
  updated_at timestamptz not null default now(),
  unique(user_id, vault_id)
);

-- 2) Enable RLS
alter table public.vaults enable row level security;

-- 3) Policies (only owner can read/write)
create policy "vaults select own" on public.vaults
for select using (auth.uid() = user_id);

create policy "vaults insert own" on public.vaults
for insert with check (auth.uid() = user_id);

create policy "vaults update own" on public.vaults
for update using (auth.uid() = user_id);

create policy "vaults delete own" on public.vaults
for delete using (auth.uid() = user_id);`;
}

async function cloudConnect(){
  try{
    sbCfg.url=document.getElementById('sbUrl').value.trim();
    sbCfg.anon=document.getElementById('sbAnon').value.trim();
    sbCfg.email=document.getElementById('sbEmail').value.trim();
    sbCfg.key=(document.getElementById('sbVaultKey')?.value||sbCfg.key||'primary').trim()||'primary';
    sbCfg.key=(document.getElementById('sbVaultKey')?.value||'primary').trim()||'primary';
    sbCfg.pass=document.getElementById('sbPass').value;
    saveCloudCfg();
    await ensureSupabase();
    // Try get session
    const { data } = await sb.auth.getSession();
    if(data?.session){
      setCloudMsg('‚úÖ Connected (signed in).','ok');
      startCloudRealtime();
      // If requested, store creds securely inside the encrypted vault
      const rp=document.getElementById('cloudRememberToggle');
      if(rp?.checked && vaultData && sbCfg.email && sbCfg.pass){
        vaultData.cloudCreds = { url: sbCfg.url, anon: sbCfg.anon, email: sbCfg.email, pass: sbCfg.pass, key: sbCfg.key||'primary' };
        await persistVault();
        sbCfg.remember = true; saveCloudCfg();
      }
    }else{
      setCloudMsg('‚úÖ Connected. Now Sign up or Sign in. (If you already have an account, just click Connect again after entering email + password to sign in.)','info');
      // Attempt sign-in automatically if creds provided
      if(sbCfg.email && sbCfg.pass){
        const { error } = await sb.auth.signInWithPassword({ email: sbCfg.email, password: sbCfg.pass });
        if(error) setCloudMsg('Connected, but sign-in failed: '+error.message,'error');
        else { setCloudMsg('‚úÖ Signed in.','ok');
          startCloudRealtime();
          const rp=document.getElementById('cloudRememberToggle');
          if(rp?.checked && vaultData && sbCfg.email && sbCfg.pass){
            vaultData.cloudCreds = { url: sbCfg.url, anon: sbCfg.anon, email: sbCfg.email, pass: sbCfg.pass, key: sbCfg.key||'primary' };
            await persistVault();
            sbCfg.remember = true; saveCloudCfg();
          }
          startCloudPolling(); }
      }
    }
    // Show setup SQL in console for convenience
    console.log('[Cloud Sync] Supabase setup SQL:\n'+cloudSetupSQL());
  }catch(e){
    setCloudMsg('‚ùå '+(e.message||String(e)),'error');
  }
}

async function cloudSignUp(){
  try{
    sbCfg.email=document.getElementById('sbEmail').value.trim();
    sbCfg.key=(document.getElementById('sbVaultKey')?.value||'primary').trim()||'primary';
    sbCfg.pass=document.getElementById('sbPass').value;
    saveCloudCfg();
    await ensureSupabase();
    if(!sbCfg.email || !sbCfg.pass) throw new Error('Enter email + password.');
    const { error } = await sb.auth.signUp({ email: sbCfg.email, password: sbCfg.pass });
    if(error) throw error;
    setCloudMsg('‚úÖ Sign-up initiated. If email confirmation is enabled, check your inbox, then come back and Connect to sign in.','ok');
  }catch(e){
    setCloudMsg('‚ùå '+(e.message||String(e)),'error');
  }
}

async function cloudSignOut(){
  try{
    if(!sb){setCloudMsg('Not connected.','info');return;}
    if(cloudChannel){
      try{ await sb.removeChannel(cloudChannel); }catch(_){}
      cloudChannel = null;
    }
    await sb.auth.signOut();
    setCloudMsg('Signed out.','info');
  }catch(e){
    setCloudMsg('‚ùå '+(e.message||String(e)),'error');
  }
}

async function cloudPull(){
  try{
    if(!(await ensureCloudSignedIn())) throw new Error('Please sign in first (Connect).');
    const id = (sbCfg.key||'primary');
    const { data, error } = await sb.from('vaults').select('passrec,vaultblob,rev,device_id,updated_at').eq('vault_id', id).order('updated_at',{ascending:false}).limit(1);
    if(error) throw error;
    if(!data || data.length===0) throw new Error('No cloud data found for this vault_id ('+id+'). Push from your primary device first.');
    const remote = data[0];
    const rec = remote.passrec;
    const blob = remote.vaultblob;

    // Save into this browser (into the same identity used by the vault)
    const targetId = rec?.vaultId || newVaultId();
    setActiveVaultId(targetId);
    setPassRec({ ...rec, vaultId: targetId }, targetId);
    setVaultBlob(blob, targetId);

    setLocalCloudRev(remote.rev || 0);
    localStorage.setItem('nwt-cloud-lastpull', new Date().toISOString());
    localStorage.setItem('nwt-cloud-lastpull-ms', String(Date.now()));

    setCloudMsg('‚úÖ Pulled latest encrypted vault to this device. Now unlock normally.','ok');
    showToast('Cloud pull complete','success');
  }catch(e){
    setCloudMsg('‚ùå '+(e.message||String(e)),'error');
  }
}

async function cloudPush(){
  try{
    if(!(await ensureCloudSignedIn())) throw new Error('Please sign in first (Connect).');
    const { data: sess } = await sb.auth.getSession();
    const id = (sbCfg.key||'primary');
    if(!activeVaultId) throw new Error('Unlock first, then push.');
    const rec = getPassRec(activeVaultId);
    if(!rec) throw new Error('No pass record found in this browser for this vault.');
    const blob = getVaultBlob(activeVaultId);
    if(!blob) throw new Error('No vault blob found in this browser for this vault.');

    const localRev = (vaultData?._rev || 0);
    const baseCloudRev = getLocalCloudRev();

    // Check remote rev to avoid overwriting newer cloud silently
    const { data: rdata, error: rerr } = await sb.from('vaults').select('rev').eq('vault_id', id).limit(1);
    if(rerr) throw rerr;
    const remoteRev = (rdata && rdata[0] ? (rdata[0].rev||0) : 0);
    if(remoteRev > baseCloudRev && localRev > baseCloudRev){
      throw new Error('Conflict: cloud has newer data. Pull first (or decide to overwrite).');
    }

    const payload = {
      user_id: sess.session.user.id,
      vault_id: id,
      passrec: { ...rec, rev: localRev, device_id: DEVICE_ID },
      vaultblob: blob,
      rev: localRev,
      device_id: DEVICE_ID,
      updated_at: new Date().toISOString()
    };

    const { error } = await sb.from('vaults').upsert(payload, { onConflict: 'user_id,vault_id' });
    if(error) throw error;

    lastPushedCt = blob?.ct || null;
    localStorage.setItem('nwt-cloud-lastpush', new Date().toISOString());
    localStorage.setItem('nwt-cloud-lastpush-ms', String(Date.now()));
        setLocalCloudRev(localRev);
    setLocalCloudRev(localRev);

    setCloudMsg('‚úÖ Pushed encrypted vault to cloud.','ok');
    showToast('Cloud push complete','success');
  }catch(e){
    setCloudMsg('‚ùå '+(e.message||String(e)),'error');
  }
}

function setCloudAuto(on){
  sbCfg.auto=!!on;
  saveCloudCfg();
  setCloudMsg(sbCfg.auto?'Auto-sync enabled.':'Auto-sync disabled.','info');
}


function setCloudAutoPull(on){
  sbCfg.autopull=!!on;
  saveCloudCfg();
  if(sbCfg.autopull){
    setCloudMsg('Auto-pull enabled.', 'info');
    startCloudPolling();
  }else{
    setCloudMsg('Auto-pull disabled.', 'info');
    stopCloudPolling();
  }
}

function setCloudPollMs(v){
  const n = Math.max(5000, Math.min(300000, parseInt(v||'20000',10)));
  sbCfg.pollMs = isFinite(n)?n:20000;
  saveCloudCfg();
  const iv=document.getElementById('cloudPollMs'); if(iv) iv.value=String(sbCfg.pollMs);
  if(sbCfg.autopull){
    startCloudPolling(true);
    setCloudMsg('Polling every '+Math.round(sbCfg.pollMs/1000)+'s.', 'info');
  }
}

function setCloudRemember(v){
  sbCfg.remember = !!v;
  saveCloudCfg();
  if(sbCfg.remember){
    setCloudMsg('Will remember Supabase login inside your encrypted vault after next successful sign-in.', 'info');
  }else{
    // Remove stored creds from vault (encrypted) if requested
    if(vaultData && vaultData.cloudCreds){
      delete vaultData.cloudCreds;
      persistVault().catch(()=>{});
    }
    setCloudMsg('Will not store Supabase login in your vault.', 'info');
  }
}

// Apply encrypted cloud creds (if present) to the current cloud config
function applyVaultCloudCreds(){
  if(!vaultData || !vaultData.cloudCreds) return;
  const c = vaultData.cloudCreds;
  if(c.url) sbCfg.url = c.url;
  if(c.anon) sbCfg.anon = c.anon;
  if(c.email) sbCfg.email = c.email;
  if(c.key) sbCfg.key = c.key;
  // remember flag should be on if creds exist
  sbCfg.remember = true;
  saveCloudCfg();
}

// Attempt to re-login automatically using creds stored in the encrypted vault
async function ensureCloudSignedIn(){
  if(!sbCfg.url || !sbCfg.anon) return false;
  await ensureSupabase();

  // Supabase JS can auto-refresh tokens when autoRefreshToken:true, so avoid
  // forcing refresh here (some environments behave oddly with manual refresh).
  try{
    const { data } = await sb.auth.getSession();
    if(data?.session) return true;
  }catch(e){ /* fall through */ }

  // No session: try encrypted vault creds (available only after unlock).
  const c = vaultData?.cloudCreds;
  if(c?.email && c?.pass){
    try{
      const { error } = await sb.auth.signInWithPassword({ email: c.email, password: c.pass });
      if(!error) return true;
    }catch(e){ /* ignore */ }
  }
  return false;
}



function stopCloudPolling(){
  if(cloudPollTimer){ clearInterval(cloudPollTimer); cloudPollTimer=null; }
}

function startCloudPolling(restart=false){
  loadCloudCfg();
  if(!sbCfg.autopull) return;
  if(restart) stopCloudPolling();
  if(cloudPollTimer) return;
  cloudPollTimer = setInterval(()=>{ cloudPollOnce().catch(()=>{}); }, sbCfg.pollMs||20000);
  // also run one immediately
  cloudPollOnce().catch(()=>{});
}

async function cloudPollOnce(){
  loadCloudCfg();
  if(!sbCfg.autopull) return;
  if(!sbCfg.url || !sbCfg.anon) return;
  if(!(await ensureCloudSignedIn())) return;

  const id=(sbCfg.key||'primary');
  const { data, error } = await sb.from('vaults').select('passrec,vaultblob,rev,device_id,updated_at').eq('vault_id', id).order('updated_at',{ascending:false}).limit(1);
  if(error || !data || data.length===0) return;

  const remote = data[0];
  const remoteRev = remote.rev || 0;
  const localCloudRev = getLocalCloudRev();

  // ensure we have a local identity slot (even if locked)
  if(!activeVaultId) activeVaultId = resolveVaultId();

  const localRev = (vaultData?._rev || 0);
  const localHasUnpushed = localRev > localCloudRev;

  if(remoteRev <= localCloudRev) return; // already up to date

  if(localHasUnpushed){
    if(!localStorage.getItem('nwt-cloud-conflict-toast')){
      localStorage.setItem('nwt-cloud-conflict-toast','1');
      showToast('Cloud has newer data. Open ‚òÅÔ∏è Sync and Pull (or Push to overwrite).','warn');
      setTimeout(()=>localStorage.removeItem('nwt-cloud-conflict-toast'), 15000);
    }
    return;
  }

  // Safe to pull automatically
  const targetId = remote?.passrec?.vaultId || activeVaultId || newVaultId();
  setActiveVaultId(targetId);
  setPassRec({ ...remote.passrec, vaultId: targetId }, targetId);
  setVaultBlob(remote.vaultblob, targetId);

  setLocalCloudRev(remoteRev);
  localStorage.setItem('nwt-cloud-lastpull', new Date().toISOString());
  localStorage.setItem('nwt-cloud-lastpull-ms', String(Date.now()));
  showToast('Pulled latest from cloud','info');

  if(vaultKey && vaultData){
    location.reload();
  }
}




async function startCloudRealtime(){
  try{
    loadCloudCfg();
    if(!sbCfg.url || !sbCfg.anon) return;
    await ensureSupabase();
    const { data: sess } = await sb.auth.getSession();
    if(!sess?.session) return;

    const userId = sess.session.user.id;
    const vaultKey = (sbCfg.key||'primary');

    if(cloudChannel){
      try{ await sb.removeChannel(cloudChannel); }catch(_){}
      cloudChannel = null;
    }

    cloudChannel = sb.channel('nwt-vaults-'+userId)
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'vaults',
        filter: `user_id=eq.${userId}`
      }, async (payload) => {
        const row = payload.new;
        if(!row || row.vault_id !== vaultKey) return;
        if(row.device_id && row.device_id === DEVICE_ID) return;

        const remoteRev = row.rev || 0;
        const localCloudRev = getLocalCloudRev();
        const localRev = (vaultData?._rev || 0);
        const localHasUnpushed = localRev > localCloudRev;

        if(remoteRev <= localCloudRev) return;

        if(localHasUnpushed){
          showToast('Cloud updated on another device. Open ‚òÅÔ∏è Sync to Pull or Push.','warn');
          return;
        }

        if(!activeVaultId) activeVaultId = resolveVaultId();
        const targetId = row?.passrec?.vaultId || activeVaultId || newVaultId();
        setActiveVaultId(targetId);
        setPassRec({ ...row.passrec, vaultId: targetId }, targetId);
        setVaultBlob(row.vaultblob, targetId);

        setLocalCloudRev(remoteRev);
        localStorage.setItem('nwt-cloud-lastpull-ms', String(Date.now()));
        showToast('Synced from cloud','info');

        if(vaultKey && vaultData) location.reload();
      })
      .subscribe();
  }catch(e){
    console.warn('[Cloud Sync] Realtime failed:', e?.message||e);
  }
}

// Pull check when returning to the tab (mobile-friendly)
window.addEventListener('focus', ()=>{ cloudPollOnce().catch(()=>{}); });
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) cloudPollOnce().catch(()=>{}); });

async function scheduleCloudPush(precomputedBlob=null){
  // Auto-sync only when enabled and signed in
  loadCloudCfg();
  if(!sbCfg.auto) return;
  // If user hasn't configured yet, skip silently
  if(!sbCfg.url || !sbCfg.anon) return;
  const id = (sbCfg.key||'primary');
  if(!activeVaultId) return;
  const blob = precomputedBlob || getVaultBlob(activeVaultId);
  if(!blob) return;
  // Avoid spamming if nothing changed
  if(lastPushedCt && blob.ct === lastPushedCt) return;

  if(cloudPushTimer) clearTimeout(cloudPushTimer);
  cloudPushTimer = setTimeout(async ()=>{
    try{
      await ensureSupabase();
      const { data: sess } = await sb.auth.getSession();
      if(!sess?.session) return; // not signed in
      const rec = getPassRec(activeVaultId);
      if(!rec) return;
      const localRev = (vaultData?._rev || 0);
      const payload = { user_id: sess.session.user.id, vault_id: id, passrec: { ...rec, rev: localRev, device_id: DEVICE_ID }, vaultblob: blob, rev: localRev, device_id: DEVICE_ID, updated_at: new Date().toISOString() };
      const { error } = await sb.from('vaults').upsert(payload, { onConflict: 'user_id,vault_id' });
      if(!error){
        lastPushedCt = blob.ct;
        localStorage.setItem('nwt-cloud-lastpush', new Date().toISOString());
    localStorage.setItem('nwt-cloud-lastpush-ms', String(Date.now()));
      }else{
        console.warn('[Cloud Sync] Auto-push failed:', error.message||error);
      }
    }catch(e){
      console.warn('[Cloud Sync] Auto-push failed:', e.message||e);
    }
  }, 800); // debounce
}


/* ‚ïê‚ïê DEVICE TRUST ‚ïê‚ïê */
function forgetDevice(){
  clearDeviceToken();
  document.getElementById('forgetDeviceBtn').style.display='none';
  showToast('Device forgotten ‚Äî TOTP required on next login','info');
}
async function updateForgetDeviceBtn(){
  const btn=document.getElementById('forgetDeviceBtn');if(!btn)return;
  const rawB64=sessionStorage.getItem('nwt-rawkey');
  if(!rawB64){btn.style.display='none';return;}
  const rec=getPassRec();
  if(!rec?.verifier){btn.style.display='none';return;}
  const trusted=await verifyDeviceToken(b64decode(rec.verifier));
  if(trusted){
    const days=deviceTokenDaysLeft();
    btn.style.display='';
    btn.title='This device is trusted ('+days+' day'+(days===1?'':'s')+' left). Click to revoke.';
  }else{
    btn.style.display='none';
  }
}

/* ‚ïê‚ïê START APP ‚ïê‚ïê */
let appStarted=false;
let appHydrated=false; // true once hydrateFromVault() has been called
function startApp(){
  if(appStarted)return;appStarted=true;
  // Hydrate globals from vault unless restore already did it
  if(!appHydrated){
    if(!vaultData)vaultData=defaultVault();
    hydrateFromVault();
    applyVaultCloudCreds();
    appHydrated=true;
  }
  highlightModeButtons();
  // Auto-capture snapshot on first load if data is stale (no snapshot today)
  const todaySnap=snapshots.find(s=>s.date===todayKey());
  if(!todaySnap&&getTotalUSD()>0)captureSnapshot();
  updateForgetDeviceBtn();
  updateBackupStatus();checkBackupWarning();
  // If configured, begin background cloud polling
  startCloudPolling();
  render();fetchAllPrices();
  if(autoRefreshTimer)clearInterval(autoRefreshTimer);
  autoRefreshTimer=setInterval(()=>fetchAllPrices(),5*60*1000);
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeAllModals();});
  ['addModal','passModal','exportModal','restoreModal','txModal','cloudModal'].forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.addEventListener('click',e=>{if(e.target===e.currentTarget)closeAllModals();});
  });
}
loadCloudCfg();
initLock();
</script>
</body>
</html>
