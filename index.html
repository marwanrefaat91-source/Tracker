<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<!-- PWA / iOS home screen -->
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Investments"/>

<!-- iOS Home Screen icon (matches login chart) -->
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="167x167" href="icons/apple-touch-icon-167.png">
<link rel="apple-touch-icon" sizes="152x152" href="icons/apple-touch-icon-152.png">
<link rel="apple-touch-icon" sizes="120x120" href="icons/apple-touch-icon-120.png">
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="theme-color" content="#08090c"/>
<title>Investments â€” Marwan</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  /* â”€â”€ Base surfaces â”€â”€ */
  --bg:           #070910;
  --bg-2:         #0b0d14;
  --surface:      rgba(255,255,255,0.028);
  --surface-2:    rgba(255,255,255,0.052);
  --surface-3:    rgba(255,255,255,0.075);

  /* â”€â”€ Borders â”€â”€ */
  --border:       rgba(255,255,255,0.065);
  --border-2:     rgba(255,255,255,0.12);
  --border-3:     rgba(255,255,255,0.2);

  /* â”€â”€ Text â”€â”€ */
  --text:         #eeeef2;
  --text-2:       #9494a8;
  --text-3:       #52526a;
  --text-4:       #30304a;

  /* â”€â”€ Accent: Amber-Gold â”€â”€ */
  --gold:         #c9a84c;
  --gold-bright:  #e8c46a;
  --gold-dim:     rgba(201,168,76,0.15);
  --gold-border:  rgba(201,168,76,0.22);

  /* â”€â”€ Accent: Electric Blue â”€â”€ */
  --blue:         #5b9cf6;
  --blue-dim:     rgba(91,156,246,0.12);
  --blue-border:  rgba(91,156,246,0.28);

  /* â”€â”€ Semantic â”€â”€ */
  --green:        #34d68a;
  --green-dim:    rgba(52,214,138,0.1);
  --red:          #ed5f5f;
  --red-dim:      rgba(237,95,95,0.1);

  /* â”€â”€ Fonts â”€â”€ */
  --mono: 'JetBrains Mono', 'Fira Code', monospace;
  --sans: 'Syne', system-ui, sans-serif;

  /* â”€â”€ Shape â”€â”€ */
  --r:    8px;
  --r-lg: 14px;
  --r-xl: 20px;

  /* â”€â”€ Shadows â”€â”€ */
  --shadow-card: 0 1px 3px rgba(0,0,0,0.4), 0 4px 16px rgba(0,0,0,0.25);
  --shadow-modal: 0 8px 40px rgba(0,0,0,0.6), 0 2px 8px rgba(0,0,0,0.3);
}

html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body {
  min-height: 100vh;
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ Touch / tap â”€â”€ */
button, input, select { -webkit-tap-highlight-color: transparent; }
.btn, .tab-btn, .type-btn, .karat-btn, .user-avatar { touch-action: manipulation; }
:focus-visible { outline: 2px solid rgba(91,156,246,0.6); outline-offset: 2px; }

/* â”€â”€ Atmospheric background â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background:
    radial-gradient(ellipse 70% 50% at 85% 5%,  rgba(201,168,76,0.055) 0%, transparent 55%),
    radial-gradient(ellipse 55% 45% at 5% 95%,  rgba(91,156,246,0.04)  0%, transparent 55%),
    radial-gradient(ellipse 40% 30% at 50% 50%, rgba(201,168,76,0.015) 0%, transparent 60%);
}
/* Subtle grid texture */
body::after {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image:
    linear-gradient(rgba(255,255,255,0.012) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.012) 1px, transparent 1px);
  background-size: 40px 40px;
  mask-image: radial-gradient(ellipse at center, black 0%, transparent 70%);
}

/* â”€â”€ Layout â”€â”€ */
.app { max-width: 1280px; margin: 0 auto; padding: 40px 24px 100px; position: relative; z-index: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.auth-wrap {
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  padding: 24px;
  position: relative; z-index: 1;
}
.auth-card {
  width: 100%; max-width: 400px;
  background: rgba(11,13,20,0.92);
  border: 1px solid var(--border-2);
  border-radius: var(--r-xl);
  padding: 44px 40px;
  box-shadow: var(--shadow-modal);
  animation: fadeUp 0.4s ease both;
  backdrop-filter: blur(12px);
}
.auth-logo { text-align: center; margin-bottom: 36px; }
.auth-logo-icon {
  color: var(--gold); display: inline-flex;
  align-items: center; justify-content: center;
  margin-bottom: 12px;
}
.auth-logo-icon svg { width: 38px; height: 38px; }
.app-title { display: flex; align-items: center; gap: 10px; }
.app-title-icon { width: 22px; height: 22px; display: inline-flex; color: var(--gold); }
.app-title-icon svg { width: 22px; height: 22px; }
.user-avatar svg { width: 15px; height: 15px; }
.auth-logo h1 {
  font-size: 23px; font-weight: 800; letter-spacing: -0.6px;
  color: var(--text);
  background: linear-gradient(135deg, var(--text) 0%, var(--text-2) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.auth-logo p { font-size: 12px; color: var(--text-3); margin-top: 5px; }

.auth-divider {
  display: flex; align-items: center; gap: 10px;
  margin: 22px 0; color: var(--text-4); font-size: 11px;
}
.auth-divider::before, .auth-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field { margin-bottom: 16px; }
.field label {
  display: block; font-size: 10px; font-weight: 700;
  color: var(--text-3); text-transform: uppercase;
  letter-spacing: 1px; margin-bottom: 7px;
}
.field input {
  width: 100%; padding: 11px 14px;
  background: rgba(0,0,0,0.4);
  border: 1px solid var(--border);
  color: var(--text); border-radius: var(--r);
  font-family: var(--sans); font-size: 16px; outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  -webkit-appearance: none;
}
.field input:focus {
  border-color: var(--blue-border);
  box-shadow: 0 0 0 3px rgba(91,156,246,0.08);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  padding: 8px 16px;
  border-radius: var(--r);
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-2);
  font-family: var(--sans); font-size: 13px; font-weight: 600;
  cursor: pointer;
  display: inline-flex; align-items: center; gap: 6px;
  transition: all 0.16s;
  white-space: nowrap;
  letter-spacing: 0.01em;
}
.btn:hover { background: var(--surface-2); color: var(--text); border-color: var(--border-2); }
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

.btn-primary {
  background: var(--blue-dim);
  border-color: var(--blue-border);
  color: var(--blue);
}
.btn-primary:hover { background: rgba(91,156,246,0.2); color: #82b4ff; }

.btn-gold {
  background: var(--gold-dim);
  border-color: var(--gold-border);
  color: var(--gold);
}
.btn-gold:hover { background: rgba(201,168,76,0.22); color: var(--gold-bright); }

.btn-danger {
  background: var(--red-dim);
  border-color: rgba(237,95,95,0.22);
  color: var(--red);
}
.btn-danger:hover { background: rgba(237,95,95,0.18); }

.btn-full { width: 100%; justify-content: center; padding: 13px; }
.btn-sm { padding: 5px 10px; font-size: 11px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header {
  display: flex; align-items: flex-start;
  justify-content: space-between;
  gap: 16px; flex-wrap: wrap;
  margin-bottom: 28px;
}
.header-left h1 {
  font-size: 20px; font-weight: 800; letter-spacing: -0.4px;
  color: var(--text);
}
.header-left p { font-size: 11px; color: var(--text-3); margin-top: 3px; font-family: var(--mono); }
.header-btns { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }

.sync-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 5px var(--green), 0 0 10px rgba(52,214,138,0.4);
  display: inline-block;
  animation: pulse-dot 2.5s ease-in-out infinite;
}
.sync-dot.offline { background: var(--text-4); box-shadow: none; animation: none; }
@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOTAL CARD  (premium terminal feel)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.total-card {
  position: relative; overflow: hidden;
  background: linear-gradient(145deg,
    rgba(201,168,76,0.04) 0%,
    rgba(11,13,20,0.9) 40%,
    rgba(11,13,20,0.9) 100%
  );
  border: 1px solid var(--gold-border);
  border-radius: var(--r-xl);
  padding: 34px 32px 26px;
  margin-bottom: 20px;
  text-align: center;
  box-shadow: 0 1px 0 rgba(201,168,76,0.12) inset, var(--shadow-card);
}
/* Gold top bar */
.total-card::before {
  content: '';
  position: absolute; top: 0; left: 10%; width: 80%; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  opacity: 0.55;
}
/* Corner glow */
.total-card::after {
  content: '';
  position: absolute; top: -40px; right: -40px;
  width: 160px; height: 160px;
  background: radial-gradient(circle, rgba(201,168,76,0.08) 0%, transparent 65%);
  pointer-events: none;
}

.total-label {
  font-size: 9px; font-weight: 700; letter-spacing: 2.5px;
  color: var(--text-3); text-transform: uppercase;
}
.total-usd {
  font-size: 52px; font-weight: 800; letter-spacing: -2.5px;
  color: var(--text); font-family: var(--mono);
  margin: 10px 0 4px;
  text-shadow: 0 2px 20px rgba(201,168,76,0.1);
}
.total-egp {
  font-size: 17px; color: var(--text-3);
  font-family: var(--mono); margin-bottom: 2px;
}
.total-gains {
  display: flex; justify-content: center;
  gap: 8px; margin-top: 14px; flex-wrap: wrap;
}
.gain-pill {
  font-size: 11px; font-family: var(--mono); font-weight: 600;
  padding: 4px 12px; border-radius: 20px;
  border: 1px solid transparent;
}
.gain-pill.positive {
  background: var(--green-dim);
  border-color: rgba(52,214,138,0.2);
  color: var(--green);
}
.gain-pill.negative {
  background: var(--red-dim);
  border-color: rgba(237,95,95,0.2);
  color: var(--red);
}
.gain-pill.neutral {
  background: var(--surface);
  border-color: var(--border);
  color: var(--text-3);
}

.alloc-bar {
  display: flex; height: 4px; border-radius: 4px;
  overflow: hidden; gap: 2px; margin: 20px 0 12px;
  background: rgba(255,255,255,0.03);
}
.alloc-seg {
  height: 100%; border-radius: 4px;
  transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
  min-width: 3px;
}
.legend {
  display: flex; justify-content: center;
  gap: 14px; flex-wrap: wrap;
}
.legend-item {
  display: flex; align-items: center; gap: 5px;
  font-size: 10px; color: var(--text-3);
}
.legend-dot { width: 6px; height: 6px; border-radius: 50%; }
.mode-row { display: flex; justify-content: center; gap: 4px; margin-top: 14px; }
.mode-row .btn { padding: 3px 10px; font-size: 11px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RATES BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rates-banner {
  display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
}
.rate-chip {
  flex: 1; min-width: 90px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 10px 13px;
  transition: border-color 0.2s, background 0.2s;
}
.rate-chip:hover { border-color: var(--border-2); background: var(--surface-2); }
.rate-top { display: flex; justify-content: space-between; align-items: center; gap: 6px; }
.rate-label {
  font-size: 9px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 1px; color: var(--text-3);
}
.rate-value {
  font-size: 13px; font-family: var(--mono);
  font-weight: 600; color: var(--text);
}
.rate-chg { font-size: 10px; font-family: var(--mono); font-weight: 600; margin-top: 3px; }
.rate-chg.positive { color: var(--green); }
.rate-chg.negative { color: var(--red); }
.rate-meta { font-size: 8px; color: var(--text-4); margin-top: 2px; font-family: var(--mono); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs {
  display: flex; gap: 2px; margin-bottom: 22px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r); padding: 3px;
}
.tab-btn {
  flex: 1; padding: 8px 12px;
  border-radius: 6px; border: none;
  background: transparent; color: var(--text-3);
  cursor: pointer;
  font-family: var(--sans); font-size: 13px; font-weight: 700;
  transition: all 0.16s; text-align: center; letter-spacing: 0.01em;
}
.tab-btn:hover { color: var(--text-2); }
.tab-btn.active {
  background: var(--surface-3);
  color: var(--text);
  border: 1px solid var(--border-2);
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.tab-panel { display: none; }
.tab-panel.active { display: block; animation: fadeUp 0.2s ease both; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOOLBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toolbar { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; align-items: center; }
.search-wrap { position: relative; flex: 1; min-width: 160px; }
.search-icon {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  color: var(--text-3); font-size: 13px; pointer-events: none;
}
.search-input {
  width: 100%; padding: 8px 10px 8px 32px;
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text); border-radius: var(--r);
  font-family: var(--sans); font-size: 16px; outline: none;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}
.search-input:focus { border-color: var(--blue-border); }
.sort-select {
  padding: 8px 10px;
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text-2); border-radius: var(--r);
  font-family: var(--sans); font-size: 13px; outline: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ASSET CARDS  (the centrepiece)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(290px, 1fr));
  gap: 14px;
}
.card {
  border-radius: var(--r-lg);
  border: 1px solid var(--border);
  padding: 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s, transform 0.15s, box-shadow 0.2s;
  animation: fadeUp 0.28s ease both;
  box-shadow: var(--shadow-card);
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(0,0,0,0.35);
}
/* Thin colour top bar */
.card::before {
  content: '';
  position: absolute; top: 0; left: 16px; right: 16px; height: 1px;
  border-radius: 0 0 3px 3px;
  background: var(--card-color, white);
  opacity: 0.4;
  transition: opacity 0.2s;
}
.card:hover::before { opacity: 0.7; }

.card-remove {
  position: absolute; top: 11px; right: 11px;
  background: transparent; border: none;
  color: var(--text-4); font-size: 13px;
  cursor: pointer; opacity: 0;
  transition: opacity 0.15s, color 0.15s;
  padding: 3px 6px; border-radius: 5px;
}
.card:hover .card-remove { opacity: 1; }
.card-remove:hover { color: var(--red); background: var(--red-dim); }

.card-header {
  display: flex; align-items: center;
  gap: 9px; margin-bottom: 16px;
}
.card-icon { font-size: 18px; line-height: 1; }
.card-label { font-size: 14px; font-weight: 700; flex: 1; }
.card-ticker { font-size: 10px; color: var(--text-3); font-weight: 500; margin-left: 3px; }
.card-pct {
  font-size: 11px; font-weight: 700;
  font-family: var(--mono); opacity: 0.7;
}

.card-field {
  display: flex; align-items: center;
  justify-content: space-between;
  margin-bottom: 9px; gap: 8px;
}
.card-field-label { font-size: 10px; color: var(--text-3); font-weight: 600; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.5px; }
.holding-wrap { display: flex; align-items: center; gap: 6px; }
.holding-input {
  width: 100px; padding: 5px 8px;
  background: rgba(0,0,0,0.45);
  border: 1px solid var(--border);
  color: var(--text); border-radius: 6px;
  font-family: var(--mono); font-size: 13px;
  outline: none; text-align: right;
  transition: border-color 0.2s;
}
.holding-input:focus { border-color: var(--blue-border); }
.holding-unit { font-size: 10px; color: var(--text-3); font-weight: 600; letter-spacing: 0.5px; }

.price-row { display: flex; justify-content: space-between; margin-bottom: 7px; }
.price-label { font-size: 10px; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; }
.price-value { font-size: 12px; font-family: var(--mono); color: var(--text-2); }

.card-spark-wrap {
  /* Negative margins so chart bleeds to card edges, clipped by overflow:hidden on .card */
  margin: 10px -20px 0;
  position: relative;
  display: block;
  background: transparent;
}
.card-spark-canvas {
  display: block;
  width: 100%;
  height: 110px;
  cursor: crosshair;
}
.card-spark-ranges {
  display: flex;
  justify-content: center;
  gap: 1px;
  padding: 4px 12px 6px;
  background: transparent;
}
.spark-range-btn {
  background: none;
  border: none;
  color: var(--text-3);
  font-size: 10px;
  font-family: var(--mono);
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
  letter-spacing: 0.3px;
  transition: color 0.15s, background 0.15s;
  touch-action: manipulation;
}
.spark-range-btn:hover { color: var(--text-2); background: rgba(255,255,255,0.05); }
.spark-range-btn.active { color: var(--card-color, #d4a847); background: rgba(255,255,255,0.06); }
.card-spark-tooltip {
  position: absolute;
  top: 4px; left: 14px;
  font-size: 11px;
  font-family: var(--mono);
  font-weight: 600;
  color: var(--text);
  pointer-events: none;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.1s;
}
.value-row {
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 14px; padding-top: 12px;
  border-top: 1px solid var(--border);
}
.value-label { font-size: 10px; color: var(--text-3); font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; }
.value-usd { font-size: 17px; font-weight: 700; font-family: var(--mono); }

.gain-row { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
.gain-value { font-size: 12px; font-family: var(--mono); font-weight: 600; }
.gain-value.positive { color: var(--green); }
.gain-value.negative { color: var(--red); }
.gain-value.neutral { color: var(--text-3); }

.avgcost-wrap { display: flex; align-items: center; gap: 5px; }
.avgcost-input {
  width: 80px; padding: 4px 7px;
  background: rgba(0,0,0,0.35);
  border: 1px solid var(--border);
  color: var(--text); border-radius: 6px;
  font-family: var(--mono); font-size: 12px;
  outline: none; text-align: right;
  transition: border-color 0.2s;
}
.avgcost-input:focus { border-color: rgba(201,168,76,0.5); }
.avgcost-ccy { font-size: 10px; color: var(--text-3); font-weight: 600; }

.manual-input {
  width: 80px; padding: 4px 7px;
  background: rgba(0,0,0,0.35);
  border: 1px solid var(--gold-border);
  color: var(--gold); border-radius: 6px;
  font-family: var(--mono); font-size: 12px;
  outline: none; text-align: right;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tx-btn-row { margin-top: 10px; }
.tx-log {
  margin-top: 8px;
  background: rgba(0,0,0,0.25);
  border: 1px solid var(--border);
  border-radius: 8px; padding: 8px;
}
.tx-log-title {
  font-size: 9px; font-weight: 700; color: var(--text-3);
  text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 7px;
}
.tx-item {
  display: flex; align-items: center;
  gap: 6px; font-size: 11px; margin-bottom: 5px;
}
.tx-type {
  font-weight: 700; font-size: 9px;
  padding: 2px 5px; border-radius: 4px;
  text-transform: uppercase; letter-spacing: 0.3px;
}
.tx-type.buy    { background: var(--green-dim); color: var(--green); }
.tx-type.sell   { background: var(--red-dim); color: var(--red); }
.tx-type.dividend { background: var(--gold-dim); color: var(--gold); }
.tx-date { color: var(--text-3); flex: 1; font-family: var(--mono); }
.tx-detail { font-family: var(--mono); color: var(--text-2); }
.tx-remove {
  background: none; border: none;
  color: var(--text-4); cursor: pointer;
  font-size: 11px; padding: 0 2px; transition: color 0.15s;
}
.tx-remove:hover { color: var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-state { text-align: center; padding: 64px 20px; color: var(--text-3); }
.empty-state .e-icon { font-size: 40px; display: block; margin-bottom: 14px; opacity: 0.6; }
.empty-state p { font-size: 14px; line-height: 1.7; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex; align-items: center; justify-content: center;
  z-index: 100; padding: 20px;
  backdrop-filter: blur(6px);
}
.modal-overlay.hidden { display: none; }
.modal {
  background: #0b0d14;
  border: 1px solid var(--border-2);
  border-radius: 18px; padding: 28px;
  width: 100%; max-width: 440px;
  max-height: 90vh; overflow-y: auto;
  box-shadow: var(--shadow-modal);
  animation: fadeUp 0.2s ease both;
}
.modal-title {
  font-size: 16px; font-weight: 800; margin-bottom: 22px;
  display: flex; justify-content: space-between; align-items: center;
  letter-spacing: -0.2px;
}
.modal-close {
  background: none; border: none;
  color: var(--text-3); cursor: pointer;
  font-size: 17px; padding: 2px 6px;
  border-radius: 5px; transition: all 0.15s;
}
.modal-close:hover { color: var(--text); background: var(--surface-2); }
.modal-footer { display: flex; gap: 8px; margin-top: 22px; justify-content: flex-end; }
.form-fields { display: none; }
.form-fields.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERFORMANCE TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.perf-metrics {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px; margin-bottom: 24px;
}
.perf-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 14px 16px;
  transition: border-color 0.2s;
}
.perf-card:hover { border-color: var(--border-2); }
.perf-card-label {
  font-size: 9px; color: var(--text-3); font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px;
}
.perf-card-value {
  font-size: 18px; font-weight: 800;
  font-family: var(--mono); margin: 7px 0 3px;
}
.perf-card-value.positive { color: var(--green); }
.perf-card-value.negative { color: var(--red); }
.perf-card-sub { font-size: 10px; color: var(--text-3); line-height: 1.5; }
.chart-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-lg); padding: 18px;
  margin-bottom: 16px;
}
.chart-section-title {
  font-size: 12px; font-weight: 700;
  color: var(--text-2); margin-bottom: 14px;
  display: flex; justify-content: space-between; align-items: center;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.chart-range-btns { display: flex; gap: 4px; }
.range-btn {
  padding: 3px 9px; font-size: 10px; border-radius: 5px;
  background: transparent; border: 1px solid var(--border);
  color: var(--text-3); cursor: pointer;
  font-family: var(--sans); font-weight: 700;
  transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.3px;
}
.range-btn.active {
  background: var(--surface-2);
  color: var(--text); border-color: var(--border-2);
}
.chart-wrap { position: relative; }
.chart-empty { text-align: center; padding: 40px; color: var(--text-3); font-size: 13px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.snap-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.snap-table th {
  font-size: 9px; font-weight: 700; color: var(--text-3);
  text-transform: uppercase; letter-spacing: 0.8px;
  padding: 8px 12px; text-align: left;
  border-bottom: 1px solid var(--border);
}
.snap-table td {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.025);
  font-family: var(--mono); font-size: 12px;
}
.snap-table tr:last-child td { border-bottom: none; }
.snap-table tr:hover td { background: var(--surface); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast-container {
  position: fixed; bottom: 24px; right: 24px;
  z-index: 200; display: flex; flex-direction: column; gap: 8px;
}
.toast {
  background: rgba(15,17,25,0.97);
  border: 1px solid var(--border-2);
  border-radius: 10px;
  padding: 11px 16px; font-size: 13px;
  font-weight: 600; color: var(--text);
  animation: slideIn 0.25s ease both;
  display: flex; align-items: center;
  gap: 8px; min-width: 220px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  backdrop-filter: blur(8px);
}
.toast.success { border-color: rgba(52,214,138,0.3); }
.toast.error   { border-color: rgba(237,95,95,0.3); color: var(--red); }
.toast.info    { border-color: var(--blue-border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading-overlay {
  position: fixed; inset: 0;
  background: rgba(7,9,16,0.85);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 150; backdrop-filter: blur(6px);
}
.loading-overlay.hidden { display: none; }
.spinner {
  width: 34px; height: 34px;
  border: 2px solid var(--border);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
.loading-text { margin-top: 14px; font-size: 12px; color: var(--text-3); font-family: var(--mono); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYNC STATUS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sync-status {
  display: flex; align-items: center; gap: 6px;
  font-size: 10px; color: var(--text-3);
  padding: 5px 10px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; white-space: nowrap;
  font-family: var(--mono);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(16px); }
  to   { opacity: 1; transform: translateX(0); }
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION LABEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.section-label {
  font-size: 9px; font-weight: 700; color: var(--text-3);
  text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USER MENU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.user-menu-wrap { position: relative; }
.user-menu-dropdown {
  position: absolute; top: calc(100% + 8px); right: 0;
  background: #0d0f18;
  border: 1px solid var(--border-2);
  border-radius: var(--r-lg); padding: 6px;
  min-width: 210px; z-index: 50;
  box-shadow: var(--shadow-modal);
  animation: fadeUp 0.15s ease both;
}
.user-menu-dropdown.hidden { display: none; }
.user-menu-item {
  display: flex; align-items: center; gap: 8px;
  width: 100%; padding: 9px 12px;
  background: none; border: none;
  color: var(--text-2); cursor: pointer;
  font-family: var(--sans); font-size: 12px;
  font-weight: 600; border-radius: 7px;
  text-align: left; transition: all 0.14s;
}
.user-menu-item:hover { background: var(--surface-2); color: var(--text); }
.user-menu-item.danger { color: var(--red); }
.user-email {
  font-size: 10px; color: var(--text-3);
  padding: 6px 12px 6px; border-bottom: 1px solid var(--border);
  margin-bottom: 4px; font-family: var(--mono);
}
.user-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--gold-dim); border: 1px solid var(--gold-border);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 800; color: var(--gold);
  cursor: pointer; transition: all 0.2s;
}
.user-avatar:hover { background: rgba(201,168,76,0.22); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACCOUNT MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.account-section {
  margin-bottom: 22px; padding-bottom: 22px;
  border-bottom: 1px solid var(--border);
}
.account-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.account-section-title {
  font-size: 9px; font-weight: 700; color: var(--text-3);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 13px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD MODAL â€” ASSET TYPE SELECTOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.type-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
.type-btn {
  padding: 12px 8px; border: 1px solid var(--border); border-radius: var(--r);
  background: var(--surface); color: var(--text-3); cursor: pointer;
  font-family: var(--sans); font-size: 12px; font-weight: 700;
  text-align: center; transition: all 0.16s;
  display: flex; flex-direction: column; align-items: center; gap: 3px;
}
.type-btn:hover { border-color: var(--border-2); color: var(--text); background: var(--surface-2); }
.type-btn .ti { font-size: 20px; display: block; margin-bottom: 2px; }
.type-desc { font-size: 9px; font-weight: 400; color: var(--text-3); line-height: 1.3; }
.type-btn.selected {
  background: var(--blue-dim); border-color: var(--blue-border); color: var(--blue);
}
.type-btn.selected .type-desc { color: rgba(91,156,246,0.6); }

.add-hint {
  font-size: 12px; color: var(--text-3);
  background: rgba(255,255,255,0.018);
  border: 1px solid var(--border);
  border-radius: var(--r); padding: 10px 13px;
  margin-bottom: 16px; line-height: 1.65;
}
.add-hint b { color: var(--text-2); font-weight: 600; }
.field-row { display: flex; gap: 12px; }
.field-row .field { margin-bottom: 14px; }
.field-req { color: var(--blue); font-size: 10px; }
.field-opt { color: var(--text-3); font-size: 10px; font-weight: 400; }
.field-select {
  width: 100%; padding: 10px 13px;
  background: rgba(0,0,0,0.35); border: 1px solid var(--border);
  color: var(--text); border-radius: var(--r);
  font-family: var(--sans); font-size: 13px; outline: none;
  transition: border-color 0.2s; cursor: pointer;
}
.field-select:focus { border-color: var(--blue-border); }
.field-select option { background: #0b0d14; }
.input-unit-wrap { position: relative; display: flex; align-items: center; }
.input-unit-wrap input { width: 100%; padding-right: 52px; }
.input-unit {
  position: absolute; right: 10px;
  font-size: 10px; font-weight: 700; color: var(--text-3);
  font-family: var(--mono); pointer-events: none;
  background: rgba(0,0,0,0.4); padding: 2px 5px; border-radius: 4px;
}
.karat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 6px; }
.karat-btn {
  padding: 10px 6px; border: 1px solid var(--border); border-radius: var(--r);
  background: var(--surface); cursor: pointer; font-family: var(--sans);
  text-align: center; transition: all 0.16s;
  display: flex; flex-direction: column; align-items: center; gap: 3px;
}
.karat-btn:hover { border-color: var(--gold-border); background: var(--gold-dim); }
.karat-num { font-size: 14px; font-weight: 800; color: var(--text-2); }
.karat-pct { font-size: 9px; color: var(--text-3); font-family: var(--mono); }
.karat-btn.selected { background: var(--gold-dim); border-color: var(--gold-border); }
.karat-btn.selected .karat-num { color: var(--gold); }
.karat-btn.selected .karat-pct { color: rgba(201,168,76,0.6); }
.add-preview {
  background: rgba(52,214,138,0.05);
  border: 1px solid rgba(52,214,138,0.15);
  border-radius: var(--r); padding: 10px 14px;
  margin-top: 4px; margin-bottom: 8px;
  font-size: 12px; color: var(--green);
  font-family: var(--mono);
  display: flex; align-items: center; gap: 8px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 820px) {
  .app { padding: 28px 18px 80px; }
  .cards-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
}

@media (max-width: 600px) {
  .app { padding: 22px 14px 80px; }
  .header { margin-bottom: 18px; }
  .header-left h1 { font-size: 18px; }
  .header-btns { width: 100%; justify-content: space-between; gap: 8px; }
  #refreshBtn { flex: 1; justify-content: center; }
  .header .btn.btn-primary { flex: 1; justify-content: center; }
  .sync-status { order: -1; width: 100%; justify-content: center; }
  .total-card { padding: 24px 18px 18px; border-radius: 16px; }
  .total-usd { font-size: 38px; letter-spacing: -1.5px; }
  .total-egp { font-size: 14px; }
  .legend { gap: 10px; }
  .rates-banner { gap: 8px; }
  .rate-chip { min-width: 0; flex: 1 1 130px; }
  .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .tabs::-webkit-scrollbar { display: none; }
  .tab-btn { flex: 0 0 auto; min-width: 120px; }
  .toolbar { gap: 8px; }
  .search-wrap { min-width: 0; flex: 1 1 100%; }
  .sort-select { width: 100%; }
  .cards-grid { grid-template-columns: 1fr; gap: 12px; }
  .card { padding: 16px; }
  .card-remove { opacity: 1; }
  .holding-input { width: 110px; }
  .avgcost-input, .manual-input { width: 88px; }
  .type-grid { grid-template-columns: repeat(2, 1fr); }
  .perf-metrics { grid-template-columns: 1fr 1fr; }
  .field-row { flex-direction: column; gap: 0; }
  .karat-grid { grid-template-columns: repeat(2, 1fr); }
  .modal-overlay { padding: 12px; }
  .modal { padding: 18px; border-radius: 16px; max-height: 92vh; }
  .modal-footer { flex-direction: column-reverse; }
  .modal-footer .btn { width: 100%; justify-content: center; padding: 12px; }
  #tab-history { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  #tab-markets { overflow-x: hidden; }
  .snap-table { min-width: 560px; }
}

@media (max-width: 380px) {
  .app { padding: 16px 12px 72px; }
  .total-usd { font-size: 32px; letter-spacing: -1px; }
  .gain-pill { font-size: 10px; }
  .user-avatar { width: 30px; height: 30px; font-size: 12px; }
}

/* iOS safe-area */
@supports (padding: max(0px)) {
  .app {
    padding-left: max(14px, env(safe-area-inset-left));
    padding-right: max(14px, env(safe-area-inset-right));
    padding-bottom: max(100px, calc(env(safe-area-inset-bottom) + 80px));
  }
  .toast-container {
    right: max(16px, env(safe-area-inset-right));
    bottom: max(24px, calc(env(safe-area-inset-bottom) + 16px));
  }
  .modal-overlay { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
  .auth-wrap { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
}
/* â”€â”€ Markets Tab â”€â”€ */
/* Keep dashboard/performance/history constrained to original width */
#tab-dashboard, #tab-performance, #tab-history {
  max-width: 932px; /* 980 - 48px padding already applied by .app */
}
.market-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 14px 16px;
  transition: border-color 0.2s;
}
.market-card:hover { border-color: var(--border-2); }
.market-card-header {
  display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;
}
.market-name { font-family: var(--sans); font-weight: 600; font-size: 14px; color: var(--text); }
.market-index { font-family: var(--mono); font-size: 11px; color: var(--text-3); margin-top: 2px; }
.market-status {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 9px; border-radius: 20px; font-size: 11px; font-weight: 600;
  font-family: var(--mono); letter-spacing: 0.3px; white-space: nowrap;
}
.status-open    { background: rgba(52,214,138,0.12); color: var(--green); border: 1px solid rgba(52,214,138,0.25); }
.status-closed  { background: rgba(148,148,168,0.1); color: var(--text-3); border: 1px solid var(--border); }
.status-pre     { background: rgba(91,156,246,0.12); color: var(--blue);  border: 1px solid var(--blue-border); }
.status-after   { background: rgba(201,168,76,0.12); color: var(--gold);  border: 1px solid var(--gold-border); }
.status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
.status-open .status-dot { animation: mkt-pulse 1.8s infinite; }
@keyframes mkt-pulse { 0%,100%{opacity:1} 50%{opacity:0.35} }
.market-hours-row {
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);
}
.market-hours-label { font-size: 11px; color: var(--text-3); }
.market-hours-val { font-family: var(--mono); font-size: 11px; color: var(--text-2); }
.market-region-tag {
  font-size: 10px; color: var(--text-4); font-family: var(--mono);
  background: var(--surface-2); padding: 2px 6px; border-radius: 4px;
}
.markets-section-title {
  font-size: 11px; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase;
  color: var(--text-3); margin: 18px 0 10px; grid-column: 1/-1;
}

/* â”€â”€ Feature 10: Asset Notes â”€â”€ */
.card-notes-wrap {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid var(--border);
}
.card-notes-input {
  width: 100%;
  background: transparent;
  border: none;
  border-bottom: 1px dashed var(--border);
  color: var(--text-3);
  font-family: var(--sans);
  font-size: 11px;
  line-height: 1.6;
  padding: 4px 0;
  resize: none;
  outline: none;
  transition: color 0.2s, border-color 0.2s;
  overflow: hidden;
  min-height: 22px;
}
.card-notes-input:focus {
  color: var(--text-2);
  border-bottom-color: var(--border-2);
}
.card-notes-input::placeholder { color: var(--text-4); font-style: italic; }

/* â”€â”€ Feature 7: Scenario slider â”€â”€ */
input[type=range] {
  -webkit-appearance: none;
  height: 4px;
  background: var(--surface-3);
  border-radius: 2px;
  outline: none;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  border-radius: 50%;
  background: var(--gold);
  cursor: pointer;
  border: 2px solid var(--bg);
  box-shadow: 0 0 0 1px var(--gold-border);
}


</style>
</head>
<body>

<!-- â•â• AUTH SCREEN â•â• -->
<div id="authScreen" class="auth-wrap">
  <div class="auth-card">
    <div class="auth-logo">
      <span class="auth-logo-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" role="img" focusable="false" aria-hidden="true">
          <path d="M4 19V5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 19H20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 15l4-4 3 3 6-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="7" cy="15" r="1.5" fill="currentColor"/>
          <circle cx="11" cy="11" r="1.5" fill="currentColor"/>
          <circle cx="14" cy="14" r="1.5" fill="currentColor"/>
          <circle cx="20" cy="7" r="1.5" fill="currentColor"/>
        </svg>
      </span>
      <h1>Investments</h1>
      <p>Marwan's Portfolio Tracker</p>
    </div>
    
    <div class="field">
      <label>Email</label>
      <input type="email" id="authEmail" placeholder="you@example.com" autocomplete="email"
             onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('authPassword').focus();}"/>
    </div>
    <div class="field">
      <label>Password</label>
      <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"
             onkeydown="if(event.key==='Enter')signIn()"/>
    </div>
    <div style="display:flex;gap:8px;margin-top:6px;">
      <button class="btn btn-primary btn-full" id="signInBtn" onclick="signIn()" style="padding:14px 20px;font-size:15px;">Sign In</button>
    </div>
    <p id="authMsg" style="font-size:12px;color:var(--text-3);margin-top:12px;text-align:center;"></p>
    <p style="font-size:11px;color:var(--text-3);text-align:center;margin-top:16px;">
      <a href="#" onclick="toggleSignUp();return false;" style="color:var(--blue);text-decoration:none;" id="authToggleLink">Need an account? Sign up</a>
    </p>
  </div>
</div>

<!-- â•â• MAIN APP â•â• -->
<div id="mainApp" class="app" style="display:none;">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1 class="app-title"><span class="app-title-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" role="img" focusable="false" aria-hidden="true">
          <path d="M4 19V5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 19H20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 15l4-4 3 3 6-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>Investments</h1>
      <p id="headerSub">Loadingâ€¦</p>
    </div>
    <div class="header-btns">
      <div class="sync-status" id="syncStatus">
        <span class="sync-dot offline" id="syncDot"></span>
        <span id="syncLabel">Connectingâ€¦</span>
      </div>
      <button class="btn" id="refreshBtn" onclick="fetchAllPrices()">ğŸ”„ Refresh</button>
      <button class="btn btn-primary" onclick="openAddModal()">ï¼‹ Add Asset</button>
      <div class="user-menu-wrap">
        <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()" aria-label="Account menu"></div>
        <div class="user-menu-dropdown hidden" id="userMenuDropdown">
          <div class="user-email" id="userEmail"></div>
          <button class="user-menu-item" onclick="openAccountModal();closeUserMenu()">âš™ï¸ Account</button>
          <button class="user-menu-item" onclick="downloadCSV();closeUserMenu()">ğŸ“¥ Export CSV</button>
          <button class="user-menu-item" onclick="printView();closeUserMenu()">ğŸ–¨ï¸ Print View</button>
          <button class="user-menu-item danger" onclick="signOut();closeUserMenu()">â†’ Sign Out</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Total Card -->
  <div class="total-card">
    <div class="total-label">Total Portfolio Value</div>
    <div class="total-usd" id="totalUSD">$0.00</div>
    <div class="total-egp" id="totalEGP"></div>
    <div class="total-gains">
      <span class="gain-pill neutral" id="totalUnrealized">Unrealized: â€”</span>
      <span class="gain-pill neutral" id="totalToday">Today: â€”</span>
    </div>
    <div class="alloc-bar" id="allocBar"></div>
    <div class="legend" id="legend"></div>
    <div class="mode-row">
      <button class="btn btn-sm" id="mUsd" onclick="setMode('usd')">$</button>
      <button class="btn btn-sm" id="mPct" onclick="setMode('pct')">%</button>
      <button class="btn btn-sm btn-primary" id="mBoth" onclick="setMode('both')">Both</button>
    </div>
    <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center;">
      <button class="btn btn-sm" id="currToggleBtn" onclick="toggleDisplayCurrency()" style="min-width:130px;justify-content:center;">
        <span id="currToggleLabel">ğŸŒ View in EGP</span>
      </button>
      <button class="btn btn-sm" onclick="openTargetAllocModal()" title="Set target allocations">ğŸ¯ Targets</button>
      <button class="btn btn-sm" onclick="openScenarioModal()" title="What-If calculator">ğŸ“ Scenario</button>
    </div>
    <div id="driftBar" style="display:none;margin-top:14px;padding-top:12px;border-top:1px solid var(--border)"></div>
  </div>

  <!-- Rates Banner -->
  <div class="rates-banner" id="ratesBanner"></div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard',this)">Dashboard</button>
    <button class="tab-btn" onclick="switchTab('performance',this)">Performance</button>
    <button class="tab-btn" onclick="switchTab('history',this)">History</button>
    <button class="tab-btn" onclick="switchTab('markets',this)">Markets</button>
  </div>

  <!-- Dashboard Tab -->
  <div class="tab-panel active" id="tab-dashboard">
    <div class="toolbar">
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input class="search-input" type="text" placeholder="Search assetsâ€¦" oninput="onSearch(this.value)"/>
      </div>
      <select class="sort-select" onchange="renderCards()">
        <option value="value-desc">Sort: Value â†“</option>
        <option value="gain-desc">Sort: Gain â†“</option>
        <option value="today-desc">Sort: Today â†“</option>
        <option value="name-asc">Sort: Name A-Z</option>
      </select>
    </div>
    <div class="cards-grid" id="cardsGrid"></div>
  </div>

  <!-- Performance Tab -->
  <div class="tab-panel" id="tab-performance">
    <div class="perf-metrics" id="perfMetrics"></div>
    <div class="chart-section">
      <div class="chart-section-title">
        Portfolio Value
        <div class="chart-range-btns">
          <button class="range-btn active" onclick="setChartRange('1M',this)">1M</button>
          <button class="range-btn" onclick="setChartRange('3M',this)">3M</button>
          <button class="range-btn" onclick="setChartRange('6M',this)">6M</button>
          <button class="range-btn" onclick="setChartRange('1Y',this)">1Y</button>
          <button class="range-btn" onclick="setChartRange('ALL',this)">ALL</button>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="valueChart"></canvas>
        <div class="chart-empty" id="chartEmpty" style="display:none">No data for this range yet.<br><span style="font-size:12px;">Use <b>ğŸ“… Seed History</b> in the History tab to backfill data from Jan 30, 2026.</span></div>
      </div>
    </div>
    <div class="chart-section">
      <div class="chart-section-title">Allocation Over Time</div>
      <canvas id="allocChart"></canvas>
    </div>
    <!-- Feature 8: Attribution -->
    <div id="attributionSection" style="display:none;"></div>
    <!-- Feature 6: Currency Exposure -->
    <div id="currencyExposureSection" style="display:none;"></div>
    <!-- Feature 5: Correlation -->
    <div id="correlationSection" style="display:none;"></div>
  </div>

  <!-- History Tab -->
  <div class="tab-panel" id="tab-history">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
      <div class="section-label">Snapshot History</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="btn btn-sm" onclick="openManualSnapshotModal()" style="padding:5px 12px;font-size:11px;">âœï¸ Manual Entry</button>
        <button class="btn btn-sm" onclick="openFetchPastDayModal()" style="padding:5px 12px;font-size:11px;">ğŸ“¡ Fetch Past Day</button>
        <button class="btn btn-sm" onclick="clearHistory()" style="padding:5px 12px;font-size:11px;color:var(--red);border-color:var(--red);">ğŸ—‘ Clear History</button>
      </div>
    </div>

    <!-- Manual Snapshot Entry (inline) -->
    <div id="manualSnapForm" style="display:none;background:var(--surface);border:1px solid var(--border-2);border-radius:var(--r-lg);padding:16px;margin-bottom:16px;">
      <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:12px;">Add / Overwrite Snapshot</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <label style="font-size:11px;color:var(--text-3);display:block;margin-bottom:4px;">Date (Cairo)</label>
          <input id="manualSnapDate" type="date" style="background:var(--surface-2);border:1px solid var(--border-2);border-radius:var(--r);color:var(--text);padding:7px 10px;font-size:13px;font-family:var(--mono);" />
        </div>
        <div>
          <label style="font-size:11px;color:var(--text-3);display:block;margin-bottom:4px;">Total Value (USD)</label>
          <input id="manualSnapValue" type="number" step="0.01" placeholder="e.g. 92123.45" style="background:var(--surface-2);border:1px solid var(--border-2);border-radius:var(--r);color:var(--text);padding:7px 10px;font-size:13px;font-family:var(--mono);width:160px;" />
        </div>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-primary" onclick="saveManualSnapshot()" style="padding:7px 16px;font-size:12px;">Save</button>
          <button class="btn" onclick="document.getElementById('manualSnapForm').style.display='none'" style="padding:7px 12px;font-size:12px;">Cancel</button>
        </div>
      </div>
      <p style="font-size:10px;color:var(--text-3);margin-top:10px;">âš ï¸ If a snapshot already exists for this date it will be overwritten. Asset breakdown will be empty for manually entered dates.</p>
    </div>

    <!-- Fetch Past Day Form (inline) -->
    <div id="fetchPastDayForm" style="display:none;background:var(--surface);border:1px solid var(--border-2);border-radius:var(--r-lg);padding:16px;margin-bottom:16px;">
      <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:12px;">ğŸ“¡ Fetch Historical Snapshot</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <label style="font-size:11px;color:var(--text-3);display:block;margin-bottom:4px;">Date (Cairo)</label>
          <input id="fetchPastDate" type="date" style="background:var(--surface-2);border:1px solid var(--border-2);border-radius:var(--r);color:var(--text);padding:7px 10px;font-size:13px;font-family:var(--mono);" />
        </div>
        <div style="display:flex;gap:6px;align-items:flex-end;">
          <button class="btn btn-primary" onclick="runFetchPastDay()" id="fetchPastDayBtn" style="padding:7px 16px;font-size:12px;">Fetch</button>
          <button class="btn" onclick="document.getElementById('fetchPastDayForm').style.display='none'" style="padding:7px 12px;font-size:12px;">Cancel</button>
        </div>
      </div>
      <p style="font-size:10px;color:var(--text-3);margin-top:10px;">ğŸ“ˆ Fetches the actual <b>closing price</b> for each asset on the selected date directly from Yahoo Finance (via historical OHLCV data). Cash &amp; deposits use the FX closing rate for that day. Works entirely client-side â€” no edge function needed.</p>
      <div id="fetchPastDayLog" style="display:none;margin-top:10px;background:var(--surface-2);border-radius:var(--r);padding:10px;font-size:10px;font-family:var(--mono);color:var(--text-2);white-space:pre-wrap;max-height:120px;overflow-y:auto;"></div>
    </div>

    <!-- View Toggle: Total vs Per-Asset -->
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;" id="histViewToggleRow">
      <span style="font-size:11px;color:var(--text-3);">View:</span>
      <button id="histViewTotalBtn" class="btn btn-sm btn-primary" onclick="setHistView('total')" style="padding:4px 12px;font-size:11px;">ğŸ“Š Portfolio Total</button>
      <button id="histViewAssetBtn" class="btn btn-sm" onclick="setHistView('asset')" style="padding:4px 12px;font-size:11px;">ğŸ“‹ Per Asset</button>
      <select id="histAssetSelect" style="display:none;background:var(--surface-2);border:1px solid var(--border-2);border-radius:var(--r);color:var(--text);padding:4px 8px;font-size:11px;font-family:var(--mono);" onchange="renderHistoryTab()"></select>
    </div>

    <div id="snapEmpty" class="empty-state" style="display:none">
      <span class="e-icon">ğŸ“…</span>
      <p>No snapshots yet. They're captured automatically when you refresh prices.</p>
    </div>

    <!-- Total view table -->
    <table class="snap-table" id="snapTable" style="display:none">
      <thead><tr>
        <th>Date</th><th id="histValHeader">Value (USD)</th><th id="histSecHeader">Value (EGP)</th><th>Change</th><th>Change %</th><th>Assets</th>
      </tr></thead>
      <tbody id="snapBody"></tbody>
    </table>

    <!-- Per-asset view table -->
    <table class="snap-table" id="snapAssetTable" style="display:none">
      <thead><tr>
        <th>Date</th><th id="assetHistValHeader">Value (USD)</th><th id="assetHistSecHeader">Value (EGP)</th><th>Change</th><th>Change %</th><th>% of Portfolio</th>
      </tr></thead>
      <tbody id="snapAssetBody"></tbody>
    </table>
  </div>

  <!-- Markets Tab -->
  <div class="tab-panel" id="tab-markets">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
      <div class="section-label">Global Markets</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span id="marketsCairoTime" style="font-family:var(--mono);font-size:12px;color:var(--text-2);"></span>
        <button class="btn btn-sm" onclick="renderMarketsTab()" style="padding:5px 12px;font-size:11px;">âŸ³ Refresh</button>
      </div>
    </div>
    <div id="marketsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;"></div>
  </div>

</div><!-- /.app -->

<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Loadingâ€¦</div>
</div>

<!-- â•â• TOAST CONTAINER â•â• -->
<div class="toast-container" id="toastContainer"></div>

<!-- â•â• ADD ASSET MODAL â•â• -->
<div class="modal-overlay hidden" id="addModal" onclick="if(event.target===this)closeAddModal()">
  <div class="modal" style="max-width:460px;">
    <div class="modal-title">
      <span id="addModalTitle">Add Asset</span>
      <button class="modal-close" onclick="closeAddModal()">âœ•</button>
    </div>

    <!-- Type Selector -->
    <div class="type-grid" id="typeGrid">
      <button class="type-btn selected" data-type="etf" onclick="selectType('etf',this)">
        <span class="ti">ğŸ“ˆ</span>ETF / Fund
        <span class="type-desc">Stocks, ETFs, indices</span>
      </button>
      <button class="type-btn" data-type="cash" onclick="selectType('cash',this)">
        <span class="ti">ğŸ’µ</span>Cash
        <span class="type-desc">Any currency balance</span>
      </button>
      <button class="type-btn" data-type="gold" onclick="selectType('gold',this)">
        <span class="ti">ğŸ¥‡</span>Gold
        <span class="type-desc">Bullion, coins, ingots</span>
      </button>
      <button class="type-btn" data-type="deposit" onclick="selectType('deposit',this)">
        <span class="ti">ğŸ¦</span>Deposit
        <span class="type-desc">CDs, savings, fixed</span>
      </button>
    </div>

    <!-- â”€â”€ ETF â”€â”€ -->
    <div class="form-fields active" id="fieldsETF">
      <div class="add-hint">Enter the ticker symbol exactly as it appears on the exchange (e.g. <b>IGDA.L</b> for London, <b>AAPL</b> for NASDAQ). Live price will be fetched automatically.</div>
      <div class="field-row">
        <div class="field" style="flex:1.4">
          <label>Ticker Symbol <span class="field-req">*</span></label>
          <input id="aTicker" placeholder="e.g. IGDA.L, AAPL, IGLN.L" autocomplete="off" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()"/>
        </div>
        <div class="field" style="flex:1">
          <label>Exchange <span class="field-opt">(optional)</span></label>
          <select id="aExchange" class="field-select">
            <option value="">Auto-detect</option>
            <option value=".L">London (.L)</option>
            <option value=".CA">Egypt (.CA)</option>
            <option value="">US (NASDAQ/NYSE)</option>
          </select>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label>Number of Shares <span class="field-req">*</span></label>
          <div class="input-unit-wrap">
            <input id="aShares" type="number" placeholder="0.00" step="0.01" min="0"/>
            <span class="input-unit">shares</span>
          </div>
        </div>
        <div class="field" style="flex:1">
          <label>Avg Cost / Share <span class="field-opt">(optional)</span></label>
          <div class="input-unit-wrap">
            <input id="aAvgCost" type="number" placeholder="0.00" step="0.0001" min="0"/>
            <span class="input-unit" id="aAvgCostCcy">USD</span>
          </div>
        </div>
      </div>
      <div class="add-preview" id="etfPreview" style="display:none"></div>
    </div>

    <!-- â”€â”€ CASH â”€â”€ -->
    <div class="form-fields" id="fieldsCash">
      <div class="add-hint">Track any cash balance in any currency. The value will be converted to USD using live exchange rates.</div>
      <div class="field">
        <label>Label <span class="field-req">*</span></label>
        <input id="aCashLabel" placeholder="e.g. USD Cash, Emergency Fund"/>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1.5">
          <label>Amount <span class="field-req">*</span></label>
          <div class="input-unit-wrap">
            <input id="aCashAmt" type="number" placeholder="0.00" step="0.01" min="0"/>
            <span class="input-unit" id="cashAmtUnit">USD</span>
          </div>
        </div>
        <div class="field" style="flex:1">
          <label>Currency <span class="field-req">*</span></label>
          <select id="aCashCcy" class="field-select" onchange="document.getElementById('cashAmtUnit').textContent=this.value">
            <option value="USD">USD â€” US Dollar</option>
            <option value="EGP">EGP â€” Egyptian Pound</option>
            <option value="GBP">GBP â€” British Pound</option>
            <option value="EUR">EUR â€” Euro</option>
            <option value="SAR">SAR â€” Saudi Riyal</option>
            <option value="AED">AED â€” UAE Dirham</option>
          </select>
        </div>
      </div>
    </div>

    <!-- â”€â”€ GOLD â”€â”€ -->
    <div class="form-fields" id="fieldsGold">
      <div class="add-hint">Track physical gold. Select the karat to set purity automatically. Live gold price (XAU) will be fetched from the market.</div>
      <div class="field">
        <label>Label <span class="field-opt">(optional)</span></label>
        <input id="aGoldLabel" placeholder="e.g. 24K Gold Ingots, Gold Coins"/>
      </div>
      <div class="field">
        <label>Gold Karat <span class="field-req">*</span></label>
        <div class="karat-grid" id="karatGrid">
          <button class="karat-btn selected" data-karat="24" data-purity="1.0" onclick="selectKarat(this)">
            <span class="karat-num">24K</span>
            <span class="karat-pct">99.9% pure</span>
          </button>
          <button class="karat-btn" data-karat="22" data-purity="0.9167" onclick="selectKarat(this)">
            <span class="karat-num">22K</span>
            <span class="karat-pct">91.7% pure</span>
          </button>
          <button class="karat-btn" data-karat="21" data-purity="0.875" onclick="selectKarat(this)">
            <span class="karat-num">21K</span>
            <span class="karat-pct">87.5% pure</span>
          </button>
          <button class="karat-btn" data-karat="18" data-purity="0.75" onclick="selectKarat(this)">
            <span class="karat-num">18K</span>
            <span class="karat-pct">75.0% pure</span>
          </button>
        </div>
        <input type="hidden" id="aGoldPurity" value="1.0"/>
      </div>
      <div class="field">
        <label>Weight <span class="field-req">*</span></label>
        <div class="input-unit-wrap">
          <input id="aGoldGrams" type="number" placeholder="0.00" step="0.01" min="0" oninput="updateGoldPreview()"/>
          <span class="input-unit">grams</span>
        </div>
      </div>
      <div class="add-preview" id="goldPreview" style="display:none"></div>
    </div>

    <!-- â”€â”€ DEPOSIT â”€â”€ -->
    <div class="form-fields" id="fieldsDeposit">
      <div class="add-hint">Track certificates of deposit, fixed savings, or any interest-bearing account. Value is converted to USD using live FX rates.</div>
      <div class="field">
        <label>Label <span class="field-req">*</span></label>
        <input id="aDepLabel" placeholder="e.g. CD â€” Banque Misr, Fixed Deposit"/>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1.5">
          <label>Amount <span class="field-req">*</span></label>
          <div class="input-unit-wrap">
            <input id="aDepAmt" type="number" placeholder="0.00" step="0.01" min="0"/>
            <span class="input-unit" id="depAmtUnit">EGP</span>
          </div>
        </div>
        <div class="field" style="flex:1">
          <label>Currency <span class="field-req">*</span></label>
          <select id="aDepCcy" class="field-select" onchange="document.getElementById('depAmtUnit').textContent=this.value">
            <option value="EGP">EGP â€” Egyptian Pound</option>
            <option value="USD">USD â€” US Dollar</option>
            <option value="GBP">GBP â€” British Pound</option>
            <option value="EUR">EUR â€” Euro</option>
            <option value="SAR">SAR â€” Saudi Riyal</option>
            <option value="AED">AED â€” UAE Dirham</option>
          </select>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label>Interest Rate <span class="field-opt">(optional)</span></label>
          <div class="input-unit-wrap">
            <input id="aDepRate" type="number" placeholder="0.00" step="0.01" min="0" max="100"/>
            <span class="input-unit">% p.a.</span>
          </div>
        </div>
        <div class="field" style="flex:1">
          <label>Maturity Date <span class="field-opt">(optional)</span></label>
          <input id="aDepMaturity" type="date"/>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn" onclick="closeAddModal()">Cancel</button>
      <button class="btn btn-primary" id="addAssetBtn" onclick="addAsset()">
        <span id="addBtnIcon">ï¼‹</span> Add Asset
      </button>
    </div>
  </div>
</div>

<!-- â•â• TRANSACTION MODAL â•â• -->
<div class="modal-overlay hidden" id="txModal" onclick="if(event.target===this)closeTxModal()">
  <div class="modal">
    <div class="modal-title">Add Transaction <button class="modal-close" onclick="closeTxModal()">âœ•</button></div>
    <div style="display:flex;gap:6px;margin-bottom:16px;">
      <button class="type-btn selected" data-tx="buy" onclick="selectTxType('buy',this)" style="flex:1">Buy</button>
      <button class="type-btn" data-tx="sell" onclick="selectTxType('sell',this)" style="flex:1">Sell</button>
      <button class="type-btn" data-tx="dividend" onclick="selectTxType('dividend',this)" style="flex:1">Dividend</button>
    </div>
    <div id="txBuySell">
      <div class="field"><label>Quantity</label><input id="txQty" type="number" placeholder="0.00" step="0.01"/></div>
      <div class="field"><label>Price per unit</label><input id="txPrice" type="number" placeholder="0.00" step="0.0001"/></div>
    </div>
    <div id="txDividend" style="display:none">
      <div class="field-row">
        <div class="field" style="flex:2"><label>Dividend amount</label><input id="txDivAmt" type="number" placeholder="0.00" step="0.01"/></div>
        <div class="field" style="flex:1"><label>Currency</label>
          <select id="txDivCcy" class="field-select">
            <option value="USD">USD</option><option value="EGP">EGP</option>
            <option value="GBP">GBP</option><option value="EUR">EUR</option>
            <option value="SAR">SAR</option><option value="AED">AED</option>
          </select>
        </div>
      </div>
    </div>
    <div class="field"><label>Date</label><input id="txDate" type="date"/></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeTxModal()">Cancel</button>
      <button class="btn btn-primary" onclick="addTx()">Add</button>
    </div>
  </div>
</div>

<!-- â•â• TARGET ALLOCATION MODAL â•â• -->
<div class="modal-overlay hidden" id="targetAllocModal" onclick="if(event.target===this)closeTargetAllocModal()">
  <div class="modal" style="max-width:500px;">
    <div class="modal-title">ğŸ¯ Target Allocation <button class="modal-close" onclick="closeTargetAllocModal()">âœ•</button></div>
    <p style="font-size:12px;color:var(--text-3);margin-bottom:16px;">Set your desired allocation % for each asset. The app will show drift and rebalancing suggestions.</p>
    <div id="targetAllocBody"></div>
    <div id="targetAllocTotal" style="font-size:12px;font-family:var(--mono);margin-top:10px;padding:8px 12px;background:var(--surface);border-radius:var(--r);"></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeTargetAllocModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveTargetAlloc()">Save Targets</button>
    </div>
  </div>
</div>

<!-- â•â• SCENARIO MODAL â•â• -->
<div class="modal-overlay hidden" id="scenarioModal" onclick="if(event.target===this)closeScenarioModal()">
  <div class="modal" style="max-width:560px;">
    <div class="modal-title">ğŸ“ What-If Scenario <button class="modal-close" onclick="closeScenarioModal()">âœ•</button></div>
    <p style="font-size:12px;color:var(--text-3);margin-bottom:16px;">Adjust asset prices to model different market conditions and see the impact on your portfolio.</p>
    <div id="scenarioSliders"></div>
    <div style="margin-top:16px;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);">
      <div style="font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Scenario Result</div>
      <div id="scenarioResult" style="font-size:22px;font-weight:800;font-family:var(--mono);"></div>
      <div id="scenarioDiff" style="font-size:13px;font-family:var(--mono);margin-top:4px;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="resetScenario()">Reset</button>
      <button class="btn btn-primary" onclick="closeScenarioModal()">Done</button>
    </div>
  </div>
</div>

<!-- â•â• ACCOUNT MODAL â•â• -->
<div class="modal-overlay hidden" id="accountModal" onclick="if(event.target===this)closeAccountModal()">
  <div class="modal" style="max-width:480px;">
    <div class="modal-title">Account <button class="modal-close" onclick="closeAccountModal()">âœ•</button></div>

    <div class="account-section">
      <div class="account-section-title">Change Password</div>
      <div class="field"><label>New Password</label><input type="password" id="newPass1" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
      <div class="field"><label>Confirm</label><input type="password" id="newPass2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
      <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
      <span id="passChangeMsg" style="font-size:12px;color:var(--text-3);margin-left:10px;"></span>
    </div>

    <div class="account-section">
      <div class="account-section-title">Danger Zone</div>
      <button class="btn btn-danger" onclick="confirmDeleteAll()">ğŸ—‘ Delete All My Data</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIGURATION â€” fill in your Supabase credentials below
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL  = 'https://xudlzocokzcsheoubwwm.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1ZGx6b2Nva3pjc2hlb3Vid3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NTc2MjEsImV4cCI6MjA4NzAzMzYyMX0.xDxNzDdiXqvwcNENDb8-z12eXoF9boPCjLScJY2dvJ8';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TROY_OZ_GRAM = 31.1034768;
const COLORS = ['#d4a847','#4f8ef7','#3dd68c','#f07e5b','#a78bfa','#38bdf8','#f472b6','#fb923c'];
const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 min
const USER_ICON_SVG = `<svg viewBox="0 0 24 24" role="img" focusable="false" aria-hidden="true">
  <path d="M12 12a4.2 4.2 0 1 0-4.2-4.2A4.2 4.2 0 0 0 12 12Z" fill="currentColor" opacity="0.9"/>
  <path d="M4.5 20.2c1.6-4 5-6.2 7.5-6.2s5.9 2.2 7.5 6.2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
</svg>`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE CLIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Async bootstrap (wraps entire app to avoid top-level await issues in iOS PWA) â”€â”€
(async function _boot() {
let createClient;
try {
  const mod = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
  createClient = mod.createClient;
} catch(e) {
  document.body.innerHTML = '<div style="padding:40px;font-family:sans-serif;color:#fff;background:#08090c;min-height:100vh;display:flex;align-items:center;justify-content:center;"><div style="text-align:center"><div style="font-size:48px;margin-bottom:16px">âš ï¸</div><h2 style="margin-bottom:8px">Failed to load app</h2><p style="color:#888;font-size:14px">Check your internet connection and reload the page.</p><button onclick="location.reload()" style="margin-top:20px;padding:10px 24px;background:#4f8ef7;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer">Reload</button></div></div>';
  return;
}
const sb = createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { persistSession: true, autoRefreshToken: true, storageKey: 'inv-auth' }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;
let assets = [];
let transactions = {}; // { assetId: [{id,type,qty,price,date,amount}] }
let snapshots = [];
let fxRates = {};
let fxMeta = {};
let goldPerOz = 0;
let goldPrevOz = 0;
let goldMeta = {};
let etfPrices = {};
let etfMeta = {};
let unrealizedMode = 'both';
let displayCurrency = 'USD'; // 'USD' or 'EGP'
let activeChartRange = '1M';
let chartInstances = {};
// sparkRangeCache is declared in the SPARKLINES section below
let searchQuery = '';
let currentTxAssetId = null;
let currentTxType = 'buy';
let autoRefreshTimer = null;
let saveDebounceTimer = null;
let targetAlloc = {};          // Feature 4: { assetId: pct } target allocations
let assetNotes = {};           // Feature 10: { assetId: noteText }
let realizedGains = {};        // Feature 2: { assetId: totalRealizedUSD }
const cardActiveRange = {};    // Feature 11: { assetId: rangeLabel } â€” moved here for settings restore

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE DATA LAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAllData() {
  const uid = currentUser.id;
  const [assetsRes, txRes, snapRes, settingsRes] = await Promise.all([
    sb.from('assets').select('*').eq('user_id', uid).order('created_at', { ascending: true }),
    sb.from('transactions').select('*').eq('user_id', uid).order('date', { ascending: true }),
    sb.from('snapshots').select('*').eq('user_id', uid).order('date', { ascending: true }),
    sb.from('settings').select('*').eq('user_id', uid).limit(1),
  ]);
  if (assetsRes.error) throw assetsRes.error;
  assets = (assetsRes.data || []).map(row => ({ ...row.data, id: row.asset_id, _dbId: row.id }));
  transactions = {};
  for (const tx of (txRes.data || [])) {
    if (!transactions[tx.asset_id]) transactions[tx.asset_id] = [];
    transactions[tx.asset_id].push({ id: tx.tx_id, type: tx.type, qty: tx.qty, price: tx.price, date: tx.date, amount: tx.amount });
  }
  snapshots = (snapRes.data || []).map(row => ({ date: row.date, totalUSD: row.total_usd, assets: row.assets_breakdown }));
  recalcAllRealizedGains(); // Feature 2: rebuild realized gains from tx history
  const settings = settingsRes.data?.[0];
  if (settings) {
    unrealizedMode = settings.unrealized_mode || 'both';
    displayCurrency = settings.display_currency || 'USD';
    if (settings.spark_ranges && typeof settings.spark_ranges === 'object') {
      Object.assign(cardActiveRange, settings.spark_ranges); // Feature 11
    }
    if (settings.target_alloc && typeof settings.target_alloc === 'object') {
      Object.assign(targetAlloc, settings.target_alloc); // Feature 4
    }
    if (settings.asset_notes && typeof settings.asset_notes === 'object') {
      Object.assign(assetNotes, settings.asset_notes); // Feature 10
    }
  }
}

async function saveAsset(asset) {
  const uid = currentUser.id;
  const { error } = await sb.from('assets').upsert({
    user_id: uid,
    asset_id: asset.id,
    data: asset,
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id,asset_id' });
  if (error) console.error('saveAsset:', error);
}

async function deleteAsset(assetId) {
  await sb.from('assets').delete().eq('user_id', currentUser.id).eq('asset_id', assetId);
  await sb.from('transactions').delete().eq('user_id', currentUser.id).eq('asset_id', assetId);
}

async function saveTx(assetId, tx) {
  const { error } = await sb.from('transactions').upsert({
    user_id: currentUser.id,
    asset_id: assetId,
    tx_id: tx.id,
    type: tx.type,
    qty: tx.qty || null,
    price: tx.price || null,
    amount: tx.amount || null,
    date: tx.date
  }, { onConflict: 'user_id,tx_id' });
  if (error) console.error('saveTx:', error);
}

async function deleteTx(txId) {
  await sb.from('transactions').delete().eq('user_id', currentUser.id).eq('tx_id', txId);
}

function debounceSaveAsset(asset) {
  clearTimeout(saveDebounceTimer);
  saveDebounceTimer = setTimeout(() => saveAsset(asset), 400);
}

async function saveSettings() {
  await sb.from('settings').upsert({
    user_id: currentUser.id,
    unrealized_mode: unrealizedMode,
    display_currency: displayCurrency,
    spark_ranges: cardActiveRange,
    target_alloc: targetAlloc,
    asset_notes: assetNotes,
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id' });
}

async function saveSnapshot(snap) {
  const { error } = await sb.from('snapshots').upsert({
    user_id: currentUser.id,
    date: snap.date,
    total_usd: snap.totalUSD,
    assets_breakdown: snap.assets || {}
  }, { onConflict: 'user_id,date' });
  if (error) console.error('saveSnapshot:', error);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP LAUNCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function launchApp() {
  show('loadingOverlay');
  setText('loadingText', 'Loading your portfolioâ€¦');
  try {
    await loadAllData();
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    const email = currentUser.email || '';
    document.getElementById('userEmail').textContent = email;
    const av=document.getElementById('userAvatar');
    if(av){ av.innerHTML = USER_ICON_SVG; av.title = email; }

    document.getElementById('headerSub').textContent = 'Signed in as ' + email;
    setSyncStatus(true, 'Live');
    hide('loadingOverlay');
    render();
    await fetchAllPrices();
    // Auto-refresh
    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    autoRefreshTimer = setInterval(() => fetchAllPrices(), AUTO_REFRESH_INTERVAL);
    // Realtime subscription
    sb.channel('assets-' + currentUser.id)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'assets', filter: `user_id=eq.${currentUser.id}` }, () => loadAndRender())
      .subscribe();
    setupKeyListeners();
    setupClickOutside();
  } catch(e) {
    hide('loadingOverlay');
    showToast('Failed to load data: ' + e.message, 'error');
    console.error(e);
  }
}

async function loadAndRender() {
  await loadAllData();
  render();
}

// â”€â”€ Check session on boot â”€â”€
(async () => {
  const { data } = await sb.auth.getSession();
  if (data?.session) {
    currentUser = data.session.user;
    await launchApp();
  } else {
    // Show auth
    document.getElementById('authScreen').style.display = 'flex';
  }
  sb.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session && !currentUser) {
      currentUser = session.user;
      launchApp();
    }
  });
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH UI + ACTIONS (email/password)
//  Note: because this file uses <script>, any
//  functions called from HTML onclick must be attached to window.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let isSignUp = false;

function setAuthMsg(msg, kind='') {
  const el = document.getElementById('authMsg');
  if (!el) return;
  el.textContent = msg || '';
  el.style.color = (kind === 'error') ? 'var(--red)' : 'var(--text-3)';
}

function setAuthModeUI() {
  const btn = document.querySelector('#authScreen .btn-primary');
  const link = document.getElementById('authToggleLink');
  if (btn) btn.textContent = isSignUp ? 'Create Account' : 'Sign In';
  if (link) link.textContent = isSignUp ? 'Already have an account? Sign in' : 'Need an account? Sign up';
  setAuthMsg('');
}

window.toggleSignUp = function() {
  isSignUp = !isSignUp;
  setAuthModeUI();
};

window.signIn = async function() {
  try {
    const email = (document.getElementById('authEmail')?.value || '').trim();
    const password = document.getElementById('authPassword')?.value || '';
    if (!email || !password) { setAuthMsg('Please enter email and password.', 'error'); return; }

    const sib=document.getElementById('signInBtn');if(sib){sib.disabled=true;sib.textContent=isSignUp?'Creating accountâ€¦':'Signing inâ€¦';}
    setAuthMsg(isSignUp ? 'Creating your accountâ€¦' : 'Signing you inâ€¦');

    let res;
    if (isSignUp) {
      res = await sb.auth.signUp({ email, password });
    } else {
      res = await sb.auth.signInWithPassword({ email, password });
    }

    if (res.error) throw res.error;

    // If email confirmations are enabled, Supabase may not return a session immediately.
    const session = res.data?.session;
    if (session?.user) {
      currentUser = session.user;
      await launchApp();
      return;
    }
    const sibd=document.getElementById('signInBtn');if(sibd){sibd.disabled=false;sibd.textContent=isSignUp?'Create Account':'Sign In';}

    if (isSignUp) {
      setAuthMsg('âœ… Account created. Check your email to confirm, then sign in.', '');
      isSignUp = false;
      setAuthModeUI();
    } else {
      setAuthMsg('Signed in, but no session returned. Try again or check email confirmation settings.', 'error');
    }
  } catch (e) {
    const sibc=document.getElementById('signInBtn');if(sibc){sibc.disabled=false;sibc.textContent=isSignUp?'Create Account':'Sign In';}
    setAuthMsg('âŒ ' + (e?.message || 'Authentication failed.'), 'error');
    console.error(e);
  }
};

window.signOut = async function() {
  try {
    await sb.auth.signOut();
  } finally {
    currentUser = null;
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('authScreen').style.display = 'flex';
    setAuthModeUI();
  }
};

// Initialize UI state
setAuthModeUI();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ASSET VALUE CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFxRate(c) { if (!c || c === 'USD') return 1; return fxRates?.[c.toUpperCase()] || 0; }
function toUSD(amt, ccy) {
  if (!ccy || ccy === 'USD') return amt;
  if (ccy === 'GBp' || ccy === 'GBX') { const r = getFxRate('GBP'); return r ? (amt/100)/r : 0; }
  const rate = getFxRate(ccy.toUpperCase()); return rate ? amt/rate : 0;
}
function assetValueUSD(a) {
  switch(a.type) {
    case 'cash': return toUSD(a.holding, a.currency);
    case 'gold': { const p = a.purity||1; const ppg = goldPerOz ? (goldPerOz/TROY_OZ_GRAM)*p : 0; return (a.holding||0)*ppg; }
    case 'etf': { const ep = etfPrices[a.ticker]; if(ep){ let pu = ep.price; if(ep.currency&&ep.currency!=='USD') pu=toUSD(ep.price,ep.currency); return (a.holding||0)*pu; } return (a.holding||0)*(a.manualPrice||0); }
    case 'deposit': return toUSD(a.holding, a.currency);
    default: return 0;
  }
}
function costBasisUSD(a) {
  const avg = Number(a.avgCost)||0; if(avg<=0) return 0;
  if(a.type==='etf'){ const ep = a.ticker?etfPrices[a.ticker]:null; return toUSD((a.holding||0)*avg, ep?.currency||'USD'); }
  if(a.type==='gold') return (a.holding||0)*avg;
  return 0;
}
function unrealizedUSD(a) {
  if(a.type!=='etf'&&a.type!=='gold') return null;
  const b = costBasisUSD(a); if(b<=0) return null;
  return assetValueUSD(a) - b;
}
function todaysGainUSD(a) {
  if(a.type==='etf'){ const ep=etfPrices[a.ticker]; if(!ep||ep.price==null||ep.prevClose==null) return null; const d=(ep.price-ep.prevClose)*(a.holding||0); return ep.currency&&ep.currency!=='USD'?toUSD(d,ep.currency):d; }
  if(a.type==='gold'){ if(!goldPerOz||!goldPrevOz||goldPerOz===goldPrevOz) return null; const p=a.purity||1; const oz=((a.holding||0)/TROY_OZ_GRAM)*p; return(goldPerOz-goldPrevOz)*oz; }
  return null;
}
function getTotalUSD() { return assets.reduce((s,a)=>s+assetValueUSD(a),0); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SNAPSHOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Always use Cairo date (UTC+2, no DST) so client and edge-function agree on the date
function todayKey() {
  const now = new Date();
  const cairoMs = now.getTime() + 2 * 60 * 60 * 1000; // shift to UTC+2
  return new Date(cairoMs).toISOString().slice(0, 10);
}
async function captureSnapshot() {
  // Cairo time (UTC+2, no DST) â€” always match what the edge function uses
  const nowUtc = new Date();
  const cairoMs = nowUtc.getTime() + 2 * 60 * 60 * 1000;
  const cairoNow = new Date(cairoMs);
  const cairoHour = cairoNow.getUTCHours();
  const cairoMin  = cairoNow.getUTCMinutes();
  const cairoTimeMin = cairoHour * 60 + cairoMin;
  const todayDate = todayKey(); // Cairo-anchored date

  // Guard: if a DB snapshot already exists for this Cairo-date, NEVER overwrite it.
  // The edge function owns persisted snapshots. Only update in-memory for live display.
  const alreadyHave = snapshots.some(s => s.date === todayDate);
  if (alreadyHave) {
    const total = getTotalUSD(); if(total<=0) return;
    const snap = { date: todayDate, totalUSD: total, assets: {} };
    assets.forEach(a => { snap.assets[a.id] = assetValueUSD(a); });
    const idx = snapshots.findIndex(s => s.date === todayDate);
    if (idx >= 0) snapshots[idx] = snap;
    return; // do NOT write to DB
  }

  // Client safety-net: only write after 23:45 Cairo if edge fn missed it
  const isLateEnough = cairoTimeMin >= 23 * 60 + 45;
  if (!isLateEnough) return;

  const total = getTotalUSD(); if(total<=0) return;
  const snap = { date: todayDate, totalUSD: total, assets: {} };
  assets.forEach(a => { snap.assets[a.id] = assetValueUSD(a); });
  snapshots.push(snap);
  await saveSnapshot(snap);
  console.log('[snapshot] Client safety-net wrote snapshot for', todayDate);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() { renderRates(); renderCards(); renderTotals(); updateModeButtons(); renderDriftBar(); }

function renderTotals() {
  const total = getTotalUSD();
  const egpRate = getFxRate('EGP')||0;
  if(displayCurrency==='EGP'&&egpRate){
    const egpTotal=total*egpRate;
    document.getElementById('totalUSD').textContent='EGPÂ '+egpTotal.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    document.getElementById('totalEGP').textContent=fmt(total)+' USD';
  } else {
    document.getElementById('totalUSD').textContent=fmt(total);
    document.getElementById('totalEGP').textContent=egpRate?'EGP '+(total*egpRate).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):'';
  }
  updateCurrToggleBtn();

  let tU=0,tB=0; assets.forEach(a=>{const u=unrealizedUSD(a),b=costBasisUSD(a);if(u!==null){tU+=u;tB+=b;}});
  let tT=0,hT=false,prevTot=0;
  assets.forEach(a=>{const g=todaysGainUSD(a);if(g!==null){tT+=g;hT=true;prevTot+=assetValueUSD(a)-g;}});

  const uEl=document.getElementById('totalUnrealized');
  if(tB<=0){uEl.textContent='Unrealized: â€”';uEl.className='gain-pill neutral';}
  else{const pBasis=tU/tB*100;const pPort= total>0 ? (tU/total*100) : 0;let t;if(unrealizedMode==='usd'){  t=fmtCcySigned(tU);}else if(unrealizedMode==='pct'){  t='Basis: '+fmtPct(pBasis)+', Portfolio: '+fmtPct(pPort);}else{  t=fmtCcySigned(tU)+' (Basis: '+fmtPct(pBasis)+', Portfolio: '+fmtPct(pPort)+')';}uEl.textContent='Unrealized: '+t;uEl.className='gain-pill '+(tU>0?'positive':'negative');}

  const tEl=document.getElementById('totalToday');
  if(!hT){tEl.textContent='Today: â€”';tEl.className='gain-pill neutral';}
  else{const pctPrev=prevTot>0?(tT/prevTot*100):0;const pctPort= total>0 ? (tT/total*100) : 0;tEl.textContent='Today: '+fmtCcySigned(tT)+' (Prev: '+fmtPct(pctPrev)+', Portfolio: '+fmtPct(pctPort)+')';tEl.className='gain-pill '+(tT>0?'positive':'negative');}

  // Alloc bar
  const bar=document.getElementById('allocBar'),leg=document.getElementById('legend');bar.innerHTML='';leg.innerHTML='';
  if(total>0) assets.forEach((a,i)=>{const v=assetValueUSD(a);if(v<=0)return;const p=(v/total*100);const c=a.color||COLORS[i%COLORS.length];bar.innerHTML+='<div class="alloc-seg" style="width:'+p+'%;background:'+c+'" title="'+a.label+': '+p.toFixed(1)+'%"></div>';leg.innerHTML+='<span class="legend-item"><span class="legend-dot" style="background:'+c+'"></span>'+a.label+' '+p.toFixed(1)+'%</span>';});
}

function renderRates() {
  const banner = document.getElementById('ratesBanner'); const chips = [];
  if(goldPerOz){
    let chg='';if(goldPrevOz&&goldPrevOz!==goldPerOz){const c=goldPerOz-goldPrevOz;const p=(c/goldPrevOz)*100;chg='<div class="rate-chg '+(c>0?'positive':'negative')+'">'+(c>0?'+':'')+p.toFixed(2)+'%</div>';}
    const m=goldMeta?.updatedAt?goldMeta.updatedAt.toLocaleString():'';
    chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">GOLD/OZ</span><span class="rate-value">'+fmt(goldPerOz)+'</span></div>'+chg+(m?'<div class="rate-meta">'+m+'</div>':'')+'</div>');
  }
  [...new Set(assets.filter(a=>a.type==='etf').map(a=>a.ticker))].forEach(t=>{
    const ep=etfPrices[t];const meta=etfMeta?.[t];
    if(ep){let chg='';if(ep.prevClose){const c=ep.price-ep.prevClose;const p=(c/ep.prevClose)*100;chg='<div class="rate-chg '+(c>0?'positive':'negative')+'">'+(c>0?'+':'')+p.toFixed(2)+'%</div>';}
    const disp=ep.currency==='USD'?fmt(ep.price):(ep.currency+' '+Number(ep.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}));
    const m=meta?.updatedAt?meta.updatedAt.toLocaleString():'';
    chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">'+t+'</span><span class="rate-value">'+disp+'</span></div>'+chg+(m?'<div class="rate-meta">'+m+'</div>':'')+'</div>');}
    else chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">'+t+'</span><span class="rate-value">â€”</span></div></div>');
  });
  [...new Set(['EGP',...assets.filter(a=>a.currency&&a.currency!=='USD').map(a=>(a.currency||'').toUpperCase())])].forEach(c=>{
    const r=getFxRate(c);if(!r)return;
    chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">USD/'+c+'</span><span class="rate-value">'+r.toFixed(2)+'</span></div></div>');
  });
  banner.innerHTML = chips.join('');
}

function getSortedFiltered() {
  let list = [...assets];
  if(searchQuery) list=list.filter(a=>(a.label||'').toLowerCase().includes(searchQuery)||(a.ticker||'').toLowerCase().includes(searchQuery));
  const sort = document.querySelector('.sort-select')?.value || 'value-desc';
  if(sort==='value-desc') list.sort((a,b)=>assetValueUSD(b)-assetValueUSD(a));
  else if(sort==='gain-desc') list.sort((a,b)=>{const ua=unrealizedUSD(a)??-Infinity,ub=unrealizedUSD(b)??-Infinity;return ub-ua;});
  else if(sort==='today-desc') list.sort((a,b)=>{const ta=todaysGainUSD(a)??-Infinity,tb=todaysGainUSD(b)??-Infinity;return tb-ta;});
  else if(sort==='name-asc') list.sort((a,b)=>(a.label||'').localeCompare(b.label||''));
  return list;
}

function renderCards() {
  const grid = document.getElementById('cardsGrid'); grid.innerHTML='';
  const list = getSortedFiltered();
  if(!assets.length){ grid.innerHTML='<div class="empty-state"><span class="e-icon">ğŸ“­</span><p>No assets yet.<br>Click <b>ï¼‹ Add Asset</b> to start.</p></div>'; return; }
  if(!list.length){ grid.innerHTML='<div class="empty-state"><span class="e-icon">ğŸ”</span><p>No assets match your search.</p></div>'; return; }
  const total = getTotalUSD();
  list.forEach((a,i)=>{
    const v=assetValueUSD(a); const c=a.color||COLORS[i%COLORS.length];
    const bg=c+'13'; const bc=c+'30';
    let holdLabel='Amount', holdUnit=a.currency||'USD';
    let priceH='', avgH='', gainH='', todayH='', txH='', maturityH='';
    if(a.type==='deposit'&&a.maturity){const mat=new Date(a.maturity+'T00:00:00');const today=new Date();today.setHours(0,0,0,0);const days=Math.round((mat-today)/(1000*86400));const matStr=mat.toLocaleDateString();if(days<0)maturityH=`<div class="price-row"><span class="price-label">Matured</span><span class="price-value" style="color:var(--gold)">${matStr}</span></div>`;else if(days===0)maturityH=`<div class="price-row"><span class="price-label">Matures today!</span><span class="price-value" style="color:var(--gold)">ğŸ¯ ${matStr}</span></div>`;else maturityH=`<div class="price-row"><span class="price-label">Matures in</span><span class="price-value" style="color:var(--text-2)">${days}d â€” ${matStr}</span></div>`;}if(a.type==='deposit'&&a.interestRate)priceH=priceRow('Interest rate',a.interestRate.toFixed(2)+'% p.a.');
    if(a.type==='gold'){holdLabel='Weight';holdUnit='grams';const pu=a.purity||1;const ppg=goldPerOz?(goldPerOz/TROY_OZ_GRAM)*pu:0;if(ppg>0)priceH=priceRow('Live price',fmt(ppg)+' / gram');avgH=avgCostRow(a,'USD');}
    if(a.type==='etf'){holdLabel='Shares';holdUnit='shares';const ep=etfPrices[a.ticker];if(ep){const d=ep.currency==='USD'?fmt(ep.price):(ep.currency+' '+Number(ep.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}));priceH=priceRow('Live price ('+ep.currency+')',d+' / share');}else priceH=`<div class="price-row"><span class="price-label">Manual price $</span><input class="manual-input" type="number" value="${a.manualPrice||''}" placeholder="e.g. 4.85" step="0.01" oninput="setManualPrice('${a.id}',this.value)"></div>`;avgH=avgCostRow(a,etfPrices[a.ticker]?.currency||'USD');}
    const u=unrealizedUSD(a);const ub=costBasisUSD(a);
    if(u!==null){let t,cls;const p=ub>0?(u/ub*100):0;if(unrealizedMode==='usd')t=fmtCcySigned(u);else if(unrealizedMode==='pct')t=fmtPct(p);else t=fmtCcySigned(u)+' ('+fmtPct(p)+')';cls=u>0?'positive':u<0?'negative':'neutral';gainH=`<div class="gain-row"><span class="value-label" style="font-size:11px;color:var(--text-3)">Unrealized</span><span class="gain-value ${cls}">${t}</span></div>`;}
    const tg=todaysGainUSD(a);
    if(tg!==null){
      const cls=tg>0?'positive':tg<0?'negative':'neutral';
      const prevVal=assetValueUSD(a)-tg;
      const pctPrev=prevVal>0?(tg/prevVal*100):0;
      const total2=getTotalUSD();
      const pctPort=total2>0?(tg/total2*100):0;
      todayH=`<div class="gain-row"><span class="value-label" style="font-size:11px;color:var(--text-3)">Today</span><span class="gain-value ${cls}">${fmtCcySigned(tg)} <span style="font-size:10px;opacity:0.8;">(${fmtPct(pctPrev)} Â· ${fmtPct(pctPort)} port)</span></span></div>`;
    }
    const hasTx=(a.type==='etf'||a.type==='gold');
    if(hasTx){const txList=transactions[a.id]||[];txH=`<div class="tx-btn-row"><button class="btn btn-sm" onclick="openTxModal('${a.id}')">ï¼‹ Transaction</button></div>`;if(txList.length){txH+=`<div class="tx-log"><div class="tx-log-title">Transactions (${txList.length})</div>`;txList.slice(-5).reverse().forEach(tx=>{const det=tx.type==='dividend'?'Div '+fmt(tx.amount||0):(tx.qty||0)+' @ '+fmt(tx.price||0);txH+=`<div class="tx-item"><span class="tx-type ${tx.type}">${tx.type.toUpperCase()}</span><span class="tx-date">${tx.date}</span><span class="tx-detail">${det}</span><button class="tx-remove" onclick="removeTx('${a.id}','${tx.id}')">âœ•</button></div>`;});if(txList.length>5)txH+=`<div style="font-size:10px;color:var(--text-3);padding:2px 0">+${txList.length-5} moreâ€¦</div>`;txH+=`</div>`;}}
    const ticker=a.ticker?` <span class="card-ticker">(${a.ticker})</span>`:'';
    const pct=total>0&&v>0?((v/total)*100).toFixed(1)+'%':'';
    const note=assetNotes[a.id]||'';
    const noteH=`<div class="card-notes-wrap">
      <textarea class="card-notes-input" rows="1" placeholder="ğŸ’¡ Investment thesis / notesâ€¦" oninput="updateAssetNote('${a.id}',this)">${note}</textarea>
    </div>`;
    const realG=realizedGains[a.id];
    const realGH=realG?`<div class="gain-row"><span class="value-label" style="font-size:11px;color:var(--text-3)">Realized</span><span class="gain-value ${realG>=0?'positive':'negative'}">${fmtCcySigned(realG)}</span></div>`:'';
    // Income (dividends) for this asset
    const divIncome=(transactions[a.id]||[]).filter(t=>t.type==='dividend').reduce((s,t)=>s+(t.amount||0),0);
    const divH=divIncome>0?`<div class="gain-row"><span class="value-label" style="font-size:11px;color:var(--text-3)">Income</span><span class="gain-value" style="color:var(--gold)">${fmt(divIncome)}</span></div>`:'';
    const card=document.createElement('div');
    card.className='card';card.style.background=bg;card.style.borderColor=bc;
    card.style.setProperty('--card-color', c);
    card.innerHTML=`<button class="card-remove" onclick="removeAsset('${a.id}')" title="Remove">âœ•</button>
      <div class="card-header"><span class="card-icon">${a.icon||'ğŸ“¦'}</span><span class="card-label" style="color:${c}">${a.label}${ticker}</span><span class="card-pct" style="color:${c}">${pct}</span></div>
      <div class="card-field"><span class="card-field-label">${holdLabel}</span><div class="holding-wrap"><input class="holding-input" type="number" value="${a.holding||0}" step="0.01" style="border-color:${bc}" oninput="updateHolding('${a.id}',this.value)"><span class="holding-unit">${holdUnit}</span></div></div>
      ${priceH}${maturityH}${avgH}
      <div class="value-row"><span class="value-label">Value</span><span class="value-usd" style="color:${c}">${fmtCcy(v)}</span></div>
      <div class="card-spark-wrap" id="spark-wrap-${a.id}" ${(a.type==='cash')?'style="display:none"':''}>
        <canvas class="card-spark-canvas" id="spark-${a.id}"></canvas>
        <div class="card-spark-tooltip" id="spark-tip-${a.id}"></div>
        <div class="card-spark-ranges" id="spark-ranges-${a.id}"></div>
      </div>
      ${gainH}${todayH}${realGH}${divH}${txH}${noteH}`;
    grid.appendChild(card);
    // Init chart with range buttons after DOM is ready
    requestAnimationFrame(()=>initCardChart(a,c));
  });
}

function priceRow(label,val){return`<div class="price-row"><span class="price-label">${label}</span><span class="price-value">${val}</span></div>`;}
function avgCostRow(a,ccy){return`<div class="card-field" style="margin-top:4px"><span class="card-field-label">Avg cost / unit</span><div class="avgcost-wrap"><input class="avgcost-input" type="number" value="${a.avgCost||''}" placeholder="0.00" step="0.01" oninput="updateAvgCost('${a.id}',this.value)"><span class="avgcost-ccy">${ccy}</span></div></div>`;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  USER ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.updateHolding = function(id, val) {
  const a = assets.find(x=>x.id===id); if(!a) return;
  a.holding = parseFloat(val)||0;
  debounceSaveAsset(a); renderTotals();
};
window.updateAvgCost = function(id, val) {
  const a = assets.find(x=>x.id===id); if(!a) return;
  a.avgCost = parseFloat(val)||0;
  debounceSaveAsset(a); renderTotals();
};
window.setManualPrice = function(id, val) {
  const a = assets.find(x=>x.id===id); if(!a) return;
  a.manualPrice = parseFloat(val)||0;
  const ex=etfPrices[a.ticker]; etfPrices[a.ticker]={price:a.manualPrice,currency:ex?.currency||'USD',prevClose:ex?.prevClose??null};
  debounceSaveAsset(a); renderTotals();
};
window.removeAsset = async function(id) {
  if(!confirm('Remove this asset?')) return;
  const rm = assets.find(a=>a.id===id);
  assets = assets.filter(a=>a.id!==id);
  delete transactions[id];
  await deleteAsset(id);
  render(); showToast((rm?.label||'Asset')+' removed','info');
};
window.setMode = function(m) { unrealizedMode=m; saveSettings(); render(); };
function updateModeButtons(){['usd','pct','both'].forEach(m=>{const el=document.getElementById('m'+m[0].toUpperCase()+m.slice(1));if(el){el.className='btn btn-sm'+(unrealizedMode===m?' btn-primary':'');}});}

window.onSearch = function(v) { searchQuery=v.toLowerCase(); renderCards(); };

// â”€â”€â”€ ASSET TYPES â”€â”€â”€
let selectedType = 'etf';
let selectedKarat = { karat: 24, purity: 1.0 };

window.selectType = function(type, btn) {
  selectedType = type;
  document.querySelectorAll('#typeGrid [data-type]').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  const map = { etf:'ETF', cash:'Cash', gold:'Gold', deposit:'Deposit' };
  Object.values(map).forEach(t=>{ const el=document.getElementById('fields'+t); if(el) el.classList.toggle('active', map[type]===t); });
  const titles = { etf:'Add ETF / Fund', cash:'Add Cash', gold:'Add Gold', deposit:'Add Deposit' };
  const titleEl = document.getElementById('addModalTitle');
  if(titleEl) titleEl.textContent = titles[type] || 'Add Asset';
};

window.selectKarat = function(btn) {
  document.querySelectorAll('.karat-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedKarat = { karat: parseInt(btn.dataset.karat), purity: parseFloat(btn.dataset.purity) };
  document.getElementById('aGoldPurity').value = selectedKarat.purity;
  const lbl = document.getElementById('aGoldLabel');
  if(!lbl.value || lbl.value.match(/^\d+K Gold/)) lbl.value = selectedKarat.karat + 'K Gold';
  updateGoldPreview();
};

function updateGoldPreview() {
  const grams = parseFloat(document.getElementById('aGoldGrams')?.value) || 0;
  const preview = document.getElementById('goldPreview');
  if(!preview) return;
  if(grams > 0 && goldPerOz > 0) {
    const ppg = (goldPerOz / TROY_OZ_GRAM) * selectedKarat.purity;
    const val = grams * ppg;
    preview.style.display = 'flex';
    preview.textContent = 'â‰ˆ ' + fmt(val) + '  at current gold price (' + fmt(goldPerOz) + '/oz)';
  } else { preview.style.display = 'none'; }
}

window.addAsset = async function() {
  const uc = assets.map(a=>a.color);
  const color = COLORS.find(c=>!uc.includes(c))||COLORS[assets.length%COLORS.length];
  let na;
  if(selectedType==='etf'){
    const t=document.getElementById('aTicker').value.trim().toUpperCase();
    if(!t){showToast('Enter a ticker symbol','error');return;}
    if(assets.some(a=>a.ticker===t)){showToast(t+' is already tracked','error');return;}
    const avgCost=parseFloat(document.getElementById('aAvgCost').value)||0;
    na={id:genId(),type:'etf',label:t,icon:'ğŸ“ˆ',ticker:t,holding:parseFloat(document.getElementById('aShares').value)||0,avgCost:avgCost||undefined,color};
  } else if(selectedType==='cash'){
    const label=document.getElementById('aCashLabel').value.trim();
    if(!label){showToast('Enter a label for this cash position','error');return;}
    const ccy=document.getElementById('aCashCcy').value||'USD';
    na={id:genId(),type:'cash',label,icon:'ğŸ’µ',currency:ccy,holding:parseFloat(document.getElementById('aCashAmt').value)||0,color};
  } else if(selectedType==='gold'){
    const grams=parseFloat(document.getElementById('aGoldGrams').value)||0;
    if(!grams){showToast('Enter weight in grams','error');return;}
    const label=document.getElementById('aGoldLabel').value.trim()||selectedKarat.karat+'K Gold';
    na={id:genId(),type:'gold',label,icon:'ğŸ¥‡',purity:selectedKarat.purity,holding:grams,color};
  } else if(selectedType==='deposit'){
    const label=document.getElementById('aDepLabel').value.trim();
    if(!label){showToast('Enter a label for this deposit','error');return;}
    const ccy=document.getElementById('aDepCcy').value||'EGP';
    const rate=parseFloat(document.getElementById('aDepRate').value)||undefined;
    const maturity=document.getElementById('aDepMaturity').value||undefined;
    na={id:genId(),type:'deposit',label,icon:'ğŸ¦',currency:ccy,holding:parseFloat(document.getElementById('aDepAmt').value)||0,interestRate:rate,maturity,color};
  }
  if(!na) return;
  const btn=document.getElementById('addAssetBtn');
  btn.disabled=true; btn.textContent='Addingâ€¦';
  assets.push(na);
  await saveAsset(na);
  closeAddModal();
  btn.disabled=false;
  showToast(na.label+' added','success');
  if(na.type==='etf'){show('loadingOverlay');setText('loadingText','Fetching live price for '+na.ticker+'â€¦');await fetchETFPrice(na.ticker);hide('loadingOverlay');await saveAsset(na);}
  if(na.currency&&na.currency!=='USD'&&!fxRates[na.currency]) await fetchFX();
  render();
};
// â”€â”€â”€ TRANSACTIONS â”€â”€â”€
window.openTxModal = function(assetId) { currentTxAssetId=assetId; currentTxType='buy'; selectTxType('buy',document.querySelector('[data-tx="buy"]')); document.getElementById('txDate').value=todayKey(); document.getElementById('txQty').value=''; document.getElementById('txPrice').value=''; document.getElementById('txDivAmt').value=''; document.getElementById('txModal').classList.remove('hidden'); };
window.closeTxModal = function() { document.getElementById('txModal').classList.add('hidden'); };
window.selectTxType = function(type, btn) {
  currentTxType=type;
  document.querySelectorAll('[data-tx]').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('txBuySell').style.display=type==='dividend'?'none':'';
  document.getElementById('txDividend').style.display=type==='dividend'?'':'none';
};
window.addTx = async function() {
  const date=document.getElementById('txDate').value||todayKey();
  let tx={id:'tx-'+Date.now(),type:currentTxType,date};
  if(currentTxType==='dividend'){
    tx.amount=parseFloat(document.getElementById('txDivAmt').value)||0;
    tx.currency=document.getElementById('txDivCcy')?.value||'USD';
  } else {
    tx.qty=parseFloat(document.getElementById('txQty').value)||0;
    tx.price=parseFloat(document.getElementById('txPrice').value)||0;
  }
  if(!transactions[currentTxAssetId]) transactions[currentTxAssetId]=[];
  transactions[currentTxAssetId].push(tx);
  const txList=transactions[currentTxAssetId];
  const a=assets.find(x=>x.id===currentTxAssetId);
  if(a && (currentTxType==='buy'||currentTxType==='sell')) {
    // Recalculate holding and avg cost using FIFO-style running total
    let runQty=0, totalBuyCost=0, totalBuyQty=0, realized=0;
    let runAvgCost=0;
    txList.forEach(t=>{
      if(t.type==='buy'){
        runQty+=(t.qty||0);
        totalBuyCost+=(t.qty||0)*(t.price||0);
        totalBuyQty+=(t.qty||0);
        runAvgCost=totalBuyQty>0?totalBuyCost/totalBuyQty:0;
      } else if(t.type==='sell') {
        const sellQty=(t.qty||0);
        // Realized gain = (sell price - avg cost) * qty
        realized += (t.price||0)*sellQty - runAvgCost*sellQty;
        runQty-=sellQty;
      }
    });
    a.holding=Math.max(0,runQty);
    if(totalBuyQty>0) a.avgCost=totalBuyCost/totalBuyQty;
    realizedGains[a.id]=realized;
    await saveAsset(a);
  }
  await saveTx(currentTxAssetId, tx);
  closeTxModal(); render(); showToast('Transaction added','success');
};
window.removeTx = async function(assetId, txId) {
  if(!transactions[assetId]) return;
  transactions[assetId]=transactions[assetId].filter(t=>t.id!==txId);
  recalcRealizedGains(assetId);
  await deleteTx(txId);
  render(); showToast('Transaction removed','info');
};

// Feature 10: Notes per asset
window.updateAssetNote = function(id, textarea) {
  // Auto-resize textarea
  textarea.style.height='auto';
  textarea.style.height=textarea.scrollHeight+'px';
  assetNotes[id] = textarea.value;
  clearTimeout(window._noteDebounce);
  window._noteDebounce = setTimeout(()=>saveSettings(), 800);
};

// Feature 2: Recalculate realized gains from transaction history
function recalcRealizedGains(assetId) {
  const txList = transactions[assetId]||[];
  const a = assets.find(x=>x.id===assetId);
  if(!a) return;
  let runQty=0, totalBuyCost=0, totalBuyQty=0, realized=0, runAvgCost=0;
  txList.forEach(t=>{
    if(t.type==='buy'){
      runQty+=(t.qty||0);
      totalBuyCost+=(t.qty||0)*(t.price||0);
      totalBuyQty+=(t.qty||0);
      runAvgCost=totalBuyQty>0?totalBuyCost/totalBuyQty:0;
    } else if(t.type==='sell') {
      realized += (t.price||0)*(t.qty||0) - runAvgCost*(t.qty||0);
      runQty-=(t.qty||0);
    }
  });
  realizedGains[assetId] = realized;
}

function recalcAllRealizedGains() {
  assets.forEach(a=>recalcRealizedGains(a.id));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API FETCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROXIES=[u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u),u=>'https://corsproxy.io/?'+encodeURIComponent(u),u=>'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(u)];
async function fetchTimeout(url,ms=5000){const c=new AbortController();const t=setTimeout(()=>c.abort(),ms);try{return await fetch(url,{signal:c.signal,cache:'no-store'});}finally{clearTimeout(t);}}
async function fetchJsonRace(url,ms=7000){const try1=async(u)=>{const r=await fetchTimeout(u,ms);if(!r.ok)throw new Error('HTTP '+r.status);return r.json();};return new Promise(resolve=>{let done=false,pending=1+PROXIES.length;[url,...PROXIES.map(p=>p(url))].forEach(u=>try1(u).then(d=>{if(!done){done=true;resolve(d);}}).catch(()=>{if(--pending===0&&!done)resolve(null);}));});}
async function fetchYahooChart(ticker,range='1d',interval='1d'){const u='https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(ticker)+'?interval='+encodeURIComponent(interval)+'&range='+encodeURIComponent(range)+'&_ts='+Date.now();const tryUrl=async(url)=>{const r=await fetchTimeout(url,7000);if(!r.ok)throw new Error('HTTP '+r.status);const d=await r.json();const res=d?.chart?.result?.[0];if(!res)throw new Error('No result');return res;};return new Promise(resolve=>{let done=false,pending=1+PROXIES.length;[u,...PROXIES.map(p=>p(u))].forEach(url=>tryUrl(url).then(d=>{if(!done){done=true;resolve(d);}}).catch(()=>{if(--pending===0&&!done)resolve(null);}));});}

async function fetchFX(){
  fxMeta.attempted=true;const ts=Date.now();
  const needed=new Set(['EGP']);assets.forEach(a=>{if(a?.currency&&a.currency!=='USD')needed.add(String(a.currency).toUpperCase());});
  const wanted=[...needed].filter(c=>/^[A-Z]{3}$/.test(c)&&c!=='USD');if(!wanted.length)return true;
  function merge(ratesObj){if(!ratesObj)return;for(const c of wanted){const v=Number(ratesObj[c]);if(Number.isFinite(v)&&v>0)fxRates[c]=v;}}
  const haveAll=()=>wanted.every(c=>Number.isFinite(fxRates?.[c])&&fxRates[c]>0);
  const sources=[
    async()=>{const syms=wanted.map(c=>'USD'+c+'=X').join(',');const d=await fetchJsonRace('https://query1.finance.yahoo.com/v7/finance/quote?symbols='+encodeURIComponent(syms)+'&_ts='+ts,6000);const res=d?.quoteResponse?.result;if(!Array.isArray(res)||!res.length)return false;const rates={};for(const q of res){const m=/^USD([A-Z]{3})=X$/.exec(q?.symbol||'');if(!m)continue;const px=Number(q?.regularMarketPrice);if(px>0)rates[m[1]]=px;}merge(rates);return fxRates?.EGP>0;},
    async()=>{const d=await fetchJsonRace('https://open.er-api.com/v6/latest/USD?_ts='+ts,6000);merge(d?.rates);return fxRates?.EGP>0;},
    async()=>{await Promise.allSettled(wanted.map(async c=>{const d=await fetchJsonRace('https://wise.com/rates/live?source=USD&target='+c+'&_ts='+ts,6000);const px=Number(d?.value);if(px>0)fxRates[c]=px;}));return fxRates?.EGP>0;}
  ];
  for(const fn of sources){try{if(await fn()){fxMeta.updatedAt=new Date();if(haveAll())break;}}catch{}}
  return fxRates?.EGP>0;
}

async function fetchGoldPrevClose(){
  for(const sym of['GC=F','XAUUSD=X']){
    const r=await fetchYahooChart(sym,'5d','1d');
    if(!r)continue;
    const meta=r.meta||{};
    const cur=meta.regularMarketPrice;
    // regularMarketPreviousClose is what Yahoo Finance UI uses for daily % change
    // Fall back through other fields in priority order
    let prev=meta.regularMarketPreviousClose??meta.previousClose??meta.chartPreviousClose??null;
    if(prev==null){
      // Last resort: second-to-last close candle in the chart data
      const cl=r?.indicators?.quote?.[0]?.close;
      if(Array.isArray(cl)){const nn=cl.filter(x=>x!=null);if(nn.length>=2)prev=nn[nn.length-2];}
    }
    if(typeof cur==='number'&&cur>0)goldPerOz=cur;
    if(typeof prev==='number'&&prev>0)goldPrevOz=prev;
    if(goldPerOz>0&&goldPrevOz>0){
      goldMeta={updatedAt:new Date(),source:'Yahoo ('+sym+')'};
      return true;
    }
  }
  return false;
}
async function fetchGold(){
  for(const url of['https://api.metals.dev/v1/latest?api_key=demo&currency=USD&unit=toz','https://data-asg.goldprice.org/dbXRates/USD']){const d=await fetchJsonRace(url,8000);if(!d)continue;if(d.metals?.gold>0){goldPerOz=d.metals.gold;goldMeta={updatedAt:new Date(),source:'metals.dev'};return true;}if(d.items?.[0]?.xauPrice>0){goldPerOz=d.items[0].xauPrice;goldMeta={updatedAt:new Date(),source:'goldprice.org'};return true;}}return false;
}

async function fetchETFPrice(ticker){
  const r=await fetchYahooChart(ticker,'1d','1d');if(!r)return false;
  const meta=r.meta||{};

  // â”€â”€ Currency detection (order matters) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 1. Egyptian stocks: .CA suffix OR exchange name contains cairo/egypt/egx
  //    Yahoo sometimes returns currency as 'EGP', sometimes as 'USD' for EGX â€”
  //    so we override based on ticker suffix and exchange name, not just meta.currency
  const tickerUpper = ticker.toUpperCase();
  const ex = (meta?.fullExchangeName||meta?.exchangeName||'').toString().toLowerCase();
  const isEgyptian = tickerUpper.endsWith('.CA') || ex.includes('cairo') || ex.includes('egypt') || ex.includes('egx');

  // 2. UK stocks: .L suffix â€” Yahoo returns GBp (pence), needs /100 conversion
  const isUK = tickerUpper.endsWith('.L');

  // 3. Default to what Yahoo says, but force EGP for Egyptian stocks
  let ccy = isEgyptian ? 'EGP' : (meta.currency || 'USD');

  // â”€â”€ Price extraction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let px = meta.regularMarketPrice;
  if(px==null){const cl=r?.indicators?.quote?.[0]?.close;if(Array.isArray(cl)){const nn=cl.filter(x=>x!=null);if(nn.length)px=nn[nn.length-1];}}
  let prev = meta.regularMarketPreviousClose ?? meta.previousClose ?? meta.chartPreviousClose ?? null;
  if(prev==null){const cl=r?.indicators?.quote?.[0]?.close;if(Array.isArray(cl)){const nn=cl.filter(x=>x!=null);if(nn.length>=2)prev=nn[nn.length-2];}}
  if(typeof px!=='number'||px<=0)return false;

  // â”€â”€ Unit conversions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // GBp / GBX = pence â†’ divide by 100 to get GBP
  if(ccy==='GBp'||ccy==='GBX'||(!isEgyptian&&isUK&&(meta.currency==='GBp'||meta.currency==='GBX'))){
    px=px/100;if(prev!=null)prev=prev/100;ccy='GBP';
  }

  etfPrices[ticker]={price:px,currency:ccy,prevClose:prev};
  etfMeta[ticker]={updatedAt:new Date(),source:'Yahoo'};return true;
}

window.fetchAllPrices = async function() {
  const btn=document.getElementById('refreshBtn');btn.disabled=true;btn.textContent='â³ Updatingâ€¦';
  const hasGold=assets.some(a=>a.type==='gold');
  const hasETF=assets.some(a=>a.type==='etf');
  const etfTickers=[...new Set(assets.filter(a=>a.type==='etf').map(a=>a.ticker))];
  const [fxOk,goldOk,etfOk]=await Promise.all([fetchFX(),hasGold?fetchGoldPrevClose().then(ok=>ok||fetchGold()):Promise.resolve(false),hasETF?Promise.all(etfTickers.map(t=>fetchETFPrice(t))).then(r=>r.some(Boolean)):Promise.resolve(false)]);
  btn.disabled=false;btn.textContent='ğŸ”„ Refresh';
  const parts=[];parts.push(fxOk?'FX âœ“':'FX âœ—');
  if(hasGold)parts.push(goldOk?'Gold âœ“':'Gold âœ—');
  etfTickers.forEach(t=>parts.push(etfPrices[t]?t+' âœ“':t+' âœ—'));
  document.getElementById('headerSub').textContent=parts.join(' Â· ')+' â€” '+new Date().toLocaleTimeString()+' Â· R=refresh, /=search, N=new';
  await captureSnapshot();
  // Fetch default-range spark histories for ETF+gold (non-blocking; re-renders cards when ready)
  if(assets.some(a=>a.type==='etf'||a.type==='gold')){
    prefetchSparkRanges().then(()=>renderCards());
  }
  render();
  if(fxOk||goldOk||etfOk)showToast('Prices updated','success');else showToast('Some fetches failed','error');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERFORMANCE TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.switchTab = function(name, btn) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='performance') renderPerformanceTab();
  if(name==='history') renderHistoryTab();
  if(name==='markets') renderMarketsTab();
};

function getSnapsForRange(range){
  const n=snapshots.length;if(!n)return[];
  const now=new Date();let cutoff;
  if(range==='1M')cutoff=new Date(now.setMonth(now.getMonth()-1));
  else if(range==='3M')cutoff=new Date(now.setMonth(now.getMonth()-3));
  else if(range==='6M')cutoff=new Date(now.setMonth(now.getMonth()-6));
  else if(range==='1Y')cutoff=new Date(now.setFullYear(now.getFullYear()-1));
  else return snapshots;
  return snapshots.filter(s=>new Date(s.date+'T00:00:00')>=cutoff);
}

function calcTWR(snaps){
  if(snaps.length<2)return null;let twr=1;
  for(let i=1;i<snaps.length;i++){const prev=snaps[i-1].totalUSD;const cur=snaps[i].totalUSD;if(prev>0)twr*=(cur/prev);}
  return(twr-1)*100;
}

function renderPerformanceTab(){
  const snaps=getSnapsForRange('ALL');const total=getTotalUSD();const twr=calcTWR(snaps);
  let tU=0,tB=0;assets.forEach(a=>{const u=unrealizedUSD(a),b=costBasisUSD(a);if(u!==null){tU+=u;tB+=b;}});
  let tT=0,hT=false,prevP=0;assets.forEach(a=>{const g=todaysGainUSD(a);if(g!==null){tT+=g;hT=true;prevP+=assetValueUSD(a)-g;}});
  const uPortPct=total>0?(tU/total*100):0;
  const todayPortPct=total>0?(tT/total*100):0;
  let best=null,worst=null;
  for(let i=1;i<snaps.length;i++){const p=snaps[i-1].totalUSD,c=snaps[i].totalUSD;const pct=p>0?((c-p)/p*100):0;if(best===null||pct>best.pct)best={date:snaps[i].date,pct};if(worst===null||pct<worst.pct)worst={date:snaps[i].date,pct};}
  const egpRate=getFxRate('EGP')||0;
  const totalEGP=egpRate?total*egpRate:null;
  const firstSnap=snaps[0],lastSnap=snaps[snaps.length-1];
  const totalReturn=(firstSnap&&firstSnap.totalUSD>0)?((total-firstSnap.totalUSD)/firstSnap.totalUSD*100):null;
  const daysTracked=snaps.length>=2?Math.round((new Date(lastSnap.date)-new Date(firstSnap.date))/(1000*86400)):0;

  // Feature 1: P&L Summary
  const totalRealizedGain=Object.values(realizedGains).reduce((s,v)=>s+v,0);
  const totalDividends=Object.values(transactions).flat().filter(t=>t.type==='dividend').reduce((s,t)=>{
    const a=assets.find(x=>x.id===Object.keys(transactions).find(k=>transactions[k]?.find(tx=>tx.id===t.id)));
    const amt=t.amount||0;
    // Convert to USD if needed (simplification: assume USD for now)
    return s+amt;
  },0);
  // Recalc total dividends properly
  let totalDivUSD=0;
  Object.entries(transactions).forEach(([assetId,txList])=>{
    (txList||[]).filter(t=>t.type==='dividend').forEach(t=>{
      const ccy=t.currency||'USD';
      totalDivUSD += toUSD(t.amount||0, ccy);
    });
  });
  const totalInvestedCost=assets.reduce((s,a)=>{
    const b=costBasisUSD(a); return s+(b>0?b:assetValueUSD(a));
  },0);

  // Feature 5: Risk metrics
  const risk=calcRiskMetrics(snaps);

  // Feature 1+5: Full metrics grid
  const metrics=[
    // P&L Section
    {label:'Total Value',value:fmt(total),sub:totalEGP?'â‰ˆ EGP '+totalEGP.toLocaleString('en-US',{maximumFractionDigits:0}):'Current portfolio',cls:''},
    {label:'Total Return',value:totalReturn!==null?fmtPct(totalReturn):'â€”',sub:firstSnap?'Since '+fmtDate(firstSnap.date):'No baseline yet',cls:totalReturn!==null?(totalReturn>0?'positive':'negative'):''},
    {label:'Unrealized P/L',value:tB>0?fmtSigned(tU)+' ('+fmtPct(uPortPct)+')':'â€”',sub:'vs cost basis',cls:tU>0?'positive':tU<0?'negative':''},
    {label:'Realized Gains',value:totalRealizedGain!==0?fmtSigned(totalRealizedGain):'â€”',sub:'From closed positions',cls:totalRealizedGain>0?'positive':totalRealizedGain<0?'negative':''},
    {label:'Total Income',value:totalDivUSD>0?fmt(totalDivUSD):'â€”',sub:'Dividends received',cls:totalDivUSD>0?'positive':''},
    {label:'Total P&L',value:(tU+totalRealizedGain+totalDivUSD)!==0?fmtSigned(tU+totalRealizedGain+totalDivUSD):'â€”',sub:'Unrealized + Realized + Income',cls:(tU+totalRealizedGain+totalDivUSD)>0?'positive':(tU+totalRealizedGain+totalDivUSD)<0?'negative':''},
    {label:"Today's Change",value:hT?fmtSigned(tT)+' ('+fmtPct(todayPortPct)+')':'â€”',sub:'vs yesterday',cls:tT>0?'positive':tT<0?'negative':''},
    {label:'TWR (All Time)',value:twr!==null?fmtPct(twr):'â€”',sub:snaps.length+' data points',cls:twr!==null?(twr>0?'positive':'negative'):''},
    {label:'Days Tracked',value:daysTracked>0?daysTracked+' days':'â€”',sub:firstSnap?fmtDate(firstSnap.date)+' â†’ today':'No history',cls:''},
    // Risk Section (Feature 5)
    {label:'Annual Volatility',value:risk?risk.annualVol.toFixed(1)+'%':'â€”',sub:'Annualized (252d)',cls:''},
    {label:'Daily Volatility',value:risk?risk.stdDev.toFixed(2)+'% Ïƒ':'â€”',sub:'Std dev of daily moves',cls:''},
    {label:'Sharpe Ratio',value:risk&&risk.sharpe!==null?risk.sharpe.toFixed(2):'â€”',sub:'vs 4.5% risk-free',cls:risk?.sharpe>1?'positive':risk?.sharpe<0?'negative':''},
    {label:'Max Drawdown',value:risk?'âˆ’'+risk.maxDD.toFixed(1)+'%':'â€”',sub:risk&&risk.ddEnd?fmtDate(risk.ddStart)+' â†’ '+fmtDate(risk.ddEnd):'Peak-to-trough',cls:risk?'negative':''},
    {label:'Best Day',value:best?fmtPct(best.pct):'â€”',sub:best?fmtDate(best.date):'No data',cls:'positive'},
    {label:'Worst Day',value:worst?fmtPct(worst.pct):'â€”',sub:worst?fmtDate(worst.date):'No data',cls:'negative'},
  ];
  document.getElementById('perfMetrics').innerHTML=metrics.map(m=>`<div class="perf-card"><div class="perf-card-label">${m.label}</div><div class="perf-card-value ${m.cls||''}">${m.value}</div><div class="perf-card-sub">${m.sub}</div></div>`).join('');
  renderValueChart();renderAllocChart();
  renderAttributionChart(snaps);  // Feature 8
  renderCurrencyExposureChart();  // Feature 6
  renderCorrelationMatrix(snaps); // Feature 5
}

window.setChartRange = function(range, btn) {
  activeChartRange=range;
  document.querySelectorAll('.range-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderValueChart();
};

function destroyChart(id){if(chartInstances[id]){chartInstances[id].destroy?.();delete chartInstances[id];}}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 8: PERFORMANCE ATTRIBUTION CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAttributionChart(snaps) {
  const container = document.getElementById('attributionSection');
  if(!container) return;
  if(snaps.length < 2) { container.style.display='none'; return; }
  container.style.display='';
  
  const total = getTotalUSD();
  const first = snaps[0].totalUSD;
  if(first<=0) { container.innerHTML=''; return; }

  // Contribution per asset: (current value - first value in snapshot)
  const items = assets.map(a=>{
    const firstVal = (snaps[0].assets||{})[a.id]||0;
    const curVal = assetValueUSD(a);
    const contrib = curVal - firstVal;
    const contribPct = first>0?contrib/first*100:0;
    return { label:a.label, color:a.color||COLORS[0], contrib, contribPct };
  }).filter(x=>Math.abs(x.contrib)>0.01).sort((a,b)=>b.contrib-a.contrib);

  if(!items.length) { container.innerHTML=''; return; }

  const maxAbs = Math.max(...items.map(i=>Math.abs(i.contrib)));

  container.innerHTML = `
    <div class="chart-section">
      <div class="chart-section-title">ğŸ“Š Performance Attribution â€” Contribution to Total Return</div>
      <div style="padding:4px 0;">
        ${items.map(item=>{
          const barW = maxAbs>0?Math.abs(item.contrib)/maxAbs*100:0;
          const isPos = item.contrib>=0;
          return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
            <div style="min-width:130px;font-size:11px;color:var(--text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${item.label}</div>
            <div style="flex:1;height:20px;position:relative;display:flex;align-items:center;">
              <div style="position:absolute;${isPos?'left:50%':'right:50%'};width:${barW/2}%;height:14px;background:${isPos?item.color+'99':item.color+'66'};border-radius:2px;"></div>
              <div style="position:absolute;left:50%;top:0;height:100%;width:1px;background:var(--border-2);"></div>
            </div>
            <div style="min-width:80px;text-align:right;font-size:11px;font-family:var(--mono);color:${isPos?'var(--green)':'var(--red)'}">${fmtSigned(item.contrib)}</div>
            <div style="min-width:50px;text-align:right;font-size:11px;font-family:var(--mono);color:var(--text-3)">${fmtPct(item.contribPct)}</div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 6: CURRENCY EXPOSURE CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCurrencyExposureChart() {
  const container = document.getElementById('currencyExposureSection');
  if(!container) return;
  const exposure = getCurrencyExposure();
  const total = getTotalUSD();
  if(!total || !Object.keys(exposure).length) { container.style.display='none'; return; }
  container.style.display='';

  const ccyColors = { USD:'#4f8ef7', EGP:'#34d68a', GBP:'#a78bfa', EUR:'#f472b6', GOLD:'#c9a84c', SAR:'#fb923c', AED:'#38bdf8' };
  const sorted = Object.entries(exposure).sort((a,b)=>b[1]-a[1]);

  container.innerHTML = `
    <div class="chart-section">
      <div class="chart-section-title">ğŸ’± Currency Exposure</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:14px;">
        ${sorted.map(([ccy,val])=>{
          const pct = total>0?val/total*100:0;
          const color = ccyColors[ccy]||COLORS[sorted.findIndex(x=>x[0]===ccy)%COLORS.length];
          return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px;">
            <div style="font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">${ccy}</div>
            <div style="font-size:16px;font-weight:800;font-family:var(--mono);color:${color}">${pct.toFixed(1)}%</div>
            <div style="font-size:11px;color:var(--text-3);font-family:var(--mono)">${fmt(val)}</div>
            <div style="height:4px;background:var(--surface-2);border-radius:2px;margin-top:8px;overflow:hidden;">
              <div style="height:100%;width:${Math.min(pct,100)}%;background:${color};border-radius:2px;"></div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 5: CORRELATION MATRIX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCorrelationMatrix(snaps) {
  const container = document.getElementById('correlationSection');
  if(!container) return;
  if(snaps.length < 10) { container.style.display='none'; return; }
  container.style.display='';

  const result = calcCorrelationMatrix(snaps);
  if(!result || result.ids.length < 2) { container.innerHTML=''; return; }
  
  const { ids, corr } = result;
  const labels = ids.map(id=>{ const a=assets.find(x=>x.id===id); return a?.label?.slice(0,10)||id.slice(0,10); });

  const cells = ids.map((idA,i)=>{
    return ids.map((idB,j)=>{
      const r = corr[idA+'|'+idB]??0;
      const abs = Math.abs(r);
      const bg = r>=0 ? `rgba(52,214,138,${abs*0.6})` : `rgba(237,95,95,${abs*0.6})`;
      const isDiag = idA===idB;
      return `<td style="padding:6px 8px;text-align:center;font-family:var(--mono);font-size:11px;background:${isDiag?'var(--surface-2)':bg};border:1px solid rgba(255,255,255,0.04);color:${isDiag?'var(--text-3)':'var(--text)'}">
        ${isDiag?'1.00':r.toFixed(2)}
      </td>`;
    }).join('');
  });

  container.innerHTML = `
    <div class="chart-section">
      <div class="chart-section-title">ğŸ”— Asset Correlation Matrix
        <span style="font-size:10px;color:var(--text-3);font-weight:400">Based on ${snaps.length} daily snapshots â€” green=positive, red=negative</span>
      </div>
      <div style="overflow-x:auto;">
        <table style="border-collapse:collapse;min-width:100%;">
          <thead><tr>
            <th style="padding:6px 8px;font-size:9px;color:var(--text-3);text-align:left;white-space:nowrap;"></th>
            ${labels.map(l=>`<th style="padding:6px 8px;font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;">${l}</th>`).join('')}
          </tr></thead>
          <tbody>
            ${ids.map((id,i)=>`<tr>
              <td style="padding:6px 8px;font-size:9px;color:var(--text-3);white-space:nowrap;font-weight:700;">${labels[i]}</td>
              ${cells[i]}
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>`;
}

function renderValueChart(){
  const snaps=getSnapsForRange(activeChartRange);
  const canvas=document.getElementById('valueChart');const empty=document.getElementById('chartEmpty');
  destroyChart('value');
  if(snaps.length<2){canvas.style.display='none';empty.style.display='';return;}
  canvas.style.display='';empty.style.display='none';
  chartInstances['value']=drawLineChart(canvas.getContext('2d'),canvas,snaps.map(s=>fmtDate(s.date)),snaps.map(s=>s.totalUSD));
}

function renderAllocChart(){
  const snaps=getSnapsForRange(activeChartRange);const canvas=document.getElementById('allocChart');destroyChart('alloc');if(snaps.length<2)return;
  const ids=[...new Set(snaps.flatMap(s=>Object.keys(s.assets||{})))];
  const datasets=ids.map(id=>{const a=assets.find(x=>x.id===id);const color=(a?.color)||COLORS[ids.indexOf(id)%COLORS.length];return{label:a?.label||id,data:snaps.map(s=>s.assets?.[id]||0),color};}).filter(d=>d.data.some(v=>v>0));
  chartInstances['alloc']=drawStackedChart(canvas.getContext('2d'),canvas,snaps.map(s=>fmtDate(s.date)),datasets);
}

function drawLineChart(ctx,canvas,labels,data){
  const W=canvas.parentElement.clientWidth||600;const H=200;canvas.width=W;canvas.height=H;
  const pad={top:16,right:16,bottom:36,left:64};const cw=W-pad.left-pad.right,ch=H-pad.top-pad.bottom;
  const min=Math.min(...data)*0.995,max=Math.max(...data)*1.005,range=max-min||1;
  const xp=i=>pad.left+i/(data.length-1)*cw;const yp=v=>pad.top+ch*(1-(v-min)/range);
  ctx.clearRect(0,0,W,H);
  const isUp=data[data.length-1]>=data[0];const lc=isUp?'#3dd68c':'#f05b5b';
  ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){const y=pad.top+i/4*ch;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cw,y);ctx.stroke();}
  const grad=ctx.createLinearGradient(0,pad.top,0,pad.top+ch);grad.addColorStop(0,lc+'33');grad.addColorStop(1,lc+'00');
  ctx.beginPath();ctx.moveTo(xp(0),yp(data[0]));for(let i=1;i<data.length;i++)ctx.lineTo(xp(i),yp(data[i]));ctx.lineTo(xp(data.length-1),pad.top+ch);ctx.lineTo(xp(0),pad.top+ch);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  ctx.beginPath();ctx.strokeStyle=lc;ctx.lineWidth=2;ctx.lineJoin='round';ctx.moveTo(xp(0),yp(data[0]));for(let i=1;i<data.length;i++)ctx.lineTo(xp(i),yp(data[i]));ctx.stroke();
  ctx.fillStyle='rgba(160,160,176,0.7)';ctx.font='10px JetBrains Mono,monospace';ctx.textAlign='right';
  for(let i=0;i<=4;i++){const v=min+i/4*range;ctx.fillText('$'+Math.round(v).toLocaleString(),pad.left-4,pad.top+ch*(1-i/4)+4);}
  ctx.textAlign='center';const step=Math.max(1,Math.floor(data.length/6));for(let i=0;i<labels.length;i+=step)ctx.fillText(labels[i],xp(i),H-8);
  return{destroy(){}};
}

function drawStackedChart(ctx,canvas,labels,datasets){
  const W=canvas.parentElement.clientWidth||600;const H=160;canvas.width=W;canvas.height=H;
  const pad={top:8,right:16,bottom:28,left:64};const cw=W-pad.left-pad.right,ch=H-pad.top-pad.bottom;
  const n=labels.length;const stacked=labels.map((_,i)=>datasets.reduce((s,d)=>s+d.data[i],0));const max=Math.max(...stacked,1);
  const xp=i=>pad.left+i/(n-1)*cw;const yp=v=>pad.top+ch*(1-v/max);
  ctx.clearRect(0,0,W,H);
  const cumul=new Array(n).fill(0);
  datasets.forEach(ds=>{const base=[...cumul];ds.data.forEach((v,i)=>cumul[i]+=v);ctx.beginPath();ctx.moveTo(xp(0),yp(base[0]));for(let i=1;i<n;i++)ctx.lineTo(xp(i),yp(base[i]));for(let i=n-1;i>=0;i--)ctx.lineTo(xp(i),yp(cumul[i]));ctx.closePath();ctx.fillStyle=ds.color+'88';ctx.fill();ctx.beginPath();ctx.strokeStyle=ds.color;ctx.lineWidth=1.5;ctx.moveTo(xp(0),yp(cumul[0]));for(let i=1;i<n;i++)ctx.lineTo(xp(i),yp(cumul[i]));ctx.stroke();});
  ctx.fillStyle='rgba(160,160,176,0.7)';ctx.font='10px JetBrains Mono,monospace';ctx.textAlign='right';
  for(let i=0;i<=3;i++){const v=i/3*max;ctx.fillText('$'+Math.round(v).toLocaleString(),pad.left-4,pad.top+ch*(1-i/3)+4);}
  ctx.textAlign='center';const step=Math.max(1,Math.floor(n/5));for(let i=0;i<labels.length;i+=step)ctx.fillText(labels[i],xp(i),H-5);
  return{destroy(){}};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPARKLINES â€” per-card interactive chart with range selector
//  Data seeded from Yahoo Finance v8 chart API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Range definitions: label â†’ { yahooRange, yahooInterval, isIntraday }
// isIntraday = true means timestamps are intraday (need different x-axis labels)
const SPARK_RANGES = [
  { label:'1D',  yr:'1d',   yi:'2m',   intra:true  },
  { label:'5D',  yr:'5d',   yi:'15m',  intra:true  },
  { label:'1M',  yr:'1mo',  yi:'1d',   intra:false },
  { label:'6M',  yr:'6mo',  yi:'1d',   intra:false },
  { label:'YTD', yr:'ytd',  yi:'1d',   intra:false },
  { label:'1Y',  yr:'1y',   yi:'1d',   intra:false },
  { label:'5Y',  yr:'5y',   yi:'1wk',  intra:false },
  { label:'All', yr:'max',  yi:'1mo',  intra:false },
];

// Cache keyed by "type:id_or_ticker:rangeLabel" â†’ { prices:[], timestamps:[], ccy, isGBp, isEgyptian }
// null means fetch was attempted and failed
const sparkRangeCache = {};

// Default range per asset type/region
function defaultRange(a){
  if(a.type==='etf'&&a.ticker?.toUpperCase().endsWith('.CA')) return '5D';
  return '1M';
}

// Per-card state: which range is active
// cardActiveRange declared in APP STATE section above

// â”€â”€ Cache key helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sparkCacheKey(a, rangeLabel){ return (a.type==='etf'?'etf:'+a.ticker:a.type==='gold'?'gold:'+a.id:'snap:'+a.id)+':'+rangeLabel; }

// â”€â”€ Fetch one range for an asset and populate cache â”€â”€â”€â”€â”€â”€â”€
async function fetchSparkRange(a, rangeLabel){
  const key=sparkCacheKey(a,rangeLabel);
  if(sparkRangeCache[key]!==undefined) return; // already cached (even if null)
  const rd=SPARK_RANGES.find(r=>r.label===rangeLabel);
  if(!rd){sparkRangeCache[key]=null;return;}

  try{
    if(a.type==='etf'){
      const tickerUpper=a.ticker.toUpperCase();
      const r=await fetchYahooChart(a.ticker, rd.yr, rd.yi);
      if(!r){sparkRangeCache[key]=null;return;}
      const q=r?.indicators?.quote?.[0];
      const closes=q?.close||[];
      const timestamps=r?.timestamp||[];
      const ex=(r.meta?.fullExchangeName||r.meta?.exchangeName||'').toLowerCase();
      const isEgyptian=tickerUpper.endsWith('.CA')||ex.includes('cairo')||ex.includes('egypt')||ex.includes('egx');
      const isUK=tickerUpper.endsWith('.L');
      let ccy=isEgyptian?'EGP':(r.meta?.currency||'USD');
      const isGBp=ccy==='GBp'||ccy==='GBX'||(!isEgyptian&&isUK&&(r.meta?.currency==='GBp'||r.meta?.currency==='GBX'));
      if(isGBp)ccy='GBP';
      const holding=a.holding||0;
      const prices=[]; const ts=[];
      for(let i=0;i<closes.length;i++){
        const p=closes[i];
        if(typeof p!=='number'||p<=0)continue;
        let pu=isGBp?p/100:p;
        prices.push(holding*toUSD(pu,ccy));
        ts.push(timestamps[i]||0);
      }
      // Also store raw unit price for display (not multiplied by holding)
      const rawPrices=[];
      for(let i=0;i<closes.length;i++){
        const p=closes[i];if(typeof p!=='number'||p<=0)continue;
        let pu=isGBp?p/100:p;rawPrices.push(toUSD(pu,ccy));
      }
      sparkRangeCache[key]=prices.length>=2?{prices,rawPrices,timestamps:ts,ccy,isGBp,isEgyptian,intra:rd.intra}:null;
    }
    else if(a.type==='gold'){
      for(const sym of['XAUUSD=X','GC=F']){
        const r=await fetchYahooChart(sym,rd.yr,rd.yi);
        if(!r)continue;
        const q=r?.indicators?.quote?.[0];
        const closes=q?.close||[];
        const timestamps=r?.timestamp||[];
        const purity=a.purity||1; const holding=a.holding||0;
        const prices=[]; const rawPrices=[]; const ts=[];
        for(let i=0;i<closes.length;i++){
          const p=closes[i];if(typeof p!=='number'||p<=0)continue;
          prices.push((p/TROY_OZ_GRAM)*purity*holding);
          rawPrices.push(p); // gold price per oz
          ts.push(timestamps[i]||0);
        }
        if(prices.length>=2){sparkRangeCache[key]={prices,rawPrices,timestamps:ts,ccy:'USD',isGBp:false,isEgyptian:false,intra:rd.intra};return;}
      }
      sparkRangeCache[key]=null;
    }
    else{ sparkRangeCache[key]=null; }
  }catch(e){
    console.warn('fetchSparkRange failed',a.id,rangeLabel,e);
    sparkRangeCache[key]=null;
  }
}

// â”€â”€ Fetch default range for all etf/gold assets (called from fetchAllPrices) â”€â”€
async function prefetchSparkRanges(){
  const sparkAssets=assets.filter(a=>a.type==='etf'||a.type==='gold');
  // Clear cache on refresh
  Object.keys(sparkRangeCache).forEach(k=>delete sparkRangeCache[k]);
  await Promise.all(sparkAssets.map(a=>fetchSparkRange(a,defaultRange(a))));
}

// â”€â”€ Draw chart on a canvas element â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSparkChart(canvas, tooltipEl, data, accentColor, intraday){
  const dpr=window.devicePixelRatio||1;
  const wrap=canvas.parentElement;
  const W=wrap?wrap.clientWidth:300;
  const H=110;
  canvas.width=Math.round(W*dpr);
  canvas.height=Math.round(H*dpr);
  canvas.style.width=W+'px';
  canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);

  const prices=data.prices;
  const rawPrices=data.rawPrices||prices;
  if(!prices||prices.length<2){canvas.style.opacity='0.3';return;}
  canvas.style.opacity='1';

  const pad={t:22,b:24,l:0,r:0};
  const cw=W-pad.l-pad.r;
  const ch=H-pad.t-pad.b;
  const minV=Math.min(...prices), maxV=Math.max(...prices);
  const range=maxV-minV||maxV*0.01||1;
  const xp=i=>pad.l+(i/(prices.length-1))*cw;
  const yp=v=>pad.t+ch*(1-(v-minV)/range);

  const isUp=prices[prices.length-1]>=prices[0];
  const isFlat=Math.abs(prices[prices.length-1]-prices[0])/(prices[0]||1)<0.001;
  const lc=isFlat?(accentColor||'#c9a84c'):(isUp?'#34d68a':'#ed5f5f');

  ctx.clearRect(0,0,W,H);

  // â”€â”€ Gradient fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const grad=ctx.createLinearGradient(0,pad.t,0,H-pad.b);
  grad.addColorStop(0,lc+'35');grad.addColorStop(1,lc+'00');
  ctx.beginPath();
  ctx.moveTo(xp(0),yp(prices[0]));
  for(let i=1;i<prices.length;i++)ctx.lineTo(xp(i),yp(prices[i]));
  ctx.lineTo(xp(prices.length-1),H-pad.b);
  ctx.lineTo(xp(0),H-pad.b);
  ctx.closePath();ctx.fillStyle=grad;ctx.fill();

  // â”€â”€ Line â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.beginPath();ctx.strokeStyle=lc;ctx.lineWidth=1.5;
  ctx.lineJoin='round';ctx.lineCap='round';
  ctx.moveTo(xp(0),yp(prices[0]));
  for(let i=1;i<prices.length;i++)ctx.lineTo(xp(i),yp(prices[i]));
  ctx.stroke();

  // â”€â”€ End dot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.beginPath();
  ctx.arc(xp(prices.length-1),yp(prices[prices.length-1]),2.5,0,Math.PI*2);
  ctx.fillStyle=lc;ctx.fill();

  // â”€â”€ Price labels (Y axis â€” min/max) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.fillStyle='rgba(160,160,176,0.65)';
  ctx.font=`600 9px JetBrains Mono,monospace`;
  ctx.textAlign='right';
  const fmtPriceLabel=v=>'$'+v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  // Top-right: max price
  ctx.fillText(fmtPriceLabel(Math.max(...rawPrices)),W-2,pad.t+8);
  // Bottom-right: min price
  ctx.fillText(fmtPriceLabel(Math.min(...rawPrices)),W-2,H-pad.b-2);

  // â”€â”€ X-axis date labels (2â€“3 evenly spaced) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.fillStyle='rgba(160,160,176,0.5)';
  ctx.font=`500 9px JetBrains Mono,monospace`;
  ctx.textAlign='center';
  const n=prices.length;
  const labelIdxs=[0, Math.floor(n/2), n-1];
  const ts=data.timestamps;
  labelIdxs.forEach(i=>{
    if(i>=n)return;
    let label='';
    if(ts&&ts[i]){
      const d=new Date(ts[i]*1000);
      if(intraday){label=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
      else{label=d.toLocaleDateString([],{month:'short',day:'numeric'});}
    } else {
      // Fallback: position fraction label
      label=i===0?'Start':i===n-1?'Now':'Mid';
    }
    ctx.fillText(label,xp(i),H-4);
  });

  // â”€â”€ Hover crosshair interaction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Remove old listener if any, then attach new one
  const oldHandler=canvas._sparkMoveHandler;
  if(oldHandler)canvas.removeEventListener('mousemove',oldHandler);
  canvas.removeEventListener('mouseleave',canvas._sparkLeaveHandler||null);

  canvas._sparkMoveHandler=function(e){
    const rect=canvas.getBoundingClientRect();
    const mx=e.clientX-rect.left;
    const idx=Math.round((mx/W)*(prices.length-1));
    const ci=Math.max(0,Math.min(prices.length-1,idx));
    const rawP=rawPrices[ci];
    // Crosshair vertical line
    ctx.clearRect(0,0,W,H);
    // Redraw everything (gradient, line, dots, labels)
    drawSparkChartStatic(ctx,W,H,pad,prices,rawPrices,lc,grad,fmtPriceLabel,data,intraday);
    // Crosshair
    const cx2=xp(ci);
    ctx.save();
    ctx.strokeStyle='rgba(255,255,255,0.18)';ctx.lineWidth=1;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(cx2,pad.t);ctx.lineTo(cx2,H-pad.b);ctx.stroke();
    ctx.restore();
    ctx.beginPath();ctx.arc(cx2,yp(prices[ci]),3,0,Math.PI*2);ctx.fillStyle=lc;ctx.fill();
    // Tooltip
    if(tooltipEl){tooltipEl.textContent=fmtPriceLabel(rawP);tooltipEl.style.opacity='1';}
  };
  canvas._sparkLeaveHandler=function(){
    if(tooltipEl){tooltipEl.style.opacity='0';}
    // Restore static chart
    ctx.clearRect(0,0,W,H);
    drawSparkChartStatic(ctx,W,H,pad,prices,rawPrices,lc,grad,fmtPriceLabel,data,intraday);
  };
  canvas.addEventListener('mousemove',canvas._sparkMoveHandler);
  canvas.addEventListener('mouseleave',canvas._sparkLeaveHandler);
}

// â”€â”€ Static draw (called by both initial render and hover redraw) â”€â”€
function drawSparkChartStatic(ctx,W,H,pad,prices,rawPrices,lc,grad,fmtPriceLabel,data,intraday){
  const cw=W-pad.l-pad.r;const ch=H-pad.t-pad.b;
  const minV=Math.min(...prices),maxV=Math.max(...prices);
  const range=maxV-minV||maxV*0.01||1;
  const xp=i=>pad.l+(i/(prices.length-1))*cw;
  const yp=v=>pad.t+ch*(1-(v-minV)/range);
  // Gradient fill
  ctx.beginPath();ctx.moveTo(xp(0),yp(prices[0]));
  for(let i=1;i<prices.length;i++)ctx.lineTo(xp(i),yp(prices[i]));
  ctx.lineTo(xp(prices.length-1),H-pad.b);ctx.lineTo(xp(0),H-pad.b);
  ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  // Line
  ctx.beginPath();ctx.strokeStyle=lc;ctx.lineWidth=1.5;ctx.lineJoin='round';ctx.lineCap='round';
  ctx.moveTo(xp(0),yp(prices[0]));
  for(let i=1;i<prices.length;i++)ctx.lineTo(xp(i),yp(prices[i]));
  ctx.stroke();
  // End dot
  ctx.beginPath();ctx.arc(xp(prices.length-1),yp(prices[prices.length-1]),2.5,0,Math.PI*2);ctx.fillStyle=lc;ctx.fill();
  // Price labels
  ctx.fillStyle='rgba(160,160,176,0.65)';ctx.font='600 9px JetBrains Mono,monospace';ctx.textAlign='right';
  ctx.fillText(fmtPriceLabel(Math.max(...rawPrices)),W-2,pad.t+8);
  ctx.fillText(fmtPriceLabel(Math.min(...rawPrices)),W-2,H-pad.b-2);
  // X labels
  ctx.fillStyle='rgba(160,160,176,0.5)';ctx.font='500 9px JetBrains Mono,monospace';ctx.textAlign='center';
  const n=prices.length;const ts=data.timestamps;
  [0,Math.floor(n/2),n-1].forEach(i=>{
    if(i>=n)return;
    let label='';
    if(ts&&ts[i]){const d=new Date(ts[i]*1000);label=intraday?d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):d.toLocaleDateString([],{month:'short',day:'numeric'});}
    else{label=i===0?'Start':i===n-1?'Now':'Mid';}
    ctx.fillText(label,xp(i),H-4);
  });
}

// â”€â”€ Render the range buttons and draw initial chart for an asset â”€â”€
function initCardChart(a, accentColor){
  const rangesEl=document.getElementById('spark-ranges-'+a.id);
  const canvas=document.getElementById('spark-'+a.id);
  const tooltipEl=document.getElementById('spark-tip-'+a.id);
  const wrap=document.getElementById('spark-wrap-'+a.id);
  if(!rangesEl||!canvas)return;

  // Determine available ranges (for .CA: show 1D 5D 1M only; others: all)
  const isEgyptian=a.ticker?.toUpperCase().endsWith('.CA');
  const availRanges=isEgyptian
    ? SPARK_RANGES.filter(r=>['1D','5D','1M'].includes(r.label))
    : SPARK_RANGES;

  const activeRange=cardActiveRange[a.id]||defaultRange(a);

  // Render buttons
  rangesEl.innerHTML=availRanges.map(r=>
    `<button class="spark-range-btn${r.label===activeRange?' active':''}" onclick="selectSparkRange('${a.id}','${r.label}',this)">${r.label}</button>`
  ).join('');

  // Draw current data
  const key=sparkCacheKey(a,activeRange);
  const cached=sparkRangeCache[key];
  if(cached&&cached.prices){
    drawSparkChart(canvas,tooltipEl,cached,accentColor,cached.intra);
  } else if(wrap){
    // Show skeleton until data arrives
    canvas.style.opacity='0';
  }
}

// â”€â”€ Called when user clicks a range button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.selectSparkRange=async function(assetId,rangeLabel,btn){
  const a=assets.find(x=>x.id===assetId);if(!a)return;
  cardActiveRange[assetId]=rangeLabel;
  clearTimeout(window._rangeDebounce);
  window._rangeDebounce=setTimeout(()=>saveSettings(),1000); // Feature 11: persist
  // Update button active state
  const rangesEl=document.getElementById('spark-ranges-'+assetId);
  if(rangesEl)rangesEl.querySelectorAll('.spark-range-btn').forEach(b=>{b.classList.toggle('active',b.textContent===rangeLabel);});
  const canvas=document.getElementById('spark-'+assetId);
  const tooltipEl=document.getElementById('spark-tip-'+assetId);
  const c=a.color||'#d4a847';
  // Check cache
  const key=sparkCacheKey(a,rangeLabel);
  if(sparkRangeCache[key]===undefined){
    // Fetch and draw
    if(canvas)canvas.style.opacity='0.3';
    await fetchSparkRange(a,rangeLabel);
  }
  const cached=sparkRangeCache[key];
  if(canvas&&cached&&cached.prices){drawSparkChart(canvas,tooltipEl,cached,c,cached.intra);}
  else if(canvas){canvas.style.opacity='0.2';}
};

// â”€â”€ Fallback: snapshot-based spark data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSparkData(a){
  const key=sparkCacheKey(a,cardActiveRange[a.id]||defaultRange(a));
  if(sparkRangeCache[key]&&sparkRangeCache[key].prices){return sparkRangeCache[key];}
  return null;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistoryTab(){
  const empty=document.getElementById('snapEmpty');
  const totalTable=document.getElementById('snapTable');
  const assetTable=document.getElementById('snapAssetTable');
  const body=document.getElementById('snapBody');
  const assetBody=document.getElementById('snapAssetBody');
  body.innerHTML=''; assetBody.innerHTML='';

  if(!snapshots.length){
    empty.style.display='';totalTable.style.display='none';assetTable.style.display='none';
    document.getElementById('histViewToggleRow').style.display='none';
    return;
  }
  empty.style.display='none';
  document.getElementById('histViewToggleRow').style.display='';

  const egpR=getFxRate('EGP')||0;
  const inEGP=displayCurrency==='EGP'&&egpR>0;
  const currentView=window._histView||'total';

  // â”€ populate asset selector â”€
  const sel=document.getElementById('histAssetSelect');
  const prevSelVal=sel.value;
  sel.innerHTML='';
  assets.forEach(a=>{ const o=document.createElement('option'); o.value=a.id; o.textContent=(a.icon||'')+(a.label||(a.id)); sel.appendChild(o); });
  if(prevSelVal && assets.find(a=>a.id===prevSelVal)) sel.value=prevSelVal;

  if(currentView==='total'){
    totalTable.style.display=''; assetTable.style.display='none'; sel.style.display='none';
    document.getElementById('histViewTotalBtn').classList.add('btn-primary');
    document.getElementById('histViewAssetBtn').classList.remove('btn-primary');
    const h1=document.getElementById('histValHeader'); const h2=document.getElementById('histSecHeader');
    if(h1)h1.textContent=inEGP?'Value (EGP)':'Value (USD)';
    if(h2)h2.textContent=inEGP?'Value (USD)':'Value (EGP)';
    const sorted=[...snapshots].reverse();
    sorted.forEach((s,i)=>{
      const prev=sorted[i+1];
      const chgUSD=prev?s.totalUSD-prev.totalUSD:null;
      const chgPct=(prev&&prev.totalUSD>0)?((s.totalUSD-prev.totalUSD)/prev.totalUSD*100):null;
      const cls=chgUSD>0?'var(--green)':chgUSD<0?'var(--red)':'';
      const egpTotal=egpR?s.totalUSD*egpR:0;
      const primaryVal=inEGP?('EGPÂ '+egpTotal.toLocaleString('en-US',{maximumFractionDigits:0})):fmt(s.totalUSD);
      const secondaryVal=inEGP?fmt(s.totalUSD):(egpR?'EGPÂ '+egpTotal.toLocaleString('en-US',{maximumFractionDigits:0}):'â€”');
      let chgDisp='â€”';
      if(chgUSD!==null){
        if(inEGP&&egpR){const chgEGP=chgUSD*egpR;chgDisp=(chgEGP>=0?'+':'âˆ’')+'EGPÂ '+Math.abs(chgEGP).toLocaleString('en-US',{maximumFractionDigits:0});}
        else chgDisp=(chgUSD>=0?'+$':'âˆ’$')+Math.abs(chgUSD).toFixed(2);
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmtDate(s.date)}</td><td style="font-weight:700">${primaryVal}</td><td style="color:var(--text-3);font-size:11px">${secondaryVal}</td><td style="color:${cls}">${chgDisp}</td><td style="color:${cls}">${chgPct!==null?(chgPct>=0?'+':'')+chgPct.toFixed(2)+'%':'â€”'}</td><td>${Object.keys(s.assets||{}).length}</td>`;
      body.appendChild(tr);
    });
  } else {
    // Per-asset view
    totalTable.style.display='none'; assetTable.style.display=''; sel.style.display='';
    document.getElementById('histViewTotalBtn').classList.remove('btn-primary');
    document.getElementById('histViewAssetBtn').classList.add('btn-primary');
    const h1=document.getElementById('assetHistValHeader'); const h2=document.getElementById('assetHistSecHeader');
    if(h1)h1.textContent=inEGP?'Value (EGP)':'Value (USD)';
    if(h2)h2.textContent=inEGP?'Value (USD)':'Value (EGP)';
    const selectedId=sel.value;
    const sorted=[...snapshots].reverse();
    let hasData=false;
    sorted.forEach((s,i)=>{
      const valUSD=s.assets&&s.assets[selectedId]!=null?Number(s.assets[selectedId]):null;
      if(valUSD===null)return;
      hasData=true;
      const prev=sorted[i+1];
      const prevValUSD=prev&&prev.assets&&prev.assets[selectedId]!=null?Number(prev.assets[selectedId]):null;
      const chgUSD=prevValUSD!==null?valUSD-prevValUSD:null;
      const chgPct=(prevValUSD!==null&&prevValUSD>0)?((valUSD-prevValUSD)/prevValUSD*100):null;
      const cls=chgUSD>0?'var(--green)':chgUSD<0?'var(--red)':'';
      const egpVal=egpR?valUSD*egpR:0;
      const pct=s.totalUSD>0?(valUSD/s.totalUSD*100):0;
      const primaryVal=inEGP?('EGPÂ '+egpVal.toLocaleString('en-US',{maximumFractionDigits:0})):fmt(valUSD);
      const secondaryVal=inEGP?fmt(valUSD):(egpR?'EGPÂ '+egpVal.toLocaleString('en-US',{maximumFractionDigits:0}):'â€”');
      let chgDisp='â€”';
      if(chgUSD!==null){
        if(inEGP&&egpR){const chgEGP=chgUSD*egpR;chgDisp=(chgEGP>=0?'+':'âˆ’')+'EGPÂ '+Math.abs(chgEGP).toLocaleString('en-US',{maximumFractionDigits:0});}
        else chgDisp=(chgUSD>=0?'+$':'âˆ’$')+Math.abs(chgUSD).toFixed(2);
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmtDate(s.date)}</td><td style="font-weight:700">${primaryVal}</td><td style="color:var(--text-3);font-size:11px">${secondaryVal}</td><td style="color:${cls}">${chgDisp}</td><td style="color:${cls}">${chgPct!==null?(chgPct>=0?'+':'')+chgPct.toFixed(2)+'%':'â€”'}</td><td style="color:var(--text-3)">${pct.toFixed(1)}%</td>`;
      assetBody.appendChild(tr);
    });
    if(!hasData){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td colspan="6" style="text-align:center;color:var(--text-3);padding:20px;">No breakdown data for this asset. Breakdowns are saved automatically on price refresh.</td>`;
      assetBody.appendChild(tr);
    }
  }
}

window.setHistView=function(v){
  window._histView=v;
  renderHistoryTab();
};

window.openFetchPastDayModal=function(){
  const form=document.getElementById('fetchPastDayForm');
  form.style.display=form.style.display==='none'?'':'none';
  if(form.style.display!=='none'){
    const nowMs=Date.now()+2*60*60*1000;
    const yesterday=new Date(nowMs-86400000);
    document.getElementById('fetchPastDate').value=yesterday.toISOString().slice(0,10);
    document.getElementById('fetchPastDayLog').style.display='none';
    document.getElementById('fetchPastDayLog').textContent='';
  }
};

window.runFetchPastDay=async function(){
  const dateVal=document.getElementById('fetchPastDate').value;
  if(!dateVal){showToast('Please select a date','error');return;}

  // Validate: must be a past date
  const cairoNow=new Date(Date.now()+2*60*60*1000);
  const todayStr=cairoNow.toISOString().slice(0,10);
  if(dateVal>=todayStr){showToast('Please choose a past date','error');return;}

  const btn=document.getElementById('fetchPastDayBtn');
  const logEl=document.getElementById('fetchPastDayLog');
  btn.disabled=true; btn.textContent='Fetchingâ€¦';
  logEl.style.display=''; logEl.textContent='';

  function log(msg){ logEl.textContent+=msg+'\n'; logEl.scrollTop=logEl.scrollHeight; }

  try{
    log('[historical-snapshot] Target date: '+dateVal);

    // â”€â”€ Build period1/period2 for Yahoo Finance historical query â”€â”€â”€â”€
    // period1 = start of target day UTC, period2 = start of 2 days later UTC
    // Using a 5-day window ensures we capture the close even if some days are holidays
    const p1=Math.floor(new Date(dateVal+'T00:00:00Z').getTime()/1000);
    const p2=Math.floor(new Date(dateVal+'T00:00:00Z').getTime()/1000)+5*86400;

    // â”€â”€ Helper: fetch closing price for a specific date from Yahoo â”€â”€
    async function fetchHistClose(ticker){
      // Yahoo chart with period1/period2 returns OHLCV candles for each trading day in range
      const url=`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?interval=1d&period1=${p1}&period2=${p2}&_ts=${Date.now()}`;
      let result=null;
      for(const attempt of [url,...PROXIES.map(p=>p(url))]){
        try{
          const r=await fetchTimeout(attempt,8000);
          if(!r.ok)continue;
          const d=await r.json();
          const res=d?.chart?.result?.[0];
          if(res){result=res;break;}
        }catch(_){}
      }
      if(!result)return null;

      const meta=result.meta||{};
      const timestamps=result.timestamp||[];
      const closes=result?.indicators?.quote?.[0]?.close||[];

      // Find the candle whose timestamp falls on or just after our target date
      // Yahoo timestamps are start-of-candle in UTC
      const targetMs=new Date(dateVal+'T00:00:00Z').getTime();
      let closePrice=null;

      // Walk timestamps and find the closest trading day on or after target
      for(let i=0;i<timestamps.length;i++){
        const candleDate=new Date(timestamps[i]*1000).toISOString().slice(0,10);
        if(candleDate>=dateVal && closes[i]!=null){
          closePrice=closes[i];
          log('  '+ticker+' close on '+candleDate+': '+closePrice);
          break;
        }
      }

      if(closePrice===null){
        // Fallback: last non-null close in result
        const nn=closes.filter(x=>x!=null);
        if(nn.length)closePrice=nn[nn.length-1];
        log('  '+ticker+' fallback close: '+closePrice);
      }

      if(!closePrice||closePrice<=0)return null;

      // Currency detection (mirrors fetchETFPrice logic)
      const tickerUpper=ticker.toUpperCase();
      const ex=(meta?.fullExchangeName||meta?.exchangeName||'').toLowerCase();
      const isEgyptian=tickerUpper.endsWith('.CA')||ex.includes('cairo')||ex.includes('egypt')||ex.includes('egx');
      const isUK=tickerUpper.endsWith('.L');
      let ccy=isEgyptian?'EGP':(meta.currency||'USD');
      if(ccy==='GBp'||ccy==='GBX'||(isUK&&(meta.currency==='GBp'||meta.currency==='GBX'))){
        closePrice=closePrice/100; ccy='GBP';
      }
      return {price:closePrice,currency:ccy};
    }

    // â”€â”€ Fetch gold historical close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchHistGold(){
      for(const sym of['GC=F','XAUUSD=X']){
        const r=await fetchHistClose(sym);
        if(r?.price>0){log('  Gold ('+sym+'): $'+r.price.toFixed(2)+'/oz');return r.price;}
      }
      return null;
    }

    // â”€â”€ Fetch FX rates for target date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Yahoo FX pairs support period1/period2 too
    async function fetchHistFX(currencies){
      const rates={};
      if(!currencies.length)return rates;
      const syms=currencies.map(c=>'USD'+c+'=X').join(',');
      const url=`https://query1.finance.yahoo.com/v8/finance/chart/USD${currencies[0]}=X?interval=1d&period1=${p1}&period2=${p2}&_ts=${Date.now()}`;
      // Fetch each currency pair individually for reliability
      await Promise.all(currencies.map(async c=>{
        const r=await fetchHistClose('USD'+c+'=X');
        if(r?.price>0)rates[c]=r.price;
      }));
      // Fallback to current rates for any missing
      currencies.forEach(c=>{ if(!rates[c]&&fxRates[c])rates[c]=fxRates[c]; });
      return rates;
    }

    // â”€â”€ Collect what we need â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const needsGold=assets.some(a=>a.type==='gold');
    const etfTickers=[...new Set(assets.filter(a=>a.type==='etf'&&a.ticker).map(a=>a.ticker))];
    const currencies=new Set(['EGP']);
    assets.forEach(a=>{ if(a.currency&&a.currency!=='USD')currencies.add(a.currency.toUpperCase()); });

    log('Fetching FX rates for: '+[...currencies].join(', '));
    log('Fetching ETFs: '+(etfTickers.join(', ')||'none'));
    log('Needs gold: '+needsGold);

    // â”€â”€ Parallel fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const [histFX, histGold, ...etfResults]=await Promise.all([
      fetchHistFX([...currencies]),
      needsGold?fetchHistGold():Promise.resolve(null),
      ...etfTickers.map(t=>fetchHistClose(t).then(r=>({ticker:t,result:r})))
    ]);

    log('FX rates: '+JSON.stringify(histFX));
    log('Gold: '+(histGold?'$'+histGold.toFixed(2)+'/oz':'unavailable'));

    // Build etfPricesHist map
    const etfPricesHist={};
    for(const {ticker,result} of etfResults){
      if(result?.price){ etfPricesHist[ticker]=result; log('  ETF '+ticker+': '+result.currency+' '+result.price); }
      else log('  ETF '+ticker+': unavailable');
    }

    // â”€â”€ Local toUSD using historical rates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function histToUSD(amt,ccy){
      if(!ccy||ccy==='USD')return amt;
      if(ccy==='GBp'||ccy==='GBX'){const r=histFX['GBP']||0;return r?(amt/100)/r:0;}
      const rate=histFX[ccy.toUpperCase()]||0;
      return rate?amt/rate:0;
    }

    // â”€â”€ Calculate each asset's historical value â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const TROY=31.1034768;
    const assetsBreakdown={};
    let totalUSD=0;

    for(const a of assets){
      let val=0;
      switch(a.type){
        case 'cash':   val=histToUSD(a.holding||0,a.currency); break;
        case 'deposit':val=histToUSD(a.holding||0,a.currency||'EGP'); break;
        case 'gold':{
          const p=a.purity||1;
          const ppg=histGold?(histGold/TROY)*p:0;
          val=(a.holding||0)*ppg;
          break;
        }
        case 'etf':{
          const ep=etfPricesHist[a.ticker];
          if(ep){let pu=ep.price;if(ep.currency&&ep.currency!=='USD')pu=histToUSD(ep.price,ep.currency);val=(a.holding||0)*pu;}
          else val=(a.holding||0)*(a.manualPrice||0);
          break;
        }
      }
      assetsBreakdown[a.id]=val;
      totalUSD+=val;
      log('  Asset "'+a.label+'": $'+val.toFixed(2));
    }

    log('Total portfolio: $'+totalUSD.toFixed(2));

    if(totalUSD<=0){showToast('Could not calculate value â€” prices unavailable','error');btn.disabled=false;btn.textContent='Fetch';return;}

    // â”€â”€ Upsert snapshot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const snap={date:dateVal,totalUSD,assets:assetsBreakdown};
    const existing=snapshots.findIndex(s=>s.date===dateVal);
    if(existing>=0){
      if(!confirm(`A snapshot for ${dateVal} already exists ($${snapshots[existing].totalUSD.toFixed(2)}). Overwrite with historical fetch?`)){btn.disabled=false;btn.textContent='Fetch';return;}
      snapshots[existing]=snap;
    }else{
      snapshots.push(snap);
      snapshots.sort((a,b)=>a.date.localeCompare(b.date));
    }
    await saveSnapshot(snap);
    renderHistoryTab();
    log('\nâœ… Snapshot saved for '+dateVal);
    showToast(`Historical snapshot for ${dateVal} saved âœ“`,'success');

  }catch(e){
    log('\nâŒ Error: '+(e?.message||String(e)));
    showToast('Fetch failed â€” see log','error');
  }finally{
    btn.disabled=false; btn.textContent='Fetch';
  }
};




// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 4: TARGET ALLOCATION & DRIFT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openTargetAllocModal = function() {
  const body = document.getElementById('targetAllocBody');
  const total = getTotalUSD();
  body.innerHTML = assets.map(a=>{
    const v = assetValueUSD(a);
    const current = total>0?(v/total*100).toFixed(1):0;
    const target = targetAlloc[a.id]||'';
    return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <span style="flex:1;font-size:13px;font-weight:600;color:var(--text)">${a.icon||'ğŸ“¦'} ${a.label}</span>
      <span style="font-size:11px;color:var(--text-3);font-family:var(--mono);min-width:50px;text-align:right">Now: ${current}%</span>
      <div style="position:relative;display:flex;align-items:center;">
        <input class="holding-input" type="number" min="0" max="100" step="0.5" 
          value="${target}" placeholder="0" id="ta-${a.id}"
          oninput="updateTargetAllocTotal()" style="width:70px;text-align:right;">
        <span style="font-size:11px;color:var(--text-3);margin-left:4px;font-family:var(--mono)">%</span>
      </div>
    </div>`;
  }).join('');
  updateTargetAllocTotal();
  document.getElementById('targetAllocModal').classList.remove('hidden');
};

window.updateTargetAllocTotal = function() {
  const total = assets.reduce((s,a)=>{
    const v = parseFloat(document.getElementById('ta-'+a.id)?.value)||0;
    return s+v;
  },0);
  const el = document.getElementById('targetAllocTotal');
  if(el) {
    const diff = total - 100;
    const cls = Math.abs(diff)<0.1?'var(--green)':Math.abs(diff)<5?'var(--gold)':'var(--red)';
    el.innerHTML = `Total: <span style="color:${cls};font-weight:700">${total.toFixed(1)}%</span> ${Math.abs(diff)<0.1?'âœ“ Balanced':diff>0?`(${diff.toFixed(1)}% over)`:`(${Math.abs(diff).toFixed(1)}% under)`}`;
  }
};

window.saveTargetAlloc = function() {
  assets.forEach(a=>{ const v=parseFloat(document.getElementById('ta-'+a.id)?.value)||0; if(v>0)targetAlloc[a.id]=v; else delete targetAlloc[a.id]; });
  saveSettings();
  closeTargetAllocModal();
  renderDriftBar();
  showToast('Target allocation saved','success');
};
window.closeTargetAllocModal = function() { document.getElementById('targetAllocModal').classList.add('hidden'); };

function renderDriftBar() {
  const bar = document.getElementById('driftBar');
  if(!bar) return;
  if(!Object.keys(targetAlloc).length) { bar.style.display='none'; return; }
  const total = getTotalUSD();
  if(total<=0) { bar.style.display='none'; return; }
  bar.style.display = '';
  
  const rows = assets.filter(a=>targetAlloc[a.id]).map(a=>{
    const current = total>0?assetValueUSD(a)/total*100:0;
    const target = targetAlloc[a.id]||0;
    const drift = current - target;
    const cls = Math.abs(drift)<1?'var(--text-3)':drift>0?'var(--red)':'var(--blue)';
    const action = Math.abs(drift)<1?'On target':drift>0?`Overweight ${drift.toFixed(1)}%`:`Underweight ${Math.abs(drift).toFixed(1)}%`;
    // Rebalance amount
    const targetUSD = total * target/100;
    const currentUSD = assetValueUSD(a);
    const delta = targetUSD - currentUSD;
    const deltaStr = Math.abs(drift)<1?'':(delta>=0?`+${fmt(delta)}`:`âˆ’${fmt(Math.abs(delta))}`);
    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:11px;">
      <span style="width:120px;color:var(--text-2);overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${a.icon||''} ${a.label}</span>
      <div style="flex:1;height:6px;background:var(--surface-2);border-radius:3px;position:relative;overflow:visible;">
        <div style="position:absolute;left:0;top:0;height:6px;width:${Math.min(current,100).toFixed(1)}%;background:${a.color||'var(--blue)'};border-radius:3px;opacity:0.6;"></div>
        <div style="position:absolute;left:${Math.min(target,100).toFixed(1)}%;top:-3px;width:2px;height:12px;background:var(--text-3);border-radius:1px;" title="Target ${target}%"></div>
      </div>
      <span style="min-width:38px;text-align:right;font-family:var(--mono);color:${cls}">${action.replace('Overweight','OW').replace('Underweight','UW')}</span>
      <span style="min-width:70px;text-align:right;font-family:var(--mono);color:${cls}">${deltaStr}</span>
    </div>`;
  });
  
  bar.innerHTML = `<div style="font-size:9px;color:var(--text-3);letter-spacing:1px;text-transform:uppercase;font-weight:700;margin-bottom:8px;">ğŸ¯ Allocation Drift</div>${rows.join('')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 7: WHAT-IF SCENARIO CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scenarioDeltas = {}; // { assetId or 'gold' or 'egp': pctChange }

window.openScenarioModal = function() {
  scenarioDeltas = {};
  const sliders = document.getElementById('scenarioSliders');
  let html = '';
  
  // Gold scenario if any gold
  if(assets.some(a=>a.type==='gold')) {
    html += scenarioSliderHTML('gold','Gold Price', goldPerOz||0, 'USD/oz');
  }
  // EGP/USD rate
  const egpR = getFxRate('EGP');
  if(egpR) html += scenarioSliderHTML('egp','USD/EGP Rate', egpR, 'EGP');
  // ETFs
  assets.filter(a=>a.type==='etf').forEach(a=>{
    const ep = etfPrices[a.ticker];
    const px = ep?.price||a.manualPrice||0;
    if(px>0) html += scenarioSliderHTML(a.id, a.label+(a.ticker?` (${a.ticker})`:''), px, ep?.currency||'USD');
  });
  
  sliders.innerHTML = html;
  updateScenarioResult();
  document.getElementById('scenarioModal').classList.remove('hidden');
};

function scenarioSliderHTML(id, label, basePrice, ccy) {
  return `<div style="margin-bottom:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <span style="font-size:13px;font-weight:600;color:var(--text)">${label}</span>
      <span style="font-size:11px;font-family:var(--mono);color:var(--text-2)">
        <span id="sc-base-${id}">${ccy} ${Number(basePrice).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
        â†’ <span id="sc-val-${id}" style="color:var(--gold)">${ccy} ${Number(basePrice).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
      </span>
    </div>
    <input type="range" min="-50" max="50" step="0.5" value="0" 
      style="width:100%;accent-color:var(--gold)" 
      oninput="updateScenarioDelta('${id}',${basePrice},parseFloat(this.value),'${ccy}',document.getElementById('sc-val-${id}'))">
    <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-4);font-family:var(--mono);">
      <span>âˆ’50%</span><span>0%</span><span>+50%</span>
    </div>
  </div>`;
}

window.updateScenarioDelta = function(id, base, pct, ccy, valEl) {
  scenarioDeltas[id] = pct;
  const newPrice = base * (1 + pct/100);
  if(valEl) {
    valEl.textContent = ccy+' '+newPrice.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    valEl.style.color = pct>0?'var(--green)':pct<0?'var(--red)':'var(--gold)';
  }
  updateScenarioResult();
};

function updateScenarioResult() {
  const baseTotal = getTotalUSD();
  let scenarioTotal = 0;
  const egpDelta = scenarioDeltas['egp']||0;
  const goldDelta = scenarioDeltas['gold']||0;
  
  assets.forEach(a=>{
    if(a.type==='etf') {
      const ep = etfPrices[a.ticker];
      const basePx = ep?.price||a.manualPrice||0;
      const d = scenarioDeltas[a.id]||0;
      const newPx = basePx*(1+d/100);
      let v = (a.holding||0)*newPx;
      if(ep?.currency&&ep.currency!=='USD') v = toUSD(v,ep.currency);
      scenarioTotal += v;
    } else if(a.type==='gold') {
      const newGold = goldPerOz*(1+goldDelta/100);
      const ppg = newGold/TROY_OZ_GRAM*(a.purity||1);
      scenarioTotal += (a.holding||0)*ppg;
    } else if(a.type==='cash'||a.type==='deposit') {
      // Apply EGP rate change if applicable
      if((a.currency||'USD')==='EGP'&&egpDelta!==0) {
        const baseRate = getFxRate('EGP')||1;
        const newRate = baseRate*(1+egpDelta/100);
        scenarioTotal += (a.holding||0)/newRate;
      } else {
        scenarioTotal += assetValueUSD(a);
      }
    } else {
      scenarioTotal += assetValueUSD(a);
    }
  });
  
  const diff = scenarioTotal - baseTotal;
  const pct = baseTotal>0?(diff/baseTotal*100):0;
  const el = document.getElementById('scenarioResult');
  const dl = document.getElementById('scenarioDiff');
  if(el) {
    el.textContent = fmt(scenarioTotal);
    el.style.color = diff>=0?'var(--green)':'var(--red)';
  }
  if(dl) {
    dl.textContent = (diff>=0?'+':'')+fmt(Math.abs(diff))+' ('+fmtPct(pct)+') vs current '+fmt(baseTotal);
    dl.style.color = diff>=0?'var(--green)':'var(--red)';
  }
}

window.resetScenario = function() {
  scenarioDeltas={};
  openScenarioModal();
};
window.closeScenarioModal = function() { document.getElementById('scenarioModal').classList.add('hidden'); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 5: RISK METRICS (Volatility, Sharpe, Max Drawdown, Correlation)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcRiskMetrics(snaps) {
  if(snaps.length < 5) return null;
  
  // Daily returns
  const returns = [];
  for(let i=1;i<snaps.length;i++){
    const prev=snaps[i-1].totalUSD, cur=snaps[i].totalUSD;
    if(prev>0) returns.push((cur-prev)/prev);
  }
  if(!returns.length) return null;
  
  const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
  const variance = returns.reduce((a,b)=>a+(b-mean)**2,0)/(returns.length-1);
  const stdDev = Math.sqrt(variance);
  
  // Annualized (252 trading days)
  const annualReturn = mean * 252 * 100;
  const annualVol = stdDev * Math.sqrt(252) * 100;
  
  // Sharpe (assuming 4.5% risk-free rate)
  const rfRate = 4.5;
  const sharpe = annualVol>0 ? (annualReturn - rfRate) / annualVol : null;
  
  // Max drawdown
  let peak = snaps[0].totalUSD, maxDD = 0;
  let ddStart='', ddEnd='';
  snaps.forEach(s=>{
    if(s.totalUSD>peak) { peak=s.totalUSD; ddStart=s.date; }
    const dd = (peak-s.totalUSD)/peak*100;
    if(dd>maxDD) { maxDD=dd; ddEnd=s.date; }
  });
  
  // Best/Worst consecutive periods
  const sortedR = [...returns].sort((a,b)=>b-a);
  
  return { annualReturn, annualVol, stdDev:stdDev*100, sharpe, maxDD, ddStart, ddEnd, 
           bestDay:sortedR[0]*100, worstDay:sortedR[sortedR.length-1]*100, nReturns:returns.length };
}

function calcCorrelationMatrix(snaps) {
  // Build per-asset return series from snapshot breakdown
  const assetIds = [...new Set(snaps.flatMap(s=>Object.keys(s.assets||{})))];
  if(assetIds.length < 2) return null;
  
  // Get assets we actually track
  const tracked = assetIds.filter(id=>assets.find(a=>a.id===id)).slice(0,6); // max 6
  if(tracked.length < 2) return null;
  
  // Build return series per asset
  const series = {};
  tracked.forEach(id=>{
    const vals = snaps.map(s=>(s.assets||{})[id]||0);
    const rets = [];
    for(let i=1;i<vals.length;i++) { if(vals[i-1]>0) rets.push((vals[i]-vals[i-1])/vals[i-1]); else rets.push(0); }
    series[id] = rets;
  });
  
  // Correlation between pairs
  const n = Math.min(...tracked.map(id=>series[id].length));
  const corr = {};
  tracked.forEach(idA=>{
    tracked.forEach(idB=>{
      if(idA===idB) { corr[idA+'|'+idB]=1; return; }
      const a=series[idA].slice(0,n), b=series[idB].slice(0,n);
      const ma=a.reduce((s,v)=>s+v,0)/n, mb=b.reduce((s,v)=>s+v,0)/n;
      let num=0,da=0,db=0;
      for(let i=0;i<n;i++){num+=(a[i]-ma)*(b[i]-mb);da+=(a[i]-ma)**2;db+=(b[i]-mb)**2;}
      const r=da>0&&db>0?num/Math.sqrt(da*db):0;
      corr[idA+'|'+idB]=r;
    });
  });
  return { ids:tracked, corr };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 6: CURRENCY EXPOSURE ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCurrencyExposure() {
  const exposure = {};
  const total = getTotalUSD();
  if(total<=0) return {};
  
  assets.forEach(a=>{
    let ccy;
    if(a.type==='cash'||a.type==='deposit') ccy = a.currency||'USD';
    else if(a.type==='gold') ccy = 'GOLD';  // commodity, not currency
    else if(a.type==='etf') {
      const ep = etfPrices[a.ticker];
      const ex = (ep ? '' : '').toLowerCase();
      const ticker = (a.ticker||'').toUpperCase();
      if(ticker.endsWith('.CA')) ccy='EGP';
      else if(ticker.endsWith('.L')||(ep?.currency==='GBp'||ep?.currency==='GBP')) ccy='GBP';
      else ccy = ep?.currency||'USD';
    }
    else ccy = 'USD';
    const v = assetValueUSD(a);
    exposure[ccy] = (exposure[ccy]||0) + v;
  });
  return exposure;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MARKETS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MARKETS = [
  // â”€â”€ Americas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { region:'Americas', name:'NYSE / Nasdaq', country:'ğŸ‡ºğŸ‡¸', index:'SPY Â· QQQ Â· DIA', tz:'America/New_York',
    open:'09:30', close:'16:00', pre:'04:00', after:'20:00',
    hasPre:true, hasAfter:true, days:[1,2,3,4,5], note:'Largest equity market in the world' },
  { region:'Americas', name:'Toronto Stock Exchange', country:'ğŸ‡¨ğŸ‡¦', index:'TSX Â· XIU', tz:'America/Toronto',
    open:'09:30', close:'16:00', pre:'07:00', after:'17:30',
    hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Canada\'s primary exchange' },
  { region:'Americas', name:'B3 (SÃ£o Paulo)', country:'ğŸ‡§ğŸ‡·', index:'IBOV', tz:'America/Sao_Paulo',
    open:'10:00', close:'17:55', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Largest exchange in Latin America' },

  // â”€â”€ Europe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { region:'Europe', name:'London Stock Exchange', country:'ğŸ‡¬ğŸ‡§', index:'FTSE 100 Â· FTSE 250', tz:'Europe/London',
    open:'08:00', close:'16:30', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Auction: 07:50â€“08:00' },
  { region:'Europe', name:'Euronext Paris', country:'ğŸ‡«ğŸ‡·', index:'CAC 40', tz:'Europe/Paris',
    open:'09:00', close:'17:30', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Auction: 08:00â€“09:00' },
  { region:'Europe', name:'Frankfurt (XETRA)', country:'ğŸ‡©ğŸ‡ª', index:'DAX 40', tz:'Europe/Berlin',
    open:'09:00', close:'17:30', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Pre-trading: 08:00â€“09:00' },
  { region:'Europe', name:'Euronext Amsterdam', country:'ğŸ‡³ğŸ‡±', index:'AEX', tz:'Europe/Amsterdam',
    open:'09:00', close:'17:30', hasPre:false, hasAfter:false, days:[1,2,3,4,5] },
  { region:'Europe', name:'SIX Swiss Exchange', country:'ğŸ‡¨ğŸ‡­', index:'SMI', tz:'Europe/Zurich',
    open:'09:00', close:'17:30', hasPre:false, hasAfter:false, days:[1,2,3,4,5] },

  // â”€â”€ Middle East / Africa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { region:'MENA & Africa', name:'Egyptian Exchange (EGX)', country:'ğŸ‡ªğŸ‡¬', index:'EGX 30 Â· EGX 70', tz:'Africa/Cairo',
    open:'10:00', close:'14:30', hasPre:false, hasAfter:false, days:[0,1,2,3,4], note:'Sunâ€“Thu; Cairo time â† you are here' },
  { region:'MENA & Africa', name:'Saudi Exchange (Tadawul)', country:'ğŸ‡¸ğŸ‡¦', index:'TASI Â· NOMU', tz:'Asia/Riyadh',
    open:'10:00', close:'15:00', hasPre:false, hasAfter:false, days:[0,1,2,3,4], note:'Sunâ€“Thu' },
  { region:'MENA & Africa', name:'Dubai (DFM)', country:'ğŸ‡¦ğŸ‡ª', index:'DFMGI', tz:'Asia/Dubai',
    open:'10:00', close:'14:00', hasPre:false, hasAfter:false, days:[0,1,2,3,4], note:'Sunâ€“Thu' },
  { region:'MENA & Africa', name:'Abu Dhabi (ADX)', country:'ğŸ‡¦ğŸ‡ª', index:'FTSE ADX', tz:'Asia/Dubai',
    open:'10:00', close:'13:45', hasPre:false, hasAfter:false, days:[0,1,2,3,4], note:'Sunâ€“Thu' },
  { region:'MENA & Africa', name:'Johannesburg (JSE)', country:'ğŸ‡¿ğŸ‡¦', index:'FTSE/JSE Top 40', tz:'Africa/Johannesburg',
    open:'09:00', close:'17:00', hasPre:false, hasAfter:false, days:[1,2,3,4,5] },

  // â”€â”€ Asia Pacific â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { region:'Asia Pacific', name:'Tokyo Stock Exchange', country:'ğŸ‡¯ğŸ‡µ', index:'Nikkei 225 Â· TOPIX', tz:'Asia/Tokyo',
    open:'09:00', close:'15:30', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Lunch break 11:30â€“12:30' },
  { region:'Asia Pacific', name:'Shanghai Stock Exchange', country:'ğŸ‡¨ğŸ‡³', index:'SSE Â· CSI 300', tz:'Asia/Shanghai',
    open:'09:30', close:'15:00', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Lunch break 11:30â€“13:00' },
  { region:'Asia Pacific', name:'Shenzhen Stock Exchange', country:'ğŸ‡¨ğŸ‡³', index:'SZSE Â· ChiNext', tz:'Asia/Shanghai',
    open:'09:30', close:'15:00', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Lunch break 11:30â€“13:00' },
  { region:'Asia Pacific', name:'Hong Kong Exchange (HKEX)', country:'ğŸ‡­ğŸ‡°', index:'Hang Seng', tz:'Asia/Hong_Kong',
    open:'09:30', close:'16:00', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Lunch break 12:00â€“13:00' },
  { region:'Asia Pacific', name:'Bombay Stock Exchange', country:'ğŸ‡®ğŸ‡³', index:'SENSEX Â· NIFTY 50', tz:'Asia/Kolkata',
    open:'09:15', close:'15:30', hasPre:false, hasAfter:false, days:[1,2,3,4,5] },
  { region:'Asia Pacific', name:'Korea Exchange (KRX)', country:'ğŸ‡°ğŸ‡·', index:'KOSPI Â· KOSDAQ', tz:'Asia/Seoul',
    open:'09:00', close:'15:30', hasPre:false, hasAfter:false, days:[1,2,3,4,5] },
  { region:'Asia Pacific', name:'Australian Securities Exchange', country:'ğŸ‡¦ğŸ‡º', index:'ASX 200', tz:'Australia/Sydney',
    open:'10:00', close:'16:00', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Pre-open 07:00â€“10:00' },
  { region:'Asia Pacific', name:'Singapore Exchange (SGX)', country:'ğŸ‡¸ğŸ‡¬', index:'STI', tz:'Asia/Singapore',
    open:'09:00', close:'17:00', hasPre:false, hasAfter:false, days:[1,2,3,4,5], note:'Lunch break 12:00â€“13:00' },
];

// Convert HH:MM in market's local tz to minutes since midnight Cairo
function mktTimeToMinutesCairo(hhmm, mktTz, refDate) {
  // Build a date in the market's local timezone and convert to Cairo time
  const [hh, mm] = hhmm.split(':').map(Number);
  // Use Intl to get the market's UTC offset at refDate
  const mktLocal = new Date(refDate);
  // Format refDate in market tz to get the date string
  const dateParts = new Intl.DateTimeFormat('en-CA', {
    timeZone: mktTz, year:'numeric', month:'2-digit', day:'2-digit'
  }).format(mktLocal).split('-').map(Number);
  // Build a UTC instant representing HH:MM in market's local tz
  const mktDateStr = `${dateParts[0]}-${String(dateParts[1]).padStart(2,'0')}-${String(dateParts[2]).padStart(2,'0')}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`;
  // Get market tz offset by comparing a fixed reference
  const testDate = new Date(mktDateStr + 'Z'); // treat as UTC first
  const mktFormatter = new Intl.DateTimeFormat('en-CA', {
    timeZone: mktTz, hour:'2-digit', minute:'2-digit', hour12:false
  });
  const cairoFormatter = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'Africa/Cairo', hour:'2-digit', minute:'2-digit', hour12:false
  });
  // Binary search for the offset isn't needed â€” use a known reference approach:
  // Construct the exact UTC time that corresponds to HH:MM in mktTz
  // by iterating over possible offsets from -12 to +14
  // More practical: use the offset difference via Intl API
  const now = new Date(refDate);
  const mktNowStr = mktFormatter.format(now);
  const cairoNowStr = cairoFormatter.format(now);
  const mktNowMin = parseInt(mktNowStr.split(':')[0])*60 + parseInt(mktNowStr.split(':')[1]);
  const cairoNowMin = parseInt(cairoNowStr.split(':')[0])*60 + parseInt(cairoNowStr.split(':')[1]);
  const offsetMin = cairoNowMin - mktNowMin; // cairo is this many minutes ahead of market local
  return hh * 60 + mm + offsetMin;
}

function getMarketStatus(mkt, now) {
  // now = current Date object
  const cairoFormatter = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'Africa/Cairo', weekday:'short', hour:'2-digit', minute:'2-digit', hour12:false
  });
  const mktDayFormatter = new Intl.DateTimeFormat('en-CA', {
    timeZone: mkt.tz, weekday:'short'
  });
  const mktHMFormatter = new Intl.DateTimeFormat('en-CA', {
    timeZone: mkt.tz, hour:'2-digit', minute:'2-digit', hour12:false
  });

  // Current time in market's local timezone
  const mktHMStr = mktHMFormatter.format(now);
  const mktH = parseInt(mktHMStr.split(':')[0]);
  const mktM = parseInt(mktHMStr.split(':')[1]);
  const mktMin = mktH * 60 + mktM;

  // Day of week in market's local timezone (0=Sun)
  const mktDayStr = mktDayFormatter.format(now);
  const dayMap = {Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6};
  const mktDay = dayMap[mktDayStr];

  const isWeekday = mkt.days.includes(mktDay);

  const [oh, om] = mkt.open.split(':').map(Number);
  const [ch, cm] = mkt.close.split(':').map(Number);
  const openMin = oh*60+om;
  const closeMin = ch*60+cm;

  let preMin = 0, afterMin = 1440;
  if(mkt.hasPre && mkt.pre) {
    const [ph,pm]=mkt.pre.split(':').map(Number); preMin=ph*60+pm;
  }
  if(mkt.hasAfter && mkt.after) {
    const [ah,am]=mkt.after.split(':').map(Number); afterMin=ah*60+am;
  }

  if(!isWeekday) return { status:'closed', label:'Closed', cls:'status-closed' };
  if(mktMin >= openMin && mktMin < closeMin) return { status:'open', label:'Open', cls:'status-open' };
  if(mkt.hasPre && mktMin >= preMin && mktMin < openMin) return { status:'pre', label:'Pre-Market', cls:'status-pre' };
  if(mkt.hasAfter && mktMin >= closeMin && mktMin < afterMin) return { status:'after', label:'After Hours', cls:'status-after' };
  return { status:'closed', label:'Closed', cls:'status-closed' };
}

function formatCairoTime(tzStr, now) {
  return new Intl.DateTimeFormat('en-US', {
    timeZone: tzStr, hour:'2-digit', minute:'2-digit', hour12:false
  }).format(now);
}

function mktHoursInCairo(mkt, now) {
  // Show open/close times converted to Cairo time for easy reference
  const openCairo = convertMktTimeToCairo(mkt.open, mkt.tz, now);
  const closeCairo = convertMktTimeToCairo(mkt.close, mkt.tz, now);
  return `${openCairo} â€“ ${closeCairo} Cairo`;
}

function convertMktTimeToCairo(hhmm, mktTz, refNow) {
  // Find the UTC instant that corresponds to hhmm in mktTz on today's market date
  const mktDateStr = new Intl.DateTimeFormat('en-CA', {
    timeZone: mktTz, year:'numeric', month:'2-digit', day:'2-digit'
  }).format(refNow);
  const [yy,mm,dd] = mktDateStr.split('-');
  const [hh,mn] = hhmm.split(':');
  // Construct an ISO string assumed to be in mktTz; find its UTC equivalent
  // Approximation: build date as UTC and apply offset
  const approxUtc = new Date(`${yy}-${mm}-${dd}T${hh}:${mn}:00Z`);
  // Get offset: diff between UTC and market local
  const mktLocal = new Intl.DateTimeFormat('en-CA', {
    timeZone: mktTz, hour:'2-digit', minute:'2-digit', hour12:false
  }).format(approxUtc);
  const [mh,mmn] = mktLocal.split(':').map(Number);
  const wantH = parseInt(hh), wantM = parseInt(mn);
  const diffMin = (wantH*60+wantM) - (mh*60+mmn);
  const utcMs = approxUtc.getTime() + diffMin*60000;
  // Now format that UTC instant in Cairo
  return new Intl.DateTimeFormat('en-US', {
    timeZone: 'Africa/Cairo', hour:'2-digit', minute:'2-digit', hour12:false
  }).format(new Date(utcMs));
}

let marketsRefreshTimer = null;
window.renderMarketsTab = function() {
  const now = new Date();
  const cairoTime = new Intl.DateTimeFormat('en-US', {
    timeZone:'Africa/Cairo', weekday:'short', year:'numeric', month:'short',
    day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
  }).format(now);
  const el = document.getElementById('marketsCairoTime');
  if(el) el.textContent = 'ğŸ• Cairo: ' + cairoTime;

  const grid = document.getElementById('marketsGrid');
  if(!grid) return;

  const regions = [...new Set(MARKETS.map(m=>m.region))];
  let html = '';

  regions.forEach(region => {
    html += `<div class="markets-section-title">${region}</div>`;
    MARKETS.filter(m=>m.region===region).forEach(mkt => {
      const s = getMarketStatus(mkt, now);
      const cairoHours = mktHoursInCairo(mkt, now);
      const daysLabel = (JSON.stringify(mkt.days)===JSON.stringify([1,2,3,4,5]))?'Monâ€“Fri':
                        (JSON.stringify(mkt.days)===JSON.stringify([0,1,2,3,4]))?'Sunâ€“Thu':'Custom';
      html += `
      <div class="market-card">
        <div class="market-card-header">
          <div>
            <div class="market-name">${mkt.country} ${mkt.name}</div>
            <div class="market-index">${mkt.index}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;">
            <span class="market-status ${s.cls}"><span class="status-dot"></span>${s.label}</span>
            <span class="market-region-tag">${daysLabel}</span>
          </div>
        </div>
        <div class="market-hours-row">
          <span class="market-hours-label">Trading Hours (Cairo)</span>
          <span class="market-hours-val">${cairoHours}</span>
        </div>
        ${mkt.hasPre ? `<div class="market-hours-row" style="border-top:none;margin-top:2px;padding-top:0;">
          <span class="market-hours-label" style="color:var(--blue)">Pre-Market</span>
          <span class="market-hours-val" style="color:var(--blue)">${convertMktTimeToCairo(mkt.pre, mkt.tz, now)} Cairo</span>
        </div>` : ''}
        ${mkt.hasAfter ? `<div class="market-hours-row" style="border-top:none;margin-top:2px;padding-top:0;">
          <span class="market-hours-label" style="color:var(--gold)">After-Hours</span>
          <span class="market-hours-val" style="color:var(--gold)">${convertMktTimeToCairo(mkt.after, mkt.tz, now)} Cairo</span>
        </div>` : ''}
        ${mkt.note ? `<div style="margin-top:8px;font-size:10px;color:var(--text-3);font-family:var(--mono);">â“˜ ${mkt.note}</div>` : ''}
      </div>`;
    });
  });

  grid.innerHTML = html;

  // Auto-refresh every 30s while tab is visible
  clearTimeout(marketsRefreshTimer);
  marketsRefreshTimer = setTimeout(()=>{
    if(document.getElementById('tab-markets').classList.contains('active')) renderMarketsTab();
  }, 30000);
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANUAL SNAPSHOT ENTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openManualSnapshotModal = function() {
  const form = document.getElementById('manualSnapForm');
  form.style.display = form.style.display === 'none' ? '' : 'none';
  // Pre-fill with yesterday's Cairo date
  if(form.style.display !== 'none') {
    const nowMs = Date.now() + 2*60*60*1000; // shift to Cairo UTC+2
    const yesterday = new Date(nowMs - 86400000);
    document.getElementById('manualSnapDate').value = yesterday.toISOString().slice(0,10);
    document.getElementById('manualSnapValue').value = '';
    document.getElementById('manualSnapValue').focus();
  }
};

window.saveManualSnapshot = async function() {
  const dateVal = document.getElementById('manualSnapDate').value;
  const valueVal = parseFloat(document.getElementById('manualSnapValue').value);
  if(!dateVal) { showToast('Please enter a date','error'); return; }
  if(isNaN(valueVal) || valueVal <= 0) { showToast('Please enter a valid USD value','error'); return; }

  const snap = { date: dateVal, totalUSD: valueVal, assets: {} };
  // Check if overwriting
  const existing = snapshots.findIndex(s => s.date === dateVal);
  if(existing >= 0) {
    if(!confirm(`A snapshot for ${dateVal} already exists ($${snapshots[existing].totalUSD.toFixed(2)}). Overwrite it?`)) return;
    snapshots[existing] = snap;
  } else {
    snapshots.push(snap);
    snapshots.sort((a,b) => a.date.localeCompare(b.date));
  }
  await saveSnapshot(snap);
  document.getElementById('manualSnapForm').style.display = 'none';
  renderHistoryTab();
  showToast(`Snapshot for ${dateVal} saved âœ“`, 'success');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.clearHistory = async function() {
  if(!confirm('Clear all snapshot history?')) return;
  await sb.from('snapshots').delete().eq('user_id', currentUser.id);
  snapshots=[]; renderHistoryTab(); showToast('History cleared','info');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.downloadCSV = function() {
  let csv='Asset,Type,Ticker,Currency,Holding,Value USD,Allocation %,Avg Cost,Unrealized USD,Unrealized %\n';
  const total=getTotalUSD();
  assets.forEach(a=>{const v=assetValueUSD(a);const p=total>0?((v/total)*100).toFixed(2):'0.00';const u=unrealizedUSD(a);const b=costBasisUSD(a);csv+='"'+a.label+'",'+a.type+','+(a.ticker||'')+','+(a.currency||'')+','+a.holding+','+v.toFixed(2)+','+p+','+(a.avgCost||'')+','+(u!==null?u.toFixed(2):'')+','+(u!==null&&b>0?(u/b*100).toFixed(2):'')+'\n';});
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const l=document.createElement('a');l.href=url;l.download='portfolio_'+new Date().toISOString().slice(0,10)+'.csv';l.click();URL.revokeObjectURL(url);showToast('CSV downloaded','success');
};

window.printView = function() {
  const total=getTotalUSD();const egp=getFxRate('EGP')||0;
  let html=`<html><head><title>Portfolio â€” ${new Date().toLocaleDateString()}</title><style>body{font-family:sans-serif;padding:30px;color:#111}table{width:100%;border-collapse:collapse;font-size:13px}th{background:#f0f0f0;padding:8px 12px;text-align:left;font-size:11px;text-transform:uppercase}td{padding:8px 12px;border-bottom:1px solid #eee}h1{font-size:22px;margin-bottom:4px}p{color:#666;font-size:13px;margin:0 0 20px}.total{font-size:32px;font-weight:700;margin:8px 0}.egp{font-size:16px;color:#666}</style></head><body>`;
  html+=`<h1>Portfolio Summary</h1><p>${new Date().toLocaleString()}</p><div class="total">${fmt(total)}</div><div class="egp">${egp?'EGP '+(total*egp).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):''}</div><table><thead><tr><th>Asset</th><th>Type</th><th>Holding</th><th>Value USD</th><th>Allocation</th><th>Unrealized</th></tr></thead><tbody>`;
  const t2=getTotalUSD();assets.forEach(a=>{const v=assetValueUSD(a);const p=t2>0?((v/t2)*100).toFixed(1)+'%':'â€”';const u=unrealizedUSD(a);html+=`<tr><td>${a.label}${a.ticker?' ('+a.ticker+')':''}</td><td>${a.type}</td><td>${a.holding} ${a.currency||a.ticker||'g'}</td><td>${fmt(v)}</td><td>${p}</td><td>${u!==null?fmtSigned(u):'â€”'}</td></tr>`;});
  html+=`</tbody></table></body></html>`;
  const w=window.open('','_blank');w.document.write(html);w.document.close();w.print();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACCOUNT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openAccountModal = function() { document.getElementById('accountModal').classList.remove('hidden'); };
window.changePassword = async function() {
  const p1=document.getElementById('newPass1')?.value||'';
  const p2=document.getElementById('newPass2')?.value||'';
  const msg=document.getElementById('passChangeMsg');
  if(!p1||!p2){if(msg)msg.textContent='Enter and confirm new password.';return;}
  if(p1!==p2){if(msg)msg.textContent='Passwords do not match.';return;}
  if(p1.length<6){if(msg)msg.textContent='Password must be at least 6 characters.';return;}
  if(msg)msg.textContent='Updatingâ€¦';
  const{error}=await sb.auth.updateUser({password:p1});
  if(error){if(msg){msg.textContent='Error: '+error.message;msg.style.color='var(--red)';}}
  else{if(msg){msg.textContent='âœ… Password updated!';msg.style.color='var(--green)';document.getElementById('newPass1').value='';document.getElementById('newPass2').value='';}}
};
window.closeAccountModal = function() { document.getElementById('accountModal').classList.add('hidden'); };
window.confirmDeleteAll = async function() {
  if(!confirm('âš ï¸ This will delete ALL your assets, transactions, and history. This cannot be undone. Are you sure?')) return;
  if(!confirm('Really? ALL data will be gone permanently.')) return;
  const uid=currentUser.id;
  await Promise.all([sb.from('assets').delete().eq('user_id',uid),sb.from('transactions').delete().eq('user_id',uid),sb.from('snapshots').delete().eq('user_id',uid),sb.from('settings').delete().eq('user_id',uid)]);
  assets=[];transactions={};snapshots=[];render();showToast('All data deleted.','error');
  closeAccountModal();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openAddModal = function() {
  document.getElementById('addModal').classList.remove('hidden');
  // Reset all input fields
  ['aTicker','aShares','aAvgCost','aCashLabel','aCashAmt','aGoldGrams','aDepLabel','aDepAmt','aDepRate','aDepMaturity'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  // Reset selects to defaults
  document.getElementById('aCashCcy').value='USD';
  document.getElementById('aDepCcy').value='EGP';
  document.getElementById('cashAmtUnit').textContent='USD';
  document.getElementById('depAmtUnit').textContent='EGP';
  // Reset karat to 24K
  selectedKarat={karat:24,purity:1.0};
  document.querySelectorAll('.karat-btn').forEach(b=>b.classList.remove('selected'));
  const k24=document.querySelector('.karat-btn[data-karat="24"]');if(k24)k24.classList.add('selected');
  document.getElementById('aGoldPurity').value='1.0';
  document.getElementById('aGoldLabel').value='24K Gold';
  // Hide previews
  ['etfPreview','goldPreview'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display='none';});
  // Reset add btn
  const btn=document.getElementById('addAssetBtn');if(btn){btn.disabled=false;btn.innerHTML='<span>ï¼‹</span> Add Asset';}
  // Default to ETF tab
  selectType('etf', document.querySelector('[data-type="etf"]'));
  setTimeout(()=>document.getElementById('aTicker')?.focus(),50);
};
window.closeAddModal = function() { document.getElementById('addModal').classList.add('hidden'); };

// â”€â”€ User Menu â”€â”€
window.toggleUserMenu = function() { document.getElementById('userMenuDropdown').classList.toggle('hidden'); };
window.closeUserMenu = function() { document.getElementById('userMenuDropdown').classList.add('hidden'); };

function setupClickOutside(){document.addEventListener('click',e=>{const menu=document.getElementById('userMenuDropdown');const avatar=document.getElementById('userAvatar');if(!menu.contains(e.target)&&!avatar.contains(e.target))menu.classList.add('hidden');});}

function setupKeyListeners(){
  document.addEventListener('keydown',e=>{
    const tag=document.activeElement?.tagName?.toLowerCase();
    const inInput=tag==='input'||tag==='textarea'||tag==='select';
    if(e.key==='Escape'){['addModal','txModal','accountModal'].forEach(id=>document.getElementById(id)?.classList.add('hidden'));}
    if(!inInput){
      if(e.key==='r'||e.key==='R'){e.preventDefault();fetchAllPrices();}
      if(e.key==='/'||e.key==='f'||e.key==='F'){e.preventDefault();document.querySelector('.search-input')?.focus();}
      if(e.key==='n'||e.key==='N'){e.preventDefault();openAddModal();}
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(v){return'$'+Math.abs(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtSigned(v){return(v>=0?'+':'âˆ’')+'$'+Math.abs(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtPct(v){return(v>=0?'+':'')+v.toFixed(2)+'%';}
function fmtDate(d){try{return new Date(d+'T00:00:00').toLocaleDateString();}catch{return d;}}
// Currency-aware display helpers (Feature 5)
function fmtCcy(usdVal){
  if(displayCurrency==='EGP'){const r=getFxRate('EGP');if(!r)return fmt(usdVal);return 'EGP\u00a0'+(usdVal*r).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
  return fmt(usdVal);
}
function fmtCcySigned(usdVal){
  if(displayCurrency==='EGP'){const r=getFxRate('EGP');if(!r)return fmtSigned(usdVal);return(usdVal>=0?'+':'\u2212')+'EGP\u00a0'+Math.abs(usdVal*r).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
  return fmtSigned(usdVal);
}
window.toggleDisplayCurrency = function(){
  displayCurrency = displayCurrency==='USD'?'EGP':'USD';
  saveSettings(); updateCurrToggleBtn(); render();
  if(document.getElementById('tab-history')?.classList.contains('active')) renderHistoryTab();
};
function updateCurrToggleBtn(){
  const btn=document.getElementById('currToggleBtn');
  const lbl=document.getElementById('currToggleLabel');
  if(!btn||!lbl)return;
  if(displayCurrency==='EGP'){
    lbl.textContent='ğŸ’µ View in USD';
    btn.style.background='rgba(201,168,76,0.12)';btn.style.borderColor='rgba(201,168,76,0.35)';btn.style.color='var(--gold)';
  } else {
    lbl.textContent='ğŸŒ View in EGP';
    btn.style.background='';btn.style.borderColor='';btn.style.color='';
  }
}
function genId(){return'a-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6);}
function show(id){document.getElementById(id)?.classList.remove('hidden');}
function hide(id){document.getElementById(id)?.classList.add('hidden');}
function setText(id,t){const e=document.getElementById(id);if(e)e.textContent=t;}
function setSyncStatus(online,label){const dot=document.getElementById('syncDot');const lbl=document.getElementById('syncLabel');if(dot)dot.className='sync-dot'+(online?'':' offline');if(lbl)lbl.textContent=label||'';}

let toastTimer={};
window.showToast = function(msg, type='info') {
  const c=document.getElementById('toastContainer');
  const t=document.createElement('div');t.className='toast '+type;
  const icon={success:'âœ…',error:'âŒ',info:'â„¹ï¸'}[type]||'';
  t.textContent=(icon?icon+' ':'')+msg;
  c.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity 0.3s';setTimeout(()=>t.remove(),400);},3000);
};

})(); // end _boot
</script>
</body>
</html>
