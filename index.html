<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Investments ‚Äî Marwan</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #08090c;
  --surface: rgba(255,255,255,0.03);
  --surface-raised: rgba(255,255,255,0.055);
  --border: rgba(255,255,255,0.07);
  --border-active: rgba(255,255,255,0.15);
  --text: #f0f0f2;
  --text-2: #a0a0b0;
  --text-3: #606070;
  --gold: #d4a847;
  --gold-soft: rgba(212,168,71,0.12);
  --gold-border: rgba(212,168,71,0.25);
  --blue: #4f8ef7;
  --blue-soft: rgba(79,142,247,0.12);
  --green: #3dd68c;
  --red: #f05b5b;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'Syne', system-ui, sans-serif;
  --r: 10px;
  --r-lg: 16px;
}
html { scroll-behavior: smooth; }
body {
  min-height: 100vh;
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ‚îÄ NOISE + GRADIENT BG ‚îÄ‚îÄ‚îÄ */
body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 60% 40% at 80% 10%, rgba(212,168,71,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 50% 50% at 10% 90%, rgba(79,142,247,0.04) 0%, transparent 60%);
  pointer-events: none; z-index: 0;
}

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
.app { max-width: 980px; margin: 0 auto; padding: 36px 20px 80px; position: relative; z-index: 1; }

/* ‚îÄ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ‚îÄ */
.auth-wrap {
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
}
.auth-card {
  width: 100%; max-width: 400px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 40px 36px;
  animation: fadeUp 0.4s ease both;
}
.auth-logo {
  text-align: center; margin-bottom: 32px;
}
.auth-logo-icon {
  font-size: 32px; display: block; margin-bottom: 8px;
}
.auth-logo h1 {
  font-size: 22px; font-weight: 800;
  color: var(--text); letter-spacing: -0.5px;
}
.auth-logo p { font-size: 13px; color: var(--text-3); margin-top: 4px; }

.auth-divider {
  display: flex; align-items: center; gap: 10px;
  margin: 20px 0; color: var(--text-3); font-size: 12px;
}
.auth-divider::before, .auth-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

.passkey-btn {
  width: 100%; padding: 13px;
  background: var(--gold-soft); border: 1px solid var(--gold-border);
  color: var(--gold); border-radius: var(--r);
  font-family: var(--sans); font-size: 14px; font-weight: 700;
  cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: all 0.2s;
}
.passkey-btn:hover { background: rgba(212,168,71,0.2); }

/* ‚îÄ‚îÄ‚îÄ FORM INPUTS ‚îÄ‚îÄ‚îÄ */
.field { margin-bottom: 14px; }
.field label { display: block; font-size: 11px; font-weight: 600; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
.field input {
  width: 100%; padding: 10px 13px;
  background: rgba(0,0,0,0.35); border: 1px solid var(--border);
  color: var(--text); border-radius: var(--r);
  font-family: var(--sans); font-size: 14px; outline: none;
  transition: border-color 0.2s;
}
.field input:focus { border-color: var(--blue); }

/* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
.btn {
  padding: 9px 16px; border-radius: var(--r);
  border: 1px solid var(--border); background: var(--surface);
  color: var(--text-2); font-family: var(--sans); font-size: 13px; font-weight: 600;
  cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
  transition: all 0.18s; white-space: nowrap;
}
.btn:hover { background: var(--surface-raised); color: var(--text); border-color: var(--border-active); }
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
.btn-primary { background: var(--blue-soft); border-color: rgba(79,142,247,0.3); color: var(--blue); }
.btn-primary:hover { background: rgba(79,142,247,0.22); color: #7eb0ff; }
.btn-gold { background: var(--gold-soft); border-color: var(--gold-border); color: var(--gold); }
.btn-gold:hover { background: rgba(212,168,71,0.2); }
.btn-danger { background: rgba(240,91,91,0.1); border-color: rgba(240,91,91,0.25); color: var(--red); }
.btn-danger:hover { background: rgba(240,91,91,0.2); }
.btn-full { width: 100%; justify-content: center; padding: 11px; }
.btn-sm { padding: 5px 10px; font-size: 12px; }

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.header {
  display: flex; align-items: flex-start; justify-content: space-between;
  gap: 16px; flex-wrap: wrap; margin-bottom: 28px;
}
.header-left h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; color: var(--text); }
.header-left p { font-size: 12px; color: var(--text-3); margin-top: 3px; }
.header-btns { display: flex; gap: 7px; flex-wrap: wrap; align-items: center; }
.sync-dot {
  width: 6px; height: 6px; border-radius: 50%; background: var(--green); display: inline-block;
  box-shadow: 0 0 6px var(--green);
}
.sync-dot.offline { background: var(--text-3); box-shadow: none; }

/* ‚îÄ‚îÄ‚îÄ TOTAL CARD ‚îÄ‚îÄ‚îÄ */
.total-card {
  background: linear-gradient(135deg, rgba(255,255,255,0.035) 0%, rgba(255,255,255,0.01) 100%);
  border: 1px solid rgba(212,168,71,0.18);
  border-radius: 20px; padding: 32px 28px 24px;
  margin-bottom: 20px; text-align: center; position: relative; overflow: hidden;
}
.total-card::before {
  content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
  width: 300px; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(212,168,71,0.5), transparent);
}
.total-label { font-size: 10px; font-weight: 700; letter-spacing: 2.5px; color: var(--text-3); text-transform: uppercase; }
.total-usd { font-size: 52px; font-weight: 800; color: var(--text); letter-spacing: -2px; font-family: var(--mono); margin: 8px 0 4px; }
.total-egp { font-size: 18px; color: var(--text-2); font-family: var(--mono); }
.total-gains { display: flex; justify-content: center; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
.gain-pill {
  font-size: 12px; font-family: var(--mono); font-weight: 600;
  padding: 3px 10px; border-radius: 20px;
}
.gain-pill.positive { background: rgba(61,214,140,0.1); color: var(--green); }
.gain-pill.negative { background: rgba(240,91,91,0.1); color: var(--red); }
.gain-pill.neutral { background: var(--surface); color: var(--text-3); }
.alloc-bar { display: flex; height: 5px; border-radius: 3px; overflow: hidden; gap: 2px; margin: 18px 0 10px; }
.alloc-seg { height: 100%; border-radius: 3px; transition: width 0.5s cubic-bezier(0.4,0,0.2,1); min-width: 4px; }
.legend { display: flex; justify-content: center; gap: 14px; flex-wrap: wrap; }
.legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-2); }
.legend-dot { width: 7px; height: 7px; border-radius: 50%; }
.mode-row { display: flex; justify-content: center; gap: 4px; margin-top: 12px; }
.mode-row .btn { padding: 3px 10px; font-size: 11px; }

/* ‚îÄ‚îÄ‚îÄ RATES BANNER ‚îÄ‚îÄ‚îÄ */
.rates-banner { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.rate-chip {
  flex: 1; min-width: 100px; background: var(--surface);
  border: 1px solid var(--border); border-radius: var(--r); padding: 10px 13px;
  transition: border-color 0.2s;
}
.rate-chip:hover { border-color: var(--border-active); }
.rate-top { display: flex; justify-content: space-between; align-items: center; gap: 6px; }
.rate-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-3); }
.rate-value { font-size: 13px; font-family: var(--mono); font-weight: 600; color: var(--text); }
.rate-chg { font-size: 11px; font-family: var(--mono); font-weight: 600; margin-top: 3px; }
.rate-chg.positive { color: var(--green); }
.rate-chg.negative { color: var(--red); }
.rate-meta { font-size: 9px; color: var(--text-3); margin-top: 2px; }

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
.tabs {
  display: flex; gap: 3px; margin-bottom: 22px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 4px;
}
.tab-btn {
  flex: 1; padding: 8px 10px; border-radius: 8px; border: none;
  background: transparent; color: var(--text-3); cursor: pointer;
  font-family: var(--sans); font-size: 13px; font-weight: 600;
  transition: all 0.18s; text-align: center;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { background: var(--surface-raised); color: var(--text); border: 1px solid var(--border); }
.tab-panel { display: none; }
.tab-panel.active { display: block; animation: fadeUp 0.2s ease both; }

/* ‚îÄ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ‚îÄ */
.toolbar { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; align-items: center; }
.search-wrap { position: relative; flex: 1; min-width: 160px; }
.search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-3); font-size: 13px; pointer-events: none; }
.search-input {
  width: 100%; padding: 8px 10px 8px 32px;
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text); border-radius: var(--r);
  font-family: var(--sans); font-size: 13px; outline: none; transition: border-color 0.2s;
}
.search-input:focus { border-color: var(--blue); }
.sort-select {
  padding: 8px 10px; background: var(--surface); border: 1px solid var(--border);
  color: var(--text-2); border-radius: var(--r); font-family: var(--sans); font-size: 13px; outline: none;
}

/* ‚îÄ‚îÄ‚îÄ ASSET CARDS ‚îÄ‚îÄ‚îÄ */
.cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; }
.card {
  border-radius: var(--r-lg); border: 1px solid var(--border);
  padding: 18px; position: relative; transition: border-color 0.2s, transform 0.15s;
  animation: fadeUp 0.25s ease both;
}
.card:hover { transform: translateY(-1px); }
.card-remove {
  position: absolute; top: 12px; right: 12px;
  background: transparent; border: none; color: var(--text-3);
  font-size: 14px; cursor: pointer; opacity: 0; transition: opacity 0.2s; padding: 2px 5px;
  border-radius: 5px;
}
.card:hover .card-remove { opacity: 1; }
.card-remove:hover { background: rgba(240,91,91,0.15); color: var(--red); }
.card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }
.card-icon { font-size: 20px; }
.card-label { font-size: 14px; font-weight: 700; color: var(--text); flex: 1; }
.card-ticker { font-size: 11px; color: var(--text-3); font-weight: 400; }
.card-pct { font-size: 12px; font-weight: 700; font-family: var(--mono); }
.card-field { display: flex; align-items: center; justify-content: space-between; margin-bottom: 9px; gap: 8px; }
.card-field-label { font-size: 11px; color: var(--text-3); font-weight: 600; white-space: nowrap; }
.holding-wrap { display: flex; align-items: center; gap: 6px; }
.holding-input {
  width: 100px; padding: 5px 8px; background: rgba(0,0,0,0.4);
  border: 1px solid var(--border); color: var(--text); border-radius: 7px;
  font-family: var(--mono); font-size: 13px; outline: none; text-align: right;
  transition: border-color 0.2s;
}
.holding-input:focus { border-color: var(--blue); }
.holding-unit { font-size: 11px; color: var(--text-3); }
.price-row { display: flex; justify-content: space-between; margin-bottom: 7px; }
.price-label { font-size: 11px; color: var(--text-3); }
.price-value { font-size: 12px; font-family: var(--mono); color: var(--text-2); }
.value-row { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border); }
.value-label { font-size: 11px; color: var(--text-3); font-weight: 600; }
.value-usd { font-size: 16px; font-weight: 700; font-family: var(--mono); }
.gain-row { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
.gain-value { font-size: 12px; font-family: var(--mono); font-weight: 600; }
.gain-value.positive { color: var(--green); }
.gain-value.negative { color: var(--red); }
.gain-value.neutral { color: var(--text-3); }
.avgcost-wrap { display: flex; align-items: center; gap: 5px; }
.avgcost-input {
  width: 80px; padding: 4px 7px; background: rgba(0,0,0,0.35);
  border: 1px solid var(--border); color: var(--text); border-radius: 6px;
  font-family: var(--mono); font-size: 12px; outline: none; text-align: right;
  transition: border-color 0.2s;
}
.avgcost-input:focus { border-color: var(--gold); }
.avgcost-ccy { font-size: 10px; color: var(--text-3); }
.manual-input {
  width: 80px; padding: 4px 7px; background: rgba(0,0,0,0.35);
  border: 1px solid rgba(212,168,71,0.25); color: var(--gold); border-radius: 6px;
  font-family: var(--mono); font-size: 12px; outline: none; text-align: right;
}

/* ‚îÄ‚îÄ‚îÄ TRANSACTIONS ‚îÄ‚îÄ‚îÄ */
.tx-btn-row { margin-top: 8px; }
.tx-log { margin-top: 8px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 8px; }
.tx-log-title { font-size: 10px; font-weight: 700; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.tx-item { display: flex; align-items: center; gap: 6px; font-size: 11px; margin-bottom: 5px; }
.tx-type { font-weight: 700; font-size: 10px; padding: 2px 5px; border-radius: 4px; text-transform: uppercase; }
.tx-type.buy { background: rgba(61,214,140,0.12); color: var(--green); }
.tx-type.sell { background: rgba(240,91,91,0.12); color: var(--red); }
.tx-type.dividend { background: rgba(212,168,71,0.12); color: var(--gold); }
.tx-date { color: var(--text-3); flex: 1; }
.tx-detail { font-family: var(--mono); color: var(--text-2); }
.tx-remove { background: none; border: none; color: var(--text-3); cursor: pointer; font-size: 12px; padding: 0 2px; }
.tx-remove:hover { color: var(--red); }

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state { text-align: center; padding: 60px 20px; color: var(--text-3); }
.empty-state .e-icon { font-size: 36px; display: block; margin-bottom: 12px; }
.empty-state p { font-size: 14px; line-height: 1.6; }

/* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: flex; align-items: center; justify-content: center; z-index: 100;
  padding: 20px; backdrop-filter: blur(4px);
}
.modal-overlay.hidden { display: none; }
.modal {
  background: #0f1015; border: 1px solid var(--border-active);
  border-radius: 18px; padding: 28px; width: 100%; max-width: 440px;
  max-height: 90vh; overflow-y: auto;
  animation: fadeUp 0.2s ease both;
}
.modal-title { font-size: 17px; font-weight: 800; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
.modal-close { background: none; border: none; color: var(--text-3); cursor: pointer; font-size: 18px; }
.modal-close:hover { color: var(--text); }
.modal-footer { display: flex; gap: 8px; margin-top: 20px; justify-content: flex-end; }

.form-fields { display: none; }
.form-fields.active { display: block; }

/* ‚îÄ‚îÄ‚îÄ PERFORMANCE ‚îÄ‚îÄ‚îÄ */
.perf-metrics { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
.perf-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--r);
  padding: 14px 16px;
}
.perf-card-label { font-size: 10px; color: var(--text-3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; }
.perf-card-value { font-size: 18px; font-weight: 800; font-family: var(--mono); margin: 6px 0 2px; }
.perf-card-value.positive { color: var(--green); }
.perf-card-value.negative { color: var(--red); }
.perf-card-sub { font-size: 11px; color: var(--text-3); }
.chart-section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-lg); padding: 18px; margin-bottom: 16px; }
.chart-section-title { font-size: 13px; font-weight: 700; color: var(--text-2); margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
.chart-range-btns { display: flex; gap: 4px; }
.range-btn { padding: 3px 9px; font-size: 11px; border-radius: 6px; background: transparent; border: 1px solid var(--border); color: var(--text-3); cursor: pointer; font-family: var(--sans); font-weight: 600; transition: all 0.15s; }
.range-btn.active { background: var(--surface-raised); color: var(--text); border-color: var(--border-active); }
.chart-wrap { position: relative; }
.chart-empty { text-align: center; padding: 40px; color: var(--text-3); font-size: 13px; }

/* ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ */
.snap-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.snap-table th { font-size: 10px; font-weight: 700; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); }
.snap-table td { padding: 9px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); font-family: var(--mono); font-size: 12px; }
.snap-table tr:hover td { background: var(--surface); }

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: #1a1b22; border: 1px solid var(--border-active); border-radius: 10px;
  padding: 11px 16px; font-size: 13px; font-weight: 600; color: var(--text);
  animation: slideIn 0.25s ease both;
  display: flex; align-items: center; gap: 8px; min-width: 220px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.toast.success { border-color: rgba(61,214,140,0.3); }
.toast.error { border-color: rgba(240,91,91,0.3); color: var(--red); }
.toast.info { border-color: rgba(79,142,247,0.2); }

/* ‚îÄ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ‚îÄ */
.loading-overlay {
  position: fixed; inset: 0; background: rgba(8,9,12,0.8);
  display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 150;
  backdrop-filter: blur(4px);
}
.loading-overlay.hidden { display: none; }
.spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.7s linear infinite; }
.loading-text { margin-top: 14px; font-size: 13px; color: var(--text-3); }

/* ‚îÄ‚îÄ‚îÄ PASSKEY MANAGE SECTION ‚îÄ‚îÄ‚îÄ */
.passkey-list { margin-top: 12px; }
.passkey-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 13px; background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); margin-bottom: 8px; font-size: 13px;
}

/* ‚îÄ‚îÄ‚îÄ SYNC STATUS ‚îÄ‚îÄ‚îÄ */
.sync-status {
  display: flex; align-items: center; gap: 6px;
  font-size: 11px; color: var(--text-3); padding: 6px 10px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; white-space: nowrap;
}

/* ‚îÄ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ‚îÄ */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ‚îÄ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ‚îÄ */
.section-label {
  font-size: 10px; font-weight: 700; color: var(--text-3);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
}

/* ‚îÄ‚îÄ‚îÄ USER MENU ‚îÄ‚îÄ‚îÄ */
.user-menu-wrap { position: relative; }
.user-menu-dropdown {
  position: absolute; top: calc(100% + 8px); right: 0;
  background: #0f1015; border: 1px solid var(--border-active);
  border-radius: var(--r-lg); padding: 6px;
  min-width: 200px; z-index: 50;
  animation: fadeUp 0.15s ease both;
}
.user-menu-dropdown.hidden { display: none; }
.user-menu-item {
  display: flex; align-items: center; gap: 8px; width: 100%; padding: 9px 13px;
  background: none; border: none; color: var(--text-2); cursor: pointer;
  font-family: var(--sans); font-size: 13px; font-weight: 600; border-radius: 8px; text-align: left;
  transition: all 0.15s;
}
.user-menu-item:hover { background: var(--surface); color: var(--text); }
.user-menu-item.danger { color: var(--red); }
.user-email { font-size: 11px; color: var(--text-3); padding: 8px 13px 4px; border-bottom: 1px solid var(--border); margin-bottom: 4px; }
.user-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--gold-soft); border: 1px solid var(--gold-border);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 800; color: var(--gold); cursor: pointer;
  transition: all 0.2s;
}
.user-avatar:hover { background: rgba(212,168,71,0.2); }

/* ‚îÄ‚îÄ‚îÄ ACCOUNT MODAL ‚îÄ‚îÄ‚îÄ */
.account-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
.account-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.account-section-title { font-size: 11px; font-weight: 700; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; }

/* ‚îÄ‚îÄ‚îÄ REDESIGNED ADD MODAL ‚îÄ‚îÄ‚îÄ */
.type-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
.type-btn {
  padding: 12px 8px; border: 1px solid var(--border); border-radius: var(--r);
  background: var(--surface); color: var(--text-3); cursor: pointer;
  font-family: var(--sans); font-size: 12px; font-weight: 700; text-align: center;
  transition: all 0.18s; display: flex; flex-direction: column; align-items: center; gap: 3px;
}
.type-btn:hover { border-color: var(--border-active); color: var(--text); background: var(--surface-raised); }
.type-btn .ti { font-size: 22px; display: block; margin-bottom: 2px; }
.type-desc { font-size: 9px; font-weight: 400; color: var(--text-3); line-height: 1.3; }
.type-btn.selected { background: var(--blue-soft); border-color: rgba(79,142,247,0.45); color: var(--blue); }
.type-btn.selected .type-desc { color: rgba(79,142,247,0.7); }
.add-hint {
  font-size: 12px; color: var(--text-3); background: rgba(255,255,255,0.02);
  border: 1px solid var(--border); border-radius: var(--r); padding: 10px 13px;
  margin-bottom: 16px; line-height: 1.6;
}
.add-hint b { color: var(--text-2); font-weight: 600; }
.field-row { display: flex; gap: 12px; }
.field-row .field { margin-bottom: 14px; }
.field-req { color: var(--blue); font-size: 11px; }
.field-opt { color: var(--text-3); font-size: 10px; font-weight: 400; }
.field-select {
  width: 100%; padding: 10px 13px;
  background: rgba(0,0,0,0.35); border: 1px solid var(--border);
  color: var(--text); border-radius: var(--r);
  font-family: var(--sans); font-size: 13px; outline: none;
  transition: border-color 0.2s; cursor: pointer;
}
.field-select:focus { border-color: var(--blue); }
.field-select option { background: #0f1015; }
.input-unit-wrap { position: relative; display: flex; align-items: center; }
.input-unit-wrap input { width: 100%; padding-right: 52px; }
.input-unit {
  position: absolute; right: 10px;
  font-size: 11px; font-weight: 700; color: var(--text-3);
  font-family: var(--mono); pointer-events: none;
  background: rgba(0,0,0,0.4); padding: 2px 5px; border-radius: 4px;
}
.karat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 6px; }
.karat-btn {
  padding: 10px 6px; border: 1px solid var(--border); border-radius: var(--r);
  background: var(--surface); cursor: pointer; font-family: var(--sans);
  text-align: center; transition: all 0.18s; display: flex; flex-direction: column;
  align-items: center; gap: 3px;
}
.karat-btn:hover { border-color: var(--gold-border); background: var(--gold-soft); }
.karat-num { font-size: 15px; font-weight: 800; color: var(--text-2); }
.karat-pct { font-size: 9px; color: var(--text-3); font-family: var(--mono); }
.karat-btn.selected { background: var(--gold-soft); border-color: var(--gold-border); }
.karat-btn.selected .karat-num { color: var(--gold); }
.karat-btn.selected .karat-pct { color: rgba(212,168,71,0.6); }
.add-preview {
  background: rgba(61,214,140,0.05); border: 1px solid rgba(61,214,140,0.15);
  border-radius: var(--r); padding: 10px 14px; margin-top: 4px; margin-bottom: 8px;
  font-size: 12px; color: var(--green); font-family: var(--mono);
  display: flex; align-items: center; gap: 8px;
}

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media(max-width: 600px) {
  .total-usd { font-size: 38px; }
  .type-grid { grid-template-columns: repeat(2, 1fr); }
  .perf-metrics { grid-template-columns: 1fr 1fr; }
  .field-row { flex-direction: column; gap: 0; }
  .karat-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê -->
<div id="authScreen" class="auth-wrap">
  <div class="auth-card">
    <div class="auth-logo">
      <span class="auth-logo-icon">üìä</span>
      <h1>Investments</h1>
      <p>Marwan's Portfolio Tracker</p>
    </div>

    <button class="passkey-btn" id="passkeyLoginBtn" onclick="loginWithPasskey()">
      üîë Sign in with Passkey
    </button>

    <div class="auth-divider">or use email</div>

    <div class="field">
      <label>Email</label>
      <input type="email" id="authEmail" placeholder="you@example.com" autocomplete="email"/>
    </div>
    <div class="field">
      <label>Password</label>
      <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
             onkeydown="if(event.key==='Enter')signIn()"/>
    </div>
    <div style="display:flex;gap:8px;margin-top:6px;">
      <button class="btn btn-primary btn-full" onclick="signIn()">Sign In</button>
    </div>
    <p id="authMsg" style="font-size:12px;color:var(--text-3);margin-top:12px;text-align:center;"></p>
    <p style="font-size:11px;color:var(--text-3);text-align:center;margin-top:16px;">
      <a href="#" onclick="toggleSignUp()" style="color:var(--blue);text-decoration:none;" id="authToggleLink">Need an account? Sign up</a>
    </p>
  </div>
</div>

<!-- ‚ïê‚ïê MAIN APP ‚ïê‚ïê -->
<div id="mainApp" class="app" style="display:none;">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>üìä Investments</h1>
      <p id="headerSub">Loading‚Ä¶</p>
    </div>
    <div class="header-btns">
      <div class="sync-status" id="syncStatus">
        <span class="sync-dot offline" id="syncDot"></span>
        <span id="syncLabel">Connecting‚Ä¶</span>
      </div>
      <button class="btn" id="refreshBtn" onclick="fetchAllPrices()">üîÑ Refresh</button>
      <button class="btn btn-primary" onclick="openAddModal()">Ôºã Add Asset</button>
      <div class="user-menu-wrap">
        <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">M</div>
        <div class="user-menu-dropdown hidden" id="userMenuDropdown">
          <div class="user-email" id="userEmail"></div>
          <button class="user-menu-item" onclick="openAccountModal();closeUserMenu()">‚öôÔ∏è Account & Passkeys</button>
          <button class="user-menu-item" onclick="downloadCSV();closeUserMenu()">üì• Export CSV</button>
          <button class="user-menu-item" onclick="printView();closeUserMenu()">üñ®Ô∏è Print View</button>
          <button class="user-menu-item danger" onclick="signOut();closeUserMenu()">‚Üí Sign Out</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Total Card -->
  <div class="total-card">
    <div class="total-label">Total Portfolio Value</div>
    <div class="total-usd" id="totalUSD">$0.00</div>
    <div class="total-egp" id="totalEGP"></div>
    <div class="total-gains">
      <span class="gain-pill neutral" id="totalUnrealized">Unrealized: ‚Äî</span>
      <span class="gain-pill neutral" id="totalToday">Today: ‚Äî</span>
    </div>
    <div class="alloc-bar" id="allocBar"></div>
    <div class="legend" id="legend"></div>
    <div class="mode-row">
      <button class="btn btn-sm" id="mUsd" onclick="setMode('usd')">$</button>
      <button class="btn btn-sm" id="mPct" onclick="setMode('pct')">%</button>
      <button class="btn btn-sm btn-primary" id="mBoth" onclick="setMode('both')">Both</button>
    </div>
  </div>

  <!-- Rates Banner -->
  <div class="rates-banner" id="ratesBanner"></div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard',this)">Dashboard</button>
    <button class="tab-btn" onclick="switchTab('performance',this)">Performance</button>
    <button class="tab-btn" onclick="switchTab('history',this)">History</button>
  </div>

  <!-- Dashboard Tab -->
  <div class="tab-panel active" id="tab-dashboard">
    <div class="toolbar">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input class="search-input" type="text" placeholder="Search assets‚Ä¶" oninput="onSearch(this.value)"/>
      </div>
      <select class="sort-select" onchange="renderCards()">
        <option value="value-desc">Sort: Value ‚Üì</option>
        <option value="gain-desc">Sort: Gain ‚Üì</option>
        <option value="today-desc">Sort: Today ‚Üì</option>
        <option value="name-asc">Sort: Name A-Z</option>
      </select>
    </div>
    <div class="cards-grid" id="cardsGrid"></div>
  </div>

  <!-- Performance Tab -->
  <div class="tab-panel" id="tab-performance">
    <div class="perf-metrics" id="perfMetrics"></div>
    <div class="chart-section">
      <div class="chart-section-title">
        Portfolio Value
        <div class="chart-range-btns">
          <button class="range-btn active" onclick="setChartRange('1M',this)">1M</button>
          <button class="range-btn" onclick="setChartRange('3M',this)">3M</button>
          <button class="range-btn" onclick="setChartRange('6M',this)">6M</button>
          <button class="range-btn" onclick="setChartRange('1Y',this)">1Y</button>
          <button class="range-btn" onclick="setChartRange('ALL',this)">ALL</button>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="valueChart"></canvas>
        <div class="chart-empty" id="chartEmpty" style="display:none">Not enough snapshots yet ‚Äî data builds over time.</div>
      </div>
    </div>
    <div class="chart-section">
      <div class="chart-section-title">Allocation Over Time</div>
      <canvas id="allocChart"></canvas>
    </div>
  </div>

  <!-- History Tab -->
  <div class="tab-panel" id="tab-history">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <div class="section-label">Snapshot History</div>
      <button class="btn btn-sm btn-danger" onclick="clearHistory()">üóë Clear History</button>
    </div>
    <div id="snapEmpty" class="empty-state" style="display:none">
      <span class="e-icon">üìÖ</span>
      <p>No snapshots yet. They're captured automatically when you refresh prices.</p>
    </div>
    <table class="snap-table" id="snapTable" style="display:none">
      <thead><tr>
        <th>Date</th><th>Value (USD)</th><th>Change $</th><th>Change %</th><th>Assets</th>
      </tr></thead>
      <tbody id="snapBody"></tbody>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê LOADING OVERLAY ‚ïê‚ïê -->
<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Loading‚Ä¶</div>
</div>

<!-- ‚ïê‚ïê TOAST CONTAINER ‚ïê‚ïê -->
<div class="toast-container" id="toastContainer"></div>

<!-- ‚ïê‚ïê ADD ASSET MODAL ‚ïê‚ïê -->
<div class="modal-overlay hidden" id="addModal" onclick="if(event.target===this)closeAddModal()">
  <div class="modal" style="max-width:460px;">
    <div class="modal-title">
      <span id="addModalTitle">Add Asset</span>
      <button class="modal-close" onclick="closeAddModal()">‚úï</button>
    </div>

    <!-- Type Selector -->
    <div class="type-grid" id="typeGrid">
      <button class="type-btn selected" data-type="etf" onclick="selectType('etf',this)">
        <span class="ti">üìà</span>ETF / Fund
        <span class="type-desc">Stocks, ETFs, indices</span>
      </button>
      <button class="type-btn" data-type="cash" onclick="selectType('cash',this)">
        <span class="ti">üíµ</span>Cash
        <span class="type-desc">Any currency balance</span>
      </button>
      <button class="type-btn" data-type="gold" onclick="selectType('gold',this)">
        <span class="ti">ü•á</span>Gold
        <span class="type-desc">Bullion, coins, ingots</span>
      </button>
      <button class="type-btn" data-type="deposit" onclick="selectType('deposit',this)">
        <span class="ti">üè¶</span>Deposit
        <span class="type-desc">CDs, savings, fixed</span>
      </button>
    </div>

    <!-- ‚îÄ‚îÄ ETF ‚îÄ‚îÄ -->
    <div class="form-fields active" id="fieldsETF">
      <div class="add-hint">Enter the ticker symbol exactly as it appears on the exchange (e.g. <b>IGDA.L</b> for London, <b>AAPL</b> for NASDAQ). Live price will be fetched automatically.</div>
      <div class="field-row">
        <div class="field" style="flex:1.4">
          <label>Ticker Symbol <span class="field-req">*</span></label>
          <input id="aTicker" placeholder="e.g. IGDA.L, AAPL, IGLN.L" autocomplete="off" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()"/>
        </div>
        <div class="field" style="flex:1">
          <label>Exchange <span class="field-opt">(optional)</span></label>
          <select id="aExchange" class="field-select">
            <option value="">Auto-detect</option>
            <option value=".L">London (.L)</option>
            <option value=".CA">Egypt (.CA)</option>
            <option value="">US (NASDAQ/NYSE)</option>
          </select>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label>Number of Shares <span class="field-req">*</span></label>
          <div class="input-unit-wrap">
            <input id="aShares" type="number" placeholder="0.00" step="0.01" min="0"/>
            <span class="input-unit">shares</span>
          </div>
        </div>
        <div class="field" style="flex:1">
          <label>Avg Cost / Share <span class="field-opt">(optional)</span></label>
          <div class="input-unit-wrap">
            <input id="aAvgCost" type="number" placeholder="0.00" step="0.0001" min="0"/>
            <span class="input-unit" id="aAvgCostCcy">USD</span>
          </div>
        </div>
      </div>
      <div class="add-preview" id="etfPreview" style="display:none"></div>
    </div>

    <!-- ‚îÄ‚îÄ CASH ‚îÄ‚îÄ -->
    <div class="form-fields" id="fieldsCash">
      <div class="add-hint">Track any cash balance in any currency. The value will be converted to USD using live exchange rates.</div>
      <div class="field">
        <label>Label <span class="field-req">*</span></label>
        <input id="aCashLabel" placeholder="e.g. USD Cash, Emergency Fund"/>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1.5">
          <label>Amount <span class="field-req">*</span></label>
          <div class="input-unit-wrap">
            <input id="aCashAmt" type="number" placeholder="0.00" step="0.01" min="0"/>
            <span class="input-unit" id="cashAmtUnit">USD</span>
          </div>
        </div>
        <div class="field" style="flex:1">
          <label>Currency <span class="field-req">*</span></label>
          <select id="aCashCcy" class="field-select" onchange="document.getElementById('cashAmtUnit').textContent=this.value">
            <option value="USD">USD ‚Äî US Dollar</option>
            <option value="EGP">EGP ‚Äî Egyptian Pound</option>
            <option value="GBP">GBP ‚Äî British Pound</option>
            <option value="EUR">EUR ‚Äî Euro</option>
            <option value="SAR">SAR ‚Äî Saudi Riyal</option>
            <option value="AED">AED ‚Äî UAE Dirham</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ GOLD ‚îÄ‚îÄ -->
    <div class="form-fields" id="fieldsGold">
      <div class="add-hint">Track physical gold. Select the karat to set purity automatically. Live gold price (XAU) will be fetched from the market.</div>
      <div class="field">
        <label>Label <span class="field-opt">(optional)</span></label>
        <input id="aGoldLabel" placeholder="e.g. 24K Gold Ingots, Gold Coins"/>
      </div>
      <div class="field">
        <label>Gold Karat <span class="field-req">*</span></label>
        <div class="karat-grid" id="karatGrid">
          <button class="karat-btn selected" data-karat="24" data-purity="1.0" onclick="selectKarat(this)">
            <span class="karat-num">24K</span>
            <span class="karat-pct">99.9% pure</span>
          </button>
          <button class="karat-btn" data-karat="22" data-purity="0.9167" onclick="selectKarat(this)">
            <span class="karat-num">22K</span>
            <span class="karat-pct">91.7% pure</span>
          </button>
          <button class="karat-btn" data-karat="21" data-purity="0.875" onclick="selectKarat(this)">
            <span class="karat-num">21K</span>
            <span class="karat-pct">87.5% pure</span>
          </button>
          <button class="karat-btn" data-karat="18" data-purity="0.75" onclick="selectKarat(this)">
            <span class="karat-num">18K</span>
            <span class="karat-pct">75.0% pure</span>
          </button>
        </div>
        <input type="hidden" id="aGoldPurity" value="1.0"/>
      </div>
      <div class="field">
        <label>Weight <span class="field-req">*</span></label>
        <div class="input-unit-wrap">
          <input id="aGoldGrams" type="number" placeholder="0.00" step="0.01" min="0" oninput="updateGoldPreview()"/>
          <span class="input-unit">grams</span>
        </div>
      </div>
      <div class="add-preview" id="goldPreview" style="display:none"></div>
    </div>

    <!-- ‚îÄ‚îÄ DEPOSIT ‚îÄ‚îÄ -->
    <div class="form-fields" id="fieldsDeposit">
      <div class="add-hint">Track certificates of deposit, fixed savings, or any interest-bearing account. Value is converted to USD using live FX rates.</div>
      <div class="field">
        <label>Label <span class="field-req">*</span></label>
        <input id="aDepLabel" placeholder="e.g. CD ‚Äî Banque Misr, Fixed Deposit"/>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1.5">
          <label>Amount <span class="field-req">*</span></label>
          <div class="input-unit-wrap">
            <input id="aDepAmt" type="number" placeholder="0.00" step="0.01" min="0"/>
            <span class="input-unit" id="depAmtUnit">EGP</span>
          </div>
        </div>
        <div class="field" style="flex:1">
          <label>Currency <span class="field-req">*</span></label>
          <select id="aDepCcy" class="field-select" onchange="document.getElementById('depAmtUnit').textContent=this.value">
            <option value="EGP">EGP ‚Äî Egyptian Pound</option>
            <option value="USD">USD ‚Äî US Dollar</option>
            <option value="GBP">GBP ‚Äî British Pound</option>
            <option value="EUR">EUR ‚Äî Euro</option>
            <option value="SAR">SAR ‚Äî Saudi Riyal</option>
            <option value="AED">AED ‚Äî UAE Dirham</option>
          </select>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label>Interest Rate <span class="field-opt">(optional)</span></label>
          <div class="input-unit-wrap">
            <input id="aDepRate" type="number" placeholder="0.00" step="0.01" min="0" max="100"/>
            <span class="input-unit">% p.a.</span>
          </div>
        </div>
        <div class="field" style="flex:1">
          <label>Maturity Date <span class="field-opt">(optional)</span></label>
          <input id="aDepMaturity" type="date"/>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn" onclick="closeAddModal()">Cancel</button>
      <button class="btn btn-primary" id="addAssetBtn" onclick="addAsset()">
        <span id="addBtnIcon">Ôºã</span> Add Asset
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê TRANSACTION MODAL ‚ïê‚ïê -->
<div class="modal-overlay hidden" id="txModal" onclick="if(event.target===this)closeTxModal()">
  <div class="modal">
    <div class="modal-title">Add Transaction <button class="modal-close" onclick="closeTxModal()">‚úï</button></div>
    <div style="display:flex;gap:6px;margin-bottom:16px;">
      <button class="type-btn selected" data-tx="buy" onclick="selectTxType('buy',this)" style="flex:1">Buy</button>
      <button class="type-btn" data-tx="sell" onclick="selectTxType('sell',this)" style="flex:1">Sell</button>
      <button class="type-btn" data-tx="dividend" onclick="selectTxType('dividend',this)" style="flex:1">Dividend</button>
    </div>
    <div id="txBuySell">
      <div class="field"><label>Quantity</label><input id="txQty" type="number" placeholder="0.00" step="0.01"/></div>
      <div class="field"><label>Price per unit</label><input id="txPrice" type="number" placeholder="0.00" step="0.0001"/></div>
    </div>
    <div id="txDividend" style="display:none">
      <div class="field"><label>Dividend amount (USD)</label><input id="txDivAmt" type="number" placeholder="0.00" step="0.01"/></div>
    </div>
    <div class="field"><label>Date</label><input id="txDate" type="date"/></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeTxModal()">Cancel</button>
      <button class="btn btn-primary" onclick="addTx()">Add</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê ACCOUNT MODAL ‚ïê‚ïê -->
<div class="modal-overlay hidden" id="accountModal" onclick="if(event.target===this)closeAccountModal()">
  <div class="modal" style="max-width:480px;">
    <div class="modal-title">Account <button class="modal-close" onclick="closeAccountModal()">‚úï</button></div>

    <div class="account-section">
      <div class="account-section-title">Passkeys</div>
      <p style="font-size:12px;color:var(--text-3);margin-bottom:12px;">Passkeys let you sign in with biometrics or device PIN ‚Äî no password needed.</p>
      <div class="passkey-list" id="passkeyList"><div style="color:var(--text-3);font-size:12px;">Loading‚Ä¶</div></div>
      <button class="btn btn-gold" style="margin-top:10px;" onclick="registerPasskey()">üîë Register New Passkey</button>
    </div>

    <div class="account-section">
      <div class="account-section-title">Change Password</div>
      <div class="field"><label>New Password</label><input type="password" id="newPass1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
      <div class="field"><label>Confirm</label><input type="password" id="newPass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
      <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
      <span id="passChangeMsg" style="font-size:12px;color:var(--text-3);margin-left:10px;"></span>
    </div>

    <div class="account-section">
      <div class="account-section-title">Danger Zone</div>
      <button class="btn btn-danger" onclick="confirmDeleteAll()">üóë Delete All My Data</button>
    </div>
  </div>
</div>

<script type="module">
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURATION ‚Äî fill in your Supabase credentials below
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL  = 'https://xudlzocokzcsheoubwwm.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1ZGx6b2Nva3pjc2hlb3Vid3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NTc2MjEsImV4cCI6MjA4NzAzMzYyMX0.xDxNzDdiXqvwcNENDb8-z12eXoF9boPCjLScJY2dvJ8';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TROY_OZ_GRAM = 31.1034768;
const COLORS = ['#d4a847','#4f8ef7','#3dd68c','#f07e5b','#a78bfa','#38bdf8','#f472b6','#fb923c'];
const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 min

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE CLIENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
const sb = createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { persistSession: true, autoRefreshToken: true, storageKey: 'inv-auth' }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let assets = [];
let transactions = {}; // { assetId: [{id,type,qty,price,date,amount}] }
let snapshots = [];
let fxRates = {};
let fxMeta = {};
let goldPerOz = 0;
let goldPrevOz = 0;
let goldMeta = {};
let etfPrices = {};
let etfMeta = {};
let unrealizedMode = 'both';
let activeChartRange = '1M';
let chartInstances = {};
let searchQuery = '';
let currentTxAssetId = null;
let currentTxType = 'buy';
let autoRefreshTimer = null;
let saveDebounceTimer = null;
let isSignUp = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.signIn = async function() {
  const email = document.getElementById('authEmail').value.trim();
  const pass  = document.getElementById('authPassword').value;
  if (!email || !pass) return setAuthMsg('Enter email + password.');
  setAuthMsg('Signing in‚Ä¶');
  const fn = isSignUp ? sb.auth.signUp.bind(sb.auth) : sb.auth.signInWithPassword.bind(sb.auth);
  const { data, error } = await fn({ email, password: pass });
  if (error) return setAuthMsg('‚ùå ' + error.message);
  if (isSignUp) {
    setAuthMsg('‚úÖ Account created! Check email to confirm, then sign in.');
    return;
  }
  currentUser = data.user;
  // After successful password login, update refresh tokens for all passkeys
  // registered on this device so future logins are fully passwordless
  if (data.session?.refresh_token) {
    const storedCreds = JSON.parse(localStorage.getItem('inv-passkey-creds') || '[]');
    const userCreds = storedCreds.filter(c => c.email === email);
    userCreds.forEach(c => {
      localStorage.setItem('inv-passkey-token-' + c.id, data.session.refresh_token);
    });
  }
  await launchApp();
};

window.loginWithPasskey = async function() {
  try {
    setAuthMsg('üîë Verifying passkey‚Ä¶');

    // Load stored credentials for this device
    const storedCreds = JSON.parse(localStorage.getItem('inv-passkey-creds') || '[]');
    if (!storedCreds.length) {
      setAuthMsg('No passkeys registered on this device. Sign in with email first, then go to Account ‚Üí Register Passkey.');
      return;
    }

    // Trigger WebAuthn authentication (biometric / device PIN prompt)
    const assertion = await navigator.credentials.get({
      publicKey: {
        challenge: crypto.getRandomValues(new Uint8Array(32)),
        rpId: location.hostname || 'localhost',
        allowCredentials: storedCreds.map(c => ({ type: 'public-key', id: base64ToBuffer(c.id) })),
        userVerification: 'required',
        timeout: 60000
      }
    });

    if (!assertion) { setAuthMsg('‚ùå Passkey authentication cancelled.'); return; }

    // Find matching stored credential
    const credId = bufferToBase64(assertion.rawId);
    const matched = storedCreds.find(c => c.id === credId);
    if (!matched) { setAuthMsg('‚ùå Passkey not recognized on this device.'); return; }

    // Retrieve encrypted token stored at registration time
    const tokenKey = 'inv-passkey-token-' + credId;
    const storedToken = localStorage.getItem(tokenKey);

    if (storedToken) {
      // Restore the Supabase session directly from the stored refresh token
      setAuthMsg('‚úÖ Passkey verified ‚Äî restoring session‚Ä¶');
      const { data, error } = await sb.auth.setSession({ access_token: '', refresh_token: storedToken });
      if (!error && data?.session) {
        currentUser = data.session.user;
        await launchApp();
        return;
      }
    }

    // Fallback: re-authenticate with stored email + prompt for password once
    setAuthMsg('‚úÖ Passkey verified ‚Äî signing in‚Ä¶');
    document.getElementById('authEmail').value = matched.email || '';
    const { data: sessData } = await sb.auth.getSession();
    if (sessData?.session) {
      currentUser = sessData.session.user;
      await launchApp();
      return;
    }

    // Last resort: ask for password this one time
    setAuthMsg('‚úÖ Passkey verified! Enter your password once to complete. It will be remembered for future passkey logins.');
    document.getElementById('authPassword').focus();

  } catch(e) {
    if (e.name === 'NotAllowedError') {
      setAuthMsg('Passkey authentication was cancelled.');
    } else {
      setAuthMsg('‚ùå ' + (e.message || 'Passkey failed ‚Äî use email/password instead.'));
    }
  }
};

window.registerPasskey = async function() {
  if (!currentUser) return;
  try {
    showToast('Touch your fingerprint sensor or enter device PIN‚Ä¶', 'info');
    const challenge = crypto.getRandomValues(new Uint8Array(32));
    const credential = await navigator.credentials.create({
      publicKey: {
        challenge,
        rp: { name: 'Investments Tracker', id: location.hostname || 'localhost' },
        user: {
          id: new TextEncoder().encode(currentUser.id),
          name: currentUser.email,
          displayName: currentUser.email
        },
        pubKeyCredParams: [{ type: 'public-key', alg: -7 }, { type: 'public-key', alg: -257 }],
        authenticatorSelection: { userVerification: 'required', residentKey: 'preferred' },
        timeout: 60000
      }
    });
    if (!credential) throw new Error('Registration cancelled.');

    const credId = bufferToBase64(credential.rawId);

    // Store credential metadata
    const stored = JSON.parse(localStorage.getItem('inv-passkey-creds') || '[]');
    // Remove any existing entry for this credential ID to avoid duplicates
    const filtered = stored.filter(c => c.id !== credId);
    filtered.push({ id: credId, email: currentUser.email, created: new Date().toISOString() });
    localStorage.setItem('inv-passkey-creds', JSON.stringify(filtered));

    // Store the current refresh token tied to this credential
    // This allows fully passwordless login next time the passkey is used
    const { data: sessData } = await sb.auth.getSession();
    if (sessData?.session?.refresh_token) {
      localStorage.setItem('inv-passkey-token-' + credId, sessData.session.refresh_token);
    }

    // Save credential record to Supabase for cross-device awareness
    await sb.from('passkeys').upsert({
      user_id: currentUser.id,
      cred_id: credId,
      email: currentUser.email,
      created_at: new Date().toISOString()
    }, { onConflict: 'user_id,cred_id' });

    showToast('‚úÖ Passkey registered! You can now sign in with biometrics.', 'success');
    renderPasskeyList();
  } catch(e) {
    if (e.name === 'NotAllowedError') {
      showToast('Passkey registration was cancelled.', 'error');
    } else {
      showToast('‚ùå ' + e.message, 'error');
    }
  }
};

window.changePassword = async function() {
  const p1 = document.getElementById('newPass1').value;
  const p2 = document.getElementById('newPass2').value;
  const msg = document.getElementById('passChangeMsg');
  if (!p1 || p1 !== p2) { msg.textContent = '‚ùå Passwords do not match.'; msg.style.color='var(--red)'; return; }
  const { error } = await sb.auth.updateUser({ password: p1 });
  if (error) { msg.textContent = '‚ùå ' + error.message; msg.style.color='var(--red)'; }
  else { msg.textContent = '‚úÖ Password updated.'; msg.style.color='var(--green)'; }
};

window.signOut = async function() {
  await sb.auth.signOut();
  currentUser = null;
  assets = []; transactions = {}; snapshots = [];
  clearInterval(autoRefreshTimer);
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
  showToast('Signed out.', 'info');
};

window.toggleSignUp = function() {
  isSignUp = !isSignUp;
  document.getElementById('authToggleLink').textContent = isSignUp
    ? 'Already have an account? Sign in'
    : 'Need an account? Sign up';
  setAuthMsg('');
};

function setAuthMsg(msg) {
  document.getElementById('authMsg').textContent = msg;
}

// ‚îÄ‚îÄ PASSKEY LIST ‚îÄ‚îÄ
async function renderPasskeyList() {
  const el = document.getElementById('passkeyList');
  const stored = JSON.parse(localStorage.getItem('inv-passkey-creds') || '[]');
  const userCreds = stored.filter(c => c.email === currentUser?.email);
  if (!userCreds.length) {
    el.innerHTML = '<div style="font-size:12px;color:var(--text-3)">No passkeys registered yet.</div>';
    return;
  }
  el.innerHTML = userCreds.map((c,i) => `
    <div class="passkey-item">
      <div>
        <div style="font-size:13px;font-weight:600">üîë Passkey ${i+1}</div>
        <div style="font-size:11px;color:var(--text-3)">${new Date(c.created).toLocaleDateString()}</div>
      </div>
      <button class="btn btn-sm btn-danger" onclick="removePasskey('${c.id}')">Remove</button>
    </div>
  `).join('');
}

window.removePasskey = function(id) {
  if (!confirm('Remove this passkey?')) return;
  const stored = JSON.parse(localStorage.getItem('inv-passkey-creds') || '[]');
  localStorage.setItem('inv-passkey-creds', JSON.stringify(stored.filter(c => c.id !== id)));
  localStorage.removeItem('inv-passkey-token-' + id);
  renderPasskeyList();
  showToast('Passkey removed.', 'info');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE DATA LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAllData() {
  const uid = currentUser.id;
  const [assetsRes, txRes, snapRes, settingsRes] = await Promise.all([
    sb.from('assets').select('*').eq('user_id', uid).order('created_at', { ascending: true }),
    sb.from('transactions').select('*').eq('user_id', uid).order('date', { ascending: true }),
    sb.from('snapshots').select('*').eq('user_id', uid).order('date', { ascending: true }),
    sb.from('settings').select('*').eq('user_id', uid).limit(1),
  ]);
  if (assetsRes.error) throw assetsRes.error;
  assets = (assetsRes.data || []).map(row => ({ ...row.data, id: row.asset_id, _dbId: row.id }));
  transactions = {};
  for (const tx of (txRes.data || [])) {
    if (!transactions[tx.asset_id]) transactions[tx.asset_id] = [];
    transactions[tx.asset_id].push({ id: tx.tx_id, type: tx.type, qty: tx.qty, price: tx.price, date: tx.date, amount: tx.amount });
  }
  snapshots = (snapRes.data || []).map(row => ({ date: row.date, totalUSD: row.total_usd, assets: row.assets_breakdown }));
  const settings = settingsRes.data?.[0];
  if (settings) unrealizedMode = settings.unrealized_mode || 'both';
}

async function saveAsset(asset) {
  const uid = currentUser.id;
  const { error } = await sb.from('assets').upsert({
    user_id: uid,
    asset_id: asset.id,
    data: asset,
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id,asset_id' });
  if (error) console.error('saveAsset:', error);
}

async function deleteAsset(assetId) {
  await sb.from('assets').delete().eq('user_id', currentUser.id).eq('asset_id', assetId);
  await sb.from('transactions').delete().eq('user_id', currentUser.id).eq('asset_id', assetId);
}

async function saveTx(assetId, tx) {
  const { error } = await sb.from('transactions').upsert({
    user_id: currentUser.id,
    asset_id: assetId,
    tx_id: tx.id,
    type: tx.type,
    qty: tx.qty || null,
    price: tx.price || null,
    amount: tx.amount || null,
    date: tx.date
  }, { onConflict: 'user_id,tx_id' });
  if (error) console.error('saveTx:', error);
}

async function deleteTx(txId) {
  await sb.from('transactions').delete().eq('user_id', currentUser.id).eq('tx_id', txId);
}

function debounceSaveAsset(asset) {
  clearTimeout(saveDebounceTimer);
  saveDebounceTimer = setTimeout(() => saveAsset(asset), 400);
}

async function saveSettings() {
  await sb.from('settings').upsert({
    user_id: currentUser.id,
    unrealized_mode: unrealizedMode,
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id' });
}

async function saveSnapshot(snap) {
  const { error } = await sb.from('snapshots').upsert({
    user_id: currentUser.id,
    date: snap.date,
    total_usd: snap.totalUSD,
    assets_breakdown: snap.assets || {}
  }, { onConflict: 'user_id,date' });
  if (error) console.error('saveSnapshot:', error);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP LAUNCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function launchApp() {
  show('loadingOverlay');
  setText('loadingText', 'Loading your portfolio‚Ä¶');
  try {
    await loadAllData();
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    const email = currentUser.email || '';
    document.getElementById('userEmail').textContent = email;
    document.getElementById('userAvatar').textContent = (email[0] || 'M').toUpperCase();
    document.getElementById('headerSub').textContent = 'Signed in as ' + email;
    setSyncStatus(true, 'Live');
    hide('loadingOverlay');
    render();
    await fetchAllPrices();
    // Auto-refresh
    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    autoRefreshTimer = setInterval(() => fetchAllPrices(), AUTO_REFRESH_INTERVAL);
    // Realtime subscription
    sb.channel('assets-' + currentUser.id)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'assets', filter: `user_id=eq.${currentUser.id}` }, () => loadAndRender())
      .subscribe();
    setupKeyListeners();
    setupClickOutside();
  } catch(e) {
    hide('loadingOverlay');
    showToast('Failed to load data: ' + e.message, 'error');
    console.error(e);
  }
}

async function loadAndRender() {
  await loadAllData();
  render();
}

// ‚îÄ‚îÄ Check session on boot ‚îÄ‚îÄ
(async () => {
  const { data } = await sb.auth.getSession();
  if (data?.session) {
    currentUser = data.session.user;
    await launchApp();
  } else {
    // Show auth
    document.getElementById('authScreen').style.display = 'flex';
  }
  sb.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session && !currentUser) {
      currentUser = session.user;
      launchApp();
    }
  });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ASSET VALUE CALCULATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getFxRate(c) { if (!c || c === 'USD') return 1; return fxRates?.[c.toUpperCase()] || 0; }
function toUSD(amt, ccy) {
  if (!ccy || ccy === 'USD') return amt;
  if (ccy === 'GBp' || ccy === 'GBX') { const r = getFxRate('GBP'); return r ? (amt/100)/r : 0; }
  const rate = getFxRate(ccy.toUpperCase()); return rate ? amt/rate : 0;
}
function assetValueUSD(a) {
  switch(a.type) {
    case 'cash': return toUSD(a.holding, a.currency);
    case 'gold': { const p = a.purity||1; const ppg = goldPerOz ? (goldPerOz/TROY_OZ_GRAM)*p : 0; return (a.holding||0)*ppg; }
    case 'etf': { const ep = etfPrices[a.ticker]; if(ep){ let pu = ep.price; if(ep.currency&&ep.currency!=='USD') pu=toUSD(ep.price,ep.currency); return (a.holding||0)*pu; } return (a.holding||0)*(a.manualPrice||0); }
    case 'deposit': return toUSD(a.holding, a.currency);
    default: return 0;
  }
}
function costBasisUSD(a) {
  const avg = Number(a.avgCost)||0; if(avg<=0) return 0;
  if(a.type==='etf'){ const ep = a.ticker?etfPrices[a.ticker]:null; return toUSD((a.holding||0)*avg, ep?.currency||'USD'); }
  if(a.type==='gold') return (a.holding||0)*avg;
  return 0;
}
function unrealizedUSD(a) {
  if(a.type!=='etf'&&a.type!=='gold') return null;
  const b = costBasisUSD(a); if(b<=0) return null;
  return assetValueUSD(a) - b;
}
function todaysGainUSD(a) {
  if(a.type==='etf'){ const ep=etfPrices[a.ticker]; if(!ep||ep.price==null||ep.prevClose==null) return null; const d=(ep.price-ep.prevClose)*(a.holding||0); return ep.currency&&ep.currency!=='USD'?toUSD(d,ep.currency):d; }
  if(a.type==='gold'){ if(!goldPerOz||!goldPrevOz||goldPerOz===goldPrevOz) return null; const p=a.purity||1; const oz=((a.holding||0)/TROY_OZ_GRAM)*p; return(goldPerOz-goldPrevOz)*oz; }
  return null;
}
function getTotalUSD() { return assets.reduce((s,a)=>s+assetValueUSD(a),0); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SNAPSHOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function todayKey() { return new Date().toISOString().slice(0,10); }
async function captureSnapshot() {
  const total = getTotalUSD(); if(total<=0) return;
  const snap = { date: todayKey(), totalUSD: total, assets: {} };
  assets.forEach(a => { snap.assets[a.id] = assetValueUSD(a); });
  const existing = snapshots.findIndex(s => s.date === snap.date);
  if(existing>=0) snapshots[existing] = snap; else snapshots.push(snap);
  await saveSnapshot(snap);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() { renderRates(); renderCards(); renderTotals(); updateModeButtons(); }

function renderTotals() {
  const total = getTotalUSD();
  document.getElementById('totalUSD').textContent = fmt(total);
  const egp = getFxRate('EGP')||0;
  document.getElementById('totalEGP').textContent = egp ? 'EGP ' + (total*egp).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}) : '';

  let tU=0,tB=0; assets.forEach(a=>{const u=unrealizedUSD(a),b=costBasisUSD(a);if(u!==null){tU+=u;tB+=b;}});
  let tT=0,hT=false,prevTot=0;
  assets.forEach(a=>{const g=todaysGainUSD(a);if(g!==null){tT+=g;hT=true;prevTot+=assetValueUSD(a)-g;}});

  const uEl=document.getElementById('totalUnrealized');
  if(tB<=0){uEl.textContent='Unrealized: ‚Äî';uEl.className='gain-pill neutral';}
  else{const p=tU/tB*100;let t;if(unrealizedMode==='usd')t=fmtSigned(tU);else if(unrealizedMode==='pct')t=fmtPct(p);else t=fmtSigned(tU)+' ('+fmtPct(p)+')';uEl.textContent='Unrealized: '+t;uEl.className='gain-pill '+(tU>0?'positive':'negative');}

  const tEl=document.getElementById('totalToday');
  if(!hT){tEl.textContent='Today: ‚Äî';tEl.className='gain-pill neutral';}
  else{const pct=prevTot>0?(tT/prevTot*100):0;tEl.textContent='Today: '+fmtSigned(tT)+' ('+fmtPct(pct)+')';tEl.className='gain-pill '+(tT>0?'positive':'negative');}

  // Alloc bar
  const bar=document.getElementById('allocBar'),leg=document.getElementById('legend');bar.innerHTML='';leg.innerHTML='';
  if(total>0) assets.forEach((a,i)=>{const v=assetValueUSD(a);if(v<=0)return;const p=(v/total*100);const c=a.color||COLORS[i%COLORS.length];bar.innerHTML+='<div class="alloc-seg" style="width:'+p+'%;background:'+c+'" title="'+a.label+': '+p.toFixed(1)+'%"></div>';leg.innerHTML+='<span class="legend-item"><span class="legend-dot" style="background:'+c+'"></span>'+a.label+' '+p.toFixed(1)+'%</span>';});
}

function renderRates() {
  const banner = document.getElementById('ratesBanner'); const chips = [];
  if(goldPerOz){
    let chg='';if(goldPrevOz&&goldPrevOz!==goldPerOz){const c=goldPerOz-goldPrevOz;const p=(c/goldPrevOz)*100;chg='<div class="rate-chg '+(c>0?'positive':'negative')+'">'+(c>0?'+':'')+p.toFixed(2)+'%</div>';}
    const m=goldMeta?.updatedAt?goldMeta.updatedAt.toLocaleString():'';
    chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">GOLD/OZ</span><span class="rate-value">'+fmt(goldPerOz)+'</span></div>'+chg+(m?'<div class="rate-meta">'+m+'</div>':'')+'</div>');
  }
  [...new Set(assets.filter(a=>a.type==='etf').map(a=>a.ticker))].forEach(t=>{
    const ep=etfPrices[t];const meta=etfMeta?.[t];
    if(ep){let chg='';if(ep.prevClose){const c=ep.price-ep.prevClose;const p=(c/ep.prevClose)*100;chg='<div class="rate-chg '+(c>0?'positive':'negative')+'">'+(c>0?'+':'')+p.toFixed(2)+'%</div>';}
    const disp=ep.currency==='USD'?fmt(ep.price):(ep.currency+' '+Number(ep.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}));
    const m=meta?.updatedAt?meta.updatedAt.toLocaleString():'';
    chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">'+t+'</span><span class="rate-value">'+disp+'</span></div>'+chg+(m?'<div class="rate-meta">'+m+'</div>':'')+'</div>');}
    else chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">'+t+'</span><span class="rate-value">‚Äî</span></div></div>');
  });
  [...new Set(['EGP',...assets.filter(a=>a.currency&&a.currency!=='USD').map(a=>(a.currency||'').toUpperCase())])].forEach(c=>{
    const r=getFxRate(c);if(!r)return;
    chips.push('<div class="rate-chip"><div class="rate-top"><span class="rate-label">USD/'+c+'</span><span class="rate-value">'+r.toFixed(2)+'</span></div></div>');
  });
  banner.innerHTML = chips.join('');
}

function getSortedFiltered() {
  let list = [...assets];
  if(searchQuery) list=list.filter(a=>(a.label||'').toLowerCase().includes(searchQuery)||(a.ticker||'').toLowerCase().includes(searchQuery));
  const sort = document.querySelector('.sort-select')?.value || 'value-desc';
  if(sort==='value-desc') list.sort((a,b)=>assetValueUSD(b)-assetValueUSD(a));
  else if(sort==='gain-desc') list.sort((a,b)=>{const ua=unrealizedUSD(a)??-Infinity,ub=unrealizedUSD(b)??-Infinity;return ub-ua;});
  else if(sort==='today-desc') list.sort((a,b)=>{const ta=todaysGainUSD(a)??-Infinity,tb=todaysGainUSD(b)??-Infinity;return tb-ta;});
  else if(sort==='name-asc') list.sort((a,b)=>(a.label||'').localeCompare(b.label||''));
  return list;
}

function renderCards() {
  const grid = document.getElementById('cardsGrid'); grid.innerHTML='';
  const list = getSortedFiltered();
  if(!assets.length){ grid.innerHTML='<div class="empty-state"><span class="e-icon">üì≠</span><p>No assets yet.<br>Click <b>Ôºã Add Asset</b> to start.</p></div>'; return; }
  if(!list.length){ grid.innerHTML='<div class="empty-state"><span class="e-icon">üîç</span><p>No assets match your search.</p></div>'; return; }
  const total = getTotalUSD();
  list.forEach((a,i)=>{
    const v=assetValueUSD(a); const c=a.color||COLORS[i%COLORS.length];
    const bg=c+'13'; const bc=c+'30';
    let holdLabel='Amount', holdUnit=a.currency||'USD';
    let priceH='', avgH='', gainH='', todayH='', txH='';
    if(a.type==='gold'){holdLabel='Weight';holdUnit='grams';const pu=a.purity||1;const ppg=goldPerOz?(goldPerOz/TROY_OZ_GRAM)*pu:0;if(ppg>0)priceH=priceRow('Live price',fmt(ppg)+' / gram');avgH=avgCostRow(a,'USD');}
    if(a.type==='etf'){holdLabel='Shares';holdUnit='shares';const ep=etfPrices[a.ticker];if(ep){const d=ep.currency==='USD'?fmt(ep.price):(ep.currency+' '+Number(ep.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}));priceH=priceRow('Live price ('+ep.currency+')',d+' / share');}else priceH=`<div class="price-row"><span class="price-label">Manual price $</span><input class="manual-input" type="number" value="${a.manualPrice||''}" placeholder="e.g. 4.85" step="0.01" oninput="setManualPrice('${a.id}',this.value)"></div>`;avgH=avgCostRow(a,etfPrices[a.ticker]?.currency||'USD');}
    const u=unrealizedUSD(a);const ub=costBasisUSD(a);
    if(u!==null){let t,cls;const p=ub>0?(u/ub*100):0;if(unrealizedMode==='usd')t=fmtSigned(u);else if(unrealizedMode==='pct')t=fmtPct(p);else t=fmtSigned(u)+' ('+fmtPct(p)+')';cls=u>0?'positive':u<0?'negative':'neutral';gainH=`<div class="gain-row"><span class="value-label" style="font-size:11px;color:var(--text-3)">Unrealized</span><span class="gain-value ${cls}">${t}</span></div>`;}
    const tg=todaysGainUSD(a);
    if(tg!==null){const cls=tg>0?'positive':tg<0?'negative':'neutral';todayH=`<div class="gain-row"><span class="value-label" style="font-size:11px;color:var(--text-3)">Today</span><span class="gain-value ${cls}">${fmtSigned(tg)}</span></div>`;}
    const hasTx=(a.type==='etf'||a.type==='gold');
    if(hasTx){const txList=transactions[a.id]||[];txH=`<div class="tx-btn-row"><button class="btn btn-sm" onclick="openTxModal('${a.id}')">Ôºã Transaction</button></div>`;if(txList.length){txH+=`<div class="tx-log"><div class="tx-log-title">Transactions (${txList.length})</div>`;txList.slice(-5).reverse().forEach(tx=>{const det=tx.type==='dividend'?'Div '+fmt(tx.amount||0):(tx.qty||0)+' @ '+fmt(tx.price||0);txH+=`<div class="tx-item"><span class="tx-type ${tx.type}">${tx.type.toUpperCase()}</span><span class="tx-date">${tx.date}</span><span class="tx-detail">${det}</span><button class="tx-remove" onclick="removeTx('${a.id}','${tx.id}')">‚úï</button></div>`;});if(txList.length>5)txH+=`<div style="font-size:10px;color:var(--text-3);padding:2px 0">+${txList.length-5} more‚Ä¶</div>`;txH+=`</div>`;}}
    const ticker=a.ticker?` <span class="card-ticker">(${a.ticker})</span>`:'';
    const pct=total>0&&v>0?((v/total)*100).toFixed(1)+'%':'';
    const card=document.createElement('div');
    card.className='card';card.style.background=bg;card.style.borderColor=bc;
    card.innerHTML=`<button class="card-remove" onclick="removeAsset('${a.id}')" title="Remove">‚úï</button>
      <div class="card-header"><span class="card-icon">${a.icon||'üì¶'}</span><span class="card-label" style="color:${c}">${a.label}${ticker}</span><span class="card-pct" style="color:${c}">${pct}</span></div>
      <div class="card-field"><span class="card-field-label">${holdLabel}</span><div class="holding-wrap"><input class="holding-input" type="number" value="${a.holding||0}" step="0.01" style="border-color:${bc}" oninput="updateHolding('${a.id}',this.value)"><span class="holding-unit">${holdUnit}</span></div></div>
      ${priceH}${avgH}
      <div class="value-row"><span class="value-label">Value</span><span class="value-usd" style="color:${c}">${fmt(v)}</span></div>
      ${gainH}${todayH}${txH}`;
    grid.appendChild(card);
  });
}

function priceRow(label,val){return`<div class="price-row"><span class="price-label">${label}</span><span class="price-value">${val}</span></div>`;}
function avgCostRow(a,ccy){return`<div class="card-field" style="margin-top:4px"><span class="card-field-label">Avg cost / unit</span><div class="avgcost-wrap"><input class="avgcost-input" type="number" value="${a.avgCost||''}" placeholder="0.00" step="0.01" oninput="updateAvgCost('${a.id}',this.value)"><span class="avgcost-ccy">${ccy}</span></div></div>`;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USER ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.updateHolding = function(id, val) {
  const a = assets.find(x=>x.id===id); if(!a) return;
  a.holding = parseFloat(val)||0;
  debounceSaveAsset(a); renderTotals();
};
window.updateAvgCost = function(id, val) {
  const a = assets.find(x=>x.id===id); if(!a) return;
  a.avgCost = parseFloat(val)||0;
  debounceSaveAsset(a); renderTotals();
};
window.setManualPrice = function(id, val) {
  const a = assets.find(x=>x.id===id); if(!a) return;
  a.manualPrice = parseFloat(val)||0;
  const ex=etfPrices[a.ticker]; etfPrices[a.ticker]={price:a.manualPrice,currency:ex?.currency||'USD',prevClose:ex?.prevClose??null};
  debounceSaveAsset(a); renderTotals();
};
window.removeAsset = async function(id) {
  if(!confirm('Remove this asset?')) return;
  const rm = assets.find(a=>a.id===id);
  assets = assets.filter(a=>a.id!==id);
  delete transactions[id];
  await deleteAsset(id);
  render(); showToast((rm?.label||'Asset')+' removed','info');
};
window.setMode = function(m) { unrealizedMode=m; saveSettings(); render(); };
function updateModeButtons(){['usd','pct','both'].forEach(m=>{const el=document.getElementById('m'+m[0].toUpperCase()+m.slice(1));if(el){el.className='btn btn-sm'+(unrealizedMode===m?' btn-primary':'');}});}

window.onSearch = function(v) { searchQuery=v.toLowerCase(); renderCards(); };

// ‚îÄ‚îÄ‚îÄ ASSET TYPES ‚îÄ‚îÄ‚îÄ
let selectedType = 'etf';
let selectedKarat = { karat: 24, purity: 1.0 };

window.selectType = function(type, btn) {
  selectedType = type;
  document.querySelectorAll('#typeGrid [data-type]').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  const map = { etf:'ETF', cash:'Cash', gold:'Gold', deposit:'Deposit' };
  Object.values(map).forEach(t=>{ const el=document.getElementById('fields'+t); if(el) el.classList.toggle('active', map[type]===t); });
  const titles = { etf:'Add ETF / Fund', cash:'Add Cash', gold:'Add Gold', deposit:'Add Deposit' };
  const titleEl = document.getElementById('addModalTitle');
  if(titleEl) titleEl.textContent = titles[type] || 'Add Asset';
};

window.selectKarat = function(btn) {
  document.querySelectorAll('.karat-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedKarat = { karat: parseInt(btn.dataset.karat), purity: parseFloat(btn.dataset.purity) };
  document.getElementById('aGoldPurity').value = selectedKarat.purity;
  const lbl = document.getElementById('aGoldLabel');
  if(!lbl.value || lbl.value.match(/^\d+K Gold/)) lbl.value = selectedKarat.karat + 'K Gold';
  updateGoldPreview();
};

function updateGoldPreview() {
  const grams = parseFloat(document.getElementById('aGoldGrams')?.value) || 0;
  const preview = document.getElementById('goldPreview');
  if(!preview) return;
  if(grams > 0 && goldPerOz > 0) {
    const ppg = (goldPerOz / TROY_OZ_GRAM) * selectedKarat.purity;
    const val = grams * ppg;
    preview.style.display = 'flex';
    preview.textContent = '‚âà ' + fmt(val) + '  at current gold price (' + fmt(goldPerOz) + '/oz)';
  } else { preview.style.display = 'none'; }
}

window.addAsset = async function() {
  const uc = assets.map(a=>a.color);
  const color = COLORS.find(c=>!uc.includes(c))||COLORS[assets.length%COLORS.length];
  let na;
  if(selectedType==='etf'){
    const t=document.getElementById('aTicker').value.trim().toUpperCase();
    if(!t){showToast('Enter a ticker symbol','error');return;}
    if(assets.some(a=>a.ticker===t)){showToast(t+' is already tracked','error');return;}
    const avgCost=parseFloat(document.getElementById('aAvgCost').value)||0;
    na={id:genId(),type:'etf',label:t,icon:'üìà',ticker:t,holding:parseFloat(document.getElementById('aShares').value)||0,avgCost:avgCost||undefined,color};
  } else if(selectedType==='cash'){
    const label=document.getElementById('aCashLabel').value.trim();
    if(!label){showToast('Enter a label for this cash position','error');return;}
    const ccy=document.getElementById('aCashCcy').value||'USD';
    na={id:genId(),type:'cash',label,icon:'üíµ',currency:ccy,holding:parseFloat(document.getElementById('aCashAmt').value)||0,color};
  } else if(selectedType==='gold'){
    const grams=parseFloat(document.getElementById('aGoldGrams').value)||0;
    if(!grams){showToast('Enter weight in grams','error');return;}
    const label=document.getElementById('aGoldLabel').value.trim()||selectedKarat.karat+'K Gold';
    na={id:genId(),type:'gold',label,icon:'ü•á',purity:selectedKarat.purity,holding:grams,color};
  } else if(selectedType==='deposit'){
    const label=document.getElementById('aDepLabel').value.trim();
    if(!label){showToast('Enter a label for this deposit','error');return;}
    const ccy=document.getElementById('aDepCcy').value||'EGP';
    const rate=parseFloat(document.getElementById('aDepRate').value)||undefined;
    const maturity=document.getElementById('aDepMaturity').value||undefined;
    na={id:genId(),type:'deposit',label,icon:'üè¶',currency:ccy,holding:parseFloat(document.getElementById('aDepAmt').value)||0,interestRate:rate,maturity,color};
  }
  if(!na) return;
  const btn=document.getElementById('addAssetBtn');
  btn.disabled=true; btn.textContent='Adding‚Ä¶';
  assets.push(na);
  await saveAsset(na);
  closeAddModal();
  btn.disabled=false;
  showToast(na.label+' added','success');
  if(na.type==='etf'){show('loadingOverlay');setText('loadingText','Fetching live price for '+na.ticker+'‚Ä¶');await fetchETFPrice(na.ticker);hide('loadingOverlay');await saveAsset(na);}
  if(na.currency&&na.currency!=='USD'&&!fxRates[na.currency]) await fetchFX();
  render();
};
// ‚îÄ‚îÄ‚îÄ TRANSACTIONS ‚îÄ‚îÄ‚îÄ
window.openTxModal = function(assetId) { currentTxAssetId=assetId; currentTxType='buy'; selectTxType('buy',document.querySelector('[data-tx="buy"]')); document.getElementById('txDate').value=todayKey(); document.getElementById('txQty').value=''; document.getElementById('txPrice').value=''; document.getElementById('txDivAmt').value=''; document.getElementById('txModal').classList.remove('hidden'); };
window.closeTxModal = function() { document.getElementById('txModal').classList.add('hidden'); };
window.selectTxType = function(type, btn) {
  currentTxType=type;
  document.querySelectorAll('[data-tx]').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('txBuySell').style.display=type==='dividend'?'none':'';
  document.getElementById('txDividend').style.display=type==='dividend'?'':'none';
};
window.addTx = async function() {
  const date=document.getElementById('txDate').value||todayKey();
  let tx={id:'tx-'+Date.now(),type:currentTxType,date};
  if(currentTxType==='dividend'){tx.amount=parseFloat(document.getElementById('txDivAmt').value)||0;}
  else{tx.qty=parseFloat(document.getElementById('txQty').value)||0;tx.price=parseFloat(document.getElementById('txPrice').value)||0;}
  if(!transactions[currentTxAssetId]) transactions[currentTxAssetId]=[];
  transactions[currentTxAssetId].push(tx);
  if(currentTxType==='buy'||currentTxType==='sell'){ const txList=transactions[currentTxAssetId]; const a=assets.find(x=>x.id===currentTxAssetId); if(a){let totalQty=0,totalCost=0;txList.forEach(t=>{if(t.type==='buy'){totalQty+=(t.qty||0);totalCost+=(t.qty||0)*(t.price||0);}else if(t.type==='sell'){totalQty-=(t.qty||0);}});if(totalQty>0)a.avgCost=totalCost/txList.filter(t=>t.type==='buy').reduce((s,t)=>s+(t.qty||0),0);a.holding=totalQty;await saveAsset(a);}}
  await saveTx(currentTxAssetId, tx);
  closeTxModal(); render(); showToast('Transaction added','success');
};
window.removeTx = async function(assetId, txId) {
  if(!transactions[assetId]) return;
  transactions[assetId]=transactions[assetId].filter(t=>t.id!==txId);
  await deleteTx(txId);
  render(); showToast('Transaction removed','info');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  API FETCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROXIES=[u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u),u=>'https://corsproxy.io/?'+encodeURIComponent(u),u=>'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(u)];
async function fetchTimeout(url,ms=5000){const c=new AbortController();const t=setTimeout(()=>c.abort(),ms);try{return await fetch(url,{signal:c.signal,cache:'no-store'});}finally{clearTimeout(t);}}
async function fetchJsonRace(url,ms=7000){const try1=async(u)=>{const r=await fetchTimeout(u,ms);if(!r.ok)throw new Error('HTTP '+r.status);return r.json();};return new Promise(resolve=>{let done=false,pending=1+PROXIES.length;[url,...PROXIES.map(p=>p(url))].forEach(u=>try1(u).then(d=>{if(!done){done=true;resolve(d);}}).catch(()=>{if(--pending===0&&!done)resolve(null);}));});}
async function fetchYahooChart(ticker,range='1d',interval='1d'){const u='https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(ticker)+'?interval='+encodeURIComponent(interval)+'&range='+encodeURIComponent(range)+'&_ts='+Date.now();const tryUrl=async(url)=>{const r=await fetchTimeout(url,7000);if(!r.ok)throw new Error('HTTP '+r.status);const d=await r.json();const res=d?.chart?.result?.[0];if(!res)throw new Error('No result');return res;};return new Promise(resolve=>{let done=false,pending=1+PROXIES.length;[u,...PROXIES.map(p=>p(u))].forEach(url=>tryUrl(url).then(d=>{if(!done){done=true;resolve(d);}}).catch(()=>{if(--pending===0&&!done)resolve(null);}));});}

async function fetchFX(){
  fxMeta.attempted=true;const ts=Date.now();
  const needed=new Set(['EGP']);assets.forEach(a=>{if(a?.currency&&a.currency!=='USD')needed.add(String(a.currency).toUpperCase());});
  const wanted=[...needed].filter(c=>/^[A-Z]{3}$/.test(c)&&c!=='USD');if(!wanted.length)return true;
  function merge(ratesObj){if(!ratesObj)return;for(const c of wanted){const v=Number(ratesObj[c]);if(Number.isFinite(v)&&v>0)fxRates[c]=v;}}
  const haveAll=()=>wanted.every(c=>Number.isFinite(fxRates?.[c])&&fxRates[c]>0);
  const sources=[
    async()=>{const syms=wanted.map(c=>'USD'+c+'=X').join(',');const d=await fetchJsonRace('https://query1.finance.yahoo.com/v7/finance/quote?symbols='+encodeURIComponent(syms)+'&_ts='+ts,6000);const res=d?.quoteResponse?.result;if(!Array.isArray(res)||!res.length)return false;const rates={};for(const q of res){const m=/^USD([A-Z]{3})=X$/.exec(q?.symbol||'');if(!m)continue;const px=Number(q?.regularMarketPrice);if(px>0)rates[m[1]]=px;}merge(rates);return fxRates?.EGP>0;},
    async()=>{const d=await fetchJsonRace('https://open.er-api.com/v6/latest/USD?_ts='+ts,6000);merge(d?.rates);return fxRates?.EGP>0;},
    async()=>{await Promise.allSettled(wanted.map(async c=>{const d=await fetchJsonRace('https://wise.com/rates/live?source=USD&target='+c+'&_ts='+ts,6000);const px=Number(d?.value);if(px>0)fxRates[c]=px;}));return fxRates?.EGP>0;}
  ];
  for(const fn of sources){try{if(await fn()){fxMeta.updatedAt=new Date();if(haveAll())break;}}catch{}}
  return fxRates?.EGP>0;
}

async function fetchGoldPrevClose(){
  for(const sym of['XAUUSD=X','GC=F']){const r=await fetchYahooChart(sym,'2d','1d');if(!r)continue;const meta=r.meta||{};const cur=meta.regularMarketPrice;let prev=meta.previousClose??meta.chartPreviousClose??null;if(prev==null){const cl=r?.indicators?.quote?.[0]?.close;if(Array.isArray(cl)){const nn=cl.filter(x=>x!=null);if(nn.length>=2)prev=nn[nn.length-2];}}if(typeof cur==='number'&&cur>0)goldPerOz=cur;if(typeof prev==='number'&&prev>0)goldPrevOz=prev;if(goldPerOz>0&&goldPrevOz>0){goldMeta={updatedAt:new Date(),source:'Yahoo ('+sym+')'};return true;}}return false;
}
async function fetchGold(){
  for(const url of['https://api.metals.dev/v1/latest?api_key=demo&currency=USD&unit=toz','https://data-asg.goldprice.org/dbXRates/USD']){const d=await fetchJsonRace(url,8000);if(!d)continue;if(d.metals?.gold>0){goldPerOz=d.metals.gold;goldMeta={updatedAt:new Date(),source:'metals.dev'};return true;}if(d.items?.[0]?.xauPrice>0){goldPerOz=d.items[0].xauPrice;goldMeta={updatedAt:new Date(),source:'goldprice.org'};return true;}}return false;
}

async function fetchETFPrice(ticker){
  const r=await fetchYahooChart(ticker,'1d','1d');if(!r)return false;
  const meta=r.meta||{};let ccy=meta.currency||'USD';
  const ex=(meta?.fullExchangeName||meta?.exchangeName||'').toString().toLowerCase();
  if(ex.includes('cairo')||ex.includes('egypt'))ccy='EGP';
  let px=meta.regularMarketPrice;
  if(px==null){const cl=r?.indicators?.quote?.[0]?.close;if(Array.isArray(cl)){const nn=cl.filter(x=>x!=null);if(nn.length)px=nn[nn.length-1];}}
  let prev=meta.previousClose??meta.chartPreviousClose??null;
  if(prev==null){const cl=r?.indicators?.quote?.[0]?.close;if(Array.isArray(cl)){const nn=cl.filter(x=>x!=null);if(nn.length>=2)prev=nn[nn.length-2];}}
  if(typeof px!=='number'||px<=0)return false;
  if(ccy==='GBp'||ccy==='GBX'){px=px/100;if(prev!=null)prev=prev/100;ccy='GBP';}
  etfPrices[ticker]={price:px,currency:ccy,prevClose:prev};
  etfMeta[ticker]={updatedAt:new Date(),source:'Yahoo'};return true;
}

window.fetchAllPrices = async function() {
  const btn=document.getElementById('refreshBtn');btn.disabled=true;btn.textContent='‚è≥ Updating‚Ä¶';
  const hasGold=assets.some(a=>a.type==='gold');
  const hasETF=assets.some(a=>a.type==='etf');
  const etfTickers=[...new Set(assets.filter(a=>a.type==='etf').map(a=>a.ticker))];
  const [fxOk,goldOk,etfOk]=await Promise.all([fetchFX(),hasGold?fetchGoldPrevClose().then(ok=>ok||fetchGold()):Promise.resolve(false),hasETF?Promise.all(etfTickers.map(t=>fetchETFPrice(t))).then(r=>r.some(Boolean)):Promise.resolve(false)]);
  btn.disabled=false;btn.textContent='üîÑ Refresh';
  const parts=[];parts.push(fxOk?'FX ‚úì':'FX ‚úó');
  if(hasGold)parts.push(goldOk?'Gold ‚úì':'Gold ‚úó');
  etfTickers.forEach(t=>parts.push(etfPrices[t]?t+' ‚úì':t+' ‚úó'));
  document.getElementById('headerSub').textContent=parts.join(' ¬∑ ')+' ‚Äî '+new Date().toLocaleTimeString();
  await captureSnapshot();
  render();
  if(fxOk||goldOk||etfOk)showToast('Prices updated','success');else showToast('Some fetches failed','error');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PERFORMANCE TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.switchTab = function(name, btn) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='performance') renderPerformanceTab();
  if(name==='history') renderHistoryTab();
};

function getSnapsForRange(range){
  const n=snapshots.length;if(!n)return[];
  const now=new Date();let cutoff;
  if(range==='1M')cutoff=new Date(now.setMonth(now.getMonth()-1));
  else if(range==='3M')cutoff=new Date(now.setMonth(now.getMonth()-3));
  else if(range==='6M')cutoff=new Date(now.setMonth(now.getMonth()-6));
  else if(range==='1Y')cutoff=new Date(now.setFullYear(now.getFullYear()-1));
  else return snapshots;
  return snapshots.filter(s=>new Date(s.date+'T00:00:00')>=cutoff);
}

function calcTWR(snaps){
  if(snaps.length<2)return null;let twr=1;
  for(let i=1;i<snaps.length;i++){const prev=snaps[i-1].totalUSD;const cur=snaps[i].totalUSD;if(prev>0)twr*=(cur/prev);}
  return(twr-1)*100;
}

function renderPerformanceTab(){
  const snaps=getSnapsForRange('ALL');const total=getTotalUSD();const twr=calcTWR(snaps);
  let tU=0,tB=0;assets.forEach(a=>{const u=unrealizedUSD(a),b=costBasisUSD(a);if(u!==null){tU+=u;tB+=b;}});
  let tT=0,hT=false,prevP=0;assets.forEach(a=>{const g=todaysGainUSD(a);if(g!==null){tT+=g;hT=true;prevP+=assetValueUSD(a)-g;}});
  const todPct=prevP>0?(tT/prevP*100):0;
  let best=null,worst=null;
  for(let i=1;i<snaps.length;i++){const p=snaps[i-1].totalUSD,c=snaps[i].totalUSD;const pct=p>0?((c-p)/p*100):0;if(best===null||pct>best.pct)best={date:snaps[i].date,pct};if(worst===null||pct<worst.pct)worst={date:snaps[i].date,pct};}
  const metrics=[
    {label:'Total Value',value:fmt(total),sub:'Current',cls:''},
    {label:'Unrealized P/L',value:tB>0?fmtSigned(tU)+' ('+fmtPct(tU/tB*100)+')':'‚Äî',sub:'vs cost basis',cls:tU>0?'positive':tU<0?'negative':''},
    {label:"Today's Change",value:hT?fmtSigned(tT)+' ('+fmtPct(todPct)+')':'‚Äî',sub:'vs prev close',cls:tT>0?'positive':tT<0?'negative':''},
    {label:'TWR (All Time)',value:twr!==null?fmtPct(twr):'‚Äî',sub:snaps.length+' snapshots',cls:twr>0?'positive':twr<0?'negative':''},
    {label:'Best Day',value:best?fmtPct(best.pct):'‚Äî',sub:best?fmtDate(best.date):'No data',cls:'positive'},
    {label:'Worst Day',value:worst?fmtPct(worst.pct):'‚Äî',sub:worst?fmtDate(worst.date):'No data',cls:'negative'},
  ];
  document.getElementById('perfMetrics').innerHTML=metrics.map(m=>`<div class="perf-card"><div class="perf-card-label">${m.label}</div><div class="perf-card-value ${m.cls}">${m.value}</div><div class="perf-card-sub">${m.sub}</div></div>`).join('');
  renderValueChart();renderAllocChart();
}

window.setChartRange = function(range, btn) {
  activeChartRange=range;
  document.querySelectorAll('.range-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderValueChart();
};

function destroyChart(id){if(chartInstances[id]){chartInstances[id].destroy?.();delete chartInstances[id];}}

function renderValueChart(){
  const snaps=getSnapsForRange(activeChartRange);
  const canvas=document.getElementById('valueChart');const empty=document.getElementById('chartEmpty');
  destroyChart('value');
  if(snaps.length<2){canvas.style.display='none';empty.style.display='';return;}
  canvas.style.display='';empty.style.display='none';
  chartInstances['value']=drawLineChart(canvas.getContext('2d'),canvas,snaps.map(s=>fmtDate(s.date)),snaps.map(s=>s.totalUSD));
}

function renderAllocChart(){
  const snaps=getSnapsForRange(activeChartRange);const canvas=document.getElementById('allocChart');destroyChart('alloc');if(snaps.length<2)return;
  const ids=[...new Set(snaps.flatMap(s=>Object.keys(s.assets||{})))];
  const datasets=ids.map(id=>{const a=assets.find(x=>x.id===id);const color=(a?.color)||COLORS[ids.indexOf(id)%COLORS.length];return{label:a?.label||id,data:snaps.map(s=>s.assets?.[id]||0),color};}).filter(d=>d.data.some(v=>v>0));
  chartInstances['alloc']=drawStackedChart(canvas.getContext('2d'),canvas,snaps.map(s=>fmtDate(s.date)),datasets);
}

function drawLineChart(ctx,canvas,labels,data){
  const W=canvas.parentElement.clientWidth||600;const H=200;canvas.width=W;canvas.height=H;
  const pad={top:16,right:16,bottom:36,left:64};const cw=W-pad.left-pad.right,ch=H-pad.top-pad.bottom;
  const min=Math.min(...data)*0.995,max=Math.max(...data)*1.005,range=max-min||1;
  const xp=i=>pad.left+i/(data.length-1)*cw;const yp=v=>pad.top+ch*(1-(v-min)/range);
  ctx.clearRect(0,0,W,H);
  const isUp=data[data.length-1]>=data[0];const lc=isUp?'#3dd68c':'#f05b5b';
  ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){const y=pad.top+i/4*ch;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cw,y);ctx.stroke();}
  const grad=ctx.createLinearGradient(0,pad.top,0,pad.top+ch);grad.addColorStop(0,lc+'33');grad.addColorStop(1,lc+'00');
  ctx.beginPath();ctx.moveTo(xp(0),yp(data[0]));for(let i=1;i<data.length;i++)ctx.lineTo(xp(i),yp(data[i]));ctx.lineTo(xp(data.length-1),pad.top+ch);ctx.lineTo(xp(0),pad.top+ch);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  ctx.beginPath();ctx.strokeStyle=lc;ctx.lineWidth=2;ctx.lineJoin='round';ctx.moveTo(xp(0),yp(data[0]));for(let i=1;i<data.length;i++)ctx.lineTo(xp(i),yp(data[i]));ctx.stroke();
  ctx.fillStyle='rgba(160,160,176,0.7)';ctx.font='10px JetBrains Mono,monospace';ctx.textAlign='right';
  for(let i=0;i<=4;i++){const v=min+i/4*range;ctx.fillText('$'+Math.round(v).toLocaleString(),pad.left-4,pad.top+ch*(1-i/4)+4);}
  ctx.textAlign='center';const step=Math.max(1,Math.floor(data.length/6));for(let i=0;i<labels.length;i+=step)ctx.fillText(labels[i],xp(i),H-8);
  return{destroy(){}};
}

function drawStackedChart(ctx,canvas,labels,datasets){
  const W=canvas.parentElement.clientWidth||600;const H=160;canvas.width=W;canvas.height=H;
  const pad={top:8,right:16,bottom:28,left:64};const cw=W-pad.left-pad.right,ch=H-pad.top-pad.bottom;
  const n=labels.length;const stacked=labels.map((_,i)=>datasets.reduce((s,d)=>s+d.data[i],0));const max=Math.max(...stacked,1);
  const xp=i=>pad.left+i/(n-1)*cw;const yp=v=>pad.top+ch*(1-v/max);
  ctx.clearRect(0,0,W,H);
  const cumul=new Array(n).fill(0);
  datasets.forEach(ds=>{const base=[...cumul];ds.data.forEach((v,i)=>cumul[i]+=v);ctx.beginPath();ctx.moveTo(xp(0),yp(base[0]));for(let i=1;i<n;i++)ctx.lineTo(xp(i),yp(base[i]));for(let i=n-1;i>=0;i--)ctx.lineTo(xp(i),yp(cumul[i]));ctx.closePath();ctx.fillStyle=ds.color+'88';ctx.fill();ctx.beginPath();ctx.strokeStyle=ds.color;ctx.lineWidth=1.5;ctx.moveTo(xp(0),yp(cumul[0]));for(let i=1;i<n;i++)ctx.lineTo(xp(i),yp(cumul[i]));ctx.stroke();});
  ctx.fillStyle='rgba(160,160,176,0.7)';ctx.font='10px JetBrains Mono,monospace';ctx.textAlign='right';
  for(let i=0;i<=3;i++){const v=i/3*max;ctx.fillText('$'+Math.round(v).toLocaleString(),pad.left-4,pad.top+ch*(1-i/3)+4);}
  ctx.textAlign='center';const step=Math.max(1,Math.floor(n/5));for(let i=0;i<labels.length;i+=step)ctx.fillText(labels[i],xp(i),H-5);
  return{destroy(){}};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HISTORY TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistoryTab(){
  const body=document.getElementById('snapBody');const empty=document.getElementById('snapEmpty');body.innerHTML='';
  if(!snapshots.length){empty.style.display='';document.getElementById('snapTable').style.display='none';return;}
  empty.style.display='none';document.getElementById('snapTable').style.display='';
  const sorted=[...snapshots].reverse();
  sorted.forEach((s,i)=>{const prev=sorted[i+1];const chg=prev?s.totalUSD-prev.totalUSD:null;const chgPct=(prev&&prev.totalUSD>0)?((s.totalUSD-prev.totalUSD)/prev.totalUSD*100):null;const cls=chg>0?'var(--green)':chg<0?'var(--red)':'';const tr=document.createElement('tr');tr.innerHTML=`<td>${fmtDate(s.date)}</td><td style="font-weight:700">${fmt(s.totalUSD)}</td><td style="color:${cls}">${chg!==null?(chg>=0?'+':'')+chg.toFixed(2):'‚Äî'}</td><td style="color:${cls}">${chgPct!==null?(chgPct>=0?'+':'')+chgPct.toFixed(2)+'%':'‚Äî'}</td><td>${Object.keys(s.assets||{}).length}</td>`;body.appendChild(tr);});
}

window.clearHistory = async function() {
  if(!confirm('Clear all snapshot history?')) return;
  await sb.from('snapshots').delete().eq('user_id', currentUser.id);
  snapshots=[]; renderHistoryTab(); showToast('History cleared','info');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.downloadCSV = function() {
  let csv='Asset,Type,Ticker,Currency,Holding,Value USD,Allocation %,Avg Cost,Unrealized USD,Unrealized %\n';
  const total=getTotalUSD();
  assets.forEach(a=>{const v=assetValueUSD(a);const p=total>0?((v/total)*100).toFixed(2):'0.00';const u=unrealizedUSD(a);const b=costBasisUSD(a);csv+='"'+a.label+'",'+a.type+','+(a.ticker||'')+','+(a.currency||'')+','+a.holding+','+v.toFixed(2)+','+p+','+(a.avgCost||'')+','+(u!==null?u.toFixed(2):'')+','+(u!==null&&b>0?(u/b*100).toFixed(2):'')+'\n';});
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const l=document.createElement('a');l.href=url;l.download='portfolio_'+new Date().toISOString().slice(0,10)+'.csv';l.click();URL.revokeObjectURL(url);showToast('CSV downloaded','success');
};

window.printView = function() {
  const total=getTotalUSD();const egp=getFxRate('EGP')||0;
  let html=`<html><head><title>Portfolio ‚Äî ${new Date().toLocaleDateString()}</title><style>body{font-family:sans-serif;padding:30px;color:#111}table{width:100%;border-collapse:collapse;font-size:13px}th{background:#f0f0f0;padding:8px 12px;text-align:left;font-size:11px;text-transform:uppercase}td{padding:8px 12px;border-bottom:1px solid #eee}h1{font-size:22px;margin-bottom:4px}p{color:#666;font-size:13px;margin:0 0 20px}.total{font-size:32px;font-weight:700;margin:8px 0}.egp{font-size:16px;color:#666}</style></head><body>`;
  html+=`<h1>Portfolio Summary</h1><p>${new Date().toLocaleString()}</p><div class="total">${fmt(total)}</div><div class="egp">${egp?'EGP '+(total*egp).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):''}</div><table><thead><tr><th>Asset</th><th>Type</th><th>Holding</th><th>Value USD</th><th>Allocation</th><th>Unrealized</th></tr></thead><tbody>`;
  const t2=getTotalUSD();assets.forEach(a=>{const v=assetValueUSD(a);const p=t2>0?((v/t2)*100).toFixed(1)+'%':'‚Äî';const u=unrealizedUSD(a);html+=`<tr><td>${a.label}${a.ticker?' ('+a.ticker+')':''}</td><td>${a.type}</td><td>${a.holding} ${a.currency||a.ticker||'g'}</td><td>${fmt(v)}</td><td>${p}</td><td>${u!==null?fmtSigned(u):'‚Äî'}</td></tr>`;});
  html+=`</tbody></table></body></html>`;
  const w=window.open('','_blank');w.document.write(html);w.document.close();w.print();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACCOUNT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openAccountModal = function() { document.getElementById('accountModal').classList.remove('hidden'); renderPasskeyList(); };
window.closeAccountModal = function() { document.getElementById('accountModal').classList.add('hidden'); };
window.confirmDeleteAll = async function() {
  if(!confirm('‚ö†Ô∏è This will delete ALL your assets, transactions, and history. This cannot be undone. Are you sure?')) return;
  if(!confirm('Really? ALL data will be gone permanently.')) return;
  const uid=currentUser.id;
  await Promise.all([sb.from('assets').delete().eq('user_id',uid),sb.from('transactions').delete().eq('user_id',uid),sb.from('snapshots').delete().eq('user_id',uid),sb.from('settings').delete().eq('user_id',uid)]);
  assets=[];transactions={};snapshots=[];render();showToast('All data deleted.','error');
  closeAccountModal();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openAddModal = function() {
  document.getElementById('addModal').classList.remove('hidden');
  // Reset all input fields
  ['aTicker','aShares','aAvgCost','aCashLabel','aCashAmt','aGoldGrams','aDepLabel','aDepAmt','aDepRate','aDepMaturity'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  // Reset selects to defaults
  document.getElementById('aCashCcy').value='USD';
  document.getElementById('aDepCcy').value='EGP';
  document.getElementById('cashAmtUnit').textContent='USD';
  document.getElementById('depAmtUnit').textContent='EGP';
  // Reset karat to 24K
  selectedKarat={karat:24,purity:1.0};
  document.querySelectorAll('.karat-btn').forEach(b=>b.classList.remove('selected'));
  const k24=document.querySelector('.karat-btn[data-karat="24"]');if(k24)k24.classList.add('selected');
  document.getElementById('aGoldPurity').value='1.0';
  document.getElementById('aGoldLabel').value='24K Gold';
  // Hide previews
  ['etfPreview','goldPreview'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display='none';});
  // Reset add btn
  const btn=document.getElementById('addAssetBtn');if(btn){btn.disabled=false;btn.innerHTML='<span>Ôºã</span> Add Asset';}
  // Default to ETF tab
  selectType('etf', document.querySelector('[data-type="etf"]'));
  setTimeout(()=>document.getElementById('aTicker')?.focus(),50);
};
window.closeAddModal = function() { document.getElementById('addModal').classList.add('hidden'); };

// ‚îÄ‚îÄ User Menu ‚îÄ‚îÄ
window.toggleUserMenu = function() { document.getElementById('userMenuDropdown').classList.toggle('hidden'); };
window.closeUserMenu = function() { document.getElementById('userMenuDropdown').classList.add('hidden'); };

function setupClickOutside(){document.addEventListener('click',e=>{const menu=document.getElementById('userMenuDropdown');const avatar=document.getElementById('userAvatar');if(!menu.contains(e.target)&&!avatar.contains(e.target))menu.classList.add('hidden');});}

function setupKeyListeners(){document.addEventListener('keydown',e=>{if(e.key==='Escape'){['addModal','txModal','accountModal'].forEach(id=>document.getElementById(id)?.classList.add('hidden'));}});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmt(v){return'$'+Math.abs(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtSigned(v){return(v>=0?'+':'‚àí')+'$'+Math.abs(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtPct(v){return(v>=0?'+':'')+v.toFixed(2)+'%';}
function fmtDate(d){try{return new Date(d+'T00:00:00').toLocaleDateString();}catch{return d;}}
function genId(){return'a-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6);}
function show(id){document.getElementById(id)?.classList.remove('hidden');}
function hide(id){document.getElementById(id)?.classList.add('hidden');}
function setText(id,t){const e=document.getElementById(id);if(e)e.textContent=t;}
function setSyncStatus(online,label){const dot=document.getElementById('syncDot');const lbl=document.getElementById('syncLabel');if(dot)dot.className='sync-dot'+(online?'':' offline');if(lbl)lbl.textContent=label||'';}

function bufferToBase64(buf){const b=new Uint8Array(buf instanceof ArrayBuffer?buf:buf.buffer??buf);let s='';b.forEach(x=>s+=String.fromCharCode(x));return btoa(s);}
function base64ToBuffer(b64){const bin=atob(b64);const buf=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)buf[i]=bin.charCodeAt(i);return buf.buffer;}

let toastTimer={};
window.showToast = function(msg, type='info') {
  const c=document.getElementById('toastContainer');
  const t=document.createElement('div');t.className='toast '+type;
  const icon={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'}[type]||'';
  t.textContent=(icon?icon+' ':'')+msg;
  c.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity 0.3s';setTimeout(()=>t.remove(),400);},3000);
};
</script>
</body>
</html>
